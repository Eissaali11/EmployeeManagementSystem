# معمارية النظام - نُظم

## نظرة عامة على المعمارية

النظام مصمم وفقاً لمعمارية **Modular Monolith** مع فصل الاهتمامات وتنظيم الكود في طبقات منطقية.

## الطبقات الرئيسية

### 1. طبقة الإعدادات (Configuration Layer)
```
config/
├── settings.py          # إعدادات البيئات المختلفة
└── __init__.py
```

**المسؤوليات:**
- إدارة إعدادات البيئات (تطوير، إنتاج، اختبار)
- تحديد المتغيرات البيئية المطلوبة
- إعدادات الأمان والقاعدة

### 2. الطبقة الأساسية (Core Layer)
```
core/
├── app_factory.py       # مصنع إنشاء التطبيق
├── extensions.py        # ملحقات Flask المشتركة
└── __init__.py
```

**المسؤوليات:**
- إنشاء وتكوين تطبيق Flask
- تهيئة الملحقات (قاعدة البيانات، المصادقة)
- تسجيل المسارات ومعالجات الأخطاء
- إعداد المرشحات والمتغيرات العامة

### 3. طبقة الخدمات (Services Layer)
```
services/
├── auth_service.py      # خدمة المصادقة والتفويض
├── notification_service.py  # خدمة الإشعارات
├── report_service.py    # خدمة التقارير والإحصائيات
├── file_service.py      # خدمة إدارة الملفات
└── __init__.py
```

**المسؤوليات:**
- منطق العمل المعقد
- التكامل مع الخدمات الخارجية
- معالجة البيانات والحسابات
- إدارة الملفات والمرفقات

### 4. طبقة المسارات (Routes Layer)
```
routes/
├── auth.py             # مصادقة المستخدمين
├── attendance.py       # الحضور والغياب
├── departments.py      # إدارة الأقسام
├── employees.py        # إدارة الموظفين
├── salaries.py         # إدارة الرواتب
├── documents.py        # إدارة الوثائق
├── vehicles.py         # إدارة المركبات
├── users.py            # إدارة المستخدمين
├── reports.py          # التقارير
└── fees_costs.py       # الرسوم والتكاليف
```

**المسؤوليات:**
- التعامل مع طلبات HTTP
- التحقق من الصلاحيات
- تحويل البيانات بين الطبقات
- إرجاع الاستجابات المناسبة

### 5. طبقة البيانات (Data Layer)
```
models.py               # نماذج قاعدة البيانات
```

**المسؤوليات:**
- تعريف جداول قاعدة البيانات
- العلاقات بين الكيانات
- قيود البيانات والتحقق
- دوال مساعدة للاستعلامات

### 6. طبقة الأدوات المساعدة (Utilities Layer)
```
utils/
├── audit_logger.py     # تسجيل أنشطة النظام
└── ...
```

**المسؤوليات:**
- وظائف مساعدة عامة
- تسجيل الأنشطة والتدقيق
- معالجة الأخطاء
- التحقق من البيانات

## تدفق البيانات

### 1. طلب HTTP الداخل
```
Request → Route → Service → Model → Database
```

### 2. استجابة HTTP الخارجة
```
Database → Model → Service → Route → Response
```

### 3. معالجة الأخطاء
```
Error → Service/Route → Error Handler → Error Response
```

## أنماط التصميم المستخدمة

### 1. Factory Pattern
- استخدام `app_factory.py` لإنشاء تطبيق Flask
- تسهيل الاختبار وإدارة البيئات المختلفة

### 2. Service Layer Pattern
- فصل منطق العمل عن طبقة العرض
- سهولة الاختبار وإعادة الاستخدام

### 3. Repository Pattern (ضمني)
- استخدام SQLAlchemy ORM كطبقة تجريد
- سهولة تغيير قاعدة البيانات

### 4. Decorator Pattern
- استخدام decorators للصلاحيات (`@admin_required`)
- مرشحات القوالب المخصصة

## الأمان والصلاحيات

### 1. مستويات المصادقة
```
Level 1: تسجيل الدخول (@login_required)
Level 2: الأدوار (@admin_required, @manager_required)
Level 3: الصلاحيات التفصيلية (check_module_access)
Level 4: فصل الأقسام (can_access_department)
```

### 2. نظام الصلاحيات
```
User → UserRole (Admin/Manager/Employee)
User → UserPermission → Module + Permissions (CRUD)
User → assigned_department_id (للتحكم في الوصول)
```

## إدارة الحالة

### 1. حالة الجلسة
- Flask-Login لإدارة جلسات المستخدمين
- CSRF protection لحماية النماذج

### 2. حالة قاعدة البيانات
- SQLAlchemy ORM مع PostgreSQL
- معاملات آمنة مع rollback عند الأخطاء

## التكامل مع الخدمات الخارجية

### 1. Firebase Authentication
- مصادقة إضافية للمستخدمين
- تسجيل دخول عبر Google

### 2. Twilio SMS
- إرسال الإشعارات النصية
- تنبيهات انتهاء الوثائق

### 3. تصدير التقارير
- ReportLab للتقارير PDF
- openpyxl للتقارير Excel

## قابلية التوسع

### 1. توسع أفقي
- استخدام Gunicorn مع multiple workers
- إمكانية إضافة load balancer

### 2. توسع عمودي
- تحسين استعلامات قاعدة البيانات
- استخدام connection pooling

### 3. توسع الوظائف
- إضافة خدمات جديدة في مجلد `services/`
- إضافة مسارات جديدة في مجلد `routes/`

## مراقبة الأداء

### 1. التسجيل
- سجل شامل لجميع الأنشطة
- تتبع الأخطاء والاستثناءات

### 2. التدقيق
- تسجيل جميع العمليات الحساسة
- تتبع تغييرات البيانات

## أفضل الممارسات المتبعة

### 1. فصل الاهتمامات
- كل طبقة لها مسؤولية واضحة
- عدم خلط منطق العمل مع العرض

### 2. قابلية الاختبار
- خدمات منفصلة قابلة للاختبار
- استخدام dependency injection

### 3. قابلية الصيانة
- كود منظم ومفهوم
- توثيق شامل للوظائف

### 4. الأمان
- التحقق من الصلاحيات في كل طبقة
- حماية من CSRF وSQL injection

## خطة التطوير المستقبلية

### المرحلة القادمة
1. إضافة API REST للتطبيقات المحمولة
2. تحسين واجهة المستخدم مع Vue.js
3. إضافة نظام workflow للموافقات
4. تكامل مع أنظمة المحاسبة الخارجية

### التحسينات التقنية
1. إضافة Redis للتخزين المؤقت
2. استخدام Celery للمهام غير المتزامنة
3. تطبيق microservices للوحدات الكبيرة
4. إضافة Docker للنشر

هذه المعمارية تضمن قابلية الصيانة والتوسع والأمان للنظام على المدى الطويل.