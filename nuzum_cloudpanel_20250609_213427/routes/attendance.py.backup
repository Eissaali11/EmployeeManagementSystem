from flask import Blueprint, render_template, request, redirect, url_for, flash, jsonify, send_file
from sqlalchemy import func, extract
from datetime import datetime, time, timedelta, date
from app import db
from models import Attendance, Employee, Department, SystemAudit, VehicleProject
from utils.date_converter import parse_date, format_date_hijri, format_date_gregorian
from utils.excel import export_attendance_by_department
import calendar

attendance_bp = Blueprint('attendance', __name__)

@attendance_bp.route('/')
def index():
    """List attendance records with filtering options"""
    # Get filter parameters
    date_str = request.args.get('date', datetime.now().strftime('%Y-%m-%d'))
    department_id = request.args.get('department_id', '')
    status = request.args.get('status', '')
    
    # Parse date
    try:
        date = parse_date(date_str)
    except ValueError:
        date = datetime.now().date()
    
    # Build query
    query = Attendance.query.filter(Attendance.date == date)
    
    # Apply filters
    if department_id and department_id != '':
        query = query.join(Employee).filter(Employee.department_id == department_id)
    
    if status and status != '':
        query = query.filter(Attendance.status == status)
    
    # Execute query
    attendances = query.all()
    
    # Get departments for filter dropdown
    departments = Department.query.all()
    
    # Format date for display in both calendars
    hijri_date = format_date_hijri(date)
    gregorian_date = format_date_gregorian(date)
    
    return render_template('attendance/index.html', 
                          attendances=attendances,
                          departments=departments,
                          date=date,
                          hijri_date=hijri_date,
                          gregorian_date=gregorian_date,
                          selected_department=department_id,
                          selected_status=status)

@attendance_bp.route('/record', methods=['GET', 'POST'])
def record():
    """Record attendance for individual employees"""
    if request.method == 'POST':
        try:
            employee_id = request.form['employee_id']
            date_str = request.form['date']
            status = request.form['status']
            
            # Parse date
            date = parse_date(date_str)
            
            # Check if attendance record already exists
            existing = Attendance.query.filter_by(
                employee_id=employee_id,
                date=date
            ).first()
            
            if existing:
                # Update existing record
                existing.status = status
                existing.notes = request.form.get('notes', '')
                
                # Process check-in and check-out times if present
                if status == 'present':
                    check_in_str = request.form.get('check_in', '')
                    check_out_str = request.form.get('check_out', '')
                    
                    if check_in_str:
                        hours, minutes = map(int, check_in_str.split(':'))
                        existing.check_in = time(hours, minutes)
                    
                    if check_out_str:
                        hours, minutes = map(int, check_out_str.split(':'))
                        existing.check_out = time(hours, minutes)
                else:
                    existing.check_in = None
                    existing.check_out = None
                
                db.session.commit()
                flash('تم تحديث سجل الحضور بنجاح', 'success')
            else:
                # Create new attendance record
                new_attendance = Attendance(
                    employee_id=employee_id,
                    date=date,
                    status=status,
                    notes=request.form.get('notes', '')
                )
                
                # Process check-in and check-out times if present and status is 'present'
                if status == 'present':
                    check_in_str = request.form.get('check_in', '')
                    check_out_str = request.form.get('check_out', '')
                    
                    if check_in_str:
                        hours, minutes = map(int, check_in_str.split(':'))
                        new_attendance.check_in = time(hours, minutes)
                    
                    if check_out_str:
                        hours, minutes = map(int, check_out_str.split(':'))
                        new_attendance.check_out = time(hours, minutes)
                
                db.session.add(new_attendance)
                db.session.commit()
                
                # Log the action
                employee = Employee.query.get(employee_id)
                audit = SystemAudit(
                    action='create',
                    entity_type='attendance',
                    entity_id=new_attendance.id,
                    entity_name=employee.name,
                    details=f'تم تسجيل حضور للموظف: {employee.name} بتاريخ {date}'
                )
                db.session.add(audit)
                db.session.commit()
                
                flash('تم تسجيل الحضور بنجاح', 'success')
            
            return redirect(url_for('attendance.index', date=date_str))
        
        except Exception as e:
            db.session.rollback()
            flash(f'حدث خطأ: {str(e)}', 'danger')
    
    # Get all active employees for dropdown
    employees = Employee.query.filter_by(status='active').all()
    
    # Default to today's date
    today = datetime.now().date()
    hijri_date = format_date_hijri(today)
    gregorian_date = format_date_gregorian(today)
    
    return render_template('attendance/record.html', 
                          employees=employees, 
                          today=today,
                          hijri_date=hijri_date,
                          gregorian_date=gregorian_date)

@attendance_bp.route('/department', methods=['GET', 'POST'])
def department_attendance():
    """Record attendance for an entire department at once"""
    if request.method == 'POST':
        try:
            department_id = request.form['department_id']
            date_str = request.form['date']
            status = request.form['status']
            
            # Parse date
            date = parse_date(date_str)
            
            # Get all employees in the department
            employees = Employee.query.filter_by(
                department_id=department_id,
                status='active'
            ).all()
            
            count = 0
            for employee in employees:
                # Check if attendance record already exists
                existing = Attendance.query.filter_by(
                    employee_id=employee.id,
                    date=date
                ).first()
                
                if existing:
                    # Update existing record
                    existing.status = status
                    if status != 'present':
                        existing.check_in = None
                        existing.check_out = None
                else:
                    # Create new attendance record
                    new_attendance = Attendance(
                        employee_id=employee.id,
                        date=date,
                        status=status
                    )
                    db.session.add(new_attendance)
                
                count += 1
            
            # Log the action
            department = Department.query.get(department_id)
            audit = SystemAudit(
                action='mass_update',
                entity_type='attendance',
                entity_id=0,
                entity_name=department.name,
                details=f'تم تسجيل حضور لقسم {department.name} بتاريخ {date} لعدد {count} موظف'
            )
            db.session.add(audit)
            db.session.commit()
            
            flash(f'تم تسجيل الحضور لـ {count} موظف بنجاح', 'success')
            return redirect(url_for('attendance.index', date=date_str))
        
        except Exception as e:
            db.session.rollback()
            flash(f'حدث خطأ: {str(e)}', 'danger')
    
    # Get all departments
    departments = Department.query.all()
    
    # Default to today's date
    today = datetime.now().date()
    hijri_date = format_date_hijri(today)
    gregorian_date = format_date_gregorian(today)
    
    return render_template('attendance/department.html', 
                          departments=departments,
                          today=today,
                          hijri_date=hijri_date,
                          gregorian_date=gregorian_date)

@attendance_bp.route('/multi-day-department', methods=['GET', 'POST'])
def multi_day_department_attendance():
    """تسجيل حضور لقسم بالكامل لفترة زمنية محددة"""
    if request.method == 'POST':
        try:
            department_id = request.form['department_id']
            start_date_str = request.form['start_date']
            end_date_str = request.form['end_date']
            status = request.form['status']
            
            # تحليل التواريخ
            try:
                start_date = parse_date(start_date_str)
                end_date = parse_date(end_date_str)
                
                if not start_date or not end_date:
                    raise ValueError("تاريخ غير صالح")
                
                # التحقق من صحة النطاق
                if end_date < start_date:
                    flash('تاريخ النهاية يجب أن يكون بعد تاريخ البداية أو مساوياً له.', 'danger')
                    return redirect(url_for('attendance.multi_day_department_attendance'))
            except (ValueError, TypeError) as e:
                flash(f'خطأ في تنسيق التاريخ: {str(e)}', 'danger')
                return redirect(url_for('attendance.multi_day_department_attendance'))
                
            # الحصول على جميع الموظفين في القسم
            employees = Employee.query.filter_by(
                department_id=department_id,
                status='active'
            ).all()
            
            # حساب عدد الأيام
            delta = end_date - start_date
            days_count = delta.days + 1  # لتضمين اليوم الأخير
            
            # التحضير لكل يوم في النطاق المحدد
            total_count = 0
            current_date = start_date
            
            while current_date <= end_date:
                day_count = 0
                
                for employee in employees:
                    # التحقق من وجود سجل حضور مسبق
                    existing = Attendance.query.filter_by(
                        employee_id=employee.id,
                        date=current_date
                    ).first()
                    
                    if existing:
                        # تحديث السجل الموجود
                        existing.status = status
                        if status != 'present':
                            existing.check_in = None
                            existing.check_out = None
                    else:
                        # إنشاء سجل حضور جديد
                        new_attendance = Attendance(
                            employee_id=employee.id,
                            date=current_date,
                            status=status
                        )
                        db.session.add(new_attendance)
                    
                    day_count += 1
                
                total_count += day_count
                current_date += timedelta(days=1)
            
            # تسجيل الإجراء
            department = Department.query.get(department_id)
            audit = SystemAudit(
                action='mass_update_range',
                entity_type='attendance',
                entity_id=0,
                entity_name=department.name,
                details=f'تم تسجيل حضور لقسم {department.name} للفترة من {start_date} إلى {end_date} لعدد {len(employees)} موظف'
            )
            db.session.add(audit)
            db.session.commit()
            
            flash(f'تم تسجيل الحضور لـ {len(employees)} موظف خلال {days_count} يوم بنجاح', 'success')
            return redirect(url_for('attendance.index'))
        
        except Exception as e:
            db.session.rollback()
            flash(f'حدث خطأ: {str(e)}', 'danger')
    
    # الحصول على جميع الأقسام
    departments = Department.query.all()
    
    # التاريخ الافتراضي (اليوم)
    today = datetime.now().date()
    hijri_date = format_date_hijri(today)
    gregorian_date = format_date_gregorian(today)
    
    return render_template('attendance/multi_day_department.html', 
                          departments=departments,
                          today=today,
                          hijri_date=hijri_date,
                          gregorian_date=gregorian_date)

@attendance_bp.route('/<int:id>/delete', methods=['POST'])
def delete(id):
    """Delete an attendance record"""
    attendance = Attendance.query.get_or_404(id)
    date = attendance.date
    employee_name = attendance.employee.name
    
    try:
        db.session.delete(attendance)
        
        # Log the action
        audit = SystemAudit(
            action='delete',
            entity_type='attendance',
            entity_id=id,
            entity_name=employee_name,
            details=f'تم حذف سجل حضور للموظف: {employee_name} بتاريخ {date}'
        )
        db.session.add(audit)
        db.session.commit()
        
        flash('تم حذف سجل الحضور بنجاح', 'success')
    except Exception as e:
        db.session.rollback()
        flash(f'حدث خطأ أثناء حذف سجل الحضور: {str(e)}', 'danger')
    
    return redirect(url_for('attendance.index', date=date))

@attendance_bp.route('/stats')
def stats():
    """Get attendance statistics for a date range"""
    # Get date range
    start_date_str = request.args.get('start_date')
    end_date_str = request.args.get('end_date')
    
    try:
        start_date = parse_date(start_date_str) if start_date_str else (datetime.now().date() - timedelta(days=30))
        end_date = parse_date(end_date_str) if end_date_str else datetime.now().date()
    except ValueError:
        start_date = datetime.now().date() - timedelta(days=30)
        end_date = datetime.now().date()
    
    # Calculate statistics
    stats = db.session.query(
        Attendance.status,
        func.count(Attendance.id).label('count')
    ).filter(
        Attendance.date.between(start_date, end_date)
    ).group_by(Attendance.status).all()
    
    # Format for response
    result = {}
    for status, count in stats:
        result[status] = count
    
    return jsonify({
        'start_date': start_date.isoformat() if start_date else None,
        'end_date': end_date.isoformat() if end_date else None,
        'stats': result
    })

@attendance_bp.route('/export_excel')
def export_excel():
    """تصدير بيانات الحضور إلى ملف Excel"""
    try:
        # الحصول على معايير التصفية
        start_date_str = request.args.get('start_date')
        end_date_str = request.args.get('end_date')
        department_id = request.args.get('department_id', '')
        
        # معالجة التواريخ
        try:
            start_date = parse_date(start_date_str) if start_date_str else datetime.now().date()
            end_date = parse_date(end_date_str) if end_date_str else start_date
        except ValueError:
            start_date = datetime.now().date()
            end_date = start_date
        
        # الحصول على جميع الموظفين النشطين
        employees_query = Employee.query.filter_by(status='active')
        
        # تطبيق فلتر القسم إذا تم تحديده
        if department_id and department_id != '':
            employees_query = employees_query.filter(Employee.department_id == department_id)
        
        employees = employees_query.all()
        
        # الحصول على سجلات الحضور للفترة المحددة
        attendance_query = Attendance.query.filter(
            Attendance.date.between(start_date, end_date)
        )
        
        # تطبيق فلتر القسم إذا تم تحديده
        if department_id and department_id != '':
            attendance_query = attendance_query.join(Employee).filter(Employee.department_id == department_id)
        
        attendances = attendance_query.all()
        
        # تصدير البيانات إلى ملف إكسل
        output = export_attendance_by_department(employees, attendances, start_date, end_date)
        
        # تحديد اسم الملف
        if start_date is not None and end_date is not None:
            if start_date == end_date:
                filename = f"سجل_الحضور_{start_date.strftime('%Y-%m-%d')}.xlsx"
            else:
                filename = f"سجل_الحضور_{start_date.strftime('%Y-%m-%d')}_إلى_{end_date.strftime('%Y-%m-%d')}.xlsx"
        else:
            # حالة احتياطية
            today = datetime.now().date()
            filename = f"سجل_الحضور_{today.strftime('%Y-%m-%d')}.xlsx"
        
        # إرسال الملف للتنزيل
        return send_file(
            output,
            as_attachment=True,
            download_name=filename,
            mimetype='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        )
    
    except Exception as e:
        flash(f'حدث خطأ أثناء تصدير البيانات: {str(e)}', 'danger')
        return redirect(url_for('attendance.index'))

# صفحة تصدير بيانات الحضور
@attendance_bp.route('/export')
def export_page():
    """صفحة تصدير بيانات الحضور إلى ملف Excel"""
    # الحصول على جميع الأقسام
    departments = Department.query.order_by(Department.name).all()
    
    # إعداد القيم الافتراضية
    today = datetime.now().date()
    default_start_date = today.strftime('%Y-%m-%d')
    
    return render_template('attendance/export.html', 
                          departments=departments,
                          default_start_date=default_start_date)

@attendance_bp.route('/api/departments/<int:department_id>/employees')
def get_department_employees(department_id):
    """API endpoint to get all employees in a department"""
    try:
        # Get the department
        department = Department.query.get_or_404(department_id)
        
        # Get all active employees in the department
        employees = Employee.query.filter_by(
            department_id=department_id,
            status='active'  # Only return active employees
        ).all()
        
        # Format employee data
        employee_data = []
        for employee in employees:
            employee_data.append({
                'id': employee.id,
                'name': employee.name,
                'employee_id': employee.employee_id,
                'job_title': employee.job_title,
                'status': employee.status
            })
        
        return jsonify(employee_data)
    
    except Exception as e:
        return jsonify({'error': str(e)}), 500
        
@attendance_bp.route('/dashboard')
def dashboard():
    """لوحة معلومات الحضور مع إحصائيات يومية وأسبوعية وشهرية"""
    
    # إضافة آلية إعادة المحاولة للتعامل مع أخطاء الاتصال المؤقتة
    import logging
    import time
    import calendar
    from datetime import date, datetime, timedelta
    
    logger = logging.getLogger(__name__)
    max_retries = 3  # عدد محاولات إعادة الاتصال
    retry_count = 0
    
    while retry_count < max_retries:
        try:
    # 1. الحصول على المشروع المحدد (إذا وجد)
    project_name = request.args.get('project', None)
    
    # 2. الحصول على التاريخ الحالي
    today = datetime.now().date()
    current_month = today.month
    current_year = today.year
    
    # 3. حساب تاريخ بداية ونهاية الأسبوع الحالي بناءً على تاريخ بداية الشهر
    start_of_month = today.replace(day=1)  # أول يوم في الشهر الحالي
    
    # نحسب عدد الأيام منذ بداية الشهر حتى اليوم الحالي
    days_since_month_start = (today - start_of_month).days
    
    # نحسب عدد الأسابيع الكاملة منذ بداية الشهر (كل أسبوع 7 أيام)
    weeks_since_month_start = days_since_month_start // 7
    
    # نحسب بداية الأسبوع الحالي (بناءً على أسابيع من بداية الشهر)
    start_of_week = start_of_month + timedelta(days=weeks_since_month_start * 7)
    
    # نهاية الأسبوع بعد 6 أيام من البداية
    end_of_week = start_of_week + timedelta(days=6)
    
    # إذا كانت نهاية الأسبوع بعد نهاية الشهر، نجعلها آخر يوم في الشهر
    last_day = calendar.monthrange(current_year, current_month)[1]
    end_of_month = today.replace(day=last_day)
    if end_of_week > end_of_month:
        end_of_week = end_of_month
    
    # 4. حساب تاريخ بداية ونهاية الشهر الحالي
    start_of_month = today.replace(day=1)
    last_day = calendar.monthrange(current_year, current_month)[1]
    end_of_month = today.replace(day=last_day)
    
    # 5. إنشاء قاعدة الاستعلام
    query_base = db.session.query(
        Attendance.status,
        func.count(Attendance.id).label('count')
    )
    
    # 6. إحصائيات الحضور حسب المشروع أو عامة
    # تعريف قائمة معرفات الموظفين (سيكون None للكل)
    employee_ids = None
    
    if project_name:
        # استعلام للموظفين في مشروع محدد
        # نحتاج للحصول على قائمة الموظفين المرتبطين بالمشروع
        project_employees = db.session.query(Employee.id).filter(
            Employee.project == project_name,
            Employee.status == 'active'
        ).all()
        
        # تحويل النتائج إلى قائمة بسيطة من المعرفات
        employee_ids = [emp[0] for emp in project_employees]
    
    # تعريف ونهيئة متغيرات إحصائية
    daily_stats = []
    weekly_stats = []
    monthly_stats = []
    
    # إذا كان هناك مشروع محدد ولا يوجد موظفين فيه، نترك الإحصائيات فارغة
    if project_name and not employee_ids:
        # لا يوجد موظفين في هذا المشروع، نترك الإحصائيات فارغة
        pass
    else:
        # بناء استعلامات الإحصائيات إما لجميع الموظفين أو لموظفي مشروع محدد
        if employee_ids:
            # إحصائيات الموظفين في المشروع المحدد
            
            # إحصائيات اليوم
            daily_stats = query_base.filter(
                Attendance.date == today,
                Attendance.employee_id.in_(employee_ids)
            ).group_by(Attendance.status).all()
            
            # إحصائيات الأسبوع
            weekly_stats = query_base.filter(
                Attendance.date >= start_of_week,
                Attendance.date <= end_of_week,
                Attendance.employee_id.in_(employee_ids)
            ).group_by(Attendance.status).all()
            
            # إحصائيات الشهر
            monthly_stats = query_base.filter(
                Attendance.date >= start_of_month,
                Attendance.date <= end_of_month,
                Attendance.employee_id.in_(employee_ids)
            ).group_by(Attendance.status).all()
        else:
            # إحصائيات عامة لجميع الموظفين
            
            # إحصائيات اليوم
            daily_stats = query_base.filter(
                Attendance.date == today
            ).group_by(Attendance.status).all()
            
            # إحصائيات الأسبوع
            weekly_stats = query_base.filter(
                Attendance.date >= start_of_week,
                Attendance.date <= end_of_week
            ).group_by(Attendance.status).all()
            
            # إحصائيات الشهر
            monthly_stats = query_base.filter(
                Attendance.date >= start_of_month,
                Attendance.date <= end_of_month
            ).group_by(Attendance.status).all()
    
    # 7. إحصائيات الحضور اليومي خلال الشهر الحالي لعرضها في المخطط البياني
    daily_attendance_data = []
    
    for day in range(1, last_day + 1):
        current_date = date(current_year, current_month, day)
        
        # تخطي التواريخ المستقبلية
        if current_date > today:
            break
            
        # استخدام employee_ids مباشرة بعد التأكد من أنه تم تعريفه في خطوة سابقة
        if employee_ids:
            present_count = db.session.query(func.count(Attendance.id)).filter(
                Attendance.date == current_date,
                Attendance.status == 'present',
                Attendance.employee_id.in_(employee_ids)
            ).scalar() or 0
            
            absent_count = db.session.query(func.count(Attendance.id)).filter(
                Attendance.date == current_date,
                Attendance.status == 'absent',
                Attendance.employee_id.in_(employee_ids)
            ).scalar() or 0
        else:
            present_count = db.session.query(func.count(Attendance.id)).filter(
                Attendance.date == current_date,
                Attendance.status == 'present'
            ).scalar() or 0
            
            absent_count = db.session.query(func.count(Attendance.id)).filter(
                Attendance.date == current_date,
                Attendance.status == 'absent'
            ).scalar() or 0
            
        daily_attendance_data.append({
            'date': current_date.strftime('%Y-%m-%d'),
            'day': str(day),
            'present': present_count,
            'absent': absent_count
        })
        
    # 8. الحصول على قائمة المشاريع النشطة للفلتر
    active_projects = db.session.query(Employee.project).filter(
        Employee.status == 'active',
        Employee.project.isnot(None)
    ).distinct().all()
    
    active_projects = [project[0] for project in active_projects if project[0]]
    
    # 9. تحويل البيانات إلى قاموس
    def stats_to_dict(stats_data):
        result = {'present': 0, 'absent': 0, 'leave': 0, 'sick': 0}
        for item in stats_data:
            result[item[0]] = item[1]
        return result
    
    daily_stats_dict = stats_to_dict(daily_stats)
    weekly_stats_dict = stats_to_dict(weekly_stats)
    monthly_stats_dict = stats_to_dict(monthly_stats)
    
    # 10. إعداد البيانات للمخططات البيانية
    # 10.أ. مخطط توزيع الحضور اليومي
    daily_chart_data = {
        'labels': ['حاضر', 'غائب', 'إجازة', 'مرضي'],
        'datasets': [{
            'data': [
                daily_stats_dict['present'],
                daily_stats_dict['absent'],
                daily_stats_dict['leave'],
                daily_stats_dict['sick']
            ],
            'backgroundColor': ['#28a745', '#dc3545', '#ffc107', '#17a2b8']
        }]
    }
    
    # 10.ب. مخطط توزيع الحضور الأسبوعي
    weekly_chart_data = {
        'labels': ['حاضر', 'غائب', 'إجازة', 'مرضي'],
        'datasets': [{
            'data': [
                weekly_stats_dict['present'],
                weekly_stats_dict['absent'],
                weekly_stats_dict['leave'],
                weekly_stats_dict['sick']
            ],
            'backgroundColor': ['#28a745', '#dc3545', '#ffc107', '#17a2b8']
        }]
    }
    
    # 10.ج. مخطط توزيع الحضور الشهري
    monthly_chart_data = {
        'labels': ['حاضر', 'غائب', 'إجازة', 'مرضي'],
        'datasets': [{
            'data': [
                monthly_stats_dict['present'],
                monthly_stats_dict['absent'],
                monthly_stats_dict['leave'],
                monthly_stats_dict['sick']
            ],
            'backgroundColor': ['#28a745', '#dc3545', '#ffc107', '#17a2b8']
        }]
    }
    
    # 10.د. مخطط الحضور اليومي خلال الشهر
    daily_trend_chart_data = {
        'labels': [item['day'] for item in daily_attendance_data],
        'datasets': [
            {
                'label': 'الحضور',
                'data': [item['present'] for item in daily_attendance_data],
                'backgroundColor': 'rgba(40, 167, 69, 0.2)',
                'borderColor': 'rgba(40, 167, 69, 1)',
                'borderWidth': 1,
                'tension': 0.4
            },
            {
                'label': 'الغياب',
                'data': [item['absent'] for item in daily_attendance_data],
                'backgroundColor': 'rgba(220, 53, 69, 0.2)',
                'borderColor': 'rgba(220, 53, 69, 1)',
                'borderWidth': 1,
                'tension': 0.4
            }
        ]
    }
    
    # 11. حساب معدل الحضور
    # إجمالي سجلات الحضور اليومية
    total_days = (
        daily_stats_dict['present'] + 
        daily_stats_dict['absent'] + 
        daily_stats_dict['leave'] + 
        daily_stats_dict['sick']
    )
    
    # إجمالي سجلات الحضور المتوقعة لليوم (جميع الموظفين النشطين)
    # حساب إجمالي الموظفين النشطين يتم في سطور لاحقة من الكود
    
    daily_attendance_rate = 0
    if total_days > 0:
        daily_attendance_rate = round((daily_stats_dict['present'] / total_days) * 100)
    
    # حساب إجمالي الموظفين النشطين
    if employee_ids:
        active_employees_count = len(employee_ids)
    else:
        active_employees_count = db.session.query(func.count(Employee.id)).filter(
            Employee.status == 'active'
        ).scalar()
    
    # حساب كامل الأسبوع (7 أيام) × عدد الموظفين النشطين
    # حساب عدد الأيام في الأسبوع (من بداية الأسبوع إلى نهايته)
    days_in_week = (end_of_week - start_of_week).days + 1
    
    # إجمالي سجلات الحضور والغياب في الأسبوع
    total_days_week = (
        weekly_stats_dict['present'] + 
        weekly_stats_dict['absent'] + 
        weekly_stats_dict['leave'] + 
        weekly_stats_dict['sick']
    )
    
    # حساب إجمالي سجلات الحضور المفترضة للأسبوع
    total_expected_records_week = active_employees_count * days_in_week
    
    weekly_attendance_rate = 0
    if total_days_week > 0 and total_expected_records_week > 0:
        # إذا كانت هناك سجلات متوقعة أكثر من المسجلة، نستخدم الإجمالي المتوقع
        if total_expected_records_week > total_days_week:
            weekly_attendance_rate = round((weekly_stats_dict['present'] / total_expected_records_week) * 100)
        else:
            weekly_attendance_rate = round((weekly_stats_dict['present'] / total_days_week) * 100)
    
    # حساب كامل الشهر × عدد الموظفين النشطين
    days_in_month = (end_of_month - start_of_month).days + 1
    
    # عدد الأيام المتوقعة في الشهر (حتى اليوم الحالي فقط، لا نحسب الأيام المستقبلية)
    # إذا كان نهاية الشهر بعد اليوم، نستخدم اليوم الحالي كنهاية
    days_until_today = (min(end_of_month, today) - start_of_month).days + 1
    
    # إجمالي سجلات الحضور في الشهر
    total_days_month = (
        monthly_stats_dict['present'] + 
        monthly_stats_dict['absent'] + 
        monthly_stats_dict['leave'] + 
        monthly_stats_dict['sick']
    )
    
    # إجمالي سجلات الحضور المتوقعة للشهر (حتى اليوم الحالي)
    total_expected_records_month = active_employees_count * days_until_today
    
    monthly_attendance_rate = 0
    if total_days_month > 0 and total_expected_records_month > 0:
        # إذا كانت هناك سجلات متوقعة أكثر من المسجلة، نستخدم الإجمالي المتوقع
        if total_expected_records_month > total_days_month:
            monthly_attendance_rate = round((monthly_stats_dict['present'] / total_expected_records_month) * 100)
        else:
            monthly_attendance_rate = round((monthly_stats_dict['present'] / total_days_month) * 100)
    
            # إعادة الصفحة بالبيانات
            return render_template(
                'attendance/dashboard.html',
                daily_stats=daily_stats_dict,
                weekly_stats=weekly_stats_dict,
                monthly_stats=monthly_stats_dict,
                daily_chart_data=daily_chart_data,
                weekly_chart_data=weekly_chart_data,
                monthly_chart_data=monthly_chart_data,
                daily_trend_chart_data=daily_trend_chart_data,
                daily_attendance_rate=daily_attendance_rate,
                weekly_attendance_rate=weekly_attendance_rate,
                monthly_attendance_rate=monthly_attendance_rate,
                start_of_week=start_of_week,
                end_of_week=end_of_week,
                today=today,
                current_month_name={
                    1: 'يناير', 2: 'فبراير', 3: 'مارس', 4: 'أبريل', 5: 'مايو', 6: 'يونيو',
                    7: 'يوليو', 8: 'أغسطس', 9: 'سبتمبر', 10: 'أكتوبر', 11: 'نوفمبر', 12: 'ديسمبر'
                }[current_month],
                current_year=current_year,
                active_projects=active_projects,
                selected_project=project_name
            )
            
        except Exception as e:
            import logging
            logger = logging.getLogger(__name__)
            logger.error(f"Error in dashboard (attempt {retry_count+1}): {str(e)}")
            
            # إعادة ضبط الجلسة في حالة وجود خطأ في قاعدة البيانات
            db.session.rollback()
            
            # زيادة عداد المحاولات
            retry_count += 1
            
            # انتظار قبل إعادة المحاولة
            import time
            time.sleep(1)  # انتظار ثانية واحدة قبل إعادة المحاولة
    
    # في حالة فشل جميع المحاولات، نعرض صفحة خطأ أو بيانات افتراضية
    # نعرض صفحة بسيطة توضح وجود مشكلة مؤقتة
    return render_template(
        'error.html',
        message="نعتذر، حدثت مشكلة مؤقتة في الوصول إلى قاعدة البيانات. الرجاء المحاولة مرة أخرى لاحقاً.",
        error_code="DB_CONN_ERROR"
    )

@attendance_bp.route('/employee/<int:employee_id>')
def employee_attendance(employee_id):
    """عرض سجلات الحضور التفصيلية للموظف مرتبة حسب الشهر والسنة"""
    
    # الحصول على بيانات الموظف
    employee = Employee.query.get_or_404(employee_id)
    
    # الحصول على سنة وشهر محددين من معاملات الاستعلام (إذا وجدت)
    year = request.args.get('year', datetime.now().year, type=int)
    month = request.args.get('month', datetime.now().month, type=int)
    
    # الحصول على قائمة السنوات والشهور التي يوجد بها سجلات حضور للموظف
    years_months = db.session.query(
        func.extract('year', Attendance.date).label('year'),
        func.extract('month', Attendance.date).label('month')
    ).filter(
        Attendance.employee_id == employee_id
    ).distinct().order_by('year', 'month').all()
    
    # تنظيم السنوات والشهور
    attendance_periods = {}
    for year_month in years_months:
        y = int(year_month.year)
        m = int(year_month.month)
        if y not in attendance_periods:
            attendance_periods[y] = []
        attendance_periods[y].append(m)
    
    # الحصول على سجلات الحضور للشهر والسنة المحددين
    attendances = Attendance.query.filter(
        Attendance.employee_id == employee_id,
        func.extract('year', Attendance.date) == year,
        func.extract('month', Attendance.date) == month
    ).order_by(Attendance.date.desc()).all()
    
    # تنظيم سجلات الحضور حسب اليوم
    attendance_by_day = {}
    for attendance in attendances:
        day = attendance.date.day
        attendance_by_day[day] = attendance
    
    # تحديد أيام الشهر
    from calendar import monthrange
    days_in_month = monthrange(year, month)[1]
    
    # حساب ال weekday لليوم الأول من الشهر
    first_day = datetime(year, month, 1)
    first_day_weekday = first_day.weekday()
    
    return render_template('attendance/employee_attendance.html',
                          employee=employee,
                          attendances=attendances,
                          attendance_by_day=attendance_by_day,
                          attendance_periods=attendance_periods,
                          year=year,
                          month=month,
                          days_in_month=days_in_month,
                          selected_year=year,
                          selected_month=month,
                          first_day_weekday=first_day_weekday)
