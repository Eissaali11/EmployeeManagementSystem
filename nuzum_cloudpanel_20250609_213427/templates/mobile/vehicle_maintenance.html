{% extends 'mobile/layout.html' %}

{% block title %}صيانة السيارات{% endblock %}
{% block header_title %}صيانة السيارات{% endblock %}

{% block content %}
<div class="mobile-section">
  <div class="mobile-section-header">
    <h2 class="mobile-section-title">
      <i class="fas fa-tools"></i>
      صيانة السيارات
    </h2>
    <a href="{{ url_for('mobile.vehicles') }}" class="mobile-btn mobile-btn-secondary">
      <i class="fas fa-arrow-right"></i>
      عودة
    </a>
  </div>
  
  <!-- إحصائيات سريعة -->
  <div class="maintenance-stats-grid">
    <div class="maintenance-stat-card">
      <div class="stat-icon completed">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-number">{{ stats.completed }}</div>
      <div class="stat-label">منجزة</div>
    </div>
    
    <div class="maintenance-stat-card">
      <div class="stat-icon ongoing">
        <i class="fas fa-wrench"></i>
      </div>
      <div class="stat-number">{{ stats.ongoing }}</div>
      <div class="stat-label">قيد التنفيذ</div>
    </div>
    
    <div class="maintenance-stat-card">
      <div class="stat-icon today">
        <i class="fas fa-calendar-day"></i>
      </div>
      <div class="stat-number">{{ stats.today }}</div>
      <div class="stat-label">اليوم</div>
    </div>
    
    <div class="maintenance-stat-card">
      <div class="stat-icon late">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="stat-number">{{ stats.late }}</div>
      <div class="stat-label">متأخرة</div>
    </div>
  </div>

  <!-- قائمة الصيانة -->
  <div class="mobile-card">
    <div class="mobile-card-header">
      <div class="mobile-card-title">
        <i class="fas fa-list"></i>
        سجل الصيانة
      </div>
      <div class="mobile-card-actions">
        <button class="mobile-btn-icon" onclick="toggleFilters()">
          <i class="fas fa-filter"></i>
        </button>
      </div>
    </div>
    
    <!-- فلاتر البحث (مخفية افتراضياً) -->
    <div class="mobile-card-body" id="filtersSection" style="display: none;">
      <form id="filterForm" action="{{ url_for('mobile.vehicle_maintenance') }}" method="GET">
        <div class="mobile-form-group">
          <label class="mobile-form-label">السيارة</label>
          <select class="mobile-form-select" name="vehicle_id">
            <option value="">جميع السيارات</option>
            {% for vehicle in vehicles %}
            <option value="{{ vehicle.id }}" {% if selected_vehicle == vehicle.id %}selected{% endif %}>
              {{ vehicle.make }} {{ vehicle.model }} - {{ vehicle.plate_number }}
            </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">نوع الصيانة</label>
          <select class="mobile-form-select" name="maintenance_type">
            <option value="">جميع الأنواع</option>
            <option value="دورية" {% if selected_type == 'دورية' %}selected{% endif %}>صيانة دورية</option>
            <option value="طارئة" {% if selected_type == 'طارئة' %}selected{% endif %}>صيانة طارئة</option>
            <option value="إصلاح" {% if selected_type == 'إصلاح' %}selected{% endif %}>إصلاح عطل</option>
            <option value="فحص" {% if selected_type == 'فحص' %}selected{% endif %}>فحص</option>
          </select>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">الحالة</label>
          <select class="mobile-form-select" name="status">
            <option value="">جميع الحالات</option>
            <option value="قيد الانتظار" {% if selected_status == 'قيد الانتظار' %}selected{% endif %}>قيد الانتظار</option>
            <option value="قيد التنفيذ" {% if selected_status == 'قيد التنفيذ' %}selected{% endif %}>قيد التنفيذ</option>
            <option value="منجزة" {% if selected_status == 'منجزة' %}selected{% endif %}>منجزة</option>
            <option value="ملغية" {% if selected_status == 'ملغية' %}selected{% endif %}>ملغية</option>
          </select>
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">من تاريخ</label>
          <input type="date" class="mobile-form-input" name="date_from" value="{{ date_from }}">
        </div>
        
        <div class="mobile-form-group">
          <label class="mobile-form-label">إلى تاريخ</label>
          <input type="date" class="mobile-form-input" name="date_to" value="{{ date_to }}">
        </div>
        
        <div class="mobile-form-actions">
          <button type="submit" class="mobile-btn mobile-btn-primary">
            <i class="fas fa-search"></i>
            تطبيق الفلتر
          </button>
          
          <button type="button" class="mobile-btn mobile-btn-secondary" onclick="resetFilters()">
            <i class="fas fa-redo"></i>
            إعادة تعيين
          </button>
        </div>
      </form>
    </div>
    
    <div class="mobile-maintenance-list">
      {% if maintenance_records %}
        {% for record in maintenance_records %}
          {% set vehicle = record.vehicle %}
          
          <!-- تحديد فئة المهمة (استنادًا إلى الحالة والتاريخ) -->
          {% set item_class = "mobile-maintenance-item" %}
          {% if loop.first %}
            {% set item_class = item_class ~ " active" %}
          {% endif %}
          
          <!-- تحديد نوع الحالة للعرض -->
          {% set status_class = "" %}
          {% set status_text = record.status %}
          
          {% if record.status == "قيد التنفيذ" %}
            {% set status_class = "ongoing" %}
          {% elif record.status == "منجزة" %}
            {% set status_class = "completed" %}
          {% elif record.status == "قيد الانتظار" %}
            {% set is_late = record.date < current_date %}
            {% if is_late %}
              {% set status_class = "late" %}
              {% set status_text = "متأخرة" %}
            {% else %}
              {% set status_class = "scheduled" %}
              {% set status_text = "مجدولة" %}
            {% endif %}
          {% elif record.status == "ملغية" %}
            {% set status_class = "canceled" %}
          {% endif %}
          
          <div class="{{ item_class }}">
            <div class="mobile-maintenance-status {{ status_class }}">{{ status_text }}</div>
            <div class="mobile-maintenance-content">
              <div class="mobile-maintenance-title">{{ record.description }}</div>
              <div class="mobile-maintenance-vehicle">{{ vehicle.make }} {{ vehicle.model }} - {{ vehicle.plate_number }}</div>
              <div class="mobile-maintenance-meta">
                <span><i class="fas fa-calendar"></i> {{ record.date.strftime('%d/%m/%Y') }}</span>
                <span><i class="fas fa-user"></i> فني: {{ record.technician }}</span>
                {% if record.cost > 0 %}
                <span><i class="fas fa-money-bill-wave"></i> {{ "{:,.2f}".format(record.cost) }} ريال</span>
                {% endif %}
              </div>
            </div>
            <button class="mobile-btn-icon mobile-maintenance-more" onclick="viewMaintenance({{ record.id }})">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>
        {% endfor %}
      {% else %}
        <div class="mobile-empty-state">
          <div class="mobile-empty-icon">
            <i class="fas fa-tools"></i>
          </div>
          <h3>لا توجد سجلات صيانة</h3>
          <p>لم يتم العثور على سجلات صيانة تطابق معايير البحث.</p>
          <button class="mobile-btn mobile-btn-primary" onclick="resetFilters()">
            <i class="fas fa-redo"></i>
            إعادة تعيين الفلاتر
          </button>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- زر إضافة صيانة جديدة -->
  <button class="mobile-fab" onclick="location.href='{{ url_for('mobile.add_maintenance') }}'">
    <i class="fas fa-plus"></i>
  </button>
</div>
{% endblock %}

{% block styles %}
<style>
  /* إحصائيات الصيانة */
  .maintenance-stats-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
  }
  
  .maintenance-stat-card {
    background-color: white;
    border-radius: 12px;
    padding: 15px;
    text-align: center;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }
  
  .stat-icon {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
    margin-bottom: 5px;
  }
  
  .stat-icon.completed {
    background-color: rgba(25, 135, 84, 0.15);
    color: #198754;
  }
  
  .stat-icon.ongoing {
    background-color: rgba(13, 110, 253, 0.15);
    color: #0d6efd;
  }
  
  .stat-icon.today {
    background-color: rgba(0, 123, 255, 0.15);
    color: #007bff;
  }
  
  .stat-icon.late {
    background-color: rgba(220, 53, 69, 0.15);
    color: #dc3545;
  }
  
  .stat-number {
    font-size: 1.6rem;
    font-weight: 700;
    color: #333;
  }
  
  .stat-label {
    font-size: 0.9rem;
    color: #6c757d;
  }

  /* أنماط قائمة الصيانة */
  .mobile-maintenance-list {
    padding: 0;
  }
  
  .mobile-maintenance-item {
    position: relative;
    padding: 16px;
    border-bottom: 1px solid var(--border-light);
    transition: background-color var(--transition-normal);
  }
  
  .mobile-maintenance-item.active {
    background-color: rgba(var(--primary-rgb), 0.05);
  }
  
  .mobile-maintenance-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: var(--border-radius-sm);
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-medium);
    margin-bottom: 8px;
  }
  
  .mobile-maintenance-status.scheduled {
    background-color: rgba(var(--primary-rgb), 0.1);
    color: var(--primary-color);
  }
  
  .mobile-maintenance-status.ongoing {
    background-color: rgba(var(--info-rgb), 0.1);
    color: var(--info-color);
  }
  
  .mobile-maintenance-status.completed {
    background-color: rgba(var(--success-rgb), 0.1);
    color: var(--success-color);
  }
  
  .mobile-maintenance-status.late {
    background-color: rgba(var(--danger-rgb), 0.1);
    color: var(--danger-color);
  }
  
  .mobile-maintenance-title {
    font-weight: var(--font-weight-medium);
    margin-bottom: 4px;
  }
  
  .mobile-maintenance-vehicle {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: 8px;
  }
  
  .mobile-maintenance-meta {
    display: flex;
    gap: 16px;
    font-size: var(--font-size-xs);
    color: var(--text-muted);
  }
  
  .mobile-maintenance-meta span {
    display: flex;
    align-items: center;
    gap: 4px;
  }
  
  .mobile-maintenance-more {
    position: absolute;
    top: 50%;
    left: 16px;
    transform: translateY(-50%);
  }
  
  .mobile-empty-state {
    text-align: center;
    padding: 48px 16px;
    color: var(--text-muted);
  }
  
  .mobile-empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    color: var(--text-secondary);
    opacity: 0.5;
  }
  
  .mobile-empty-state h3 {
    margin-bottom: 8px;
    color: var(--text-primary);
  }
  
  .mobile-empty-state p {
    margin-bottom: 24px;
  }
  
  .mobile-maintenance-status.canceled {
    background-color: rgba(var(--secondary-rgb), 0.1);
    color: var(--secondary-color);
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  function toggleFilters() {
    const filtersSection = document.getElementById('filtersSection');
    if (filtersSection.style.display === 'none') {
      filtersSection.style.display = 'block';
    } else {
      filtersSection.style.display = 'none';
    }
  }
  
  function resetFilters() {
    // إعادة تعيين جميع قيم الفلاتر
    document.querySelectorAll('#filterForm select').forEach(select => {
      select.value = '';
    });
    
    document.querySelectorAll('#filterForm input[type="date"]').forEach(input => {
      input.value = '';
    });
    
    // إرسال النموذج
    document.getElementById('filterForm').submit();
  }
  
  function viewMaintenance(id) {
    // انتقال إلى صفحة تفاصيل الصيانة
    location.href = '{{ url_for("mobile.vehicle_maintenance") }}/' + id;
  }
  
  // عرض قسم الفلاتر تلقائيًا عند وجود فلاتر مطبقة
  document.addEventListener('DOMContentLoaded', function() {
    {% if selected_vehicle or selected_status or selected_type or date_from or date_to %}
      document.getElementById('filtersSection').style.display = 'block';
    {% endif %}
  });
</script>
{% endblock %}