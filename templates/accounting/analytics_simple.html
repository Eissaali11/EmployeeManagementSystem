{% extends "layout.html" %}

{% block title %}التحليل المالي المبسط{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        التحليل المالي المبسط - البيانات الحقيقية
                    </h4>
                    <small>آخر تحديث: {{ data.last_updated }}</small>
                </div>
                <div class="card-body">
                    
                    {% if error %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        تم عرض البيانات الأساسية بسبب: {{ error }}
                    </div>
                    {% endif %}

                    <!-- الإحصائيات الأساسية -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card bg-gradient-primary text-white">
                                <div class="card-body text-center">
                                    <h5><i class="fas fa-users me-2"></i>الموظفين</h5>
                                    <h2>{{ data.basic_stats.total_employees }}</h2>
                                    <small>إجمالي الموظفين</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-gradient-success text-white">
                                <div class="card-body text-center">
                                    <h5><i class="fas fa-building me-2"></i>الأقسام</h5>
                                    <h2>{{ data.basic_stats.total_departments }}</h2>
                                    <small>عدد الأقسام</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-gradient-info text-white">
                                <div class="card-body text-center">
                                    <h5><i class="fas fa-exchange-alt me-2"></i>المعاملات</h5>
                                    <h2>{{ data.basic_stats.total_transactions }}</h2>
                                    <small>إجمالي المعاملات</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card bg-gradient-warning text-white">
                                <div class="card-body text-center">
                                    <h5><i class="fas fa-list me-2"></i>الحسابات</h5>
                                    <h2>{{ data.basic_stats.total_accounts }}</h2>
                                    <small>دليل الحسابات</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- الملخص المالي -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-dollar-sign me-2"></i>الملخص المالي</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="text-center p-3">
                                                <h5>إجمالي المبالغ</h5>
                                                <h4 class="text-primary">{{ "{:,.0f}".format(data.financial_summary.total_amount) }} ريال</h4>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3">
                                                <h5>مجموع الرواتب</h5>
                                                <h4 class="text-success">{{ "{:,.0f}".format(data.financial_summary.total_salaries) }} ريال</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="text-center p-3">
                                                <h5>مصاريف المركبات</h5>
                                                <h4 class="text-warning">{{ "{:,.0f}".format(data.financial_summary.total_vehicle_expenses) }} ريال</h4>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center p-3">
                                                <h5>معاملات الشهر</h5>
                                                <h4 class="text-info">{{ "{:,.0f}".format(data.financial_summary.monthly_total) }} ريال</h4>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>توزيع الحسابات</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="accountsChart" width="300" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- آخر المعاملات -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>آخر المعاملات</h6>
                                </div>
                                <div class="card-body">
                                    {% if data.recent_activity %}
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>رقم المعاملة</th>
                                                    <th>النوع</th>
                                                    <th>المبلغ</th>
                                                    <th>التاريخ</th>
                                                    <th>الوصف</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for transaction in data.recent_activity %}
                                                <tr>
                                                    <td><strong>#{{ transaction.id }}</strong></td>
                                                    <td>
                                                        <span class="badge bg-secondary">{{ transaction.type }}</span>
                                                    </td>
                                                    <td>{{ "{:,.0f}".format(transaction.amount) }} ريال</td>
                                                    <td>{{ transaction.date }}</td>
                                                    <td>{{ transaction.description[:50] }}...</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <div class="text-center p-4">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <h5>لا توجد معاملات مسجلة</h5>
                                        <p class="text-muted">ابدأ بإضافة المعاملات المحاسبية لعرض التحليل المالي</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- روابط سريعة -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-link me-2"></i>روابط سريعة</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <a href="{{ url_for('accounting.dashboard') }}" class="btn btn-primary w-100 mb-2">
                                                <i class="fas fa-tachometer-alt me-2"></i>لوحة المحاسبة
                                            </a>
                                        </div>
                                        <div class="col-md-3">
                                            <a href="{{ url_for('accounting.accounts') }}" class="btn btn-success w-100 mb-2">
                                                <i class="fas fa-list me-2"></i>دليل الحسابات
                                            </a>
                                        </div>
                                        <div class="col-md-3">
                                            <a href="{{ url_for('accounting.transactions') }}" class="btn btn-info w-100 mb-2">
                                                <i class="fas fa-exchange-alt me-2"></i>المعاملات
                                            </a>
                                        </div>
                                        <div class="col-md-3">
                                            <a href="{{ url_for('accounting_ext.salary_processing') }}" class="btn btn-warning w-100 mb-2">
                                                <i class="fas fa-money-check-alt me-2"></i>معالجة الرواتب
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
                
                <!-- قسم التحليل بالذكاء الاصطناعي -->
                <div class="col-12">
                    <div class="card shadow-lg border-0" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="card-header text-white border-0">
                            <h4 class="card-title mb-0">
                                <i class="fas fa-brain me-2"></i>التحليل المالي بالذكاء الاصطناعي
                            </h4>
                            <p class="card-text mb-0 opacity-75">تحليلات وتنبؤات ذكية مدعومة بـ OpenAI GPT-4o</p>
                        </div>
                        <div class="card-body">
                            <!-- أزرار التحليل -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <button class="btn btn-light btn-lg w-100 mb-3" onclick="loadAIPredictions()" id="predictionsBtn">
                                        <i class="fas fa-chart-line text-primary me-2"></i>
                                        <div>تنبؤات مالية</div>
                                        <small class="text-muted">توقعات الإيرادات والمصروفات</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-light btn-lg w-100 mb-3" onclick="loadPatternAnalysis()" id="patternsBtn">
                                        <i class="fas fa-search text-warning me-2"></i>
                                        <div>تحليل الأنماط</div>
                                        <small class="text-muted">اكتشاف الشذوذ والمخاطر</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button class="btn btn-light btn-lg w-100 mb-3" onclick="loadBudgetRecommendations()" id="budgetBtn">
                                        <i class="fas fa-piggy-bank text-success me-2"></i>
                                        <div>توصيات الميزانية</div>
                                        <small class="text-muted">اقتراحات لتحسين الأداء</small>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- منطقة عرض النتائج -->
                            <div id="aiResults" class="bg-white rounded p-4" style="min-height: 200px; display: none;">
                                <div id="aiContent">
                                    <!-- سيتم تحميل المحتوى هنا -->
                                </div>
                            </div>
                            
                            <!-- حالة التحميل -->
                            <div id="aiLoading" class="text-center text-white" style="display: none;">
                                <div class="spinner-border text-light mb-3" role="status">
                                    <span class="visually-hidden">جاري التحليل...</span>
                                </div>
                                <p class="mb-0">
                                    <i class="fas fa-robot me-2"></i>
                                    الذكاء الاصطناعي يحلل البيانات المالية...
                                </p>
                                <small class="opacity-75">قد يستغرق التحليل بضعة ثوانٍ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
.bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
.bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); }
.bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); }
.bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #d4a72c); }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// رسم توزيع الحسابات
const ctx = document.getElementById('accountsChart').getContext('2d');
new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['حسابات الإيرادات', 'حسابات المصروفات', 'حسابات أخرى'],
        datasets: [{
            data: [
                {{ data.account_breakdown.revenue_accounts }},
                {{ data.account_breakdown.expense_accounts }},
                {{ data.account_breakdown.total_accounts - data.account_breakdown.revenue_accounts - data.account_breakdown.expense_accounts }}
            ],
            backgroundColor: ['#1cc88a', '#e74a3b', '#36b9cc']
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { position: 'bottom' }
        }
    }
});

// وظائف الذكاء الاصطناعي
function showLoading() {
    document.getElementById('aiResults').style.display = 'none';
    document.getElementById('aiLoading').style.display = 'block';
}

function hideLoading() {
    document.getElementById('aiLoading').style.display = 'none';
    document.getElementById('aiResults').style.display = 'block';
}

function showError(message) {
    hideLoading();
    document.getElementById('aiContent').innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>خطأ:</strong> ${message}
        </div>
    `;
}

// تنبؤات مالية
function loadAIPredictions() {
    showLoading();
    
    fetch('/accounting/analytics/api/ai-predictions')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.error) {
                showError(data.error);
                return;
            }
            
            displayPredictions(data);
        })
        .catch(error => {
            console.error('خطأ:', error);
            showError('فشل في الاتصال بالخدمة');
        });
}

// تحليل الأنماط
function loadPatternAnalysis() {
    showLoading();
    
    fetch('/accounting/analytics/api/pattern-analysis')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.error) {
                showError(data.error);
                return;
            }
            
            displayPatternAnalysis(data);
        })
        .catch(error => {
            console.error('خطأ:', error);
            showError('فشل في الاتصال بالخدمة');
        });
}

// توصيات الميزانية
function loadBudgetRecommendations() {
    showLoading();
    
    fetch('/accounting/analytics/api/budget-recommendations')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.error) {
                showError(data.error);
                return;
            }
            
            displayBudgetRecommendations(data);
        })
        .catch(error => {
            console.error('خطأ:', error);
            showError('فشل في الاتصال بالخدمة');
        });
}

// عرض التنبؤات
function displayPredictions(data) {
    const predictions = data.predictions;
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0">
                <i class="fas fa-chart-line text-primary me-2"></i>
                التنبؤات المالية الذكية
            </h5>
            <span class="badge bg-primary">${data.model_used || 'الذكاء الاصطناعي'}</span>
        </div>
    `;
    
    if (predictions) {
        // تحليل الاتجاهات
        if (predictions.تحليل_الاتجاهات) {
            html += `
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">📈 تحليل الاتجاهات المالية</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-success mb-2"><strong>الاتجاه العام:</strong> ${predictions.تحليل_الاتجاهات.الاتجاه_العام}</p>
                        <p class="mb-2"><strong>هيكل المصروفات:</strong></p>
                        <ul class="list-unstyled ms-3">
                            ${predictions.تحليل_الاتجاهات.المصروفات_الرئيسية.map(item => 
                                `<li><span class="badge bg-info me-2">•</span>${item}</li>`
                            ).join('')}
                        </ul>
                        <div class="alert alert-light border-start border-warning border-4">
                            <small><strong>تطور ملحوظ:</strong> ${predictions.تحليل_الاتجاهات.التغيرات_الملحوظة}</small>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // التنبؤات القادمة
        if (predictions.التنبؤات_القادمة) {
            html += `
                <div class="card border-0 shadow-sm mb-3">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">🔮 توقعات الأشهر القادمة</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
            `;
            
            Object.entries(predictions.التنبؤات_القادمة).forEach(([period, forecast]) => {
                html += `
                    <div class="col-md-6 mb-3">
                        <div class="border rounded p-3 bg-light">
                            <h6 class="text-primary">${period.replace('_', ' ')}</h6>
                            <div class="d-flex justify-content-between">
                                <span>المصروفات:</span>
                                <strong class="text-danger">${forecast.المصروفات_المتوقعة}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>الإيرادات:</span>
                                <strong class="text-success">${forecast.الإيرادات_المتوقعة}</strong>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between">
                                <span><strong>الربح المتوقع:</strong></span>
                                <strong class="text-primary">${forecast.الربح_المتوقع}</strong>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                    </div>
                </div>
            `;
        }
        
        // المخاطر والتوصيات
        if (predictions.المخاطر_المحتملة || predictions.التوصيات) {
            html += `
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-warning bg-opacity-10">
                                <h6 class="mb-0 text-warning">⚠️ المخاطر المحتملة</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    ${predictions.المخاطر_المحتملة ? predictions.المخاطر_المحتملة.map(risk => 
                                        `<li class="mb-2"><span class="text-warning">▲</span> ${risk}</li>`
                                    ).join('') : '<li>لا توجد مخاطر محددة</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-success bg-opacity-10">
                                <h6 class="mb-0 text-success">💡 التوصيات</h6>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled">
                                    ${predictions.التوصيات ? predictions.التوصيات.map(rec => 
                                        `<li class="mb-2"><span class="text-success">✓</span> ${rec}</li>`
                                    ).join('') : '<li>لا توجد توصيات حالية</li>'}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }
    
    // إضافة ملاحظة في النهاية
    if (data.note) {
        html += `
            <div class="alert alert-info border-start border-info border-4 mt-3">
                <small><i class="fas fa-info-circle me-1"></i> ${data.note}</small>
            </div>
        `;
    }
    
    document.getElementById('aiContent').innerHTML = html;
}

// عرض تحليل الأنماط
function displayPatternAnalysis(data) {
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0">
                <i class="fas fa-search text-warning me-2"></i>
                تحليل أنماط المعاملات
            </h5>
            <span class="badge bg-warning">تحليل الأنماط</span>
        </div>
    `;
    
    // الأنماط الطبيعية
    if (data.الأنماط_الطبيعية) {
        html += `
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-success bg-opacity-10">
                    <h6 class="mb-0 text-success">✅ الأنماط الطبيعية</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-2"><strong>أيام النشاط العالي:</strong></p>
                            <p class="text-muted ms-3">${data.الأنماط_الطبيعية.أيام_النشاط_العالي.join(', ')}</p>
                            
                            <p class="mb-2"><strong>متوسط المعاملات اليومية:</strong></p>
                            <p class="text-primary ms-3">${data.الأنماط_الطبيعية.متوسط_المعاملات_اليومية}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-2"><strong>أوقات الذروة:</strong></p>
                            <ul class="list-unstyled ms-3">
                                ${data.الأنماط_الطبيعية.أوقات_الذروة.map(time => 
                                    `<li><span class="badge bg-light text-dark me-2">⏰</span>${time}</li>`
                                ).join('')}
                            </ul>
                            
                            <p class="mb-2"><strong>متوسط قيمة المعاملة:</strong></p>
                            <p class="text-success ms-3 fs-5"><strong>${data.الأنماط_الطبيعية.متوسط_قيمة_المعاملة}</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // المعاملات غير الطبيعية
    if (data.المعاملات_غير_الطبيعية) {
        html += `
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-warning bg-opacity-10">
                    <h6 class="mb-0 text-warning">⚠️ المعاملات غير الطبيعية</h6>
                </div>
                <div class="card-body">
        `;
        
        Object.entries(data.المعاملات_غير_الطبيعية).forEach(([key, value]) => {
            const title = key.replace(/_/g, ' ');
            const icon = key.includes('كبيرة') ? '💰' : key.includes('أوقات') ? '🕒' : '🔍';
            html += `
                <div class="alert alert-warning border-start border-warning border-4 mb-2">
                    <strong>${icon} ${title}:</strong><br>
                    <small>${value}</small>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // اتجاهات الإنفاق
    if (data.اتجاهات_الإنفاق) {
        html += `
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-info bg-opacity-10">
                    <h6 class="mb-0 text-info">📊 اتجاهات الإنفاق اليومية</h6>
                </div>
                <div class="card-body">
                    <div class="row">
        `;
        
        Object.entries(data.اتجاهات_الإنفاق).forEach(([day, pattern]) => {
            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-primary">${day}</h6>
                        <p class="text-muted small mb-0">${pattern}</p>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // توصيات الرقابة
    if (data.توصيات_الرقابة) {
        html += `
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-primary bg-opacity-10">
                    <h6 class="mb-0 text-primary">🛡️ توصيات تحسين الرقابة المالية</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        ${data.توصيات_الرقابة.map((recommendation, index) => `
                            <div class="col-md-6 mb-3">
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-primary rounded-pill me-3">${index + 1}</span>
                                    <p class="mb-0">${recommendation}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // ملاحظة
    if (data.note) {
        html += `
            <div class="alert alert-info border-start border-info border-4">
                <small><i class="fas fa-info-circle me-1"></i> ${data.note}</small>
            </div>
        `;
    }
    
    document.getElementById('aiContent').innerHTML = html;
}

// عرض توصيات الميزانية
function displayBudgetRecommendations(data) {
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0">
                <i class="fas fa-piggy-bank text-success me-2"></i>
                توصيات الميزانية الذكية
            </h5>
            <span class="badge bg-success">تحسين الأداء</span>
        </div>
    `;
    
    // تحليل هيكل المصروفات
    if (data.تحليل_هيكل_المصروفات) {
        html += `
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary bg-opacity-10">
                    <h6 class="mb-0 text-primary">📊 تحليل هيكل المصروفات</h6>
                </div>
                <div class="card-body">
                    <div class="row">
        `;
        
        Object.entries(data.تحليل_هيكل_المصروفات).forEach(([category, details]) => {
            const title = category.replace(/_/g, ' ');
            html += `
                <div class="col-md-6 mb-3">
                    <div class="border rounded p-3 h-100">
                        <h6 class="text-dark">${title}</h6>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>النسبة:</span>
                            <span class="badge bg-info">${details.النسبة}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>المبلغ الشهري:</span>
                            <strong class="text-primary">${details.المبلغ_الشهري}</strong>
                        </div>
                        <div class="alert alert-light border-0 mb-0">
                            <small><strong>التقييم:</strong> ${details.التقييم}</small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                    </div>
                </div>
            </div>
        `;
    }
    
    // فرص التوفير
    if (data.فرص_التوفير) {
        html += `
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success bg-opacity-10">
                    <h6 class="mb-0 text-success">💰 فرص التوفير المحددة</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        ${data.فرص_التوفير.map((opportunity, index) => `
                            <div class="col-md-4 mb-3">
                                <div class="card border-success h-100">
                                    <div class="card-body text-center">
                                        <h6 class="card-title text-success">${opportunity.المجال}</h6>
                                        <div class="display-6 text-success mb-2">
                                            ${opportunity.التوفير_المتوقع}
                                        </div>
                                        <p class="card-text small text-muted">${opportunity.الطريقة}</p>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
    }
    
    // اقتراح الميزانية
    if (data.اقتراح_الميزانية) {
        html += `
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-warning bg-opacity-10">
                    <h6 class="mb-0 text-warning">📋 اقتراح الميزانية المحسنة</h6>
                </div>
                <div class="card-body">
        `;
        
        Object.entries(data.اقتراح_الميزانية).forEach(([period, budget]) => {
            html += `
                <h6 class="text-primary mb-3">${period.replace(/_/g, ' ')}</h6>
                <div class="row">
            `;
            
            Object.entries(budget).forEach(([item, amount]) => {
                const isTotal = item === 'الإجمالي';
                const isSaving = item === 'التوفير_الكلي';
                const itemName = item.replace(/_/g, ' ');
                const colorClass = isTotal ? 'text-primary' : isSaving ? 'text-success' : 'text-dark';
                
                html += `
                    <div class="col-md-3 mb-2">
                        <div class="d-flex justify-content-between ${isTotal || isSaving ? 'border-top pt-2' : ''}">
                            <span class="${colorClass}">${itemName}:</span>
                            <strong class="${colorClass}">${amount}</strong>
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // آلية المراقبة والمؤشرات
    html += `
        <div class="row">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-info bg-opacity-10">
                        <h6 class="mb-0 text-info">🔍 آلية المراقبة</h6>
                    </div>
                    <div class="card-body">
    `;
    
    if (data.آلية_المراقبة) {
        Object.entries(data.آلية_المراقبة).forEach(([method, description]) => {
            const methodName = method.replace(/_/g, ' ');
            html += `
                <div class="mb-3">
                    <strong class="text-info">${methodName}:</strong>
                    <br><small class="text-muted">${description}</small>
                </div>
            `;
        });
    }
    
    html += `
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-danger bg-opacity-10">
                        <h6 class="mb-0 text-danger">⚠️ المؤشرات التحذيرية</h6>
                    </div>
                    <div class="card-body">
    `;
    
    if (data.المؤشرات_التحذيرية) {
        data.المؤشرات_التحذيرية.forEach((indicator, index) => {
            html += `
                <div class="alert alert-danger border-start border-danger border-4 mb-2">
                    <small><strong>${index + 1}.</strong> ${indicator}</small>
                </div>
            `;
        });
    }
    
    html += `
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ملاحظة
    if (data.note) {
        html += `
            <div class="alert alert-info border-start border-info border-4 mt-3">
                <small><i class="fas fa-info-circle me-1"></i> ${data.note}</small>
            </div>
        `;
    }
    
    document.getElementById('aiContent').innerHTML = html;
}
</script>
{% endblock %}