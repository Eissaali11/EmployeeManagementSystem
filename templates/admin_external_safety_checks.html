{% extends "layout.html" %}

{% block title %}إدارة طلبات فحص السلامة الخارجية{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-lg" style="background: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%); border: none;">
                <div class="card-header text-white" style="background: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%); border-bottom: 2px solid #fff;">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-shield-alt ml-2"></i>
                        إدارة طلبات فحص السلامة الخارجية
                    </h3>
                </div>
                
                <div class="card-body" style="background: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%);">
                    <!-- الإحصائيات -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); border: none;">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5>قيد المراجعة</h5>
                                            <h2>{{ safety_checks | selectattr('is_pending') | list | length }}</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-clock fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); border: none;">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5>معتمدة</h5>
                                            <h2>{{ safety_checks | selectattr('is_approved') | list | length }}</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-check-circle fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none;">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5>مرفوضة</h5>
                                            <h2>{{ safety_checks | selectattr('is_rejected') | list | length }}</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-times-circle fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="card text-white" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); border: none;">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h5>الإجمالي</h5>
                                            <h2>{{ safety_checks | length }}</h2>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-list fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- الفلاتر -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select class="form-control" id="statusFilter" style="background-color: #2d4a6b; color: white; border: 1px solid #4a6b8a;">
                                <option value="">جميع الحالات</option>
                                <option value="pending">قيد المراجعة</option>
                                <option value="approved">معتمدة</option>
                                <option value="rejected">مرفوضة</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchFilter" placeholder="البحث برقم اللوحة أو اسم السائق..." style="background-color: #2d4a6b; color: white; border: 1px solid #4a6b8a;">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-secondary" onclick="clearFilters()" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border: none;">
                                <i class="fas fa-times"></i> مسح الفلاتر
                            </button>
                        </div>
                    </div>
                    
                    <!-- رسالة تحذيرية للتمرير -->
                    <div class="alert alert-info" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none; border-radius: 10px; margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i>
                        <strong>تلميح:</strong> يمكنك التمرير داخل الجدول لعرض جميع البيانات والأعمدة. استخدم مؤشرات التمرير أسفل وجانب الجدول.
                    </div>
                    
                    <!-- الجدول -->
                    <div class="table-responsive" style="max-height: 70vh; overflow-x: auto; overflow-y: auto; border: 2px solid #4a6b8a; border-radius: 15px; background-color: #2d4a6b; padding: 5px;">
                        <table class="table table-striped table-hover" id="safetyChecksTable" style="background-color: #2d4a6b; color: white; min-width: 1400px; white-space: nowrap;">
                            <thead style="background: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%); color: white;">
                                <tr>
                                    <th style="color: white; border-color: #4a6b8a;">#</th>
                                    <th style="color: white; border-color: #4a6b8a;">رقم اللوحة</th>
                                    <th style="color: white; border-color: #4a6b8a;">نوع السيارة</th>
                                    <th style="color: white; border-color: #4a6b8a;">اسم السائق</th>
                                    <th style="color: white; border-color: #4a6b8a;">القسم</th>
                                    <th style="color: white; border-color: #4a6b8a;">المدينة</th>
                                    <th style="color: white; border-color: #4a6b8a;">تاريخ الفحص</th>
                                    <th style="color: white; border-color: #4a6b8a;">الحالة</th>
                                    <th style="color: white; border-color: #4a6b8a;">الصور</th>
                                    <th style="color: white; border-color: #4a6b8a;">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for safety_check in safety_checks %}
                                <tr data-status="{{ safety_check.approval_status }}" style="background-color: rgba(45, 74, 107, 0.8); color: white; border-color: #4a6b8a;">
                                    <td style="color: white; border-color: #4a6b8a;">{{ safety_check.id }}</td>
                                    <td style="color: white; border-color: #4a6b8a;">{{ safety_check.vehicle_plate_number }}</td>
                                    <td style="color: white; border-color: #4a6b8a;">{{ safety_check.vehicle_make_model }}</td>
                                    <td style="color: white; border-color: #4a6b8a;">{{ safety_check.driver_name }}</td>
                                    <td style="color: white; border-color: #4a6b8a;">{{ safety_check.driver_department }}</td>
                                    <td style="color: white; border-color: #4a6b8a;">{{ safety_check.driver_city }}</td>
                                    <td style="color: white; border-color: #4a6b8a;">{{ safety_check.inspection_date.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td style="color: white; border-color: #4a6b8a;">
                                        {% if safety_check.is_pending %}
                                            <span class="badge" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white;">قيد المراجعة</span>
                                        {% elif safety_check.is_approved %}
                                            <span class="badge" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white;">معتمدة</span>
                                        {% elif safety_check.is_rejected %}
                                            <span class="badge" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white;">مرفوضة</span>
                                        {% endif %}
                                    </td>
                                    <td style="color: white; border-color: #4a6b8a;">
                                        <span class="badge" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white;">{{ safety_check.safety_images | length }}</span>
                                    </td>
                                    <td style="color: white; border-color: #4a6b8a;">
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('external_safety.admin_view_safety_check', check_id=safety_check.id) }}" 
                                               class="btn btn-sm" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: white; border: none;">
                                                <i class="fas fa-eye"></i> عرض
                                            </a>
                                            
                                            {% if safety_check.is_pending %}
                                            <form method="POST" 
                                                  action="{{ url_for('external_safety.approve_safety_check', check_id=safety_check.id) }}" 
                                                  style="display: inline-block;">
                                                <button type="submit" 
                                                        class="btn btn-sm" style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; border: none;"
                                                        onclick="return confirm('هل أنت متأكد من اعتماد هذا الطلب؟')">
                                                    <i class="fas fa-check"></i> اعتماد
                                                </button>
                                            </form>
                                            
                                            <a href="{{ url_for('external_safety.reject_safety_check_page', check_id=safety_check.id) }}" 
                                               class="btn btn-sm" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; border: none;">
                                                <i class="fas fa-times"></i> رفض
                                            </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if not safety_checks %}
                    <div class="text-center py-5">
                        <i class="fas fa-shield-alt fa-3x mb-3" style="color: #ffffff;"></i>
                        <h4 style="color: #ffffff;">لا توجد طلبات فحص سلامة</h4>
                        <p style="color: #ffffff;">لم يتم تقديم أي طلبات فحص سلامة خارجية حتى الآن.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- نافذة منبثقة لرفض الطلب -->
<div class="modal fade" id="rejectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: white;">رفض طلب فحص السلامة</h5>
                <button type="button" class="close" data-dismiss="modal" style="color: white;">
                    <span>&times;</span>
                </button>
            </div>
            <form id="rejectForm" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="rejection_reason" style="color: white;">سبب الرفض:</label>
                        <textarea class="form-control" 
                                  id="rejection_reason" 
                                  name="rejection_reason" 
                                  rows="3" 
                                  required
                                  placeholder="أدخل سبب رفض الطلب..."
                                  style="background-color: #2d4a6b; color: white; border: 1px solid #4a6b8a;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border: none; color: white;">إلغاء</button>
                    <button type="submit" class="btn btn-danger" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border: none; color: white;">رفض الطلب</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // فلترة الجدول
    document.getElementById('statusFilter').addEventListener('change', function() {
        filterTable();
    });
    
    document.getElementById('searchFilter').addEventListener('input', function() {
        filterTable();
    });
    
    function filterTable() {
        const statusFilter = document.getElementById('statusFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
        const rows = document.querySelectorAll('#safetyChecksTable tbody tr');
        
        rows.forEach(row => {
            const status = row.getAttribute('data-status');
            const text = row.textContent.toLowerCase();
            
            let showRow = true;
            
            if (statusFilter && status !== statusFilter) {
                showRow = false;
            }
            
            if (searchFilter && !text.includes(searchFilter)) {
                showRow = false;
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
    
    function clearFilters() {
        document.getElementById('statusFilter').value = '';
        document.getElementById('searchFilter').value = '';
        filterTable();
    }
    
    function showRejectModal(checkId) {
        const form = document.getElementById('rejectForm');
        form.action = `/admin/external-safety-check/${checkId}/reject`;
        $('#rejectModal').modal('show');
    }
</script>

<style>
    /* تحسينات CSS مخصصة للصفحة */
    .container-fluid {
        background: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%);
        min-height: 100vh;
        padding: 20px;
    }
    
    .card {
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    /* تحسينات التمرير */
    .table-responsive {
        max-height: 70vh;
        overflow-x: auto;
        overflow-y: auto;
        border: 2px solid #4a6b8a;
        border-radius: 15px;
        background-color: #2d4a6b;
        padding: 5px;
        scrollbar-width: thick;
        scrollbar-color: #ffffff #4a6b8a;
    }
    
    .table-responsive::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }
    
    .table-responsive::-webkit-scrollbar-track {
        background: #4a6b8a;
        border-radius: 10px;
        border: 1px solid #6b8aa5;
    }
    
    .table-responsive::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #ffffff 0%, #e0e0e0 100%);
        border-radius: 10px;
        border: 1px solid #cccccc;
    }
    
    .table-responsive::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #f0f0f0 0%, #d0d0d0 100%);
    }
    
    .table-responsive::-webkit-scrollbar-corner {
        background: #4a6b8a;
    }
    
    #safetyChecksTable {
        background-color: #2d4a6b;
        color: white;
        min-width: 1200px;
        white-space: nowrap;
        margin-bottom: 0;
    }
    
    #safetyChecksTable thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%) !important;
    }
    
    #safetyChecksTable th {
        color: white !important;
        border-color: #4a6b8a !important;
        padding: 12px 8px;
        font-weight: bold;
        text-align: center;
        min-width: 120px;
    }
    
    #safetyChecksTable td {
        color: white !important;
        border-color: #4a6b8a !important;
        padding: 10px 8px;
        text-align: center;
        vertical-align: middle;
    }
    
    #safetyChecksTable tbody tr {
        background-color: rgba(45, 74, 107, 0.8) !important;
        color: white !important;
        border-color: #4a6b8a !important;
    }
    
    #safetyChecksTable tbody tr:hover {
        background-color: rgba(45, 74, 107, 1) !important;
    }
    
    /* تحسينات الأزرار */
    .btn-group {
        display: flex;
        gap: 5px;
        flex-wrap: nowrap;
    }
    
    .btn-group .btn {
        flex: 1;
        white-space: nowrap;
        padding: 0.375rem 0.75rem;
        border-radius: 5px;
        margin: 0;
        font-size: 0.875rem;
    }
    
    .btn-group .btn i {
        margin-left: 5px;
    }
    
    /* تحسينات الإحصائيات */
    .stat-card {
        background: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%);
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        color: white;
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .stat-card h3 {
        margin: 0;
        font-size: 2rem;
        font-weight: bold;
    }
    
    .stat-card p {
        margin: 5px 0 0 0;
        font-size: 1rem;
    }
    
    /* تحسينات الفلاتر */
    .form-control {
        background-color: #2d4a6b !important;
        color: white !important;
        border: 1px solid #4a6b8a !important;
        border-radius: 5px;
    }
    
    .form-control:focus {
        background-color: #2d4a6b !important;
        color: white !important;
        border-color: #ffffff !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25) !important;
    }
    
    .form-control::placeholder {
        color: #cccccc !important;
    }
    
    /* تحسينات الجدول للشاشات الصغيرة */
    @media (max-width: 768px) {
        .table-responsive {
            max-height: 60vh;
        }
        
        #safetyChecksTable {
            min-width: 800px;
        }
        
        #safetyChecksTable th,
        #safetyChecksTable td {
            padding: 8px 4px;
            font-size: 0.8rem;
        }
        
        .btn-group .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }
    }
    }
    
    .card-header {
        border-radius: 15px 15px 0 0;
        font-size: 1.2rem;
        font-weight: bold;
    }
    
    .table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .table tr:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        transition: background-color 0.3s ease;
    }
    
    .btn {
        border-radius: 25px;
        padding: 0.375rem 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .badge {
        border-radius: 15px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
    }
    
    .form-control {
        border-radius: 10px;
        border: 1px solid #4a6b8a;
    }
    
    .form-control:focus {
        border-color: #ffffff;
        box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
    }
    
    .form-control::placeholder {
        color: #cccccc;
    }
    
    .modal-content {
        background: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%);
        color: white;
        border-radius: 15px;
        border: none;
    }
    
    .modal-header {
        border-bottom: 1px solid #4a6b8a;
    }
    
    .modal-footer {
        border-top: 1px solid #4a6b8a;
    }
    
    /* تحسينات إضافية للتأثيرات */
    .btn-group .btn {
        margin: 0 2px;
    }
    
    .btn-group .btn:first-child {
        margin-left: 0;
    }
    
    .btn-group .btn:last-child {
        margin-right: 0;
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.1) !important;
        cursor: pointer;
    }
    
    .card-body {
        padding: 2rem;
    }
    
    .row {
        margin-bottom: 1rem;
    }
    
    .col-md-3 {
        margin-bottom: 1rem;
    }
    
    /* تحسينات للحقول المنسدلة */
    select.form-control option {
        background-color: #2d4a6b;
        color: white;
    }
    
    .form-control:focus {
        background-color: #2d4a6b;
        color: white;
    }
    
    /* تحسينات لحالة الفراغ */
    .text-center {
        padding: 3rem;
        border-radius: 15px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        margin: 2rem 0;
    }
    
    /* تحسينات لصور الإحصائيات */
    .card-body h5 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .card-body h2 {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0;
    }
    
    /* تحسينات للأيقونات */
    .fas {
        margin-left: 0.5rem;
    }
    
    .align-self-center .fas {
        margin-left: 0;
    }
</style>
{% endblock %}