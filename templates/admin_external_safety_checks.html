{% extends "layout.html" %}

{% block extra_css %}
<style>
    /* Modern Safety Checks Management Styles */
    :root {
        --primary-gradient: linear-gradient(135deg, #1e3a5c 0%, #2d4a6b 100%);
        --pending-gradient: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        --approved-gradient: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        --rejected-gradient: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        --info-gradient: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        --secondary-gradient: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        --glass-bg: rgba(30, 58, 92, 0.95);
        --glass-border: rgba(255, 255, 255, 0.2);
        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
    }

    body {
        background: linear-gradient(135deg, #0f1c2e 0%, #1e3a5c 100%);
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        color: white;
    }

    /* Enhanced Header */
    .page-header-enhanced {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        animation: slideDown 0.6s ease-out;
    }

    .page-header-enhanced::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--info-gradient);
    }

    .page-header-enhanced h3 {
        margin: 0;
        font-weight: 700;
        font-size: 1.75rem;
        display: flex;
        align-items: center;
    }

    /* Enhanced Stats Cards */
    .stat-card-enhanced {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        transition: all 0.3s ease;
        height: 100%;
        position: relative;
        overflow: hidden;
    }

    .stat-card-enhanced:hover {
        transform: translateY(-5px);
        box-shadow: var(--card-shadow-hover);
    }

    .stat-card-enhanced::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }

    .stat-card-pending::before {
        background: var(--pending-gradient);
    }

    .stat-card-approved::before {
        background: var(--approved-gradient);
    }

    .stat-card-rejected::before {
        background: var(--rejected-gradient);
    }

    .stat-card-total::before {
        background: var(--info-gradient);
    }

    .stat-card-enhanced h5 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }

    .stat-card-enhanced h2 {
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 0;
    }

    .stat-icon {
        font-size: 2rem;
        opacity: 0.8;
    }

    /* Enhanced Filter Section */
    .filter-card-enhanced {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        animation: slideUp 0.6s ease-out 0.2s both;
    }

    .filter-input-enhanced {
        background: rgba(45, 74, 107, 0.7) !important;
        border: 1px solid var(--glass-border) !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 0.75rem 1rem !important;
        transition: all 0.3s ease;
    }

    .filter-input-enhanced:focus {
        border-color: white !important;
        box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.15) !important;
    }

    .filter-input-enhanced::placeholder {
        color: rgba(255, 255, 255, 0.6) !important;
    }

    /* Enhanced Table Section */
    .table-container-enhanced {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
        animation: slideUp 0.6s ease-out 0.4s both;
    }

    .table-responsive-enhanced {
        max-height: 70vh;
        overflow: auto;
    }

    .table-enhanced {
        background: transparent;
        color: white;
        margin-bottom: 0;
    }

    .table-enhanced thead {
        background: var(--primary-gradient);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .table-enhanced th {
        padding: 1rem;
        font-weight: 600;
        border-bottom: 1px solid var(--glass-border);
        text-align: center;
        vertical-align: middle;
    }

    .table-enhanced td {
        padding: 0.75rem;
        border-bottom: 1px solid var(--glass-border);
        text-align: center;
        vertical-align: middle;
    }

    .table-enhanced tbody tr {
        transition: all 0.3s ease;
    }

    .table-enhanced tbody tr:hover {
        background: rgba(255, 255, 255, 0.05) !important;
    }

    /* Enhanced Badges */
    .badge-enhanced {
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
        box-shadow: var(--card-shadow);
    }

    .badge-pending {
        background: var(--pending-gradient);
        color: white;
    }

    .badge-approved {
        background: var(--approved-gradient);
        color: white;
    }

    .badge-rejected {
        background: var(--rejected-gradient);
        color: white;
    }

    .badge-info {
        background: var(--info-gradient);
        color: white;
    }

    /* Enhanced Action Buttons */
    .btn-action-enhanced {
        border: none;
        border-radius: 12px;
        padding: 0.5rem 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: var(--card-shadow);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        min-width: 90px;
    }

    .btn-action-enhanced:hover {
        transform: translateY(-2px);
        box-shadow: var(--card-shadow-hover);
    }

    .btn-view {
        background: var(--info-gradient);
        color: white;
    }

    .btn-approve {
        background: var(--approved-gradient);
        color: white;
    }

    .btn-reject {
        background: var(--rejected-gradient);
        color: white;
    }

    /* Enhanced Empty State */
    .empty-state-enhanced {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 3rem;
        text-align: center;
        animation: fadeIn 0.6s ease-out;
    }

    .empty-state-enhanced i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.7;
    }

    .empty-state-enhanced h4 {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    /* Enhanced Modal */
    .modal-enhanced .modal-content {
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        color: white;
    }

    .modal-enhanced .modal-header {
        border-bottom: 1px solid var(--glass-border);
    }

    .modal-enhanced .modal-footer {
        border-top: 1px solid var(--glass-border);
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(30, 58, 92, 0.5);
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        border: 2px solid rgba(30, 58, 92, 0.5);
    }

    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.4);
    }

    /* Animations */
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .page-header-enhanced {
            padding: 1.5rem;
        }
        
        .page-header-enhanced h3 {
            font-size: 1.5rem;
        }
        
        .stat-card-enhanced {
            padding: 1rem;
        }
        
        .stat-card-enhanced h2 {
            font-size: 1.75rem;
        }
        
        .table-enhanced th, 
        .table-enhanced td {
            padding: 0.5rem;
            font-size: 0.85rem;
        }
        
        .btn-action-enhanced {
            min-width: auto;
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Enhanced Header -->
    <div class="page-header-enhanced">
        <div class="d-flex justify-content-between align-items-center flex-wrap">
            <div>
                <h3><i class="fas fa-shield-alt ml-2"></i>إدارة طلبات فحص السلامة الخارجية</h3>
                <p class="text-muted mb-0">إدارة شاملة لطلبات فحص سلامة المركبات الخارجية</p>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-4">
            <div class="stat-card-enhanced stat-card-pending">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>قيد المراجعة</h5>
                        <h2>{{ pending_checks }}</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="stat-card-enhanced stat-card-approved">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>معتمدة</h5>
                        <h2>{{ approved_checks }}</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="stat-card-enhanced stat-card-rejected">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>مرفوضة</h5>
                        <h2>{{ rejected_checks }}</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-times-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 mb-4">
            <div class="stat-card-enhanced stat-card-total">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5>الإجمالي</h5>
                        <h2>{{ total_checks }}</h2>
                    </div>
                    <div class="stat-icon">
                        <i class="fas fa-list"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Filter Section -->
    <div class="filter-card-enhanced">
        <form method="GET" id="filterForm">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <label class="form-label text-light mb-1">الحالة:</label>
                    <select class="form-control filter-input-enhanced" name="status_filter">
                        <option value="">جميع الحالات</option>
                        <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>قيد المراجعة</option>
                        <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>معتمدة</option>
                        <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>مرفوضة</option>
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label text-light mb-1">السيارة:</label>
                    <select class="form-control filter-input-enhanced" name="vehicle_filter">
                        <option value="">جميع السيارات</option>
                        {% for vehicle in vehicles_list %}
                        <option value="{{ vehicle }}" {% if vehicle_filter == vehicle %}selected{% endif %}>{{ vehicle }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label text-light mb-1">القسم:</label>
                    <select class="form-control filter-input-enhanced" name="department_filter">
                        <option value="">جميع الأقسام</option>
                        {% for department in departments_list %}
                        <option value="{{ department }}" {% if department_filter == department %}selected{% endif %}>{{ department }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-action-enhanced" style="background: var(--info-gradient);">
                            <i class="fas fa-search"></i> تطبيق الفلاتر
                        </button>
                        <button type="button" class="btn btn-action-enhanced" style="background: var(--secondary-gradient);" 
                                onclick="clearFilters()">
                            <i class="fas fa-times"></i> مسح
                        </button>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Bulk Actions -->
        <div class="row">
            <div class="col-md-12">
                <button class="btn btn-action-enhanced btn-reject" 
                        id="bulkDeleteBtn" 
                        onclick="bulkDelete()" 
                        style="display: none;">
                    <i class="fas fa-trash-alt"></i> حذف المحدد (<span id="selectedCount">0</span>)
                </button>
            </div>
        </div>
        
        <!-- Enhanced Info Alert -->
        <div class="alert alert-info" style="background: rgba(52, 152, 219, 0.2); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 12px;">
            <i class="fas fa-info-circle"></i>
            <strong>عدد النتائج:</strong> {{ safety_checks|length }} من أصل {{ total_checks }} طلب
            {% if status_filter or vehicle_filter or department_filter %}
            | <strong>مطبق فلاتر:</strong>
            {% if status_filter %}<span class="badge badge-secondary ms-1">الحالة: {{ status_filter }}</span>{% endif %}
            {% if vehicle_filter %}<span class="badge badge-secondary ms-1">السيارة: {{ vehicle_filter }}</span>{% endif %}
            {% if department_filter %}<span class="badge badge-secondary ms-1">القسم: {{ department_filter }}</span>{% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- Enhanced Table Section -->
    <div class="table-container-enhanced">
        <div class="table-responsive-enhanced">
            <table class="table table-enhanced table-hover" id="safetyChecksTable">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="form-check-input">
                        </th>
                        <th>#</th>
                        <th>رقم اللوحة</th>
                        <th>نوع السيارة</th>
                        <th>اسم السائق</th>
                        <th>القسم</th>
                        <th>المدينة</th>
                        <th>تاريخ الفحص</th>
                        <th>الحالة</th>
                        <th>الصور</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for safety_check in safety_checks %}
                    <tr data-status="{{ safety_check.approval_status }}">
                        <td>
                            <input type="checkbox" class="row-checkbox form-check-input" 
                                   value="{{ safety_check.id }}" 
                                   onchange="updateBulkDeleteButton()">
                        </td>
                        <td>{{ safety_check.id }}</td>
                        <td>{{ safety_check.vehicle_plate_number }}</td>
                        <td>{{ safety_check.vehicle_make_model }}</td>
                        <td>{{ safety_check.driver_name }}</td>
                        <td>{{ safety_check.driver_department }}</td>
                        <td>{{ safety_check.driver_city }}</td>
                        <td>{{ safety_check.inspection_date.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>
                            {% if safety_check.is_pending %}
                                <span class="badge-enhanced badge-pending">قيد المراجعة</span>
                            {% elif safety_check.is_approved %}
                                <span class="badge-enhanced badge-approved">معتمدة</span>
                            {% elif safety_check.is_rejected %}
                                <span class="badge-enhanced badge-rejected">مرفوضة</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge-enhanced badge-info">{{ safety_check.safety_images | length }}</span>
                        </td>
                        <td>
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{{ url_for('external_safety.admin_view_safety_check', check_id=safety_check.id) }}" 
                                   class="btn btn-action-enhanced btn-view" title="عرض التفاصيل">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                {% if safety_check.is_pending %}
                                <form method="POST" 
                                      action="{{ url_for('external_safety.approve_safety_check', check_id=safety_check.id) }}" 
                                      class="d-inline">
                                    <button type="submit" 
                                            class="btn btn-action-enhanced btn-approve" 
                                            title="اعتماد الطلب"
                                            onclick="return confirm('هل أنت متأكد من اعتماد هذا الطلب؟')">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                
                                <a href="{{ url_for('external_safety.reject_safety_check_page', check_id=safety_check.id) }}" 
                                   class="btn btn-action-enhanced btn-reject" title="رفض الطلب">
                                    <i class="fas fa-times"></i>
                                </a>
                                {% endif %}
                                
                                <!-- زر الحذف الفردي -->
                                <a href="{{ url_for('external_safety.delete_safety_check', check_id=safety_check.id) }}" 
                                   class="btn btn-action-enhanced" 
                                   style="background: var(--rejected-gradient); color: white;" 
                                   title="حذف الطلب">
                                    <i class="fas fa-trash-alt"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not safety_checks %}
        <div class="empty-state-enhanced">
            <i class="fas fa-shield-alt"></i>
            <h4>لا توجد طلبات فحص سلامة</h4>
            <p class="text-muted">لم يتم تقديم أي طلبات فحص سلامة خارجية حتى الآن.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Enhanced Modal -->
<div class="modal fade modal-enhanced" id="rejectModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">رفض طلب فحص السلامة</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="rejectForm" method="POST">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="rejection_reason">سبب الرفض:</label>
                        <textarea class="form-control filter-input-enhanced" 
                                  id="rejection_reason" 
                                  name="rejection_reason" 
                                  rows="3" 
                                  required
                                  placeholder="أدخل سبب رفض الطلب..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-action-enhanced" 
                            style="background: var(--secondary-gradient);" 
                            data-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-action-enhanced btn-reject">رفض الطلب</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        if (typeof bootstrap !== 'undefined') {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }
        
        // Filter table function with debouncing
        let searchTimeout;
        function filterTable() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const statusFilter = document.getElementById('statusFilter').value;
                const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
                const rows = document.querySelectorAll('#safetyChecksTable tbody tr');
                
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const status = row.getAttribute('data-status');
                    const text = row.textContent.toLowerCase();
                    
                    let showRow = true;
                    
                    if (statusFilter && status !== statusFilter) {
                        showRow = false;
                    }
                    
                    if (searchFilter && !text.includes(searchFilter)) {
                        showRow = false;
                    }
                    
                    if (showRow) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                
                // Show notification if filtered
                if (statusFilter || searchFilter) {
                    showNotification('تم العثور على ' + visibleCount + ' طلب', 'info');
                }
            }, 300);
        }
        
        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', filterTable);
        document.getElementById('searchFilter').addEventListener('input', filterTable);
        
        // تحديث عدد العناصر المحددة لحذف مجمع
        window.updateBulkDeleteButton = function() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][data-check-id]');
            const checked = document.querySelectorAll('input[type="checkbox"][data-check-id]:checked');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectedCount = document.getElementById('selectedCount');
            
            if (checked.length > 0) {
                bulkDeleteBtn.style.display = 'inline-block';
                selectedCount.textContent = checked.length;
            } else {
                bulkDeleteBtn.style.display = 'none';
                selectedCount.textContent = '0';
            }
        };
        
        // Submit filter form - دالة إرسال الفلاتر
        window.submitFilterForm = function() {
            const form = document.getElementById('filterForm');
            if (form) {
                form.submit();
            }
        };
        
        // Clear filters function - دالة مسح الفلاتر
        window.clearFilters = function() {
            // إعادة تعيين جميع الفلاتر
            const statusFilter = document.querySelector('select[name="status_filter"]');
            const vehicleFilter = document.querySelector('select[name="vehicle_filter"]');
            const departmentFilter = document.querySelector('select[name="department_filter"]');
            
            if (statusFilter) statusFilter.value = '';
            if (vehicleFilter) vehicleFilter.value = '';
            if (departmentFilter) departmentFilter.value = '';
            
            // إرسال النموذج فوراً
            document.getElementById('filterForm').submit();
        };
        
        // Enhanced notification system
        function showNotification(message, type) {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification-toast');
            existingNotifications.forEach(notification => notification.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification-toast position-fixed bottom-0 end-0 m-3 alert alert-${type}`;
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            notification.style.backdropFilter = 'blur(10px)';
            notification.style.backgroundColor = 'rgba(30, 58, 92, 0.8)';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }
        
        // Initialize table display
        filterTable();
    });
    
    function showRejectModal(checkId) {
        const form = document.getElementById('rejectForm');
        form.action = `/admin/external-safety-check/${checkId}/reject`;
        $('#rejectModal').modal('show');
    }

    // دوال التحديد الجماعي
    function toggleSelectAll() {
        const selectAll = document.getElementById('selectAll');
        const checkboxes = document.querySelectorAll('.row-checkbox');
        const visibleCheckboxes = Array.from(checkboxes).filter(cb => cb.closest('tr').style.display !== 'none');
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
        
        updateBulkDeleteButton();
    }

    function updateBulkDeleteButton() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
        const selectedCount = document.getElementById('selectedCount');
        
        console.log('تحديث زر الحذف الجماعي:', checkboxes.length, 'عنصر محدد');
        
        if (checkboxes.length > 0) {
            bulkDeleteBtn.style.display = 'inline-block';
            selectedCount.textContent = checkboxes.length;
            console.log('إظهار زر الحذف الجماعي');
        } else {
            bulkDeleteBtn.style.display = 'none';
            console.log('إخفاء زر الحذف الجماعي');
        }
        
        // تحديث حالة "تحديد الكل"
        const allCheckboxes = document.querySelectorAll('.row-checkbox');
        const visibleCheckboxes = Array.from(allCheckboxes).filter(cb => cb.closest('tr').style.display !== 'none');
        const checkedVisibleBoxes = visibleCheckboxes.filter(cb => cb.checked);
        
        const selectAll = document.getElementById('selectAll');
        if (visibleCheckboxes.length === 0) {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        } else if (checkedVisibleBoxes.length === visibleCheckboxes.length) {
            selectAll.checked = true;
            selectAll.indeterminate = false;
        } else if (checkedVisibleBoxes.length > 0) {
            selectAll.checked = false;
            selectAll.indeterminate = true;
        } else {
            selectAll.checked = false;
            selectAll.indeterminate = false;
        }
    }

    function bulkDelete() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        const selectedIds = Array.from(checkboxes).map(cb => cb.value);
        
        if (selectedIds.length === 0) {
            showNotification('لم يتم تحديد أي عناصر للحذف', 'warning');
            return;
        }
        
        const confirmMessage = `هل أنت متأكد من حذف ${selectedIds.length} طلب فحص سلامة؟\n\nهذا الإجراء لا يمكن التراجع عنه وسيتم حذف جميع الصور المرفقة أيضاً.`;
        
        if (confirm(confirmMessage)) {
            // إنشاء نموذج مخفي لإرسال البيانات
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("external_safety.bulk_delete_safety_checks") }}';
            
            // إضافة CSRF token
            const csrfToken = document.createElement('input');
            csrfToken.type = 'hidden';
            csrfToken.name = 'csrf_token';
            csrfToken.value = '{{ csrf_token() }}';
            form.appendChild(csrfToken);
            
            // إضافة المعرفات المحددة
            selectedIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'check_ids';
                input.value = id;
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
        }
    }

    // إضافة مستمع الأحداث لتحديث أزرار التحديد عند تطبيق الفلاتر
    document.addEventListener('DOMContentLoaded', function() {
        // إعادة تعريف clearFilters في النطاق العام
        window.clearFilters = function() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchFilter').value = '';
            filterTable();
            showNotification('تم مسح جميع الفلاتر', 'info');
            updateBulkDeleteButton(); // تحديث أزرار التحديد بعد مسح الفلاتر
        };
        
        // تحديث أزرار التحديد عند تحميل الصفحة
        updateBulkDeleteButton();
    });
</script>
{% endblock %}