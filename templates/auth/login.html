{% extends "layout.html" %}

{% block title %}تسجيل الدخول{% endblock %}

{% block styles %}
<style>
    .login-container {
        max-width: 450px;
        margin: 2rem auto;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        background-color: var(--bs-dark);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .login-title {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .login-btn {
        padding: 0.75rem 1.25rem;
        font-size: 1rem;
        border-radius: 30px;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .login-btn i {
        font-size: 1.25rem;
    }
    
    .login-logo {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .login-logo img {
        max-width: 120px;
        opacity: 0.9;
    }
    
    .system-name {
        font-size: 1.75rem;
        text-align: center;
        margin: 1rem 0 2rem;
        color: var(--bs-info);
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="login-container">
        <div class="login-logo">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="شعار النظام" class="img-fluid">
        </div>
        <h1 class="system-name">نظام إدارة الموظفين</h1>
        <h2 class="login-title text-light mb-4">تسجيل الدخول</h2>
        
        <div class="text-center">
            <button id="googleSignIn" class="btn btn-light login-btn">
                <i class="fas fa-google text-danger"></i>
                تسجيل الدخول باستخدام Google
            </button>
        </div>
        
        <div id="statusMessage" class="mt-3 text-center"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- إضافة مكتبات Firebase -->
<script type="module">
  // استيراد المكتبات المطلوبة من Firebase
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
  import { 
    getAuth, 
    signInWithPopup, 
    GoogleAuthProvider,
    onAuthStateChanged
  } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js';

  // تكوين Firebase
  const firebaseConfig = {
    apiKey: "{{ firebase_api_key }}",
    authDomain: "{{ firebase_project_id }}.firebaseapp.com",
    projectId: "{{ firebase_project_id }}",
    storageBucket: "{{ firebase_project_id }}.appspot.com",
    appId: "{{ firebase_app_id }}"
  };

  // تهيئة Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // عناصر DOM
  const googleSignInBtn = document.getElementById('googleSignIn');
  const statusMessage = document.getElementById('statusMessage');

  // تسجيل الدخول باستخدام Google
  googleSignInBtn.addEventListener('click', async () => {
    try {
      statusMessage.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">جاري تسجيل الدخول...</span></div>';
      googleSignInBtn.disabled = true;
      
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      
      // إرسال بيانات المستخدم إلى الخادم
      await sendUserDataToServer(user);
    } catch (error) {
      console.error("خطأ في تسجيل الدخول:", error);
      statusMessage.innerHTML = `<div class="alert alert-danger">حدث خطأ: ${error.message}</div>`;
      googleSignInBtn.disabled = false;
    }
  });

  // إرسال بيانات المستخدم إلى الخادم
  async function sendUserDataToServer(user) {
    try {
      const response = await fetch('/auth/process', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          uid: user.uid,
          email: user.email,
          name: user.displayName || user.email.split('@')[0],
          picture: user.photoURL || '',
        }),
      });
      
      const data = await response.json();
      
      if (data.status === 'success') {
        statusMessage.innerHTML = '<div class="alert alert-success">تم تسجيل الدخول بنجاح! جاري تحويلك...</div>';
        window.location.href = data.redirect;
      } else {
        statusMessage.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        googleSignInBtn.disabled = false;
      }
    } catch (error) {
      console.error("خطأ في إرسال البيانات:", error);
      statusMessage.innerHTML = '<div class="alert alert-danger">حدث خطأ في الاتصال بالخادم</div>';
      googleSignInBtn.disabled = false;
    }
  }

  // التحقق من حالة المصادقة الحالية
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("المستخدم مسجل الدخول:", user.email);
    }
  });
</script>
{% endblock %}