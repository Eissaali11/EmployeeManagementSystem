{% extends "layout.html" %}

{% block title %}تسجيل الدخول{% endblock %}

{% block styles %}
<style>
    .login-container {
        max-width: 450px;
        margin: 2rem auto;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        background-color: var(--bs-dark);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .login-title {
        text-align: center;
        margin-bottom: 1.5rem;
    }
    
    .login-btn {
        padding: 0.75rem 1.25rem;
        font-size: 1rem;
        border-radius: 30px;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }
    
    .login-btn i {
        font-size: 1.25rem;
    }
    
    .login-logo {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .login-logo img {
        max-width: 120px;
        opacity: 0.9;
    }
    
    .system-name {
        font-size: 1.75rem;
        text-align: center;
        margin: 1rem 0 2rem;
        color: var(--bs-info);
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="login-container">
        <div class="login-logo">
            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="شعار النظام" class="img-fluid">
        </div>
        <h1 class="system-name">نظام إدارة الموظفين</h1>
        <h2 class="login-title text-light mb-4">تسجيل الدخول</h2>
        
        <!-- بداية التبويبات -->
        <ul class="nav nav-tabs mb-4" id="loginTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="email-tab" data-bs-toggle="tab" data-bs-target="#email-login" type="button" role="tab" aria-controls="email-login" aria-selected="true">
                    <i class="fas fa-envelope me-2"></i>البريد الإلكتروني
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="google-tab" data-bs-toggle="tab" data-bs-target="#google-login" type="button" role="tab" aria-controls="google-login" aria-selected="false">
                    <i class="fab fa-google me-2"></i>Google
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="loginTabsContent">
            <!-- تسجيل الدخول بالبريد الإلكتروني -->
            <div class="tab-pane fade show active" id="email-login" role="tabpanel" aria-labelledby="email-tab">
                <form method="POST" action="{{ url_for('auth.login') }}">
                    <div class="mb-3">
                        <label for="email" class="form-label">البريد الإلكتروني</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">كلمة المرور</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="remember" name="remember">
                        <label class="form-check-label" for="remember">تذكرني</label>
                    </div>
                    <button type="submit" class="btn btn-primary login-btn">
                        <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
                    </button>
                </form>
                <div class="mt-3 text-center">
                    <p class="mb-1">ليس لديك حساب؟ <a href="{{ url_for('auth.register') }}" class="text-info">إنشاء حساب جديد</a></p>
                </div>
            </div>
            
            <!-- تسجيل الدخول باستخدام Google -->
            <div class="tab-pane fade" id="google-login" role="tabpanel" aria-labelledby="google-tab">
                <div class="text-center py-3">
                    <p class="mb-3">يمكنك تسجيل الدخول باستخدام حساب Google الخاص بك</p>
                    <button id="googleSignIn" class="btn btn-light login-btn">
                        <i class="fab fa-google text-danger me-2"></i>تسجيل الدخول باستخدام Google
                    </button>
                </div>
            </div>
        </div>
        
        <div id="statusMessage" class="mt-3 text-center"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- إضافة مكتبات Firebase -->
<script type="module">
  // استيراد المكتبات المطلوبة من Firebase
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
  import { 
    getAuth, 
    signInWithPopup, 
    GoogleAuthProvider,
    onAuthStateChanged
  } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js';

  // تكوين Firebase
  const firebaseConfig = {
    apiKey: "{{ firebase_api_key }}",
    authDomain: "{{ firebase_project_id }}.firebaseapp.com",
    projectId: "{{ firebase_project_id }}",
    storageBucket: "{{ firebase_project_id }}.appspot.com",
    appId: "{{ firebase_app_id }}"
  };

  // تهيئة Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // عناصر DOM
  const googleSignInBtn = document.getElementById('googleSignIn');
  const statusMessage = document.getElementById('statusMessage');

  // تسجيل الدخول باستخدام Google
  googleSignInBtn.addEventListener('click', async () => {
    try {
      statusMessage.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">جاري تسجيل الدخول...</span></div>';
      googleSignInBtn.disabled = true;
      
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      
      // إرسال بيانات المستخدم إلى الخادم
      await sendUserDataToServer(user);
    } catch (error) {
      console.error("خطأ في تسجيل الدخول:", error);
      statusMessage.innerHTML = `<div class="alert alert-danger">حدث خطأ: ${error.message}</div>`;
      googleSignInBtn.disabled = false;
    }
  });

  // إرسال بيانات المستخدم إلى الخادم
  async function sendUserDataToServer(user) {
    try {
      const response = await fetch('/auth/process', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          uid: user.uid,
          email: user.email,
          name: user.displayName || user.email.split('@')[0],
          picture: user.photoURL || '',
        }),
      });
      
      const data = await response.json();
      
      if (data.status === 'success') {
        statusMessage.innerHTML = '<div class="alert alert-success">تم تسجيل الدخول بنجاح! جاري تحويلك...</div>';
        window.location.href = data.redirect;
      } else {
        statusMessage.innerHTML = `<div class="alert alert-danger">${data.message}</div>`;
        googleSignInBtn.disabled = false;
      }
    } catch (error) {
      console.error("خطأ في إرسال البيانات:", error);
      statusMessage.innerHTML = '<div class="alert alert-danger">حدث خطأ في الاتصال بالخادم</div>';
      googleSignInBtn.disabled = false;
    }
  }

  // التحقق من حالة المصادقة الحالية
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("المستخدم مسجل الدخول:", user.email);
    }
  });
</script>
{% endblock %}