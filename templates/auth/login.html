{% extends "layout.html" %}

{% block title %}تسجيل الدخول{% endblock %}

{% block styles %}
<style>
    .auth-wrapper {
        min-height: 85vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(33, 37, 41, 0.95) 0%, rgba(33, 37, 41, 0.8) 100%);
        position: relative;
        overflow: hidden;
    }
    
    .auth-wrapper::before {
        content: '';
        position: absolute;
        top: -50px;
        left: -50px;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(13, 110, 253, 0.2);
        filter: blur(50px);
        z-index: 0;
    }
    
    .auth-wrapper::after {
        content: '';
        position: absolute;
        bottom: -50px;
        right: -50px;
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: rgba(20, 184, 166, 0.2);
        filter: blur(50px);
        z-index: 0;
    }
    
    .login-container {
        max-width: 450px;
        width: 100%;
        padding: 2.5rem;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        background: rgba(33, 37, 41, 0.8);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        z-index: 1;
        transform: translateY(0);
        transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        overflow: hidden;
    }
    
    .login-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }
    
    .login-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: linear-gradient(90deg, var(--bs-primary), var(--bs-info));
    }
    
    .login-title {
        text-align: center;
        margin-bottom: 1.5rem;
        font-weight: 700;
        color: white;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .login-btn {
        padding: 0.75rem 1.25rem;
        font-size: 1rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        position: relative;
        border: none;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }
    
    .login-btn.btn-primary {
        background: linear-gradient(135deg, var(--bs-primary), #0056b3);
    }
    
    .login-btn.btn-light {
        background: linear-gradient(135deg, #f8f9fa, #e2e6ea);
    }
    
    .login-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }
    
    .login-btn:active {
        transform: translateY(1px);
    }
    
    .login-btn i {
        font-size: 1.25rem;
        transition: transform 0.3s ease;
    }
    
    .login-btn:hover i {
        transform: scale(1.2);
    }
    
    .login-logo {
        text-align: center;
        margin-bottom: 1.5rem;
        position: relative;
    }
    
    .login-logo img {
        max-width: 100px;
        transition: all 0.5s ease;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    
    .login-logo::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 40px;
        height: 5px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        filter: blur(3px);
    }
    
    .system-name {
        font-size: 1.75rem;
        text-align: center;
        margin: 1rem 0 2rem;
        color: var(--bs-info);
        font-weight: 700;
        position: relative;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .system-name::after {
        content: '';
        position: absolute;
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 3px;
        background: linear-gradient(90deg, transparent, var(--bs-info), transparent);
    }
    
    .form-control {
        background-color: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        background-color: rgba(255, 255, 255, 0.12);
        border-color: var(--bs-info);
        box-shadow: 0 0 0 0.25rem rgba(13, 202, 240, 0.25);
    }
    
    .form-label {
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
        margin-bottom: 0.5rem;
    }
    
    .form-check-label {
        color: rgba(255, 255, 255, 0.7);
    }
    
    .nav-tabs {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 1.5rem;
    }
    
    .nav-tabs .nav-link {
        color: rgba(255, 255, 255, 0.7);
        border: none;
        border-bottom: 3px solid transparent;
        padding: 0.75rem 1.25rem;
        transition: all 0.3s ease;
        border-radius: 0;
    }
    
    .nav-tabs .nav-link:hover {
        color: white;
        border-color: rgba(255, 255, 255, 0.5);
    }
    
    .nav-tabs .nav-link.active {
        color: var(--bs-info);
        background-color: transparent;
        border-color: var(--bs-info);
    }
    
    a {
        color: var(--bs-info);
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    a:hover {
        color: #0dcaf0;
        text-decoration: underline;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
    }
    
    .spinner-border {
        width: 1.5rem;
        height: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-wrapper">
    <div class="container">
        <div class="login-container">
            <div class="login-logo">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="شعار النظام" class="img-fluid">
            </div>
            <h1 class="system-name">نظام إدارة الموظفين</h1>
            <h2 class="login-title mb-4">تسجيل الدخول</h2>
            
            <!-- بداية التبويبات -->
            <ul class="nav nav-tabs mb-4" id="loginTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="email-tab" data-bs-toggle="tab" data-bs-target="#email-login" type="button" role="tab" aria-controls="email-login" aria-selected="true">
                        <i class="fas fa-envelope me-2"></i>البريد الإلكتروني
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="google-tab" data-bs-toggle="tab" data-bs-target="#google-login" type="button" role="tab" aria-controls="google-login" aria-selected="false">
                        <i class="fab fa-google me-2"></i>Google
                    </button>
                </li>
            </ul>
            
            <div class="tab-content" id="loginTabsContent">
                <!-- تسجيل الدخول بالبريد الإلكتروني -->
                <div class="tab-pane fade show active" id="email-login" role="tabpanel" aria-labelledby="email-tab">
                    <div id="email-password-form">
                        <div class="mb-3">
                            <label for="emailInput" class="form-label">البريد الإلكتروني</label>
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-end-0">
                                    <i class="fas fa-envelope text-info"></i>
                                </span>
                                <input type="email" class="form-control border-start-0" id="emailInput" placeholder="أدخل بريدك الإلكتروني" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="passwordInput" class="form-label">كلمة المرور</label>
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-end-0">
                                    <i class="fas fa-lock text-info"></i>
                                </span>
                                <input type="password" class="form-control border-start-0" id="passwordInput" placeholder="أدخل كلمة المرور" required>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">تذكرني</label>
                        </div>
                        <button id="emailSignIn" class="btn btn-primary login-btn">
                            <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
                        </button>
                    </div>
                    <div id="emailLoginStatus" class="mt-3 text-center"></div>
                </div>
                
                <!-- تسجيل الدخول باستخدام Google -->
                <div class="tab-pane fade" id="google-login" role="tabpanel" aria-labelledby="google-tab">
                    <div class="text-center py-4">
                        <div class="mb-4">
                            <i class="fab fa-google text-danger fa-3x mb-3"></i>
                            <p>يمكنك تسجيل الدخول باستخدام حساب Google الخاص بك للوصول السريع والآمن</p>
                        </div>
                        <button id="googleSignIn" class="btn btn-light login-btn">
                            <i class="fab fa-google text-danger me-2"></i>تسجيل الدخول باستخدام Google
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="statusMessage" class="mt-3 text-center"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- إضافة مكتبات Firebase -->
<script type="module">
  // استيراد المكتبات المطلوبة من Firebase
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js';
  import { 
    getAuth, 
    signInWithPopup, 
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    GoogleAuthProvider,
    onAuthStateChanged
  } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js';

  // تكوين Firebase
  const firebaseConfig = {
    apiKey: "{{ firebase_api_key }}",
    authDomain: "{{ firebase_project_id }}.firebaseapp.com",
    projectId: "{{ firebase_project_id }}",
    storageBucket: "{{ firebase_project_id }}.appspot.com",
    appId: "{{ firebase_app_id }}"
  };

  // تهيئة Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const provider = new GoogleAuthProvider();

  // عناصر DOM
  const googleSignInBtn = document.getElementById('googleSignIn');
  const emailSignInBtn = document.getElementById('emailSignIn');
  const emailInput = document.getElementById('emailInput');
  const passwordInput = document.getElementById('passwordInput');
  const rememberMe = document.getElementById('rememberMe');
  const statusMessage = document.getElementById('statusMessage');
  const emailLoginStatus = document.getElementById('emailLoginStatus');

  // تسجيل الدخول باستخدام البريد الإلكتروني وكلمة المرور
  emailSignInBtn.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    
    // التحقق من صحة البيانات
    if (!email || !password) {
      emailLoginStatus.innerHTML = '<div class="alert alert-danger">الرجاء إدخال البريد الإلكتروني وكلمة المرور</div>';
      return;
    }
    
    emailLoginStatus.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">جاري تسجيل الدخول...</span></div>';
    emailSignInBtn.disabled = true;
    
    try {
      // محاولة تسجيل الدخول
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      
      // إرسال بيانات المستخدم إلى الخادم
      await sendUserDataToServer(user);
    } catch (error) {
      console.error("خطأ في تسجيل الدخول:", error);
      
      if (error.code === 'auth/user-not-found') {
        // تم عمل هذا بسبب وجود مستخدمين في قاعدة البيانات ولكن غير موجودين في Firebase
        // قد نحتاج إلى إنشاء حساب جديد في Firebase
        emailLoginStatus.innerHTML = '<div class="alert alert-warning">جاري محاولة مزامنة الحساب مع Firebase...</div>';
        
        try {
          // محاولة إنشاء المستخدم في Firebase
          const userCredential = await createUserWithEmailAndPassword(auth, email, password);
          const user = userCredential.user;
          
          // إرسال بيانات المستخدم إلى الخادم
          await sendUserDataToServer(user);
        } catch (createError) {
          emailLoginStatus.innerHTML = `<div class="alert alert-danger">فشل في تسجيل الدخول: ${createError.message}</div>`;
          emailSignInBtn.disabled = false;
        }
      } else {
        emailLoginStatus.innerHTML = `<div class="alert alert-danger">فشل في تسجيل الدخول: ${error.message}</div>`;
        emailSignInBtn.disabled = false;
      }
    }
  });

  // تسجيل الدخول باستخدام Google
  googleSignInBtn.addEventListener('click', async () => {
    try {
      statusMessage.innerHTML = '<div class="spinner-border text-light" role="status"><span class="visually-hidden">جاري تسجيل الدخول...</span></div>';
      googleSignInBtn.disabled = true;
      
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      
      // إرسال بيانات المستخدم إلى الخادم
      await sendUserDataToServer(user);
    } catch (error) {
      console.error("خطأ في تسجيل الدخول:", error);
      statusMessage.innerHTML = `<div class="alert alert-danger">حدث خطأ: ${error.message}</div>`;
      googleSignInBtn.disabled = false;
    }
  });

  // إرسال بيانات المستخدم إلى الخادم
  async function sendUserDataToServer(user) {
    try {
      const response = await fetch('/auth/process', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          uid: user.uid,
          email: user.email,
          name: user.displayName || user.email.split('@')[0],
          picture: user.photoURL || '',
        }),
      });
      
      const data = await response.json();
      
      if (data.status === 'success') {
        const successMessage = '<div class="alert alert-success">تم تسجيل الدخول بنجاح! جاري تحويلك...</div>';
        statusMessage.innerHTML = successMessage;
        emailLoginStatus.innerHTML = successMessage;
        window.location.href = data.redirect;
      } else {
        const errorMessage = `<div class="alert alert-danger">${data.message}</div>`;
        statusMessage.innerHTML = errorMessage;
        emailLoginStatus.innerHTML = errorMessage;
        googleSignInBtn.disabled = false;
        emailSignInBtn.disabled = false;
      }
    } catch (error) {
      console.error("خطأ في إرسال البيانات:", error);
      const errorMessage = '<div class="alert alert-danger">حدث خطأ في الاتصال بالخادم</div>';
      statusMessage.innerHTML = errorMessage;
      emailLoginStatus.innerHTML = errorMessage;
      googleSignInBtn.disabled = false;
      emailSignInBtn.disabled = false;
    }
  }

  // التحقق من حالة المصادقة الحالية
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("المستخدم مسجل الدخول:", user.email);
    }
  });
  
  // معالجة النموذج عند الضغط على Enter
  passwordInput.addEventListener('keyup', (event) => {
    if (event.key === 'Enter') {
      emailSignInBtn.click();
    }
  });
</script>
{% endblock %}