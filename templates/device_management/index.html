{% extends "layout.html" %}

{% block title %}Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .brand-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .brand-iphone { background-color: #007bff; color: white; }
    .brand-samsung { background-color: #28a745; color: white; }
    .brand-huawei { background-color: #dc3545; color: white; }
    .brand-other { background-color: #6c757d; color: white; }
    
    .status-available { color: #28a745; font-weight: bold; }
    .status-assigned { color: #dc3545; font-weight: bold; }
    
    .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
    
    .search-filters {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .device-info {
        font-size: 0.9em;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-mobile-alt me-2"></i>
                Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©
            </h2>
            
            <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="row mb-4">
                <div class="col-md-2">
                    <div class="stats-card text-center">
                        <h3>{{ stats.total_devices or 0 }}</h3>
                        <p class="mb-0">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</p>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card text-center">
                        <h3>{{ stats.available_devices or 0 }}</h3>
                        <p class="mb-0">Ù…ØªØ§Ø­Ø©</p>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card text-center">
                        <h3>{{ stats.assigned_devices or 0 }}</h3>
                        <p class="mb-0">Ù…Ø±Ø¨ÙˆØ·Ø©</p>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card text-center">
                        <h3>{{ stats.iphone_count or 0 }}</h3>
                        <p class="mb-0">iPhone</p>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="stats-card text-center">
                        <h3>{{ stats.devices_without_phone or 0 }}</h3>
                        <p class="mb-0">Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù…</p>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="text-center">
                        <div class="btn-group-vertical d-grid gap-2">
                            <a href="{{ url_for('device_management.create') }}" class="btn btn-success">
                                <i class="fas fa-plus me-2"></i>
                                Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯
                            </a>
                            <a href="{{ url_for('device_management.devices_only') }}" class="btn btn-warning">
                                <i class="fas fa-mobile-alt me-2"></i>
                                Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù…
                            </a>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('device_management.import_excel') }}" class="btn btn-info btn-sm">
                                    <i class="fas fa-file-import me-1"></i>
                                    Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel
                                </a>
                                <a href="{{ url_for('device_management.export_excel', department=department_filter, brand=brand_filter, status=status_filter, search=search_term) }}" class="btn btn-warning btn-sm">
                                    <i class="fas fa-file-export me-1"></i>
                                    ØªØµØ¯ÙŠØ± Excel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø¨Ø­Ø« -->
            <div class="search-filters">
                <form method="GET" class="row">
                    <div class="col-md-2">
                        <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
                        <select name="department" class="form-select">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option>
                            {% for dept in departments %}
                            <option value="{{ dept.id }}" {{ 'selected' if department_filter == dept.id|string }}>{{ dept.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label">Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</label>
                        <select name="brand" class="form-select">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª</option>
                            <option value="iPhone" {{ 'selected' if brand_filter == 'iPhone' }}>iPhone</option>
                            <option value="Samsung" {{ 'selected' if brand_filter == 'Samsung' }}>Samsung</option>
                            <option value="Huawei" {{ 'selected' if brand_filter == 'Huawei' }}>Huawei</option>
                            <option value="Xiaomi" {{ 'selected' if brand_filter == 'Xiaomi' }}>Xiaomi</option>
                            <option value="OPPO" {{ 'selected' if brand_filter == 'OPPO' }}>OPPO</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Ø§Ù„Ø­Ø§Ù„Ø©</label>
                        <select name="status" class="form-select">
                            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                            <option value="available" {{ 'selected' if status_filter == 'available' }}>Ù…ØªØ§Ø­</option>
                            <option value="assigned" {{ 'selected' if status_filter == 'assigned' }}>Ù…Ø±Ø¨ÙˆØ·</option>
                            <option value="no_phone" {{ 'selected' if status_filter == 'no_phone' }}>Ø¨Ø¯ÙˆÙ† Ø£Ø±Ù‚Ø§Ù…</option>
                            <option value="with_phone" {{ 'selected' if status_filter == 'with_phone' }}>Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù…</option>
                        </select>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="text" name="phone_search" class="form-control" 
                               placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." 
                               value="{{ phone_search or '' }}"
                               style="border: 2px solid #28a745; border-radius: 8px;">
                        <small class="form-text text-success">Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙÙ‚Ø·</small>
                    </div>
                    
                    <div class="col-md-2">
                        <label class="form-label">Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¹Ø§Ù…</label>
                        <input type="text" name="search" class="form-control" 
                               placeholder="IMEI Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„..." 
                               value="{{ search_term }}"
                               style="border: 2px solid #007bff; border-radius: 8px;">
                        <small class="form-text text-muted">IMEI Ø£Ùˆ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</small>
                    </div>
                    
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search"></i> Ø¨Ø­Ø«
                        </button>
                        <a href="{{ url_for('device_management.index') }}" class="btn btn-secondary">
                            <i class="fas fa-times"></i>
                        </a>
                    </div>
                </form>
            </div>
            
            <!-- Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø© ({{ devices|length }} Ø¬Ù‡Ø§Ø²)
                    </h5>
                </div>
                <div class="card-body">
                    {% if devices %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>IMEI</th>
                                    <th>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</th>
                                    <th>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
                                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th>Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø±ØªØ¨Ø·</th>
                                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for device in devices %}
                                <tr>
                                    <td>
                                        <code>{{ device.imei }}</code>
                                        {% if device.serial_number %}
                                        <div class="device-info">S/N: {{ device.serial_number }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set brand_lower = (device.device_brand or '').lower() %}
                                        {% if 'iphone' in brand_lower %}
                                            <span class="brand-badge brand-iphone">{{ device.device_brand }}</span>
                                        {% elif 'samsung' in brand_lower %}
                                            <span class="brand-badge brand-samsung">{{ device.device_brand }}</span>
                                        {% elif 'huawei' in brand_lower %}
                                            <span class="brand-badge brand-huawei">{{ device.device_brand }}</span>
                                        {% else %}
                                            <span class="brand-badge brand-other">{{ device.device_brand }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ device.device_model }}</strong>
                                        {% if device.assigned_date %}
                                        <div class="device-info">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±Ø¨Ø·: {{ device.assigned_date.strftime('%Y-%m-%d') }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.assigned_sim and device.assigned_sim.phone_number %}
                                            <span class="badge bg-info">{{ device.assigned_sim.phone_number }}</span>
                                        {% elif device.phone_number %}
                                            <span class="badge bg-secondary">{{ device.phone_number }}</span>
                                        {% else %}
                                            <span class="text-muted">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.is_assigned %}
                                            <span class="status-assigned">Ù…Ø±Ø¨ÙˆØ·</span>
                                        {% else %}
                                            <span class="status-available">Ù…ØªØ§Ø­</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.assigned_employee %}
                                            <strong>{{ device.assigned_employee.name }}</strong>
                                            <div class="device-info">{{ device.assigned_employee.employee_id }}</div>
                                            {% if device.current_assignment.assignment_date %}
                                            <div class="device-info">Ù…Ù†Ø°: {{ device.current_assignment.assignment_date.strftime('%Y-%m-%d') }}</div>
                                            {% endif %}
                                            {% if device.current_assignment.assignment_type %}
                                            <div class="device-info">
                                                {% if device.current_assignment.assignment_type == 'device_only' %}
                                                    <span class="badge bg-warning">Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·</span>
                                                {% elif device.current_assignment.assignment_type == 'sim_only' %}
                                                    <span class="badge bg-info">Ø±Ù‚Ù… ÙÙ‚Ø·</span>
                                                {% elif device.current_assignment.assignment_type == 'device_and_sim' %}
                                                    <span class="badge bg-success">Ø¬Ù‡Ø§Ø² ÙˆØ±Ù‚Ù…</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('device_management.edit', device_id=device.id) }}" 
                                               class="btn btn-outline-primary btn-sm" title="ØªØ¹Ø¯ÙŠÙ„">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            
                                            {% if device.is_assigned %}
                                                <!-- ÙÙƒ Ø§Ù„Ø±Ø¨Ø· -->
                                                <form method="POST" action="{{ url_for('device_management.unassign_from_employee', device_id=device.id) }}" 
                                                      style="display: inline;" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ÙÙƒ Ø±Ø¨Ø· Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ')">
                                                    <button type="submit" class="btn btn-outline-warning btn-sm" title="ÙÙƒ Ø§Ù„Ø±Ø¨Ø·">
                                                        <i class="fas fa-unlink"></i>
                                                    </button>
                                                </form>
                                            {% else %}
                                                <!-- Ø±Ø¨Ø· Ø¨Ù…ÙˆØ¸Ù -->
                                                <a href="{{ url_for('device_assignment.assign_device', device_id=device.id) }}" 
                                                   class="btn btn-outline-success btn-sm" title="Ø±Ø¨Ø· Ø¨Ù…ÙˆØ¸Ù">
                                                    <i class="fas fa-link"></i>
                                                </a>
                                            {% endif %}
                                            
                                            <form method="POST" action="{{ url_for('device_management.delete', device_id=device.id) }}" 
                                                  style="display: inline;" onsubmit="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŸ')">
                                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Ø­Ø°Ù"
                                                        {% if device.is_assigned %}disabled{% endif %}>
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                
                                {% if not device.is_assigned %}
                                <!-- Modal Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù…ÙˆØ¸Ù -->
                                <div class="modal fade" id="assignModal{{ device.id }}" tabindex="-1">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù…ÙˆØ¸Ù</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <form method="POST" action="{{ url_for('device_management.assign_to_employee', device_id=device.id) }}">
                                                <div class="modal-body">
                                                    <div class="mb-3">
                                                        <label class="form-label">Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
                                                        <input type="text" class="form-control" 
                                                               value="{{ device.device_brand }} {{ device.device_model }} - IMEI: {{ device.imei }}" readonly>
                                                    </div>
                                                    <div class="mb-3">
                                                        <label class="form-label">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ÙˆØ¸Ù</label>
                                                        <select name="employee_id" class="form-select" required>
                                                            <option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option>
                                                            {% for emp in employees %}
                                                            <option value="{{ emp.id }}">{{ emp.name }} ({{ emp.employee_id }})</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                                                    <button type="submit" class="btn btn-success">Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-mobile-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¬Ù‡Ø²Ø© Ù…Ø­Ù…ÙˆÙ„Ø©</h5>
                        <p class="text-muted">Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ø£Ø¬Ù‡Ø²Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù†Ø¸Ø§Ù…</p>
                        <a href="{{ url_for('device_management.create') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>
                            Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø¹Ù†Ø¯ ÙØªØ­ modal Ø§Ù„Ø±Ø¨Ø·
document.addEventListener('DOMContentLoaded', function() {
    const assignModals = document.querySelectorAll('[id^="assignModal"]');
    
    assignModals.forEach(modal => {
        modal.addEventListener('show.bs.modal', function() {
            const select = this.querySelector('select[name="employee_id"]');
            if (select.children.length <= 1) {
                // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
                fetch('/employees/api/list')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            data.employees.forEach(emp => {
                                const option = document.createElement('option');
                                option.value = emp.id;
                                option.textContent = `${emp.name} (${emp.employee_id})`;
                                select.appendChild(option);
                            });
                        }
                    })
                    .catch(error => console.error('Error loading employees:', error));
            }
        });
    });
});
</script>
{% endblock %}