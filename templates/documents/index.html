{% extends 'layout.html' %} {% block extra_css %}

<style>

    /* Modern Documents Management Styles */

    :root {

        --primary-gradient: linear-gradient(135deg, #667eea 0%, #05122d 100%);

        --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);

        --info-gradient: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);

        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);

        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);

        --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);

        --card-shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
            0 10px 10px -5px rgba(0, 0, 0, 0.04);

        --glass-bg: rgba(255, 255, 255, 0.95);

        --glass-border: rgba(255, 255, 255, 0.2);

    }



    /* Enhanced Header */

    .page-header {

        background: var(--glass-bg);

        backdrop-filter: blur(10px);

        border: 1px solid var(--glass-border);

        border-radius: 16px;

        box-shadow: var(--card-shadow);

        padding: 2rem;

        margin-bottom: 2rem;

        position: relative;

        overflow: hidden;

        animation: slideDown 0.6s ease-out;

    }



    .page-header::before {

        content: "";

        position: absolute;

        top: 0;

        left: 0;

        right: 0;

        height: 4px;

        background: var(--primary-gradient);

    }



    .page-header h1 {

        background: var(--primary-gradient);

        -webkit-background-clip: text;

        -webkit-text-fill-color: transparent;

        background-clip: text;

        font-weight: 700;

        margin-bottom: 0.5rem;

        font-size: 2.5rem;

    }



    .page-header .subtitle {

        color: #6c757d;

        font-size: 1rem;

    }



    /* Enhanced Action Buttons */

    .btn-action-group {

        display: flex;

        gap: 0.75rem;

        flex-wrap: wrap;

    }



    .btn-enhanced {

        position: relative;

        overflow: hidden;

        border: none;

        border-radius: 12px;

        padding: 0.75rem 1.5rem;

        font-weight: 600;

        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

        box-shadow: var(--card-shadow);

        text-decoration: none;

        display: inline-flex;

        align-items: center;

        gap: 0.5rem;

        min-width: 140px;

        justify-content: center;

    }



    .btn-enhanced::before {

        content: "";

        position: absolute;

        top: 0;

        left: -100%;

        width: 100%;

        height: 100%;

        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.3),
            transparent
        );

        transition: left 0.5s ease;

    }



    .btn-enhanced:hover::before {

        left: 100%;

    }



    .btn-enhanced:hover {

        transform: translateY(-2px);

        box-shadow: var(--card-shadow-hover);

        text-decoration: none;

    }



    .btn-success-enhanced {

        background: var(--success-gradient);

        color: white;

    }



    .btn-info-enhanced {

        background: var(--info-gradient);

        color: white;

    }



    .btn-primary-enhanced {

        background: var(--primary-gradient);

        color: white;

    }



    .btn-warning-enhanced {

        background: var(--warning-gradient);

        color: white;

    }



    /* Enhanced Stats Cards */

    .stats-card {

        border: none;

        border-radius: 16px;

        box-shadow: var(--card-shadow);

        transition: all 0.3s ease;

        overflow: hidden;

        position: relative;

        animation: slideUp 0.6s ease-out;

    }



    .stats-card:hover {

        transform: translateY(-5px);

        box-shadow: var(--card-shadow-hover);

    }



    .stats-card::before {

        content: "";

        position: absolute;

        top: 0;

        left: 0;

        right: 0;

        height: 4px;

        background: rgba(255, 255, 255, 0.4);

    }



    .stats-card .counter-value {

        font-size: 2.5rem;

        font-weight: 700;

        margin-bottom: 0.5rem;

    }



    .stats-card .card-body {

        padding: 1.5rem;

        text-align: center;

    }



    /* Enhanced Filter Card */

    .filter-card {

        background: var(--glass-bg);

        backdrop-filter: blur(10px);

        border: 1px solid var(--glass-border);

        border-radius: 16px;

        box-shadow: var(--card-shadow);

        margin-bottom: 2rem;

        overflow: hidden;

        animation: slideUp 0.6s ease-out 0.2s both;

    }



    .filter-card .card-header {

        background: linear-gradient(135deg, #3c57d2ff 0%, #05122d 100%);

        color: white;

        padding: 1rem 1.5rem;

        border-bottom: none;

    }



    .filter-card .card-header h5 {

        margin: 0;

        font-weight: 600;

    }



    .filter-card .card-body {

        padding: 1.5rem;

    }



    /* Enhanced Table Card */

    .table-card {

        background: var(--glass-bg);

        backdrop-filter: blur(10px);

        border: 1px solid var(--glass-border);

        border-radius: 16px;

        box-shadow: var(--card-shadow);

        overflow: hidden;

        animation: slideUp 0.6s ease-out 0.3s both;

    }



    .table-card .card-header {

        background: linear-gradient(135deg, #3c57d2ff 0%, #05122d 100%);

        color: white;

        padding: 1rem 1.5rem;

        border-bottom: none;

        display: flex;

        justify-content: space-between;

        align-items: center;

    }



    .table-card .card-header h5 {

        margin: 0;

        font-weight: 600;

    }



    .table-card .card-body {

        padding: 0;

    }



    /* Enhanced Table */

    .enhanced-table {

        width: 100%;

        border-collapse: separate;

        border-spacing: 0;

    }



    .enhanced-table thead th {

        background: rgba(102, 126, 234, 0.1);

        color: #05122d;

        font-weight: 600;

        padding: 1rem;

        border-bottom: 1px solid rgba(0, 0, 0, 0.1);

    }



    .enhanced-table tbody td {

        padding: 1rem;

        border-bottom: 1px solid rgba(0, 0, 0, 0.05);

        vertical-align: middle;

    }



    .enhanced-table tbody tr:last-child td {

        border-bottom: none;

    }



    .enhanced-table tbody tr:hover {

        background: rgba(102, 126, 234, 0.05);

    }



    /* Enhanced Badges */

    .badge-enhanced {

        padding: 0.5rem 0.75rem;

        border-radius: 20px;

        font-weight: 600;

        font-size: 0.75rem;

        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);

        transition: all 0.3s ease;

        display: inline-flex;

        align-items: center;

        gap: 0.25rem;

    }



    .badge-enhanced:hover {

        transform: translateY(-1px);

        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);

    }



    /* Enhanced Action Buttons */

    .action-buttons {

        display: flex;

        gap: 0.5rem;

    }



    .btn-sm-enhanced {

        border-radius: 8px;

        padding: 0.5rem;

        min-width: 36px;

        display: inline-flex;

        align-items: center;

        justify-content: center;

        transition: all 0.3s ease;

        border: none;

    }



    .btn-sm-enhanced:hover {

        transform: translateY(-2px);

        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);

    }



    /* Animations */

    @keyframes slideDown {

        from {

            opacity: 0;

            transform: translateY(-30px);

        }

        to {

            opacity: 1;

            transform: translateY(0);

        }

    }



    @keyframes slideUp {

        from {

            opacity: 0;

            transform: translateY(30px);

        }

        to {

            opacity: 1;

            transform: translateY(0);

        }

    }



    /* Responsive Design */

    @media (max-width: 768px) {

        .page-header {

            padding: 1.5rem;

        }



        .btn-action-group {

            flex-direction: column;

            width: 100%;

        }



        .btn-enhanced {

            width: 100%;

        }



        .stats-card .counter-value {

            font-size: 2rem;

        }



        .enhanced-table thead {

            display: none;

        }



        .enhanced-table tbody tr {

            display: block;

            margin-bottom: 1rem;

            border-radius: 8px;

            box-shadow: var(--card-shadow);

        }



        .enhanced-table tbody td {

            display: flex;

            justify-content: space-between;

            align-items: center;

            padding: 0.75rem 1rem;

            border-bottom: 1px solid rgba(0, 0, 0, 0.05);

        }



        .enhanced-table tbody td::before {

            content: attr(data-label);

            font-weight: 600;

            margin-right: 1rem;

            color: #667eea;

        }

    }

</style>

{% endblock %} {% block content %}

<div class="container-fluid">


    <!-- Enhanced Header -->

    <div class="page-header">

        <div
            class="d-flex justify-content-between align-items-center flex-wrap"
        >

    <!-- فلاتر البحث -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">خيارات البحث</h5>
        </div>
        <div class="card-body">
            <form method="get" action="{{ url_for('documents.index') }}" class="row">
                <div class="col-md-3 mb-3">
                    <label for="document_type" class="form-label">نوع الوثيقة</label>
                    <select class="form-select" id="document_type" name="document_type">
                        <option value="">جميع الأنواع</option>
                        {% for doc_type in document_types %}
                        <option value="{{ doc_type }}" {% if selected_type == doc_type %}selected{% endif %}>
                            {% if doc_type == 'national_id' %}
                            الهوية الوطنية
                            {% elif doc_type == 'passport' %}
                            جواز السفر
                            {% elif doc_type == 'health_certificate' %}
                            الشهادة الصحية
                            {% elif doc_type == 'work_permit' %}
                            تصريح العمل
                            {% elif doc_type == 'education_certificate' %}
                            الشهادة الدراسية
                            {% else %}
                            {{ doc_type }}
                            {% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="employee_id" class="form-label">الموظف</label>
                    <select class="form-select" id="employee_id" name="employee_id">
                        <option value="">جميع الموظفين</option>
                        {% for employee in employees %}
                        <option value="{{ employee.id }}" {% if selected_employee == employee.id|string %}selected{% endif %}>
                            {{ employee.name }} ({{ employee.employee_id }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="department_id" class="form-label">القسم</label>
                    <select class="form-select" id="department_id" name="department_id">
                        <option value="">جميع الأقسام</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}" {% if selected_department == department.id|string %}selected{% endif %}>
                            {{ department.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="sponsorship_status" class="form-label">حالة الكفالة</label>
                    <select class="form-select" id="sponsorship_status" name="sponsorship_status">
                        <option value="">جميع الموظفين</option>
                        <option value="inside" {% if selected_sponsorship == 'inside' %}selected{% endif %}>على الكفالة</option>
                        <option value="outside" {% if selected_sponsorship == 'outside' %}selected{% endif %}>خارج الكفالة</option>
                    </select>
                </div>
                
                <div class="col-md-3 mb-3">
                    <label for="status_filter" class="form-label">حالة الصلاحية</label>
                    <select class="form-select" id="status_filter" name="status_filter">
                        <option value="">جميع الوثائق</option>
                        <option value="expired" {% if request.args.get('status_filter') == 'expired' %}selected{% endif %}>الوثائق المنتهية</option>
                        <option value="expiring_30" {% if request.args.get('status_filter') == 'expiring_30' %}selected{% endif %}>تنتهي خلال 30 يوم</option>
                        <option value="expiring_60" {% if request.args.get('status_filter') == 'expiring_60' %}selected{% endif %}>تنتهي خلال 60 يوم</option>
                        <option value="expiring_90" {% if request.args.get('status_filter') == 'expiring_90' %}selected{% endif %}>تنتهي خلال 90 يوم</option>
                        <option value="valid" {% if request.args.get('status_filter') == 'valid' %}selected{% endif %}>الوثائق السارية</option>
                    </select>
                </div>
                
                <div class="col-12 text-center">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i> بحث
                    </button>
                    <a href="{{ url_for('documents.index') }}" class="btn btn-secondary">
                        <i class="fas fa-undo me-1"></i> إعادة تعيين
                    </a>
                </div>
            </form>
        </div>
    </div>




    <!-- جدول الوثائق -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="card-title mb-0 print-title">قائمة الوثائق</h5>

            <div>

                <button onclick="printPage()" class="btn btn-sm btn-info me-2">
                    <i class="fas fa-print me-1"></i> طباعة
                </button>

                <a href="{{ url_for('documents.export_excel', 
                     document_type=request.args.get('document_type', ''),
                     status_filter=request.args.get('status_filter', ''),
                     show_all=show_all,
                     employee_id=selected_employee,
                     department_id=selected_department,
                     sponsorship_status=selected_sponsorship) }}" 
                   class="btn btn-sm btn-success me-2">
                    <i class="fas fa-file-excel me-1"></i> تصدير إلى Excel
                </a>
                <a href="{{ url_for('documents.index', show_all='true') }}" class="btn btn-sm btn-outline-primary {% if show_all %}active{% endif %}">
                    <i class="fas fa-globe me-1"></i> عرض جميع الوثائق
                </a>
                <a href="{{ url_for('documents.index', show_all='false') }}" class="btn btn-sm btn-outline-warning {% if not show_all %}active{% endif %}">
                    <i class="fas fa-filter me-1"></i> عرض الوثائق المنتهية أو التي ستنتهي قريباً
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if documents %}
            <div class="table-responsive">
                <table class="table table-striped table-hover datatable">
                    <thead>
                        <tr>
                            <th>الموظف</th>
                            <th>الرقم الوظيفي</th>
                            <th>نوع الوثيقة</th>
                            <th>رقم الوثيقة</th>
                            <th>تاريخ الإصدار</th>
                            <th>تاريخ الانتهاء</th>
                            <th>الحالة</th>
                            <th>حالة الكفالة</th>
                            <th>ملاحظات</th>
                            <th class="actions-column">الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for document in documents %}
                        {% set days_to_expiry = (document.expiry_date - now.date()).days if document.expiry_date and now else 0 %}
                        <tr class="document-{{ document.document_type }}">
                            <td>{{ document.employee.name }}</td>
                            <td>{{ document.employee.employee_id }}</td>
                            <td>
                                {% if document.document_type == 'national_id' %}
                                <span class="badge bg-primary">الهوية الوطنية</span>
                                {% elif document.document_type == 'passport' %}
                                <span class="badge bg-success">جواز السفر</span>
                                {% elif document.document_type == 'health_certificate' %}
                                <span class="badge bg-info">الشهادة الصحية</span>
                                {% elif document.document_type == 'work_permit' %}
                                <span class="badge bg-warning">تصريح العمل</span>
                                {% elif document.document_type == 'education_certificate' %}
                                <span class="badge bg-danger">الشهادة الدراسية</span>
                                {% else %}
                                <span class="badge bg-secondary">{{ document.document_type }}</span>
                                {% endif %}
                            </td>
                            <td>{{ document.document_number }}</td>
                            <td>
                                <span class="gregorian-date">{{ document.issue_date|display_date('%d/%m/%Y', 'لم يتم التعديل') }}</span>
                                <span class="hijri-date" style="display: none;"></span>
                            </td>
                            <td>
                                <span class="gregorian-date">{{ document.expiry_date|display_date('%d/%m/%Y', 'لم يتم التعديل') }}</span>
                                <span class="hijri-date" style="display: none;"></span>
                            </td>
                            <td>
                                {% if not document.expiry_date %}
                                <span class="badge bg-secondary">غير محدد</span>
                                {% else %}
                                    {% set days_to_expiry = document.expiry_date|days_remaining %}
                                    {% if days_to_expiry < 0 %}
                                    <span class="badge bg-danger">منتهية منذ {{ -days_to_expiry }} يوم</span>
                                    {% elif days_to_expiry < 30 %}
                                    <span class="badge bg-warning">تنتهي خلال {{ days_to_expiry }} يوم</span>
                                    {% else %}
                                    <span class="badge bg-success">سارية</span>
                                    {% endif %}
                                {% endif %}
                            </td>
                            <td>
                                {% if document.employee.sponsorship_status == 'inside' %}
                                <span class="badge bg-success">على الكفالة</span>
                                {% elif document.employee.sponsorship_status == 'outside' %}
                                <span class="badge bg-warning">خارج الكفالة</span>
                                {% else %}
                                <span class="badge bg-secondary">غير محدد</span>
                                {% endif %}
                            </td>
                            <td>{{ document.notes or '-' }}</td>
                            <td class="actions-column">
                                <!-- زر تحديث تاريخ انتهاء الوثيقة -->
                                <a href="{{ url_for('documents.update_expiry', id=document.id) }}" class="btn btn-sm btn-info mb-1" title="تحديث تاريخ الانتهاء">
                                    <i class="fas fa-calendar-alt"></i>
                                </a>
                                
                                <!-- زر حذف الوثيقة -->
                                <a href="{{ url_for('documents.confirm_delete', id=document.id) }}" class="btn btn-sm btn-danger mb-1">
                                    <i class="fas fa-trash"></i>
                                </a>
                                
                                <!-- زر تعديل بيانات الموظف - يظهر فقط للوثائق من نوع الهوية الوطنية -->
                                {% if document.document_type == 'national_id' %}
                                <a href="{{ url_for('employees.edit', id=document.employee_id) }}" class="btn btn-sm btn-warning" title="تعديل بيانات الموظف">
                                    <i class="fas fa-user-edit"></i> تعديل بيانات الموظف
                                </a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-4">
                <i class="fas fa-file-alt text-muted fs-1 mb-3"></i>
                <p>لا توجد وثائق مسجلة</p>
                <div class="mt-3">
                    <a href="{{ url_for('documents.create') }}" class="btn btn-success mx-2">
                        <i class="fas fa-plus me-1"></i> إضافة وثيقة
                    </a>
                    <a href="{{ url_for('documents.import_excel') }}" class="btn btn-primary mx-2">
                        <i class="fas fa-file-import me-1"></i> استيراد من Excel
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}



                <h1>إدارة الوثائق</h1>

                <p class="subtitle">
                    نظام إدارة الوثائق والملفات الخاصة بالموظفين
                </p>

            </div>

            <div class="btn-action-group">

                <a
                    href="{{ url_for('documents.create') }}"
                    class="btn-enhanced btn-success-enhanced"
                >

                    <i class="fas fa-plus"></i> إضافة وثيقة

                </a>

                <a
                    href="{{ url_for('documents.department_bulk_create') }}"
                    class="btn-enhanced btn-info-enhanced"
                >

                    <i class="fas fa-building"></i> إضافة وثائق قسم كامل

                </a>

                <a
                    href="{{ url_for('documents.import_excel') }}"
                    class="btn-enhanced btn-primary-enhanced"
                >

                    <i class="fas fa-file-import"></i> استيراد من Excel

                </a>

                <a
                    href="{{ url_for('documents.expiring') }}"
                    class="btn-enhanced btn-warning-enhanced"
                >

                    <i class="fas fa-exclamation-triangle"></i> الوثائق المنتهية

                </a>

            </div>

        </div>

    </div>



    <!-- Enhanced Stats Cards -->

    <div class="row mb-4">

        <div class="col-md-3 mb-4">

            <div class="stats-card card bg-primary text-white">

                <div class="card-body">

                    <h3 class="counter-value">{{ total_docs }}</h3>

                    <p class="mb-0">إجمالي الوثائق</p>

                </div>

            </div>

        </div>

        <div class="col-md-3 mb-4">

            <div class="stats-card card bg-danger text-white">

                <div class="card-body">

                    <h3 class="counter-value">{{ expired_docs }}</h3>

                    <p class="mb-0">الوثائق المنتهية</p>

                </div>

            </div>

        </div>

        <div class="col-md-3 mb-4">

            <div class="stats-card card bg-warning text-white">

                <div class="card-body">

                    <h3 class="counter-value">{{ expiring_soon }}</h3>

                    <p class="mb-0">تنتهي خلال 30 يوم</p>

                </div>

            </div>

        </div>

        <div class="col-md-3 mb-4">

            <div class="stats-card card bg-success text-white">

                <div class="card-body">

                    <h3 class="counter-value">{{ safe_docs }}</h3>

                    <p class="mb-0">الوثائق السارية</p>

                </div>

            </div>

        </div>

    </div>



    <!-- Enhanced Filter Card -->

    <div class="filter-card card">

        <div class="card-header">

            <h5 class="card-title mb-0">خيارات البحث المتقدم</h5>

        </div>

        <div class="card-body">

            <form
                method="get"
                action="{{ url_for('documents.index') }}"
                class="row"
            >

                <div class="col-md-3 mb-3">

                    <label for="document_type" class="form-label"
                        >نوع الوثيقة</label
                    >

                    <select
                        class="form-select"
                        id="document_type"
                        name="document_type"
                    >

                        <option value="">جميع الأنواع</option>

                        {% for doc_type in document_types %}

                        <option
                            value="{{ doc_type }}"
                            {%
                            if
                            selected_type=""
                            ="doc_type"
                            %}selected{%
                            endif
                            %}
                        >

                            {% if doc_type == 'national_id' %} الهوية الوطنية {%

                            elif doc_type == 'passport' %} جواز السفر {% elif
                            doc_type == 'health_certificate' %} الشهادة الصحية

                            {% elif doc_type == 'work_permit' %} تصريح العمل {%

                            elif doc_type == 'education_certificate' %} الشهادة

                            الدراسية {% else %} {{ doc_type }} {% endif %}

                        </option>

                        {% endfor %}

                    </select>

                </div>



                <div class="col-md-3 mb-3">

                    <label for="employee_id" class="form-label">الموظف</label>

                    <select
                        class="form-select"
                        id="employee_id"
                        name="employee_id"
                    >

                        <option value="">جميع الموظفين</option>

                        {% for employee in employees %}

                        <option
                            value="{{ employee.id }}"
                            {%
                            if
                            selected_employee=""
                            ="employee.id|string"
                            %}selected{%
                            endif
                            %}
                        >

                            {{ employee.name }} ({{ employee.employee_id }})

                        </option>

                        {% endfor %}

                    </select>

                </div>



                <div class="col-md-3 mb-3">

                    <label for="department_id" class="form-label">القسم</label>

                    <select
                        class="form-select"
                        id="department_id"
                        name="department_id"
                    >

                        <option value="">جميع الأقسام</option>

                        {% for department in departments %}

                        <option
                            value="{{ department.id }}"
                            {%
                            if
                            selected_department=""
                            ="department.id|string"
                            %}selected{%
                            endif
                            %}
                        >

                            {{ department.name }}

                        </option>

                        {% endfor %}

                    </select>

                </div>



                <div class="col-md-3 mb-3">

                    <label for="sponsorship_status" class="form-label"
                        >حالة الكفالة</label
                    >

                    <select
                        class="form-select"
                        id="sponsorship_status"
                        name="sponsorship_status"
                    >

                        <option value="">جميع الموظفين</option>

                        <option
                            value="inside"
                            {%
                            if
                            selected_sponsorship=""
                            ="inside"
                            %}selected{%
                            endif
                            %}
                        >
                            على الكفالة
                        </option>

                        <option
                            value="outside"
                            {%
                            if
                            selected_sponsorship=""
                            ="outside"
                            %}selected{%
                            endif
                            %}
                        >
                            خارج الكفالة
                        </option>

                    </select>

                </div>



                <div class="col-md-3 mb-3">

                    <label for="expiring" class="form-label"
                        >حالة الصلاحية</label
                    >

                    <select class="form-select" id="expiring" name="expiring">

                        <option value="">جميع الوثائق</option>

                        <option
                            value="30"
                            {%
                            if
                            selected_expiring=""
                            ="30"
                            %}selected{%
                            endif
                            %}
                        >
                            تنتهي خلال 30 يوم
                        </option>

                        <option
                            value="60"
                            {%
                            if
                            selected_expiring=""
                            ="60"
                            %}selected{%
                            endif
                            %}
                        >
                            تنتهي خلال 60 يوم
                        </option>

                        <option
                            value="90"
                            {%
                            if
                            selected_expiring=""
                            ="90"
                            %}selected{%
                            endif
                            %}
                        >
                            تنتهي خلال 90 يوم
                        </option>

                    </select>

                </div>



                <div class="col-12 text-center mt-2">

                    <button
                        type="submit"
                        class="btn-enhanced btn-primary-enhanced"
                    >

                        <i class="fas fa-search me-1"></i> بحث

                    </button>

                    <a
                        href="{{ url_for('documents.index') }}"
                        class="btn-enhanced btn-secondary"
                    >

                        <i class="fas fa-undo me-1"></i> إعادة تعيين

                    </a>

                </div>

            </form>

        </div>

    </div>



    <!-- Enhanced Table Card -->

    <div class="table-card card">

        <div class="card-header">

            <h5 class="card-title mb-0">قائمة الوثائق</h5>

            <div class="btn-action-group">

                <a
                    href="{{ url_for('documents.export_excel', 

                     document_type=request.args.get('document_type', ''),

                     days=request.args.get('days', '0'), 



                     show_all=show_all,

                     employee_id=selected_employee,

                     department_id=selected_department,

                     sponsorship_status=selected_sponsorship) }}"
                    class="btn btn-sm btn-success me-2"
                >

                    <i class="fas fa-file-excel me-1"></i> تصدير إلى Excel

                </a>

                <a
                    href="{{ url_for('documents.index', show_all='true') }}"
                    class="btn-enhanced {% if show_all %}active{% endif %}"
                >

                    <i class="fas fa-globe"></i> عرض جميع الوثائق
                </a>
                <a

                    href="{{ url_for('documents.index', show_all='false') }}"
                    class="btn-enhanced btn-warning-enhanced {% if not show_all %}active{% endif %}"
                >

                    <i class="fas fa-filter"></i> عرض الوثائق المنتهية

                </a>

            </div>

        </div>

        <div class="card-body">

            {% if documents %}

            <div class="table-responsive">

                <table class="table enhanced-table">

                    <thead>

                        <tr>

                            <th>الموظف</th>

                            <th>الرقم الوظيفي</th>

                            <th>نوع الوثيقة</th>

                            <th>رقم الوثيقة</th>

                            <th>تاريخ الإصدار</th>

                            <th>تاريخ الانتهاء</th>

                            <th>الحالة</th>

                            <th>حالة الكفالة</th>

                            <th>ملاحظات</th>

                            <th>الإجراءات</th>

                        </tr>

                    </thead>

                    <tbody>

                        {% for document in documents %} {% set days_to_expiry =
                        (document.expiry_date - now.date()).days if
                        document.expiry_date and now else 0 %}

                        <tr class="document-{{ document.document_type }}">

                            <td data-label="الموظف">
                                {{ document.employee.name }}
                            </td>

                            <td data-label="الرقم الوظيفي">
                                {{ document.employee.employee_id }}
                            </td>

                            <td data-label="نوع الوثيقة">

                                {% if document.document_type == 'national_id' %}

                                <span class="badge-enhanced bg-primary"
                                    >الهوية الوطنية</span
                                >

                                {% elif document.document_type == 'passport' %}

                                <span class="badge-enhanced bg-success"
                                    >جواز السفر</span
                                >

                                {% elif document.document_type ==
                                'health_certificate' %}

                                <span class="badge-enhanced bg-info"
                                    >الشهادة الصحية</span
                                >

                                {% elif document.document_type == 'work_permit'
                                %}

                                <span class="badge-enhanced bg-warning"
                                    >تصريح العمل</span
                                >

                                {% elif document.document_type ==
                                'education_certificate' %}

                                <span class="badge-enhanced bg-danger"
                                    >الشهادة الدراسية</span
                                >

                                {% else %}

                                <span class="badge-enhanced bg-secondary"
                                    >{{ document.document_type }}</span
                                >

                                {% endif %}

                            </td>

                            <td data-label="رقم الوثيقة">
                                {{ document.document_number }}
                            </td>

                            <td data-label="تاريخ الإصدار">

                                <span class="gregorian-date"
                                    >{{
                                    document.issue_date|display_date('%d/%m/%Y',
                                    'لم يتم التعديل') }}</span
                                >

                                <span
                                    class="hijri-date"
                                    style="display: none"
                                ></span>

                            </td>

                            <td data-label="تاريخ الانتهاء">

                                <span class="gregorian-date"
                                    >{{
                                    document.expiry_date|display_date('%d/%m/%Y',
                                    'لم يتم التعديل') }}</span
                                >

                                <span
                                    class="hijri-date"
                                    style="display: none"
                                ></span>

                            </td>

                            <td data-label="الحالة">

                                {% if not document.expiry_date %}

                                <span class="badge-enhanced bg-secondary"
                                    >غير محدد</span
                                >

                                {% else %} {% set days_to_expiry =
                                document.expiry_date|days_remaining %} {% if

                                days_to_expiry < 0 %}

                                <span class="badge-enhanced bg-danger"
                                    >منتهية منذ {{ -days_to_expiry }} يوم</span

                                >
                                {% elif days_to_expiry < 30 %}

                                <span class="badge-enhanced bg-warning"
                                    >تنتهي خلال {{ days_to_expiry }} يوم</span

                                >
                                {% else %}

                                <span class="badge-enhanced bg-success"
                                    >سارية</span

                                >

                                {% endif %} {% endif %}

                            </td>

                            <td data-label="حالة الكفالة">

                                {% if document.employee.sponsorship_status ==
                                'inside' %}

                                <span class="badge-enhanced bg-success"
                                    >على الكفالة</span
                                >

                                {% elif document.employee.sponsorship_status ==
                                'outside' %}

                                <span class="badge-enhanced bg-warning"
                                    >خارج الكفالة</span
                                >

                                {% else %}

                                <span class="badge-enhanced bg-secondary"
                                    >غير محدد</span
                                >

                                {% endif %}

                            </td>

                            <td data-label="ملاحظات">
                                {{ document.notes or '-' }}
                            </td>

                            <td data-label="الإجراءات">

                                <div class="action-buttons">

                                    <a
                                        href="{{ url_for('documents.update_expiry', id=document.id) }}"
                                        class="btn btn-sm-enhanced btn-info"
                                        title="تحديث تاريخ الانتهاء"
                                    >

                                        <i class="fas fa-calendar-alt"></i>

                                    </a>


                                    <a

                                        href="{{ url_for('documents.confirm_delete', id=document.id) }}"
                                        class="btn btn-sm-enhanced btn-danger"

                                        title="حذف الوثيقة"

                                    >

                                        <i class="fas fa-trash"></i>

                                    </a>


                                    {% if document.document_type ==
                                    'national_id' %}

                                    <a
                                        href="{{ url_for('employees.edit', id=document.employee_id) }}"
                                        class="btn btn-sm-enhanced btn-warning"

                                        title="تعديل بيانات الموظف"
                                    >

                                        <i class="fas fa-user-edit"></i>

                                    </a>

                                    {% endif %}

                                </div>

                            </td>

                        </tr>

                        {% endfor %}

                    </tbody>

                </table>

            </div>

            {% else %}

            <div class="text-center py-5">

                <div class="empty-state">

                    <i class="fas fa-file-alt text-muted fs-1 mb-3"></i>

                    <h5 class="mb-2">لا توجد وثائق مسجلة</h5>

                    <p class="text-muted mb-4">
                        يمكنك البدء بإضافة وثيقة جديدة أو استيراد وثائق من ملف
                        Excel
                    </p>

                    <div class="btn-action-group justify-content-center">

                        <a
                            href="{{ url_for('documents.create') }}"
                            class="btn-enhanced btn-success-enhanced"
                        >

                            <i class="fas fa-plus"></i> إضافة وثيقة

                        </a>

                        <a
                            href="{{ url_for('documents.import_excel') }}"
                            class="btn-enhanced btn-primary-enhanced"
                        >

                            <i class="fas fa-file-import"></i> استيراد من Excel

                        </a>

                    </div>

                </div>

            </div>

            {% endif %}

        </div>

    </div>

</div>

{% endblock %} {% block extra_js %}


{% block extra_css %}
<style>
/* أنماط الطباعة المحسنة */
@media print {
    /* إعدادات الصفحة */
    @page {
        margin: 1.5cm;
        size: A4 landscape;
    }
    
    /* إعادة تعيين كامل للصفحة */
    * {
        -webkit-print-color-adjust: exact !important;
        color-adjust: exact !important;
    }
    
    /* إخفاء العناصر غير المرغوب فيها */
    .navbar, .sidebar, .btn, .pagination, .no-print,
    .card-header .btn, .actions-column, .breadcrumb,
    .form-control, .form-select, form, .card:first-child {
        display: none !important;
    }
    
    /* تحسين تخطيط الصفحة */
    body {
        font-family: 'Arial', sans-serif !important;
        font-size: 14px !important;
        line-height: 1.4 !important;
        color: #000 !important;
        background: white !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .container {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .card {
        border: none !important;
        box-shadow: none !important;
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
    }
    
    .card-header {
        background: white !important;
        border: none !important;
        text-align: center !important;
        margin-bottom: 15px !important;
    }
    
    .card-header h5 {
        font-size: 22px !important;
        font-weight: bold !important;
        color: #000 !important;
        margin: 0 !important;
        padding: 15px 0 !important;
        border-bottom: 3px solid #000 !important;
    }
    
    .card-body {
        padding: 0 !important;
    }
    
    /* تحسين الجدول للطباعة */
    .table-responsive {
        overflow: visible !important;
    }
    
    .table {
        font-size: 12px !important;
        border-collapse: collapse !important;
        width: 100% !important;
        margin: 0 !important;
        background: white !important;
    }
    
    .table th {
        background-color: #e9ecef !important;
        font-weight: bold !important;
        font-size: 13px !important;
        border: 2px solid #000 !important;
        padding: 8px 6px !important;
        text-align: center !important;
        color: #000 !important;
        white-space: nowrap !important;
    }
    
    .table td {
        border: 1px solid #333 !important;
        padding: 6px 4px !important;
        text-align: center !important;
        color: #000 !important;
        vertical-align: middle !important;
        word-wrap: break-word !important;
        max-width: 120px !important;
    }
    
    /* إخفاء عمود الإجراءات */
    .actions-column {
        display: none !important;
    }
    
    /* تحسين العرض للـ badges */
    .badge {
        border: 1px solid #333 !important;
        padding: 3px 6px !important;
        background: white !important;
        color: #000 !important;
        font-size: 10px !important;
        font-weight: bold !important;
        border-radius: 0 !important;
    }
    
    .badge.bg-success {
        background: #d4edda !important;
        border-color: #28a745 !important;
        color: #155724 !important;
    }
    
    .badge.bg-warning {
        background: #fff3cd !important;
        border-color: #ffc107 !important;
        color: #856404 !important;
    }
    
    .badge.bg-danger {
        background: #f8d7da !important;
        border-color: #dc3545 !important;
        color: #721c24 !important;
    }
    
    .badge.bg-secondary {
        background: #e2e3e5 !important;
        border-color: #6c757d !important;
        color: #383d41 !important;
    }
    
    /* تجنب كسر الصفحة في منتصف الصف */
    .table tr {
        page-break-inside: avoid !important;
    }
    
    .table thead {
        display: table-header-group !important;
    }
    
    .table tbody tr:nth-child(even) {
        background-color: #f8f9fa !important;
    }
    
    /* رأس الصفحة */
    .print-header {
        text-align: center;
        margin-bottom: 25px;
        border-bottom: 3px solid #000;
        padding-bottom: 15px;
    }
    
    /* إضافة معلومات الطباعة */
    .container::before {
        content: "شركة نُظم - تقرير الوثائق";
        display: block;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 10px;
        color: #000;
    }
    
    .container::after {
        content: "تاريخ الطباعة: " attr(data-print-date) " | وقت الطباعة: " attr(data-print-time);
        display: block;
        text-align: center;
        font-size: 12px;
        margin-top: 15px;
        padding-top: 10px;
        border-top: 2px solid #000;
        color: #000;
    }
    
    /* تحسين عرض النصوص الطويلة */
    .table td:nth-child(1), /* اسم الموظف */
    .table td:nth-child(9) { /* الملاحظات */
        max-width: 150px !important;
        word-wrap: break-word !important;
        white-space: normal !important;
    }
    
    .table td:nth-child(3) { /* القسم */
        max-width: 100px !important;
    }
    
    .table td:nth-child(4) { /* نوع الوثيقة */
        max-width: 90px !important;
    }
}

/* أنماط الشاشة العادية */
@media screen {
    .print-only {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}

<script>

    document.addEventListener("DOMContentLoaded", function () {

        // Enhanced filter field behavior

        const filterFields = [
            "document_type",
            "employee_id",
            "department_id",
            "sponsorship_status",
            "expiring",

        ];


        filterFields.forEach(function (field) {

            const element = document.getElementById(field);

            if (element) {

                element.addEventListener("change", function () {

                    // Show loading state

                    const form = this.closest("form");

                    if (form) {

                        const submitButton = form.querySelector(
                            'button[type="submit"]',
                        );

                        if (submitButton) {

                            submitButton.innerHTML =
                                '<i class="fas fa-spinner fa-spin me-1"></i> جاري التحميل...';

                            submitButton.disabled = true;

                        }

                        form.submit();

                    }

                });

            }

        });



        // Add data-labels for responsive table

        document
            .querySelectorAll(".enhanced-table thead th")
            .forEach((th, index) => {

                const label = th.textContent;

                document
                    .querySelectorAll(
                        `.enhanced-table tbody tr td:nth-child(${index + 1})`,
                    )
                    .forEach((td) => {

                        td.setAttribute("data-label", label);

                    });

            });



        // Initialize tooltips

        if (typeof bootstrap !== "undefined") {

            var tooltipTriggerList = [].slice.call(
                document.querySelectorAll("[title]"),
            );

            tooltipTriggerList.map(function (tooltipTriggerEl) {

                return new bootstrap.Tooltip(tooltipTriggerEl);

            });

        }

    });



    
    // دالة الطباعة المحسنة
    function printPage() {
        // إضافة تاريخ ووقت الطباعة
        const container = document.querySelector('.container');
        if (container) {
            const now = new Date();
            const currentDate = now.toLocaleDateString('ar-SA');
            const currentTime = now.toLocaleTimeString('ar-SA');
            container.setAttribute('data-print-date', currentDate);
            container.setAttribute('data-print-time', currentTime);
        }
        
        // إخفاء جميع العناصر غير المرغوب فيها
        const elementsToHide = [
            '.card:first-of-type', // فلاتر البحث
            '.navbar',
            '.sidebar', 
            '.btn:not(.print-btn)',
            '.pagination',
            '.breadcrumb'
        ];
        
        const hiddenElements = [];
        elementsToHide.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(element => {
                if (element && element.style.display !== 'none') {
                    hiddenElements.push({element, originalDisplay: element.style.display});
                    element.style.display = 'none';
                }
            });
        });
        
        // تحسين عنوان الصفحة للطباعة
        const originalTitle = document.title;
        document.title = 'تقرير الوثائق - شركة نُظم';
        
        // بدء عملية الطباعة
        setTimeout(() => {
            window.print();
            
            // استعادة العنوان الأصلي والعناصر المخفية
            document.title = originalTitle;
            hiddenElements.forEach(({element, originalDisplay}) => {
                element.style.display = originalDisplay || 'block';
            });
        }, 100);
    }
    
    // تحسين تنسيق الطباعة عند فتح مربع حوار الطباعة
    window.addEventListener('beforeprint', function() {
        // إضافة معلومات إضافية للطباعة
        const printInfo = document.createElement('div');
        printInfo.className = 'print-only';
        printInfo.innerHTML = `
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px;">
                <h2>تقرير الوثائق - نُظم</h2>
                <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-SA')}</p>
                <p>وقت الطباعة: ${new Date().toLocaleTimeString('ar-SA')}</p>
            </div>
        `;
        document.body.insertBefore(printInfo, document.body.firstChild);
    });
    
    window.addEventListener('afterprint', function() {
        // إزالة معلومات الطباعة بعد انتهاء الطباعة
        const printInfo = document.querySelector('.print-only');
        if (printInfo) {
            printInfo.remove();
        }
    });

</script>

{% endblock %}
