{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>إضافة موظف جديد</h1>
        <a href="{{ url_for('employees.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-right me-1"></i> العودة للقائمة
        </a>
    </div>

    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">بيانات الموظف الجديد</h5>
        </div>
        <div class="card-body">
            <form action="{{ url_for('employees.create') }}" method="post">
                <div class="row">
                    <!-- معلومات أساسية -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="name" class="form-label required-field">الاسم الكامل</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="employee_id" class="form-label required-field">الرقم الوظيفي</label>
                            <input type="text" class="form-control" id="employee_id" name="employee_id" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="national_id" class="form-label required-field">رقم الهوية</label>
                            <input type="text" class="form-control" id="national_id" name="national_id" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label for="mobile" class="form-label required-field">جوال العمل</label>
                            <div class="mobile-dropdown-container" style="position: relative;">
                                <!-- حقل البحث -->
                                <input type="text" class="form-control" id="mobile_search" 
                                       placeholder="ابحث عن رقم الجوال أو اكتب رقم جديد..." 
                                       autocomplete="off">
                                
                                <!-- القائمة المخفية للأرقام المتاحة -->
                                <div class="mobile-dropdown-list" id="mobile_dropdown_list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; background: #ffffff; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                                    {% for phone in available_phone_numbers %}
                                    <div class="mobile-dropdown-item" data-value="{{ phone.phone_number }}" 
                                         style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333; background: #fff;">
                                        <div style="font-weight: bold; color: #2c3e50; font-size: 14px;">{{ phone.phone_number }}</div>
                                        {% if phone.carrier or phone.plan_type %}
                                        <div style="font-size: 12px; color: #7f8c8d; margin-top: 2px;">
                                            {% if phone.carrier %}{{ phone.carrier }}{% endif %}
                                            {% if phone.plan_type %} - {{ phone.plan_type }}{% endif %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- الحقل المخفي لحفظ القيمة -->
                                <input type="hidden" id="mobile" name="mobile" required>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group mb-3">
                            <label for="mobilePersonal" class="form-label">الجوال الشخصي</label>
                            <input type="text" class="form-control" id="mobilePersonal" name="mobilePersonal">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="email" class="form-label">البريد الإلكتروني</label>
                            <input type="email" class="form-control" id="email" name="email">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="job_title" class="form-label required-field">المسمى الوظيفي</label>
                            <input type="text" class="form-control" id="job_title" name="job_title" required>
                        </div>
                    </div>

                    <!-- قائمة الجنسيات -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="nationality_id" class="form-label">الجنسية</label>
                            <select class="form-select" id="nationality_id" name="nationality_id">
                                <option value="" selected>- اختر الجنسية -</option>
                                {% for nat in nationalities %}
                                <option value="{{ nat.id }}">{{ nat.name_ar }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="contract_status" class="form-label">حالة العقد</label>
                            <select class="form-select" id="contract_status" name="contract_status">
                                <option value="">- غير محدد -</option>
                                <option value="Active" selected>ساري</option>
                                <option value="Expired">منتهي</option>
                                <option value="Probation">فترة تجربة</option>
                                <option value="Terminated">منهى</option>
                            </select>
                        </div>
                    </div>

                    <!-- عمود حالة الرخصة (جديد) -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="license_status" class="form-label">حالة الرخصة</label>
                            <select class="form-select" id="license_status" name="license_status">
                                <option value="">- غير محدد -</option>
                                <option value="Valid">سارية</option>
                                <option value="Expired">منتهية</option>
                                <option value="Suspended">موقوفة</option>
                                <option value="Not-Applicable" selected>لا تنطبق</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- قائمة حالة العقد -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="contract_status" class="form-label">حالة العقد</label>
                            <select class="form-select" id="contract_status" name="contract_status">
                                <option value="" selected>- غير محدد -</option>
                                <option value="Active">ساري</option>
                                <option value="Expired">منتهي</option>
                                <option value="Probation">فترة تجربة</option>
                                <option value="Terminated">منهى</option>
                            </select>
                        </div>
                    </div>

                    <!-- قائمة حالة الرخصة -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="license_status" class="form-label">حالة الرخصة</label>
                            <select class="form-select" id="license_status" name="license_status">
                                <option value="" selected>- غير محدد -</option>
                                <option value="Valid">سارية</option>
                                <option value="Expired">منتهية</option>
                                <option value="Suspended">موقوفة</option>
                                <option value="Not-Applicable">لا تنطبق</option>
                            </select>
                        </div>
                    </div>

                    <!-- نوع الموظف -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="employee_type" class="form-label required-field">نوع الموظف</label>
                            <select class="form-select" id="employee_type" name="employee_type" required onchange="toggleCustodyFields()">
                                <option value="regular">موظف عادي</option>
                                <option value="driver">موظف سائق</option>
                            </select>
                        </div>
                    </div>

                    <!-- معلومات العمل -->
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="status" class="form-label required-field">الحالة</label>
                            <select class="form-select" id="status" name="status" required>
                                <option value="active">نشط</option>
                                <option value="inactive">غير نشط</option>
                                <option value="on_leave">في إجازة</option>
                                <option value="terminated">متوقف عن العمل</option>
                            </select>
                        </div>
                    </div>

                    <!-- حقول العهدة للسائقين -->
                    <div class="col-12" id="custody-section" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>عهدة السائق</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="has_mobile_custody" name="has_mobile_custody" onchange="toggleMobileFields()">
                                                <label class="form-check-label" for="has_mobile_custody">
                                                    عهدة جوال
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row" id="mobile-fields" style="display: none;">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="mobile" class="form-label">رقم الهاتف المحمول</label>
                                            <div class="phone-dropdown-container" style="position: relative;">
                                                <!-- حقل البحث -->
                                                <input type="text" class="form-control" id="phone_search" 
                                                       placeholder="ابحث عن رقم الهاتف أو اكتب رقم جديد..." 
                                                       autocomplete="off" maxlength="20">
                                                
                                                <!-- القائمة المخفية للأرقام المتاحة -->
                                                <div class="phone-dropdown-list" id="phone_dropdown_list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; background: #ffffff; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                                                    {% for phone in available_phone_numbers %}
                                                    <div class="phone-dropdown-item" data-value="{{ phone.phone_number }}" 
                                                         style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333; background: #fff;">
                                                        <div style="font-weight: bold; color: #2c3e50; font-size: 14px;">{{ phone.phone_number }}</div>
                                                        {% if phone.carrier or phone.plan_type %}
                                                        <div style="font-size: 12px; color: #7f8c8d; margin-top: 2px;">
                                                            {% if phone.carrier %}{{ phone.carrier }}{% endif %}
                                                            {% if phone.plan_type %} - {{ phone.plan_type }}{% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                
                                                <!-- الحقل المخفي لحفظ القيمة -->
                                                <input type="hidden" id="mobile" name="mobile">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="mobile_type" class="form-label">نوع الجوال</label>
                                            <input type="text" class="form-control" id="mobile_type" name="mobile_type" placeholder="مثال: iPhone 15, Samsung Galaxy S24">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="mobile_imei" class="form-label">رقم IMEI</label>
                                            <div class="imei-dropdown-container" style="position: relative;">
                                                <!-- حقل البحث -->
                                                <input type="text" class="form-control" id="imei_search" 
                                                       placeholder="ابحث عن رقم IMEI أو اكتب رقم جديد..." 
                                                       autocomplete="off" maxlength="15">
                                                
                                                <!-- القائمة المخفية للأرقام المتاحة -->
                                                <div class="imei-dropdown-list" id="imei_dropdown_list" style="display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; background: #ffffff; border-radius: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.15);">
                                                    {% for device in available_imei_numbers %}
                                                    <div class="imei-dropdown-item" data-value="{{ device.imei }}" 
                                                         style="padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; color: #333; background: #fff;">
                                                        <div style="font-weight: bold; color: #2c3e50; font-size: 14px;">{{ device.imei }}</div>
                                                        {% if device.brand or device.model %}
                                                        <div style="font-size: 12px; color: #7f8c8d; margin-top: 2px;">
                                                            {% if device.brand %}{{ device.brand }}{% endif %}
                                                            {% if device.model %} {{ device.model }}{% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                
                                                <!-- الحقل المخفي لحفظ القيمة -->
                                                <input type="hidden" id="mobile_imei" name="mobile_imei">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- قسم معلومات الكفالة -->
                    <div class="col-12">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-user-tie me-2"></i>معلومات الكفالة</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="sponsorship_status" class="form-label">حالة الكفالة</label>
                                            <select class="form-select" id="sponsorship_status" name="sponsorship_status" onchange="toggleSponsorNameField()">
                                                <option value="inside" selected>على الكفالة</option>
                                                <option value="outside">خارج الكفالة</option>
                                            </select>
                                            <div class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i>
                                                اختر "على الكفالة" إذا كان الموظف لا يزال على كفالة الشركة أو كفيل آخر
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3" id="sponsor-name-field">
                                            <label for="current_sponsor_name" class="form-label">اسم الكفيل الحالي</label>
                                            <input type="text" class="form-control" id="current_sponsor_name" name="current_sponsor_name" 
                                                   placeholder="اختياري - اسم الكفيل أو الشركة الكافلة">
                                            <div class="form-text text-muted">
                                                <i class="fas fa-info-circle"></i>
                                                يمكن تركه فارغاً إذا كان غير معروف أو غير محدد
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- القسم الجديد لاختيار عدة أقسام -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">الأقسام المرتبط بها الموظف</label>
                        <div class="department-pills-container p-2 rounded" style="border: 1px solid var(--bs-border-color-translucent);">
                            <!-- التحقق من وجود أقسام لعرضها -->
                            {% if departments %}
                                {% for dept in departments %}
                                <!-- مربع اختيار مخفي فعليًا، لإرسال البيانات فقط -->
                                <div class="d-none">
                                    <input class="form-check-input department-checkbox" type="checkbox" name="department_ids" value="{{ dept.id }}" id="dept-create-{{ dept.id }}">
                                </div>
                                <!-- الشارة التفاعلية التي يراها المستخدم وينقر عليها -->
                                <span class="badge department-pill" data-target-id="dept-create-{{ dept.id }}">
                                    <i class="fas fa-check-circle me-1"></i>
                                    {{ dept.name }}
                                </span>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted small m-1">لا توجد أقسام معرفة في النظام لتعيينها.</p>
                            {% endif %}
                        </div>
                        <div class="form-text mt-2">انقر على اسم القسم لتحديده أو إلغاء تحديده.</div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="location" class="form-label required-field">الموقع</label>
                            <input type="text" class="form-control" id="location" name="location" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="project" class="form-label required-field">المشروع</label>
                            <input type="text" class="form-control" id="project" name="project" required>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="join_date" class="form-label">تاريخ الالتحاق</label>
                            <input type="date" class="form-control date-picker" id="join_date" name="join_date">
                            <div class="form-text text-muted">
                                <i class="fas fa-info-circle"></i>
                                يمكنك استخدام التاريخ الميلادي أو الهجري عن طريق زر التبديل أعلى الصفحة
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="birth_date" class="form-label">تاريخ الميلاد</label>
                            <input type="date" class="form-control date-picker" id="birth_date" name="birth_date">
                            <div class="form-text text-muted">
                                <i class="fas fa-birthday-cake"></i>
                                تاريخ ميلاد الموظف
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> حفظ البيانات
                    </button>
                    <button type="reset" class="btn btn-secondary">
                        <i class="fas fa-undo me-1"></i> إعادة تعيين
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function toggleCustodyFields() {
    const employeeType = document.getElementById('employee_type').value;
    const custodySection = document.getElementById('custody-section');
    
    if (employeeType === 'driver') {
        custodySection.style.display = 'block';
    } else {
        custodySection.style.display = 'none';
        // إخفاء وإلغاء تحديد حقول الجوال
        document.getElementById('has_mobile_custody').checked = false;
        toggleMobileFields();
    }
}

function toggleMobileFields() {
    const hasMobileCustody = document.getElementById('has_mobile_custody').checked;
    const mobileFields = document.getElementById('mobile-fields');
    
    if (hasMobileCustody) {
        mobileFields.style.display = 'block';
    } else {
        mobileFields.style.display = 'none';
        // مسح قيم حقول الجوال
        document.getElementById('mobile_type').value = '';
        document.getElementById('mobile_imei').value = '';
        document.getElementById('mobile').value = '';
        // مسح قيم حقول البحث
        const phoneSearch = document.getElementById('phone_search');
        const imeiSearch = document.getElementById('imei_search');
        if (phoneSearch) phoneSearch.value = '';
        if (imeiSearch) imeiSearch.value = '';
    }
}

// إعداد الحالة الافتراضية عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    toggleCustodyFields();
    initializeImeiDropdown();
    initializePhoneDropdown();
    initializeMobileDropdown();
    initializeDepartmentPills();
});

// دالة إعداد الشارات التفاعلية للأقسام
function initializeDepartmentPills() {
    const departmentPills = document.querySelectorAll('.department-pill');
    
    departmentPills.forEach(pill => {
        pill.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target-id');
            const targetCheckbox = document.getElementById(targetId);
            
            if (targetCheckbox) {
                // تبديل حالة الـ checkbox
                targetCheckbox.checked = !targetCheckbox.checked;
                
                // تبديل ظهور الشارة
                if (targetCheckbox.checked) {
                    this.classList.add('active');
                    this.style.backgroundColor = '#28a745';
                    this.style.borderColor = '#28a745';
                } else {
                    this.classList.remove('active');
                    this.style.backgroundColor = '#6c757d';
                    this.style.borderColor = '#6c757d';
                }
            }
        });
    });
}

// دالة إظهار/إخفاء حقل اسم الكفيل
function toggleSponsorNameField() {
    const sponsorshipStatus = document.getElementById('sponsorship_status').value;
    const sponsorNameField = document.getElementById('sponsor-name-field');
    
    if (sponsorshipStatus === 'outside') {
        sponsorNameField.style.display = 'none';
    } else {
        sponsorNameField.style.display = 'block';
    }
}

// دالة إعداد القائمة المنسدلة القابلة للبحث للهاتف الأساسي (العمل)
function initializeMobileDropdown() {
    const searchInput = document.getElementById('mobile_search');
    const dropdownList = document.getElementById('mobile_dropdown_list');
    const hiddenInput = document.getElementById('mobile');
    const dropdownItems = document.querySelectorAll('.mobile-dropdown-item');
    
    if (!searchInput || !dropdownList || !hiddenInput) return;
    
    // إظهار القائمة عند التركيز على حقل البحث
    searchInput.addEventListener('focus', function() {
        dropdownList.style.display = 'block';
        filterMobileDropdownItems('');
    });
    
    // البحث في الأرقام أثناء الكتابة
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterMobileDropdownItems(searchTerm);
        dropdownList.style.display = 'block';
        
        // تحديث القيمة المخفية
        hiddenInput.value = searchTerm;
    });
    
    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // التعامل مع اختيار عنصر من القائمة
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdownList.style.display = 'none';
        });
        
        // تأثيرات التمرير
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.color = '#1976d2';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#ffffff';
            this.style.color = '#333';
        });
    });
    
    // دالة فلترة العناصر
    function filterMobileDropdownItems(searchTerm) {
        dropdownItems.forEach(item => {
            const phoneNumber = item.dataset.value;
            const text = item.textContent.toLowerCase();
            
            if (phoneNumber.includes(searchTerm) || text.includes(searchTerm.toLowerCase())) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// دالة إعداد القائمة المنسدلة القابلة للبحث للهاتف
function initializePhoneDropdown() {
    const searchInput = document.getElementById('phone_search');
    const dropdownList = document.getElementById('phone_dropdown_list');
    const hiddenInput = document.getElementById('mobile');
    const dropdownItems = document.querySelectorAll('.phone-dropdown-item');
    
    if (!searchInput || !dropdownList || !hiddenInput) return;
    
    // إظهار القائمة عند التركيز على حقل البحث
    searchInput.addEventListener('focus', function() {
        dropdownList.style.display = 'block';
        filterPhoneDropdownItems('');
    });
    
    // البحث في الأرقام أثناء الكتابة
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterPhoneDropdownItems(searchTerm);
        dropdownList.style.display = 'block';
        
        // تحديث القيمة المخفية
        hiddenInput.value = searchTerm;
    });
    
    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // التعامل مع اختيار عنصر من القائمة
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdownList.style.display = 'none';
        });
        
        // تأثيرات التمرير
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.color = '#1976d2';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#ffffff';
            this.style.color = '#333';
        });
    });
    
    // دالة فلترة العناصر
    function filterPhoneDropdownItems(searchTerm) {
        dropdownItems.forEach(item => {
            const phoneNumber = item.dataset.value;
            const text = item.textContent.toLowerCase();
            
            if (phoneNumber.includes(searchTerm) || text.includes(searchTerm.toLowerCase())) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// دالة إعداد القائمة المنسدلة القابلة للبحث لرقم IMEI
function initializeImeiDropdown() {
    const searchInput = document.getElementById('imei_search');
    const dropdownList = document.getElementById('imei_dropdown_list');
    const hiddenInput = document.getElementById('mobile_imei');
    const dropdownItems = document.querySelectorAll('.imei-dropdown-item');
    
    if (!searchInput || !dropdownList || !hiddenInput) return;
    
    // إظهار القائمة عند التركيز على حقل البحث
    searchInput.addEventListener('focus', function() {
        dropdownList.style.display = 'block';
        filterImeiDropdownItems('');
    });
    
    // البحث في الأرقام أثناء الكتابة
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.trim();
        filterImeiDropdownItems(searchTerm);
        dropdownList.style.display = 'block';
        
        // تحديث القيمة المخفية
        hiddenInput.value = searchTerm;
    });
    
    // إخفاء القائمة عند النقر خارجها
    document.addEventListener('click', function(e) {
        if (!searchInput.contains(e.target) && !dropdownList.contains(e.target)) {
            dropdownList.style.display = 'none';
        }
    });
    
    // التعامل مع اختيار عنصر من القائمة
    dropdownItems.forEach(item => {
        item.addEventListener('click', function() {
            const value = this.dataset.value;
            searchInput.value = value;
            hiddenInput.value = value;
            dropdownList.style.display = 'none';
        });
        
        // تأثيرات التمرير
        item.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e3f2fd';
            this.style.color = '#1976d2';
        });
        
        item.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '#ffffff';
            this.style.color = '#333';
        });
    });
    
    // دالة فلترة العناصر
    function filterImeiDropdownItems(searchTerm) {
        dropdownItems.forEach(item => {
            const imeiNumber = item.dataset.value;
            const text = item.textContent.toLowerCase();
            
            if (imeiNumber.includes(searchTerm) || text.includes(searchTerm.toLowerCase())) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
}

// إضافة CSS محسن للقوائم المنسدلة
const dropdownCSS = document.createElement('style');
dropdownCSS.textContent = `
    .mobile-dropdown-list, .phone-dropdown-list, .imei-dropdown-list {
        border: 1px solid #bdc3c7 !important;
        background: #ffffff !important;
        color: #2c3e50 !important;
    }
    
    .mobile-dropdown-item, .phone-dropdown-item, .imei-dropdown-item {
        color: #2c3e50 !important;
        background: #ffffff !important;
        transition: all 0.2s ease;
    }
    
    .mobile-dropdown-item:hover, .phone-dropdown-item:hover, .imei-dropdown-item:hover {
        background: #e3f2fd !important;
        color: #1976d2 !important;
    }
    
    .mobile-dropdown-item div, .phone-dropdown-item div, .imei-dropdown-item div {
        color: inherit !important;
    }
    
    .mobile-dropdown-item:last-child, .phone-dropdown-item:last-child, .imei-dropdown-item:last-child {
        border-bottom: none !important;
    }
    
    /* تصميم الأقسام التفاعلية */
    .department-pills-container {
        background: #f8f9fa;
        min-height: 50px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: flex-start;
        align-content: flex-start;
    }
    
    .department-pill {
        font-size: 13px;
        padding: 8px 15px;
        margin: 3px;
        cursor: pointer;
        border: 2px solid #6c757d;
        background-color: #6c757d;
        color: white;
        border-radius: 20px;
        transition: all 0.3s ease;
        user-select: none;
        display: inline-flex;
        align-items: center;
    }
    
    .department-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .department-pill.active {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
        color: white;
    }
    
    .department-pill i {
        transition: transform 0.2s ease;
    }
    
    .department-pill.active i {
        transform: scale(1.1);
    }
`;
document.head.appendChild(dropdownCSS);
</script>

{% endblock %}
