{% extends "layout.html" %}

{% block title %}إضافة تفويض خارجي جديد{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- العنوان الرئيسي -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="mb-1">
                        <i class="fas fa-file-signature text-primary me-2"></i>
                        إضافة تفويض خارجي جديد
                    </h2>
                    <p class="text-muted mb-0">
                        <i class="fas fa-car me-1"></i>
                        المركبة: <strong>{{ vehicle.plate_number }}</strong> - {{ vehicle.make }} {{ vehicle.model }}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right me-1"></i>
                        العودة للمركبة
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- نموذج إضافة التفويض -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        بيانات التفويض الخارجي
                    </h5>
                </div>
                
                <form id="externalAuthForm" action="{{ url_for('external_authorizations.store_authorization') }}" method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="vehicle_id" value="{{ vehicle.id }}">
                    {{ form.hidden_tag() }}
                    
                    <div class="card-body">
                        <!-- معلومات السائق -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-user me-2"></i>
                                    معلومات السائق
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="driver_name" class="form-label fw-bold">
                                    <i class="fas fa-user me-1"></i>اسم السائق *
                                </label>
                                <input type="text" class="form-control" id="driver_name" name="driver_name" 
                                       placeholder="أدخل اسم السائق" required>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="driver_phone" class="form-label fw-bold">
                                    <i class="fas fa-phone me-1"></i>رقم الهاتف
                                </label>
                                <input type="tel" class="form-control" id="driver_phone" name="driver_phone" 
                                       placeholder="مثال: 966501234567">
                            </div>
                        </div>

                        <!-- معلومات المشروع -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-project-diagram me-2"></i>
                                    معلومات المشروع
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="project_name" class="form-label fw-bold">
                                    <i class="fas fa-building me-1"></i>اسم المشروع *
                                </label>
                                <select class="form-select" id="project_name" name="project_name" required>
                                    <option value="">اختر المشروع</option>
                                    <option value="مشروع الرياض">مشروع الرياض</option>
                                    <option value="مشروع جدة">مشروع جدة</option>
                                    <option value="مشروع الدمام">مشروع الدمام</option>
                                    <option value="مشروع المدينة المنورة">مشروع المدينة المنورة</option>
                                    <option value="مشروع تبوك">مشروع تبوك</option>
                                    <option value="مشروع أبها">مشروع أبها</option>
                                    <option value="مشروع نيوم">مشروع نيوم</option>
                                    <option value="مشروع القدية">مشروع القدية</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="city" class="form-label fw-bold">
                                    <i class="fas fa-map-marker-alt me-1"></i>المدينة *
                                </label>
                                <select class="form-select" id="city" name="city" required>
                                    <option value="">اختر المدينة</option>
                                    <option value="الرياض">الرياض</option>
                                    <option value="جدة">جدة</option>
                                    <option value="الدمام">الدمام</option>
                                    <option value="المدينة المنورة">المدينة المنورة</option>
                                    <option value="تبوك">تبوك</option>
                                    <option value="أبها">أبها</option>
                                    <option value="الخبر">الخبر</option>
                                    <option value="الطائف">الطائف</option>
                                    <option value="بريدة">بريدة</option>
                                    <option value="خميس مشيط">خميس مشيط</option>
                                </select>
                            </div>
                        </div>

                        <!-- معلومات إضافية -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    معلومات إضافية
                                </h6>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="authorization_type" class="form-label fw-bold">
                                    <i class="fas fa-exchange-alt me-1"></i>نوع التفويض *
                                </label>
                                <select class="form-select" id="authorization_type" name="authorization_type" required>
                                    <option value="">اختر نوع التفويض</option>
                                    <option value="تسليم">تسليم المركبة</option>
                                    <option value="استلام">استلام المركبة</option>
                                    <option value="صيانة">صيانة المركبة</option>
                                    <option value="مهمة">مهمة خاصة</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label for="duration" class="form-label fw-bold">
                                    <i class="fas fa-clock me-1"></i>مدة التفويض
                                </label>
                                <input type="text" class="form-control" id="duration" name="duration" 
                                       placeholder="مثال: 3 أيام، أسبوع، شهر">
                            </div>
                        </div>

                        <!-- رفع الملفات -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 mb-3">
                                    <i class="fas fa-paperclip me-2"></i>
                                    المرفقات (اختياري)
                                </h6>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="authorization_file" class="form-label fw-bold">
                                    <i class="fas fa-upload me-1"></i>رفع ملف PDF أو صورة
                                </label>
                                <input type="file" class="form-control" id="authorization_file" name="authorization_file" 
                                       accept=".pdf,.jpg,.jpeg,.png,.gif" onchange="showFileInfo(this)">
                                <small class="text-muted">
                                    أنواع الملفات المدعومة: PDF, JPG, PNG, GIF - الحد الأقصى 10MB
                                </small>
                                
                                <!-- معلومات الملف المحدد -->
                                <div id="fileInfo" class="mt-2 p-3 bg-light rounded d-none">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file text-primary me-2"></i>
                                        <div>
                                            <div class="fw-bold" id="fileName"></div>
                                            <small class="text-muted" id="fileSize"></small>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="clearFile()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- الملاحظات -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <label for="notes" class="form-label fw-bold">
                                    <i class="fas fa-sticky-note me-1"></i>ملاحظات إضافية
                                </label>
                                <textarea class="form-control" id="notes" name="notes" rows="4" 
                                          placeholder="أي ملاحظات أو تفاصيل إضافية حول التفويض..."></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- أزرار الحفظ -->
                    <div class="card-footer bg-light">
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>
                                إلغاء
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                حفظ التفويض
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// عرض معلومات الملف المحدد
function showFileInfo(input) {
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    if (input.files && input.files[0]) {
        const file = input.files[0];
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.classList.remove('d-none');
    } else {
        fileInfo.classList.add('d-none');
    }
}

// مسح الملف المحدد
function clearFile() {
    document.getElementById('authorization_file').value = '';
    document.getElementById('fileInfo').classList.add('d-none');
}

// تنسيق حجم الملف
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// تحديث المدينة تلقائياً عند اختيار المشروع
document.getElementById('project_name').addEventListener('change', function() {
    const citySelect = document.getElementById('city');
    const projectCityMap = {
        'مشروع الرياض': 'الرياض',
        'مشروع جدة': 'جدة',
        'مشروع الدمام': 'الدمام',
        'مشروع المدينة المنورة': 'المدينة المنورة',
        'مشروع تبوك': 'تبوك',
        'مشروع أبها': 'أبها',
        'مشروع نيوم': 'تبوك'
    };
    
    if (projectCityMap[this.value]) {
        citySelect.value = projectCityMap[this.value];
    }
});
</script>
{% endblock %}