{% extends "base.html" %}

{% block title %}إضافة تفويض خارجي{% endblock %}

{% block extra_css %}
<link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
<style>
.create-form-container {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    margin-top: 20px;
}

.form-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    padding: 20px;
    color: white;
    margin-bottom: 30px;
    text-align: center;
}

.employee-search-container {
    position: relative;
}

.employee-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.employee-item {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.employee-item:hover {
    background-color: #f8f9fa;
}

.employee-item:last-child {
    border-bottom: none;
}

.employee-name {
    font-weight: bold;
    color: #333;
}

.employee-details {
    font-size: 0.85rem;
    color: #666;
    margin-top: 3px;
}

.selected-employee {
    background: #e3f2fd;
    border: 2px solid #2196f3;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
    display: none;
}

.file-upload-area {
    border: 2px dashed #ddd;
    border-radius: 8px;
    padding: 30px;
    text-align: center;
    background: #fafafa;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: #667eea;
    background: #f0f4ff;
}

.file-upload-area.dragover {
    border-color: #667eea;
    background: #e3f2fd;
}

.file-info {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    border-radius: 8px;
    padding: 10px;
    margin-top: 10px;
    display: none;
}

.submit-btn {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    color: white;
    font-weight: bold;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
}

.submit-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
}

.form-floating label {
    font-weight: 500;
    color: #555;
}

.loading-spinner {
    display: none;
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #999;
    font-style: italic;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="create-form-container">
                <!-- Header -->
                <div class="form-header">
                    <h2 class="mb-0">
                        <i class="fas fa-file-signature ms-2"></i>
                        إضافة تفويض خارجي جديد
                    </h2>
                    <p class="mb-0 mt-2">قم بملء البيانات المطلوبة لإنشاء تفويض خارجي للموظف</p>
                </div>

                <!-- النموذج -->
                <form method="POST" enctype="multipart/form-data" id="authorizationForm">
                    <!-- فلترة القسم -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" id="departmentFilter">
                                    <option value="">جميع الأقسام</option>
                                    {% for dept in departments %}
                                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                                    {% endfor %}
                                </select>
                                <label for="departmentFilter">فلترة حسب القسم</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select" name="project_id" id="projectSelect" required>
                                    <option value="">اختر المشروع</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                                <label for="projectSelect">المشروع *</label>
                            </div>
                        </div>
                    </div>

                    <!-- بحث الموظف -->
                    <div class="mb-4">
                        <label class="form-label">اختيار الموظف *</label>
                        <div class="employee-search-container">
                            <div class="input-group">
                                <input type="text" class="form-control" id="employeeSearch" 
                                       placeholder="ابحث عن الموظف بالاسم أو رقم الهوية...">
                                <span class="input-group-text">
                                    <div class="loading-spinner" id="searchSpinner"></div>
                                    <i class="fas fa-search" id="searchIcon"></i>
                                </span>
                            </div>
                            <div class="employee-dropdown" id="employeeDropdown"></div>
                        </div>
                        
                        <!-- عرض الموظف المختار -->
                        <div class="selected-employee" id="selectedEmployee">
                            <div class="row">
                                <div class="col-md-8">
                                    <h6 class="mb-1" id="selectedEmployeeName"></h6>
                                    <small class="text-muted" id="selectedEmployeeDetails"></small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <button type="button" class="btn btn-outline-danger btn-sm" 
                                            onclick="clearSelectedEmployee()">
                                        <i class="fas fa-times"></i> إلغاء الاختيار
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- حقل مخفي لمعرف الموظف -->
                        <input type="hidden" name="employee_id" id="employeeId" required>
                    </div>

                    <!-- وصف التفويض -->
                    <div class="mb-4">
                        <div class="form-floating">
                            <textarea class="form-control" name="description" id="description" 
                                      style="height: 120px" placeholder="وصف التفويض"></textarea>
                            <label for="description">وصف التفويض</label>
                        </div>
                    </div>

                    <!-- رفع الملف -->
                    <div class="mb-4">
                        <label class="form-label">رفع ملف (PDF أو صورة)</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt fa-2x mb-3 text-primary"></i>
                            <h5>اسحب الملف هنا أو انقر للاختيار</h5>
                            <p class="text-muted">PDF, JPG, PNG (حد أقصى 10MB)</p>
                            <input type="file" name="authorization_file" id="authorizationFile" 
                                   accept=".pdf,.jpg,.jpeg,.png,.gif" style="display: none;">
                        </div>
                        <div class="file-info" id="fileInfo">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-file me-2"></i>
                                    <span id="fileName"></span>
                                    <small class="text-muted d-block" id="fileSize"></small>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                        onclick="clearFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- الرابط الخارجي -->
                    <div class="mb-4">
                        <div class="form-floating">
                            <input type="url" class="form-control" name="external_link" id="externalLink" 
                                   placeholder="https://example.com">
                            <label for="externalLink">رابط خارجي (اختياري)</label>
                        </div>
                        <small class="text-muted">مثل رابط Google Form أو مستند على Drive</small>
                    </div>

                    <!-- أزرار التحكم -->
                    <div class="text-center">
                        <button type="submit" class="submit-btn me-3">
                            <i class="fas fa-save ms-1"></i>
                            حفظ التفويض
                        </button>
                        <a href="{{ url_for('external_authorizations.index') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-right ms-1"></i>
                            إلغاء
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedEmployeeId = null;
let searchTimeout = null;

// بحث الموظفين
document.getElementById('employeeSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    const departmentId = document.getElementById('departmentFilter').value;
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
        hideEmployeeDropdown();
        return;
    }
    
    showSpinner();
    
    searchTimeout = setTimeout(() => {
        searchEmployees(query, departmentId);
    }, 300);
});

// فلترة حسب القسم
document.getElementById('departmentFilter').addEventListener('change', function() {
    const query = document.getElementById('employeeSearch').value.trim();
    const departmentId = this.value;
    
    if (query.length >= 2) {
        showSpinner();
        searchEmployees(query, departmentId);
    }
});

async function searchEmployees(query, departmentId = '') {
    try {
        const params = new URLSearchParams({
            search: query
        });
        
        if (departmentId) {
            params.append('department_id', departmentId);
        }
        
        const response = await fetch(`/external-authorizations/api/employees?${params}`);
        const employees = await response.json();
        
        displayEmployees(employees);
    } catch (error) {
        console.error('Error searching employees:', error);
    } finally {
        hideSpinner();
    }
}

function displayEmployees(employees) {
    const dropdown = document.getElementById('employeeDropdown');
    dropdown.innerHTML = '';
    
    if (employees.length === 0) {
        dropdown.innerHTML = '<div class="no-results">لا توجد نتائج</div>';
    } else {
        employees.forEach(employee => {
            const item = document.createElement('div');
            item.className = 'employee-item';
            item.innerHTML = `
                <div class="employee-name">${employee.name}</div>
                <div class="employee-details">
                    رقم الموظف: ${employee.employee_id} | 
                    الأقسام: ${employee.departments_str || 'غير محدد'}
                </div>
            `;
            
            item.addEventListener('click', () => selectEmployee(employee));
            dropdown.appendChild(item);
        });
    }
    
    showEmployeeDropdown();
}

function selectEmployee(employee) {
    selectedEmployeeId = employee.id;
    
    // تحديث الحقول
    document.getElementById('employeeId').value = employee.id;
    document.getElementById('employeeSearch').value = employee.name;
    
    // عرض معلومات الموظف المختار
    document.getElementById('selectedEmployeeName').textContent = employee.name;
    document.getElementById('selectedEmployeeDetails').textContent = 
        `رقم الموظف: ${employee.employee_id} | الأقسام: ${employee.departments_str || 'غير محدد'}`;
    
    document.getElementById('selectedEmployee').style.display = 'block';
    hideEmployeeDropdown();
}

function clearSelectedEmployee() {
    selectedEmployeeId = null;
    document.getElementById('employeeId').value = '';
    document.getElementById('employeeSearch').value = '';
    document.getElementById('selectedEmployee').style.display = 'none';
}

function showEmployeeDropdown() {
    document.getElementById('employeeDropdown').style.display = 'block';
}

function hideEmployeeDropdown() {
    document.getElementById('employeeDropdown').style.display = 'none';
}

function showSpinner() {
    document.getElementById('searchSpinner').style.display = 'inline-block';
    document.getElementById('searchIcon').style.display = 'none';
}

function hideSpinner() {
    document.getElementById('searchSpinner').style.display = 'none';
    document.getElementById('searchIcon').style.display = 'inline-block';
}

// رفع الملفات
const fileUploadArea = document.getElementById('fileUploadArea');
const fileInput = document.getElementById('authorizationFile');

fileUploadArea.addEventListener('click', () => fileInput.click());

fileUploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    fileUploadArea.classList.add('dragover');
});

fileUploadArea.addEventListener('dragleave', () => {
    fileUploadArea.classList.remove('dragover');
});

fileUploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    fileUploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

function handleFile(file) {
    // فحص نوع الملف
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        alert('نوع الملف غير مدعوم. يرجى اختيار PDF أو صورة.');
        return;
    }
    
    // فحص حجم الملف (10MB)
    if (file.size > 10 * 1024 * 1024) {
        alert('حجم الملف كبير جداً. الحد الأقصى 10MB.');
        return;
    }
    
    // عرض معلومات الملف
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').style.display = 'block';
}

function clearFile() {
    document.getElementById('authorizationFile').value = '';
    document.getElementById('fileInfo').style.display = 'none';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// إخفاء القائمة عند النقر خارجها
document.addEventListener('click', (e) => {
    if (!e.target.closest('.employee-search-container')) {
        hideEmployeeDropdown();
    }
});

// التحقق من صحة النموذج
document.getElementById('authorizationForm').addEventListener('submit', function(e) {
    if (!selectedEmployeeId) {
        e.preventDefault();
        alert('يرجى اختيار موظف');
        return;
    }
    
    const projectId = document.getElementById('projectSelect').value;
    if (!projectId) {
        e.preventDefault();
        alert('يرجى اختيار المشروع');
        return;
    }
});
</script>
{% endblock %}