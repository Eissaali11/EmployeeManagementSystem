{% extends 'layout.html' %}

{% block title %}إضافة رسوم حكومية{% endblock %}

{% block styles %}
<style>
    .form-card {
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .form-card .card-header {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border-radius: 10px 10px 0 0;
        padding: 15px 20px;
    }
    
    .form-label {
        font-weight: bold;
    }
    
    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 10px 15px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
    }
    
    .required-asterisk {
        color: #ef4444;
        margin-right: 3px;
    }
    
    .btn-calculate {
        background-color: #8b5cf6;
        color: white;
        border: none;
        transition: all 0.3s ease;
    }
    
    .btn-calculate:hover {
        background-color: #7c3aed;
        transform: translateY(-2px);
    }
    
    .calculation-result {
        background-color: #f3f4f6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .result-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1d4ed8;
        text-align: center;
        margin: 15px 0;
    }
    
    .result-details {
        margin-top: 15px;
        border-top: 1px dashed #d1d5db;
        padding-top: 15px;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
    }
    
    .detail-label {
        color: #6b7280;
    }
    
    .detail-value {
        font-weight: bold;
    }
    
    .fee-type-info {
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 5px;
    }
    
    .action-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    
    .manual-fee-group {
        padding: 15px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background-color: #f9fafb;
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('root') }}">الرئيسية</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('government_fees.index') }}">الرسوم الحكومية</a></li>
                    <li class="breadcrumb-item active" aria-current="page">إضافة رسوم</li>
                </ol>
            </nav>
            <h1 class="mb-3">
                <i class="fas fa-plus-circle me-2"></i>
                إضافة رسوم حكومية
            </h1>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card form-card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice-dollar me-2"></i>
                        بيانات الرسوم الحكومية
                    </h5>
                </div>
                <div class="card-body">
                    <form id="government-fee-form" method="post" action="{{ url_for('government_fees.create') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <h5 class="mb-3">بيانات الموظف</h5>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="employee_id" class="form-label">
                                        <span class="required-asterisk">*</span>
                                        الموظف
                                    </label>
                                    <select class="form-select" id="employee_id" name="employee_id" required>
                                        <option value="" selected disabled>اختر الموظف</option>
                                        {% for employee in employees %}
                                        <option value="{{ employee.id }}" data-contract="{{ employee.contract_type or 'foreign' }}" data-salary="{{ employee.basic_salary or 0 }}" data-national-balance="{{ employee.has_national_balance or 'false' }}">
                                            {{ employee.name }} ({{ employee.employee_id }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="employee_info" class="form-label">معلومات الموظف</label>
                                    <div id="employee_info" class="form-control" style="min-height: 38px; background-color: #f8f9fa;">
                                        اختر موظفًا لعرض المعلومات
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <h5 class="mb-3">حساب الرسوم</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="calculation_period" class="form-label">فترة الحساب</label>
                                    <select class="form-select" id="calculation_period" name="calculation_period">
                                        <option value="monthly">شهري</option>
                                        <option value="quarterly">ربع سنوي</option>
                                        <option value="semiannual">نصف سنوي</option>
                                        <option value="annual" selected>سنوي</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="has_national_balance" name="has_national_balance">
                                        <label class="form-check-label" for="has_national_balance">
                                            يستفيد من التوازن الوطني (تخفيض الرسوم إلى 700 ريال)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="government-fees-sections">
                            <!-- مكتب العمل (المقابل المالي) -->
                            <div class="section-card mb-3">
                                <div class="section-header">
                                    <h6 class="mb-2">مكتب العمل (المقابل المالي)</h6>
                                </div>
                                <div class="section-body">
                                    <div class="form-check">
                                        <input class="form-check-input fee-option-checkbox" type="checkbox" id="include_labor_office" name="include_labor_office" data-fee-type="labor_office" checked>
                                        <label class="form-check-label" for="include_labor_office">
                                            احتساب رسوم مكتب العمل
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        800 ريال شهريًا للموظف الوافد أو 700 ريال مع التوازن الوطني
                                    </small>
                                </div>
                            </div>
                            
                            <!-- الجوازات (الإقامة) -->
                            <div class="section-card mb-3">
                                <div class="section-header">
                                    <h6 class="mb-2">الجوازات (الإقامة)</h6>
                                </div>
                                <div class="section-body">
                                    <div class="form-check">
                                        <input class="form-check-input fee-option-checkbox" type="checkbox" id="include_passport" name="include_passport" data-fee-type="passport" checked>
                                        <label class="form-check-label" for="include_passport">
                                            احتساب رسوم الإقامة
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        650 ريال سنويًا للموظف الوافد
                                    </small>
                                </div>
                            </div>
                            
                            <!-- التأمين الطبي -->
                            <div class="section-card mb-3">
                                <div class="section-header">
                                    <h6 class="mb-2">التأمين الطبي</h6>
                                </div>
                                <div class="section-body">
                                    <div class="form-check">
                                        <input class="form-check-input fee-option-checkbox" type="checkbox" id="include_insurance" name="include_insurance" data-fee-type="insurance" checked>
                                        <label class="form-check-label" for="include_insurance">
                                            احتساب رسوم التأمين الطبي
                                        </label>
                                    </div>
                                    <div class="mt-2">
                                        <label class="form-label small">مستوى التأمين</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="insurance_level" id="insurance_basic" value="basic" checked>
                                            <label class="form-check-label" for="insurance_basic">
                                                أساسي (400 ريال سنويًا)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="insurance_level" id="insurance_medium" value="medium">
                                            <label class="form-check-label" for="insurance_medium">
                                                متوسط (900 ريال سنويًا)
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="insurance_level" id="insurance_high" value="high">
                                            <label class="form-check-label" for="insurance_high">
                                                متميز (1500 ريال سنويًا)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- التأمينات الاجتماعية -->
                            <div class="section-card mb-3">
                                <div class="section-header">
                                    <h6 class="mb-2">التأمينات الاجتماعية</h6>
                                </div>
                                <div class="section-body">
                                    <div class="form-check">
                                        <input class="form-check-input fee-option-checkbox" type="checkbox" id="include_social_insurance" name="include_social_insurance" data-fee-type="social_insurance" checked>
                                        <label class="form-check-label" for="include_social_insurance">
                                            احتساب رسوم التأمينات الاجتماعية
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        للموظف السعودي: 22% من الراتب الأساسي (12% على صاحب العمل و 10% على الموظف)<br>
                                        للموظف الوافد: 2% من الراتب الأساسي (على صاحب العمل)
                                    </small>
                                </div>
                            </div>
                            
                            <!-- رسوم أخرى -->
                            <div class="section-card mb-3">
                                <div class="section-header">
                                    <h6 class="mb-2">رسوم أخرى</h6>
                                </div>
                                <div class="section-body">
                                    <div class="form-check">
                                        <input class="form-check-input fee-option-checkbox" type="checkbox" id="include_other" name="include_other" data-fee-type="other">
                                        <label class="form-check-label" for="include_other">
                                            إضافة رسوم أخرى
                                        </label>
                                    </div>
                                    <div class="other-fee-inputs mt-2 d-none">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="other_fee_amount" class="form-label small">
                                                    <span class="required-asterisk">*</span>
                                                    مبلغ الرسوم
                                                </label>
                                                <input type="number" class="form-control" id="other_fee_amount" name="other_fee_amount" min="0" step="0.01">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="other_fee_description" class="form-label small">وصف الرسوم</label>
                                                <input type="text" class="form-control" id="other_fee_description" name="other_fee_description" placeholder="وصف الرسوم الأخرى">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- حقل مخفي لتخزين نوع الرسوم المحددة -->
                        <input type="hidden" id="fee_type" name="fee_type" value="">
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button type="button" id="calculate-button" class="btn btn-calculate w-100">
                                    <i class="fas fa-calculator me-1"></i>
                                    احتساب الرسوم
                                </button>
                            </div>
                        </div>
                        
                        <div class="row mb-3 d-none" id="download-excel-row">
                            <div class="col-md-12">
                                <button type="button" id="download-excel-button" class="btn btn-secondary w-100">
                                    <i class="fas fa-file-excel me-1"></i>
                                    تنزيل البيانات بصيغة إكسل
                                </button>
                            </div>
                        </div>
                        
                        <!-- حقل مخفي لتخزين المبلغ المحسوب -->
                        <input type="hidden" id="amount" name="amount" value="">
                        
                        <div id="calculation-result" class="calculation-result d-none">
                            <h5 class="text-center mb-3">نتيجة احتساب الرسوم</h5>
                            <div class="result-value" id="result-amount">0.00 ريال</div>
                            <div class="result-details">
                                <div class="detail-item">
                                    <div class="detail-label">نوع الرسوم:</div>
                                    <div class="detail-value" id="result-fee-type">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">الموظف:</div>
                                    <div class="detail-value" id="result-employee">-</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">الفترة:</div>
                                    <div class="detail-value" id="result-period">-</div>
                                </div>
                                <div class="detail-item" id="detail-national-balance" style="display: none;">
                                    <div class="detail-label">التوازن الوطني:</div>
                                    <div class="detail-value" id="result-national-balance">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- قسم الحفظ والمعلومات المالية -->
                        <div id="fee-details-section" class="d-none">
                            <h5 class="mb-3 mt-4">معلومات الرسوم والسداد</h5>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="fee_date" class="form-label">تاريخ الرسوم</label>
                                    <input type="date" class="form-control" id="fee_date" name="fee_date" value="{{ today }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="due_date" class="form-label">تاريخ الاستحقاق</label>
                                    <input type="date" class="form-control" id="due_date" name="due_date" value="{{ due_date }}">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="payment_status" class="form-label">حالة السداد</label>
                                    <select class="form-select" id="payment_status" name="payment_status">
                                        <option value="pending" selected>قيد الانتظار</option>
                                        <option value="paid">تم السداد</option>
                                        <option value="overdue">متأخر</option>
                                        <option value="canceled">ملغي</option>
                                    </select>
                                </div>
                                <div class="col-md-6 payment-details d-none">
                                    <label for="payment_date" class="form-label">تاريخ السداد</label>
                                    <input type="date" class="form-control" id="payment_date" name="payment_date" value="{{ today }}">
                                </div>
                            </div>
                            <div class="row mb-3 payment-details d-none">
                                <div class="col-md-6">
                                    <label for="payment_method" class="form-label">طريقة السداد</label>
                                    <select class="form-select" id="payment_method" name="payment_method">
                                        <option value="bank_transfer" selected>تحويل بنكي</option>
                                        <option value="cash">نقدا</option>
                                        <option value="check">شيك</option>
                                        <option value="credit_card">بطاقة ائتمان</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="reference_number" class="form-label">رقم المرجع</label>
                                    <input type="text" class="form-control" id="reference_number" name="reference_number" placeholder="رقم المرجع الخاص بالمعاملة">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="notes" class="form-label">ملاحظات</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="ملاحظات إضافية بخصوص الرسوم"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12 text-end">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>
                                        حفظ الرسوم
                                    </button>
                                    <a href="{{ url_for('government_fees.index') }}" class="btn btn-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        إلغاء
                                    </a>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        معلومات الرسوم الحكومية
                    </h5>
                </div>
                <div class="card-body">
                    <p>يمكنك من خلال هذه الصفحة احتساب مختلف أنواع الرسوم الحكومية المطلوبة للموظفين، مثل:</p>
                    <ul>
                        <li>المقابل المالي لمكتب العمل (800 ريال شهريًا للموظف الوافد)</li>
                        <li>رسوم الإقامة (650 ريال سنويًا للموظف الوافد)</li>
                        <li>رسوم التأمين الطبي (تختلف حسب مستوى التأمين)</li>
                        <li>رسوم التأمينات الاجتماعية (22% للسعوديين، 2% للوافدين)</li>
                    </ul>
                    <div class="alert alert-info">
                        <i class="fas fa-lightbulb me-2"></i>
                        يمكنك تحديد أكثر من نوع للرسوم واحتسابها معًا.
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        تأكد من صحة بيانات الموظف قبل احتساب الرسوم.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/government_fees.js') }}"></script>
{% endblock %}