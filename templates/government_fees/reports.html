{% extends 'layout.html' %}

{% block title %}تقارير الرسوم الحكومية{% endblock %}

{% block styles %}
<style>
    .report-card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        margin-bottom: 20px;
        height: 100%;
    }
    
    .report-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .report-card .card-header {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 15px 20px;
        font-weight: bold;
    }
    
    .report-card .card-body {
        padding: 20px;
    }
    
    .report-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #3b82f6;
    }
    
    .report-title {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .report-description {
        color: #6b7280;
        margin-bottom: 20px;
        min-height: 60px;
    }
    
    .report-actions {
        display: flex;
        justify-content: center;
        margin-top: auto;
    }
    
    .filter-card {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .report-preview {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .preview-title {
        font-weight: bold;
        margin-bottom: 10px;
        color: #1e40af;
    }
    
    .preview-table {
        width: 100%;
    }
    
    .preview-table th {
        background-color: #e5e7eb;
        padding: 8px;
        text-align: center;
    }
    
    .preview-table td {
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .custom-select-wrapper {
        position: relative;
    }
    
    .custom-select-wrapper::after {
        content: '\f078';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
    }
    
    .report-tab {
        background-color: #f8f9fa;
        border-radius: 10px 10px 0 0;
        padding: 10px 20px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .report-tab.active {
        background-color: #3b82f6;
        color: white;
    }
    
    .report-container {
        background-color: white;
        border-radius: 0 10px 10px 10px;
        padding: 20px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>
                    <i class="fas fa-chart-bar me-2"></i>
                    تقارير الرسوم الحكومية
                </h1>
                <div>
                    <a href="{{ url_for('government_fees.index') }}" class="btn btn-primary">
                        <i class="fas fa-list"></i> قائمة الرسوم
                    </a>
                    <a href="{{ url_for('government_fees.dashboard') }}" class="btn btn-info ms-2">
                        <i class="fas fa-tachometer-alt"></i> لوحة التحكم
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- قسم التبويبات -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex mb-3">
                <div class="report-tab active me-2" id="tab-standard-reports">التقارير القياسية</div>
                <div class="report-tab me-2" id="tab-custom-reports">التقارير المخصصة</div>
                <div class="report-tab" id="tab-export-data">تصدير البيانات</div>
            </div>
            
            <!-- محتوى التبويبات -->
            <div class="report-container" id="container-standard-reports">
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="report-card text-center">
                            <div class="card-header">
                                <i class="fas fa-calendar-check me-2"></i>
                                التقرير الشهري
                            </div>
                            <div class="card-body d-flex flex-column">
                                <div class="report-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="report-title">تقرير الرسوم الشهري</div>
                                <div class="report-description">
                                    ملخص شامل للرسوم الحكومية المستحقة والمدفوعة خلال شهر محدد.
                                </div>
                                <div class="form-group mb-3">
                                    <label for="monthly-report-year" class="form-label">السنة</label>
                                    <select class="form-select" id="monthly-report-year">
                                        <option value="2025" selected>2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="monthly-report-month" class="form-label">الشهر</label>
                                    <select class="form-select" id="monthly-report-month">
                                        <option value="1">يناير</option>
                                        <option value="2">فبراير</option>
                                        <option value="3">مارس</option>
                                        <option value="4" selected>أبريل</option>
                                        <option value="5">مايو</option>
                                        <option value="6">يونيو</option>
                                        <option value="7">يوليو</option>
                                        <option value="8">أغسطس</option>
                                        <option value="9">سبتمبر</option>
                                        <option value="10">أكتوبر</option>
                                        <option value="11">نوفمبر</option>
                                        <option value="12">ديسمبر</option>
                                    </select>
                                </div>
                                <div class="report-actions mt-auto">
                                    <button type="button" class="btn btn-primary" id="btn-generate-monthly-report">
                                        <i class="fas fa-file-excel me-1"></i>
                                        إنشاء التقرير
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="report-card text-center">
                            <div class="card-header">
                                <i class="fas fa-calendar me-2"></i>
                                التقرير السنوي
                            </div>
                            <div class="card-body d-flex flex-column">
                                <div class="report-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="report-title">تقرير الرسوم السنوي</div>
                                <div class="report-description">
                                    نظرة شاملة على الرسوم الحكومية المدفوعة والمستحقة خلال سنة كاملة.
                                </div>
                                <div class="form-group mb-3">
                                    <label for="yearly-report-year" class="form-label">السنة</label>
                                    <select class="form-select" id="yearly-report-year">
                                        <option value="2025" selected>2025</option>
                                        <option value="2024">2024</option>
                                        <option value="2023">2023</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label for="yearly-report-fee-type" class="form-label">نوع الرسوم (اختياري)</label>
                                    <select class="form-select" id="yearly-report-fee-type">
                                        <option value="" selected>جميع الأنواع</option>
                                        <option value="labor_office">مكتب العمل</option>
                                        <option value="passport">الجوازات</option>
                                        <option value="insurance">التأمين الطبي</option>
                                        <option value="social_insurance">التأمينات الاجتماعية</option>
                                        <option value="other">رسوم أخرى</option>
                                    </select>
                                </div>
                                <div class="report-actions mt-auto">
                                    <button type="button" class="btn btn-primary" id="btn-generate-yearly-report">
                                        <i class="fas fa-file-excel me-1"></i>
                                        إنشاء التقرير
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4 mb-4">
                        <div class="report-card text-center">
                            <div class="card-header">
                                <i class="fas fa-user me-2"></i>
                                تقرير الموظف
                            </div>
                            <div class="card-body d-flex flex-column">
                                <div class="report-icon">
                                    <i class="fas fa-user-circle"></i>
                                </div>
                                <div class="report-title">تقرير رسوم الموظف</div>
                                <div class="report-description">
                                    عرض تفصيلي لجميع الرسوم الحكومية المرتبطة بموظف محدد.
                                </div>
                                <div class="form-group mb-3">
                                    <label for="employee-report-employee" class="form-label">الموظف</label>
                                    <select class="form-select" id="employee-report-employee">
                                        <option value="" selected disabled>اختر الموظف</option>
                                        <!-- سيتم تعبئة هذه القائمة ديناميكيًا -->
                                    </select>
                                </div>
                                <div class="report-actions mt-auto">
                                    <button type="button" class="btn btn-primary" id="btn-generate-employee-report" disabled>
                                        <i class="fas fa-file-excel me-1"></i>
                                        إنشاء التقرير
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="report-container d-none" id="container-custom-reports">
                <div class="row">
                    <div class="col-md-4">
                        <div class="filter-card">
                            <h5 class="mb-4">معايير التقرير المخصص</h5>
                            <form id="custom-report-form">
                                <div class="mb-3">
                                    <label for="custom-fee-type" class="form-label">نوع الرسوم</label>
                                    <select class="form-select" id="custom-fee-type" name="fee_type">
                                        <option value="" selected>جميع الأنواع</option>
                                        <option value="labor_office">مكتب العمل</option>
                                        <option value="passport">الجوازات</option>
                                        <option value="insurance">التأمين الطبي</option>
                                        <option value="social_insurance">التأمينات الاجتماعية</option>
                                        <option value="transfer_sponsorship">نقل كفالة</option>
                                        <option value="other">رسوم أخرى</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="custom-payment-status" class="form-label">حالة السداد</label>
                                    <select class="form-select" id="custom-payment-status" name="payment_status">
                                        <option value="" selected>جميع الحالات</option>
                                        <option value="pending">قيد الانتظار</option>
                                        <option value="paid">مدفوع</option>
                                        <option value="overdue">متأخر</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="custom-department" class="form-label">القسم</label>
                                    <select class="form-select" id="custom-department" name="department_id">
                                        <option value="" selected>جميع الأقسام</option>
                                        <!-- سيتم تعبئة هذه القائمة ديناميكيًا -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="custom-date-range" class="form-label">الفترة الزمنية</label>
                                    <select class="form-select" id="custom-date-range" name="date_range">
                                        <option value="all" selected>جميع الفترات</option>
                                        <option value="current_month">الشهر الحالي</option>
                                        <option value="current_year">العام الحالي</option>
                                        <option value="last_three_months">آخر 3 شهور</option>
                                        <option value="last_six_months">آخر 6 شهور</option>
                                        <option value="custom">فترة مخصصة</option>
                                    </select>
                                </div>
                                <div class="date-range-custom d-none">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="custom-date-from" class="form-label">من تاريخ</label>
                                            <input type="date" class="form-control" id="custom-date-from" name="date_from">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="custom-date-to" class="form-label">إلى تاريخ</label>
                                            <input type="date" class="form-control" id="custom-date-to" name="date_to">
                                        </div>
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-primary" id="btn-preview-custom-report">
                                        <i class="fas fa-eye me-1"></i>
                                        معاينة التقرير
                                    </button>
                                    <button type="button" class="btn btn-success" id="btn-generate-custom-report">
                                        <i class="fas fa-file-excel me-1"></i>
                                        إنشاء التقرير
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-eye me-2"></i>
                                    معاينة التقرير
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="report-preview-container">
                                    <div class="text-center p-5">
                                        <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                                        <p class="mb-0">اختر معايير التقرير واضغط على زر "معاينة التقرير" لعرض البيانات.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="report-container d-none" id="container-export-data">
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            يمكنك تصدير جميع بيانات الرسوم الحكومية إلى ملف Excel للاستخدام في برامج أخرى.
                        </div>
                        
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-export me-2"></i>
                                    تصدير البيانات
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="export-format" class="form-label">صيغة التصدير</label>
                                            <select class="form-select" id="export-format">
                                                <option value="excel" selected>Excel (XLSX)</option>
                                                <option value="csv">CSV</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="export-content" class="form-label">محتوى التصدير</label>
                                            <select class="form-select" id="export-content">
                                                <option value="all" selected>جميع البيانات</option>
                                                <option value="current_year">بيانات العام الحالي</option>
                                                <option value="pending">الرسوم قيد الانتظار فقط</option>
                                                <option value="paid">الرسوم المدفوعة فقط</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center mt-4">
                                    <button type="button" class="btn btn-primary btn-lg" id="btn-export-data">
                                        <i class="fas fa-download me-2"></i>
                                        تصدير البيانات
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ===== التبديل بين التبويبات =====
    const tabs = {
        'tab-standard-reports': 'container-standard-reports',
        'tab-custom-reports': 'container-custom-reports',
        'tab-export-data': 'container-export-data'
    };
    
    Object.keys(tabs).forEach(tabId => {
        document.getElementById(tabId).addEventListener('click', function() {
            // تغيير التبويب النشط
            Object.keys(tabs).forEach(id => {
                document.getElementById(id).classList.remove('active');
                document.getElementById(tabs[id]).classList.add('d-none');
            });
            
            this.classList.add('active');
            document.getElementById(tabs[tabId]).classList.remove('d-none');
        });
    });
    
    // ===== تحميل بيانات الموظفين والأقسام =====
    async function loadEmployees() {
        try {
            const response = await fetch('/api/employees');
            const employees = await response.json();
            
            const employeeSelect = document.getElementById('employee-report-employee');
            employeeSelect.innerHTML = '<option value="" selected disabled>اختر الموظف</option>';
            
            employees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee.id;
                option.textContent = `${employee.name} (${employee.employee_id})`;
                employeeSelect.appendChild(option);
            });
            
            // تفعيل زر إنشاء تقرير الموظف عند اختيار موظف
            employeeSelect.addEventListener('change', function() {
                document.getElementById('btn-generate-employee-report').disabled = !this.value;
            });
        } catch (error) {
            console.error('Error loading employees:', error);
        }
    }
    
    async function loadDepartments() {
        try {
            const response = await fetch('/api/departments');
            const departments = await response.json();
            
            const departmentSelect = document.getElementById('custom-department');
            departmentSelect.innerHTML = '<option value="" selected>جميع الأقسام</option>';
            
            departments.forEach(department => {
                const option = document.createElement('option');
                option.value = department.id;
                option.textContent = department.name;
                departmentSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error loading departments:', error);
        }
    }
    
    // تحميل البيانات
    loadEmployees();
    loadDepartments();
    
    // ===== تغيير الفترة الزمنية =====
    document.getElementById('custom-date-range').addEventListener('change', function() {
        const dateRangeCustom = document.querySelector('.date-range-custom');
        
        if (this.value === 'custom') {
            dateRangeCustom.classList.remove('d-none');
        } else {
            dateRangeCustom.classList.add('d-none');
        }
    });
    
    // ===== معالجة إنشاء التقارير =====
    // التقرير الشهري
    document.getElementById('btn-generate-monthly-report').addEventListener('click', function() {
        const year = document.getElementById('monthly-report-year').value;
        const month = document.getElementById('monthly-report-month').value;
        
        window.location.href = `/government-fees/reports/monthly?year=${year}&month=${month}`;
    });
    
    // التقرير السنوي
    document.getElementById('btn-generate-yearly-report').addEventListener('click', function() {
        const year = document.getElementById('yearly-report-year').value;
        const feeType = document.getElementById('yearly-report-fee-type').value;
        
        let url = `/government-fees/reports/yearly?year=${year}`;
        if (feeType) {
            url += `&fee_type=${feeType}`;
        }
        
        window.location.href = url;
    });
    
    // تقرير الموظف
    document.getElementById('btn-generate-employee-report').addEventListener('click', function() {
        const employeeId = document.getElementById('employee-report-employee').value;
        
        if (employeeId) {
            window.location.href = `/government-fees/reports/employee/${employeeId}`;
        }
    });
    
    // ===== معالجة التقرير المخصص =====
    document.getElementById('btn-preview-custom-report').addEventListener('click', function() {
        // جمع بيانات النموذج
        const feeType = document.getElementById('custom-fee-type').value;
        const paymentStatus = document.getElementById('custom-payment-status').value;
        const departmentId = document.getElementById('custom-department').value;
        const dateRange = document.getElementById('custom-date-range').value;
        
        let dateFrom = null;
        let dateTo = null;
        
        if (dateRange === 'custom') {
            dateFrom = document.getElementById('custom-date-from').value;
            dateTo = document.getElementById('custom-date-to').value;
        }
        
        // بناء URL للاستعلام
        let url = '/government-fees/reports/preview?';
        if (feeType) url += `fee_type=${feeType}&`;
        if (paymentStatus) url += `payment_status=${paymentStatus}&`;
        if (departmentId) url += `department_id=${departmentId}&`;
        if (dateRange) url += `date_range=${dateRange}&`;
        if (dateFrom) url += `date_from=${dateFrom}&`;
        if (dateTo) url += `date_to=${dateTo}&`;
        
        // إرسال الطلب وعرض النتائج
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // عرض معاينة التقرير
                renderReportPreview(data);
            })
            .catch(error => {
                console.error('Error previewing report:', error);
                const previewContainer = document.getElementById('report-preview-container');
                previewContainer.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        حدث خطأ أثناء تحميل معاينة التقرير.
                    </div>
                `;
            });
    });
    
    // عرض معاينة التقرير
    function renderReportPreview(data) {
        const previewContainer = document.getElementById('report-preview-container');
        
        if (!data || data.length === 0) {
            previewContainer.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    لا توجد بيانات مطابقة للمعايير المحددة.
                </div>
            `;
            return;
        }
        
        // إنشاء معاينة للتقرير
        let html = `
            <div class="report-preview">
                <div class="preview-title">معاينة التقرير (${data.length} سجل)</div>
                <div class="table-responsive">
                    <table class="preview-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الموظف</th>
                                <th>نوع الرسوم</th>
                                <th>المبلغ</th>
                                <th>حالة السداد</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        // تحويل أنواع الرسوم وحالات السداد
        const feeTypes = {
            'passport': 'الجوازات',
            'labor_office': 'مكتب العمل',
            'insurance': 'التأمين الطبي',
            'social_insurance': 'التأمينات الاجتماعية',
            'transfer_sponsorship': 'نقل كفالة',
            'other': 'أخرى'
        };
        
        const paymentStatuses = {
            'pending': 'قيد الانتظار',
            'paid': 'مدفوع',
            'overdue': 'متأخر'
        };
        
        // عرض أول 10 سجلات فقط
        const previewData = data.slice(0, 10);
        
        // إضافة الصفوف
        previewData.forEach((fee, index) => {
            html += `
                <tr>
                    <td>${index + 1}</td>
                    <td>${fee.employee_name}</td>
                    <td>${feeTypes[fee.fee_type] || fee.fee_type}</td>
                    <td>${fee.amount.toLocaleString('ar-SA')} ريال</td>
                    <td>${paymentStatuses[fee.payment_status] || fee.payment_status}</td>
                </tr>
            `;
        });
        
        // إكمال الجدول
        html += `
                        </tbody>
                    </table>
                </div>
            `;
        
        // إضافة ملخص
        const total = data.reduce((sum, fee) => sum + fee.amount, 0);
        
        html += `
                <div class="mt-3 d-flex justify-content-between">
                    <div>إجمالي المبلغ: <strong>${total.toLocaleString('ar-SA')} ريال</strong></div>
                    <div>إجمالي السجلات: <strong>${data.length}</strong></div>
                </div>
            </div>
        `;
        
        // عرض النتائج
        previewContainer.innerHTML = html;
    }
    
    // إنشاء التقرير المخصص
    document.getElementById('btn-generate-custom-report').addEventListener('click', function() {
        // جمع بيانات النموذج
        const feeType = document.getElementById('custom-fee-type').value;
        const paymentStatus = document.getElementById('custom-payment-status').value;
        const departmentId = document.getElementById('custom-department').value;
        const dateRange = document.getElementById('custom-date-range').value;
        
        let dateFrom = null;
        let dateTo = null;
        
        if (dateRange === 'custom') {
            dateFrom = document.getElementById('custom-date-from').value;
            dateTo = document.getElementById('custom-date-to').value;
        }
        
        // بناء URL للتصدير
        let url = '/government-fees/reports/custom?';
        if (feeType) url += `fee_type=${feeType}&`;
        if (paymentStatus) url += `payment_status=${paymentStatus}&`;
        if (departmentId) url += `department_id=${departmentId}&`;
        if (dateRange) url += `date_range=${dateRange}&`;
        if (dateFrom) url += `date_from=${dateFrom}&`;
        if (dateTo) url += `date_to=${dateTo}&`;
        
        window.location.href = url;
    });
    
    // تصدير البيانات
    document.getElementById('btn-export-data').addEventListener('click', function() {
        const format = document.getElementById('export-format').value;
        const content = document.getElementById('export-content').value;
        
        window.location.href = `/government-fees/export?format=${format}&content=${content}`;
    });
});
</script>
{% endblock %}