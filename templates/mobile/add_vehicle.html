{% extends 'mobile/layout.html' %}

{% block title %}إضافة سيارة جديدة{% endblock %}
{% block header_title %}إضافة سيارة جديدة{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-add-vehicle-premium.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<!-- نموذج إضافة سيارة بتصميم مميز -->
<div class="mobile-card">
  <div class="mobile-card-header">
    <h1 class="mobile-card-title">
      <i class="fas fa-plus-circle" style="margin-left: 8px;"></i>
      إضافة سيارة جديدة
    </h1>
    <p class="mobile-card-subtitle">املأ البيانات أدناه لإضافة سيارة جديدة إلى النظام</p>
  </div>
  
  <div class="mobile-card-body">
      <form method="post" action="{{ url_for('mobile.add_vehicle') }}" enctype="multipart/form-data" id="vehicleForm">
        {{ form.csrf_token if form and form.csrf_token }}
        
        <!-- بيانات السيارة الأساسية -->
        <div class="mobile-form-section">
          <h3 class="mobile-form-section-title">
            <i class="fas fa-car" style="margin-left: 8px; color: #667eea;"></i>
            بيانات السيارة الأساسية
          </h3>
          
          <div class="mobile-form-group">
            <label class="mobile-form-label required">رقم اللوحة</label>
            <input type="text" class="mobile-form-input" name="plate_number" required placeholder="أدخل رقم لوحة السيارة بالكامل">
          </div>
          
          <div class="mobile-form-group">
            <label class="mobile-form-label required">الشركة المصنعة</label>
            <input type="text" class="mobile-form-input" name="make" required placeholder="مثال: تويوتا، هيونداي، نيسان">
          </div>
          
          <div class="mobile-form-row">
            <div class="mobile-form-group">
              <label class="mobile-form-label required">الموديل</label>
              <input type="text" class="mobile-form-input" name="model" required placeholder="مثال: كامري، كورولا، إلنترا">
            </div>
            
            <div class="mobile-form-group">
              <label class="mobile-form-label required">نوع السيارة</label>
              <select class="mobile-form-select" name="type_of_car" required>
                <option value="" disabled selected>اختر نوع السيارة</option>
                <option value="سيدان">سيدان</option>
                <option value="قاطرة">قاطرة</option>
                <option value="باص">باص</option>
                <option value="نقل خفيف">نقل خفيف</option>
                <option value="نقل ثقيل">نقل ثقيل</option>
                <option value="شاحنة صغيرة">شاحنة صغيرة</option>
                <option value="شاحنة كبيرة">شاحنة كبيرة</option>
                <option value="معدات ثقيلة">معدات ثقيلة</option>
                <option value="مقطورة">مقطورة</option>
                <option value="دباب">دباب</option>
                <option value="كرين">كرين</option>
                <option value="حفار">حفار</option>
              </select>
            </div>
          </div>
          
          <div class="mobile-form-row">
            <div class="mobile-form-group">
              <label class="mobile-form-label required">سنة الصنع</label>
              <input type="number" class="mobile-form-input" name="year" min="1990" max="2030" required placeholder="مثال: 2025">
            </div>
            
            <div class="mobile-form-group">
              <label class="mobile-form-label required">اللون</label>
              <input type="text" class="mobile-form-input" name="color" required placeholder="مثال: أبيض، أسود، فضي">
            </div>
          </div>
          
          <div class="mobile-form-group">
            <label class="mobile-form-label">اسم السائق</label>
            <input type="text" class="mobile-form-input" name="driver_name" placeholder="اختياري - اسم السائق المعين لهذه السيارة">
          </div>
        </div>
        
        <!-- حالة السيارة والمشروع -->
        <div class="mobile-form-section">
          <h3 class="mobile-form-section-title">
            <i class="fas fa-cogs" style="margin-left: 8px; color: #764ba2;"></i>
            حالة السيارة والمشروع
          </h3>
          
          <div class="mobile-form-row">
            <div class="mobile-form-group">
              <label class="mobile-form-label required">الحالة</label>
              <select class="mobile-form-select" name="status" required>
                <option value="available">متاحة</option>
                <option value="rented">مؤجرة</option>
                <option value="in_project">في المشروع</option>
                <option value="in_workshop">في الورشة</option>
                <option value="accident">حادث</option>
                <option value="out_of_service">خارج الخدمة</option>
              </select>
            </div>
            
            <div class="mobile-form-group">
              <label class="mobile-form-label">المشروع</label>
              <select class="mobile-form-select" name="project">
                <option value="">اختر المشروع</option>
                {% for department in departments %}
                <option value="{{ department.name }}">{{ department.name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>
        
        <!-- ملاحظات -->
        <div class="mobile-form-section">
          <h3 class="mobile-form-section-title">
            <i class="fas fa-sticky-note" style="margin-left: 8px; color: #f093fb;"></i>
            ملاحظات
          </h3>
          
          <div class="mobile-form-group">
            <label class="mobile-form-label">ملاحظات</label>
            <textarea class="mobile-form-textarea" name="notes" rows="3" placeholder="أدخل أي ملاحظات إضافية عن السيارة"></textarea>
          </div>
        </div>
        
        <div class="mobile-form-actions">
          <button type="submit" class="mobile-btn mobile-btn-primary">
            <i class="fas fa-save"></i>
            حفظ السيارة
          </button>
          <a href="{{ url_for('mobile.vehicles') }}" class="mobile-btn mobile-btn-secondary">
            <i class="fas fa-arrow-right"></i>
            العودة للقائمة
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
  .mobile-form-file {
    position: relative;
    margin-bottom: 16px;
  }
  
  .mobile-form-file-input {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }
  
  .mobile-form-file-label {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 10px 16px;
    background-color: var(--card-bg);
    border: 1px dashed var(--border-color);
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--transition-normal);
  }
  
  .mobile-form-file-label:hover {
    border-color: var(--primary-color);
    color: var(--primary-color);
  }
  
  .mobile-form-file-preview {
    margin-top: 8px;
    width: 100%;
    height: 150px;
    background-color: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: var(--border-radius);
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--text-muted);
  }
  
  .mobile-form-file-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .mobile-form-section {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border-light);
  }
  
  .mobile-form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }
  
  .mobile-form-section-title {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-medium);
    margin-bottom: 16px;
    color: var(--text-primary);
  }
  
  .mobile-form-row {
    display: flex;
    gap: 16px;
  }
  
  .mobile-form-row .mobile-form-group {
    flex: 1;
  }
  
  /* Required field styling */
  .mobile-form-label.required::after {
    content: '*';
    color: #dc3545;
    margin-left: 0.25rem;
    font-weight: bold;
  }
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/image-compression.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تطبيق ضغط الصور على جميع حقول رفع الملفات
    applyImageCompression('input[type="file"]', {
        maxWidth: 1024,
        maxHeight: 1024,
        quality: 0.8,
        maxFileSize: 2 * 1024 * 1024, // 2MB
        outputFormat: 'image/jpeg'
    });
    
    // معاينة الصورة قبل الرفع (للعناصر الموجودة)
    const vehicleImageInput = document.getElementById('vehicleImage');
    const imagePreview = document.getElementById('imagePreview');
    
    if (vehicleImageInput && imagePreview) {
        vehicleImageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    imagePreview.innerHTML = `<img src="${e.target.result}" alt="معاينة الصورة" style="max-width: 100%; border-radius: 8px;">`;
                };
                
                reader.readAsDataURL(file);
            } else {
                imagePreview.innerHTML = '';
            }
        });
    }
    
    // تحسين تجربة إرسال النموذج
    const form = document.getElementById('vehicleForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const submitButtons = document.querySelectorAll('button[type="submit"], input[type="submit"]');
            submitButtons.forEach(button => {
                button.disabled = true;
                if (button.innerHTML) {
                    button.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="
                                width: 16px;
                                height: 16px;
                                border: 2px solid transparent;
                                border-top: 2px solid white;
                                border-radius: 50%;
                                animation: spin 1s linear infinite;
                            "></div>
                            جاري الحفظ...
                        </div>
                    `;
                }
            });
        });
    }
    
    // إضافة تحذيرات للملفات الكبيرة
    const fileInputs = document.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.addEventListener('change', function() {
            const files = Array.from(this.files);
            const largeFiles = files.filter(file => file.size > 5 * 1024 * 1024); // أكبر من 5MB
            
            if (largeFiles.length > 0) {
                showCompressionNotice('الملفات المحددة كبيرة الحجم وسيتم ضغطها تلقائياً لتحسين الأداء.');
            }
        });
    });
});

// دالة عرض إشعار الضغط
function showCompressionNotice(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        z-index: 10001;
        font-size: 0.9rem;
        text-align: center;
        backdrop-filter: blur(10px);
        animation: slideDown 0.3s ease-out;
    `;
    notification.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
            <i class="fas fa-compress-alt"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideUp 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
    }, 4000);
}

// إضافة CSS للرسوم المتحركة
const style = document.createElement('style');
style.textContent = `
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideUp {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-20px); }
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}