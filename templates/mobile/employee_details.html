{% extends 'mobile/layout.html' %}

{% block title %}{{ employee.name }} - نظام إدارة الموظفين{% endblock %}

{% block header_title %}تفاصيل الموظف{% endblock %}

{% block header_actions %}
<button class="mobile-menu-button" aria-label="تعديل" onclick="location.href='{{ url_for('mobile.edit_employee', employee_id=employee.id) }}'">
    <i class="fas fa-edit"></i>
</button>
{% endblock %}

{% block content %}
<!-- معلومات الموظف -->
<div class="mobile-card">
    <div class="profile-header">
        <div class="profile-avatar">
            {% if employee.profile_image %}
            <img src="{{ url_for('static', filename=employee.profile_image) }}" alt="{{ employee.name }}" class="profile-img">
            {% else %}
            <i class="fas fa-user"></i>
            {% endif %}
        </div>
        <h2 class="profile-name">{{ employee.name }}</h2>
        <p class="profile-position">{{ employee.job_title }}</p>
    </div>
    
    <div class="mobile-card-content">
        <div class="info-group">
            <div class="info-label">الرقم الوظيفي</div>
            <div class="info-value">{{ employee.employee_id }}</div>
        </div>
        
        <div class="info-group">
            <div class="info-label">القسم</div>
            <div class="info-value">{{ employee.department.name if employee.department else 'غير محدد' }}</div>
        </div>
        
        <div class="info-group">
            <div class="info-label">رقم الجوال</div>
            <div class="info-value">
                {% if employee.mobile %}
                <a href="tel:{{ employee.mobile }}" class="phone-link">
                    <i class="fas fa-phone"></i> {{ employee.mobile }}
                </a>
                {% else %}
                <span class="text-muted">غير متوفر</span>
                {% endif %}
            </div>
        </div>
        
        {% if employee.mobilePersonal %}
        <div class="info-group">
            <div class="info-label">الجوال الشخصي</div>
            <div class="info-value">
                <a href="tel:{{ employee.mobilePersonal }}" class="phone-link">
                    <i class="fas fa-mobile-alt"></i> {{ employee.mobilePersonal }}
                </a>
            </div>
        </div>
        {% endif %}
        
        <div class="info-group">
            <div class="info-label">البريد الإلكتروني</div>
            <div class="info-value">
                {% if employee.email %}
                <a href="mailto:{{ employee.email }}" class="email-link">{{ employee.email }}</a>
                {% else %}
                <span class="text-muted">غير متوفر</span>
                {% endif %}
            </div>
        </div>
        
        <div class="info-group">
            <div class="info-label">تاريخ التعيين</div>
            <div class="info-value">
                {% if employee.hire_date %}
                {{ employee.hire_date.strftime('%Y-%m-%d') }}
                {% else %}
                <span class="text-muted">غير متوفر</span>
                {% endif %}
            </div>
        </div>
        
        <div class="info-group">
            <div class="info-label">الجنسية</div>
            <div class="info-value">{{ employee.nationality or 'غير محدد' }}</div>
        </div>
        
        <div class="info-group">
            <div class="info-label">رقم الهوية</div>
            <div class="info-value">{{ employee.national_id or 'غير متوفر' }}</div>
        </div>
        
        {% if employee.national_id_image %}
        <div class="info-group" style="display: block;">
            <div class="info-label" style="margin-bottom: 10px;">صورة الهوية الوطنية</div>
            <div class="info-value">
                <img src="{{ url_for('static', filename=employee.national_id_image) }}" 
                     alt="الهوية الوطنية" 
                     class="national-id-img"
                     onclick="openImageModal(this.src)">
            </div>
        </div>
        {% endif %}
        
        <div class="info-group">
            <div class="info-label">الحالة</div>
            <div class="info-value">
                {% if employee.active %}
                <span class="badge bg-success">نشط</span>
                {% else %}
                <span class="badge bg-danger">غير نشط</span>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- أقسام المعلومات الإضافية -->
<div class="mobile-tabs">
    <div class="mobile-tab-buttons">
        <button class="mobile-tab-button active" data-target="attendance-tab">الحضور</button>
        <button class="mobile-tab-button" data-target="salary-tab">الراتب</button>
        <button class="mobile-tab-button" data-target="documents-tab">الوثائق</button>
    </div>
    
    <!-- قسم الحضور -->
    <div id="attendance-tab" class="mobile-tab-content">
        <div class="mobile-card">
            <div class="mobile-card-title">
                <i class="fas fa-calendar-check"></i> سجل الحضور
            </div>
            
            <div class="mobile-card-content">
                {% if attendance_records %}
                <div class="mobile-table">
                    {% for record in attendance_records %}
                    <div class="mobile-table-row">
                        <div class="mobile-table-cell">{{ record.date }}</div>
                        <div class="mobile-table-cell">
                            {% if record.status == 'حاضر' %}
                            <span class="badge bg-success">حاضر</span>
                            {% elif record.status == 'غائب' %}
                            <span class="badge bg-danger">غائب</span>
                            {% elif record.status == 'إجازة' %}
                            <span class="badge bg-info">إجازة</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ record.status }}</span>
                            {% endif %}
                        </div>
                        <div class="mobile-table-cell">{{ record.check_in }}</div>
                        <div class="mobile-table-cell">{{ record.check_out }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <p class="text-secondary">لا توجد سجلات حضور</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- قسم الراتب -->
    <div id="salary-tab" class="mobile-tab-content" style="display: none;">
        <div class="mobile-card">
            <div class="mobile-card-title">
                <i class="fas fa-money-bill-wave"></i> معلومات الراتب
            </div>
            
            <div class="mobile-card-content">
                {% if salary %}
                <div class="info-group">
                    <div class="info-label">الراتب الأساسي</div>
                    <div class="info-value">{{ '{:,.2f}'.format(salary.basic_salary) }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">البدلات</div>
                    <div class="info-value">{{ '{:,.2f}'.format(salary.allowances) }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">المكافآت</div>
                    <div class="info-value">{{ '{:,.2f}'.format(salary.bonus) }}</div>
                </div>
                
                <div class="info-group">
                    <div class="info-label">الخصومات</div>
                    <div class="info-value">{{ '{:,.2f}'.format(salary.deductions) }}</div>
                </div>
                
                <div class="info-group total-salary">
                    <div class="info-label">صافي الراتب</div>
                    <div class="info-value">{{ '{:,.2f}'.format(salary.net_salary) }}</div>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <p class="text-secondary">لا توجد معلومات راتب</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- قسم الوثائق -->
    <div id="documents-tab" class="mobile-tab-content" style="display: none;">
        <div class="mobile-card">
            <div class="mobile-card-title">
                <i class="fas fa-file-alt"></i> الوثائق
            </div>
            
            <div class="mobile-card-content">
                {% if documents %}
                <div class="mobile-table">
                    {% for doc in documents %}
                    <div class="mobile-table-row">
                        <div class="mobile-table-cell">{{ doc.name }}</div>
                        <div class="mobile-table-cell">{{ doc.document_number }}</div>
                        <div class="mobile-table-cell">{{ doc.issue_date.strftime('%Y-%m-%d') }}</div>
                        <div class="mobile-table-cell">
                            {% if doc.expiry_date %}
                                {% if doc.expiry_date < current_date %}
                                <span class="badge bg-danger">منتهية</span>
                                {% elif (doc.expiry_date - current_date).days <= 30 %}
                                <span class="badge bg-warning">تنتهي قريباً</span>
                                {% else %}
                                <span class="badge bg-success">سارية</span>
                                {% endif %}
                            {% else %}
                            <span class="badge bg-secondary">غير محدد</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <p class="text-secondary">لا توجد وثائق</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="action-buttons">
    <a href="{{ url_for('mobile.employees') }}" class="mobile-btn mobile-btn-secondary">
        <i class="fas fa-arrow-right"></i> العودة للقائمة
    </a>
</div>

<!-- Modal لعرض الصورة -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
    <img class="image-modal-content" id="modalImage">
</div>

<style>
.profile-header {
    text-align: center;
    padding: 20px 0;
    border-bottom: 1px solid #eee;
}

.profile-avatar {
    width: 100px;
    height: 100px;
    background-color: #f0f0f0;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 auto 15px;
    overflow: hidden;
    border: 3px solid #fff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.profile-avatar i {
    font-size: 2.5rem;
    color: #757575;
}

.profile-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.profile-name {
    font-size: 1.5rem;
    margin-bottom: 5px;
}

.profile-position {
    color: #757575;
    margin-bottom: 0;
}

.info-group {
    display: flex;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
}

.info-group:last-child {
    border-bottom: none;
}

.info-label {
    flex: 1;
    font-weight: bold;
    color: #757575;
}

.info-value {
    flex: 2;
}

.phone-link, .email-link {
    color: var(--primary-color);
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.phone-link i {
    font-size: 0.9rem;
}

.national-id-img {
    width: 100%;
    max-width: 400px;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    cursor: pointer;
    transition: transform 0.2s;
}

.national-id-img:hover {
    transform: scale(1.02);
}

.image-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
    padding: 20px;
}

.image-modal-content {
    max-width: 90%;
    max-height: 90%;
    margin: auto;
    display: block;
    position: relative;
    top: 50%;
    transform: translateY(-50%);
}

.image-modal-close {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #fff;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
}

.total-salary {
    font-weight: bold;
    font-size: 1.1rem;
}

.mobile-tabs {
    margin-top: 15px;
}

.mobile-tab-buttons {
    display: flex;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin: 0 1rem 15px;
    overflow: hidden;
}

.mobile-tab-button {
    flex: 1;
    background: none;
    border: none;
    padding: 12px;
    font-size: 0.9rem;
    cursor: pointer;
    transition: background-color 0.2s;
}

.mobile-tab-button.active {
    background-color: var(--primary-color);
    color: white;
}

.action-buttons {
    margin: 20px 1rem;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // تفعيل التبديل بين علامات التبويب
    const tabButtons = document.querySelectorAll('.mobile-tab-button');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            
            // إزالة الفئة النشطة من جميع الأزرار
            tabButtons.forEach(btn => btn.classList.remove('active'));
            
            // إضافة الفئة النشطة للزر الحالي
            this.classList.add('active');
            
            // إخفاء جميع محتويات التبويب
            const tabContents = document.querySelectorAll('.mobile-tab-content');
            tabContents.forEach(content => content.style.display = 'none');
            
            // إظهار المحتوى المستهدف
            const targetContent = document.getElementById(targetId);
            if (targetContent) {
                targetContent.style.display = 'block';
            }
        });
    });
});

// فتح modal الصورة
function openImageModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    
    modal.style.display = 'block';
    modalImg.src = imageSrc;
    
    // منع التمرير في الخلفية
    document.body.style.overflow = 'hidden';
}

// إغلاق modal الصورة
function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
    
    // إعادة تفعيل التمرير
    document.body.style.overflow = 'auto';
}

// إغلاق modal عند الضغط على Escape
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endblock %}