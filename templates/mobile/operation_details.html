{% extends "mobile/layout.html" %}

{% block title %}تفاصيل العملية{% endblock %}

{% block content %}
<style>
/* تنسيق تفاصيل العملية المحمولة */
.operation-details-header {
    background: linear-gradient(135deg, #1e3a5c 0%, #2c5282 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}

.details-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    font-weight: 600;
    color: #333;
    flex: 1;
}

.detail-value {
    flex: 1;
    text-align: left;
    color: #666;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
}

.status-badge.pending {
    background: #fff3cd;
    color: #856404;
}

.status-badge.under_review {
    background: #d1ecf1;
    color: #0c5460;
}

.status-badge.approved {
    background: #d4edda;
    color: #155724;
}

.status-badge.rejected {
    background: #f8d7da;
    color: #721c24;
}

.priority-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.priority-badge.urgent {
    background: #dc3545;
    color: white;
}

.priority-badge.high {
    background: #ffc107;
    color: #212529;
}

.priority-badge.normal {
    background: #17a2b8;
    color: white;
}

.priority-badge.low {
    background: #6c757d;
    color: white;
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 20px;
}

.pdf-preview-btn {
    background: linear-gradient(45deg, #dc3545, #e85a6a);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 16px;
    text-decoration: none;
    text-align: center;
    font-weight: 500;
    transition: all 0.3s ease;
}

.pdf-preview-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    color: white;
    text-decoration: none;
}

.related-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}

.related-info h6 {
    color: #495057;
    margin-bottom: 12px;
}
</style>

<!-- Header -->
<div class="operation-details-header">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h5 class="mb-1">
                <i class="fas fa-eye me-2"></i>
                تفاصيل العملية
            </h5>
            <p class="mb-0 opacity-75">{{ operation.title or 'عملية بدون عنوان' }}</p>
        </div>
        <a href="{{ url_for('mobile.operations') }}" class="btn btn-light btn-sm">
            <i class="fas fa-arrow-right me-1"></i>
            عودة
        </a>
    </div>
</div>

<!-- معلومات العملية الأساسية -->
<div class="details-card">
    <h6 class="mb-3">
        <i class="fas fa-info-circle me-2"></i>
        المعلومات الأساسية
    </h6>
    
    <div class="detail-row">
        <span class="detail-label">العنوان:</span>
        <span class="detail-value">{{ operation.title or 'غير محدد' }}</span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">نوع العملية:</span>
        <span class="detail-value">
            {% if operation.operation_type == 'handover' %}تسليم/استلام
            {% elif operation.operation_type == 'workshop' %}ورشة
            {% elif operation.operation_type == 'safety_inspection' %}فحص سلامة
            {% elif operation.operation_type == 'external_authorization' %}تفويض خارجي
            {% else %}{{ operation.operation_type }}{% endif %}
        </span>
    </div>
    
    <div class="detail-row">
        <span class="detail-label">الحالة:</span>
        <span class="detail-value">
            <span class="status-badge {{ operation.status }}">
                {% if operation.status == 'pending' %}معلقة
                {% elif operation.status == 'under_review' %}تحت المراجعة
                {% elif operation.status == 'approved' %}موافق عليها
                {% elif operation.status == 'rejected' %}مرفوضة
                {% else %}{{ operation.status }}{% endif %}
            </span>
        </span>
    </div>
    
    {% if operation.priority %}
    <div class="detail-row">
        <span class="detail-label">الأولوية:</span>
        <span class="detail-value">
            <span class="priority-badge {{ operation.priority }}">
                {% if operation.priority == 'urgent' %}عاجل
                {% elif operation.priority == 'high' %}عالي
                {% elif operation.priority == 'normal' %}عادي
                {% elif operation.priority == 'low' %}منخفض
                {% else %}{{ operation.priority }}{% endif %}
            </span>
        </span>
    </div>
    {% endif %}
    
    <div class="detail-row">
        <span class="detail-label">تاريخ الطلب:</span>
        <span class="detail-value">
            {{ operation.requested_at.strftime('%Y/%m/%d %H:%M') if operation.requested_at else 'غير محدد' }}
        </span>
    </div>
    
    {% if operation.vehicle %}
    <div class="detail-row">
        <span class="detail-label">المركبة:</span>
        <span class="detail-value">
            <span class="badge bg-secondary">{{ operation.vehicle.plate_number }}</span>
            {{ operation.vehicle.make }} {{ operation.vehicle.model }}
        </span>
    </div>
    {% endif %}
    
    {% if operation.requester %}
    <div class="detail-row">
        <span class="detail-label">الطالب:</span>
        <span class="detail-value">{{ operation.requester.email or operation.requester.name or 'مستخدم' }}</span>
    </div>
    {% endif %}
</div>

<!-- الوصف -->
{% if operation.description %}
<div class="details-card">
    <h6 class="mb-3">
        <i class="fas fa-align-left me-2"></i>
        الوصف
    </h6>
    <p class="text-muted mb-0">{{ operation.description }}</p>
</div>
{% endif %}

<!-- الإجراءات والروابط -->
<div class="details-card">
    <h6 class="mb-3">
        <i class="fas fa-tools me-2"></i>
        الإجراءات المتاحة
    </h6>
    
    <div class="action-buttons">
        <!-- رابط عرض PDF للتسليم -->
        {% if operation.operation_type == 'handover' and operation.related_id %}
        <a href="{{ url_for('vehicles.handover_pdf_public', handover_id=operation.related_id) }}" 
           class="pdf-preview-btn" target="_blank">
            <i class="fas fa-file-pdf me-2"></i>
            عرض نموذج PDF
        </a>
        {% endif %}
        
        <!-- رابط تصدير Excel -->
        <a href="{{ url_for('operations.export_all_operations_excel') }}" 
           class="btn btn-success">
            <i class="fas fa-file-excel me-2"></i>
            تصدير Excel
        </a>
    </div>
</div>

<!-- معلومات السجل المرتبط -->
{% if operation.operation_type == 'handover' and operation.related_id %}
<div class="details-card">
    <h6 class="mb-3">
        <i class="fas fa-exchange-alt me-2"></i>
        معلومات التسليم/الاستلام
    </h6>
    
    <div class="related-info">
        <div class="detail-row">
            <span class="detail-label">رقم السجل:</span>
            <span class="detail-value">#{{ operation.related_id }}</span>
        </div>
        
        <div class="text-center mt-3">
            <a href="{{ url_for('vehicles.handover_pdf_public', handover_id=operation.related_id) }}" 
               class="btn btn-outline-danger btn-sm" target="_blank">
                <i class="fas fa-external-link-alt me-1"></i>
                عرض التفاصيل الكاملة
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- معلومات الموافقة/الرفض -->
{% if operation.status in ['approved', 'rejected'] %}
<div class="details-card">
    <h6 class="mb-3">
        <i class="fas fa-{{ 'check' if operation.status == 'approved' else 'times' }} me-2"></i>
        معلومات {{ 'الموافقة' if operation.status == 'approved' else 'الرفض' }}
    </h6>
    
    {% if operation.reviewed_at %}
    <div class="detail-row">
        <span class="detail-label">تاريخ المراجعة:</span>
        <span class="detail-value">{{ operation.reviewed_at.strftime('%Y/%m/%d %H:%M') }}</span>
    </div>
    {% endif %}
    
    {% if operation.review_notes %}
    <div class="detail-row">
        <span class="detail-label">ملاحظات:</span>
        <span class="detail-value">{{ operation.review_notes }}</span>
    </div>
    {% endif %}
</div>
{% endif %}

{% endblock %}