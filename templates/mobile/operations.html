{% extends "mobile/layout.html" %}

{% block title %}إدارة العمليات{% endblock %}

{% block content %}
<style>
/* تنسيق متقدم لصفحة إدارة العمليات */
.operations-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
}

.operations-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    text-align: center;
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

.stat-card.pending {
    border-left: 4px solid #ffc107;
}

.stat-card.under_review {
    border-left: 4px solid #17a2b8;
}

.stat-card.approved {
    border-left: 4px solid #28a745;
}

.stat-card.rejected {
    border-left: 4px solid #dc3545;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
}

.stat-label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}

.quick-actions {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.action-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.action-btn {
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.action-btn i {
    font-size: 24px;
}

.action-btn.primary {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
}

.action-btn.success {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.action-btn.info {
    background: linear-gradient(135deg, #17a2b8, #6610f2);
    color: white;
}

.action-btn.warning {
    background: linear-gradient(135deg, #ffc107, #fd7e14);
    color: #333;
}

.recent-operations {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
    margin-bottom: 25px;
}

.section-header {
    background: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: between;
    align-items: center;
}

.section-title {
    font-weight: 600;
    margin: 0;
    color: #333;
}

.operation-item {
    padding: 15px 20px;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.3s ease;
}

.operation-item:last-child {
    border-bottom: none;
}

.operation-item:hover {
    background-color: #f8f9ff;
}

.operation-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 8px;
}

.operation-title {
    font-weight: 600;
    font-size: 15px;
    color: #333;
    flex: 1;
}

.operation-priority {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.priority-urgent {
    background: #ffebee;
    color: #c62828;
}

.priority-high {
    background: #fff3e0;
    color: #ef6c00;
}

.priority-normal {
    background: #e3f2fd;
    color: #1565c0;
}

.priority-low {
    background: #f3e5f5;
    color: #7b1fa2;
}

.operation-meta {
    display: flex;
    justify-content: between;
    align-items: center;
    font-size: 13px;
    color: #666;
}

.operation-type {
    padding: 4px 8px;
    border-radius: 8px;
    font-size: 11px;
    font-weight: 500;
}

.type-handover {
    background: #e3f2fd;
    color: #1565c0;
}

.type-workshop {
    background: #fff3e0;
    color: #ef6c00;
}

.type-external_authorization {
    background: #f3e5f5;
    color: #7b1fa2;
}

.type-safety_inspection {
    background: #e8f5e8;
    color: #2e7d32;
}

.search-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.search-input {
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 12px 15px;
    font-size: 16px;
    width: 100%;
    transition: border-color 0.3s ease;
}

.search-input:focus {
    border-color: #667eea;
    outline: none;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.no-operations {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.no-operations i {
    font-size: 48px;
    margin-bottom: 15px;
    color: #ddd;
}

.mobile-content {
    padding-bottom: 100px !important;
}

.notification-dot {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 20px;
    height: 20px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}
</style>

<!-- Header إدارة العمليات -->
<div class="operations-header">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h4 class="mb-1">
                <i class="fas fa-cogs me-2"></i>
                إدارة العمليات
            </h4>
            <p class="mb-0 opacity-75">مراجعة وإدارة طلبات العمليات</p>
        </div>
        {% if stats.unread_notifications > 0 %}
        <div class="position-relative">
            <a href="{{ url_for('mobile.operations_notifications') }}" class="btn btn-light btn-sm">
                <i class="fas fa-bell"></i>
                <span class="notification-dot">{{ stats.unread_notifications }}</span>
            </a>
        </div>
        {% endif %}
    </div>
    
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <small class="opacity-75">آخر تحديث: الآن</small>
        </div>
        <div class="text-end">
            <button class="btn btn-light btn-sm" onclick="refreshData()">
                <i class="fas fa-sync-alt me-1"></i>
                تحديث
            </button>
        </div>
    </div>
</div>

<!-- إحصائيات العمليات -->
<div class="stats-grid">
    <div class="stat-card pending">
        <div class="stat-number text-warning">{{ stats.pending }}</div>
        <div class="stat-label">معلقة</div>
    </div>
    
    <div class="stat-card under_review">
        <div class="stat-number text-info">{{ stats.under_review }}</div>
        <div class="stat-label">تحت المراجعة</div>
    </div>
    
    <div class="stat-card approved">
        <div class="stat-number text-success">{{ stats.approved }}</div>
        <div class="stat-label">موافق عليها</div>
    </div>
    
    <div class="stat-card rejected">
        <div class="stat-number text-danger">{{ stats.rejected }}</div>
        <div class="stat-label">مرفوضة</div>
    </div>
</div>

<!-- البحث السريع -->
<div class="search-section">
    <form method="GET" action="{{ url_for('mobile.operations_dashboard') }}">
        <div class="position-relative">
            <input type="text" name="search_plate" value="{{ request.args.get('search_plate', '') }}" 
                   class="search-input" placeholder="بحث برقم اللوحة...">
            <button type="submit" class="btn btn-primary position-absolute" 
                    style="top: 6px; left: 6px; border-radius: 8px;">
                <i class="fas fa-search"></i>
            </button>
        </div>
    </form>
</div>

<!-- الإجراءات السريعة -->
<div class="quick-actions">
    <h6 class="mb-3">الإجراءات السريعة</h6>
    <div class="action-buttons">
        <a href="{{ url_for('mobile.operations_list') }}" class="action-btn primary">
            <i class="fas fa-list"></i>
            <span>جميع العمليات</span>
        </a>
        
        <a href="{{ url_for('mobile.operations_list', status='pending') }}" class="action-btn warning">
            <i class="fas fa-clock"></i>
            <span>العمليات المعلقة</span>
        </a>
        
        <a href="{{ url_for('mobile.operations_notifications') }}" class="action-btn info">
            <i class="fas fa-bell"></i>
            <span>الإشعارات</span>
            {% if stats.unread_notifications > 0 %}
            <span class="badge bg-danger">{{ stats.unread_notifications }}</span>
            {% endif %}
        </a>
        
        <a href="{{ url_for('operations.export_all_operations_excel') }}" class="action-btn success">
            <i class="fas fa-file-excel"></i>
            <span>تصدير Excel</span>
        </a>
    </div>
</div>

<!-- العمليات الحديثة -->
<div class="recent-operations">
    <div class="section-header">
        <h6 class="section-title">
            <i class="fas fa-clock me-2"></i>
            العمليات المعلقة
        </h6>
        <a href="{{ url_for('mobile.operations_list', status='pending') }}" class="btn btn-sm btn-outline-primary">
            عرض الكل
        </a>
    </div>
    
    {% if pending_requests %}
        {% for operation in pending_requests %}
        <div class="operation-item" onclick="location.href='{{ url_for('mobile.operation_details', operation_id=operation.id) }}'">
            <div class="operation-header">
                <div class="operation-title">{{ operation.title }}</div>
                <div class="operation-priority priority-{{ operation.priority }}">
                    {% if operation.priority == 'urgent' %}عاجل
                    {% elif operation.priority == 'high' %}عالي
                    {% elif operation.priority == 'normal' %}عادي
                    {% else %}منخفض{% endif %}
                </div>
            </div>
            
            <div class="operation-meta">
                <div>
                    <span class="operation-type type-{{ operation.operation_type }}">
                        {% if operation.operation_type == 'handover' %}تسليم/استلام
                        {% elif operation.operation_type == 'workshop' %}ورشة
                        {% elif operation.operation_type == 'external_authorization' %}تفويض خارجي
                        {% elif operation.operation_type == 'safety_inspection' %}فحص سلامة
                        {% endif %}
                    </span>
                    
                    {% if operation.vehicle %}
                    <small class="me-2">• {{ operation.vehicle.plate_number }}</small>
                    {% endif %}
                </div>
                
                <div>
                    {% if operation.requested_at %}
                        {{ operation.requested_at.strftime('%m/%d %H:%M') }}
                    {% else %}
                        {{ operation.created_at.strftime('%m/%d %H:%M') }}
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="no-operations">
            <div class="text-muted mb-3">
                <i class="fas fa-check-circle"></i>
            </div>
            <h5 class="text-muted">لا توجد عمليات معلقة</h5>
            <p class="text-muted">جميع العمليات تمت مراجعتها</p>
        </div>
    {% endif %}
</div>

<script>
// تحديث البيانات
function refreshData() {
    location.reload();
}

// تحديث الإحصائيات تلقائياً كل دقيقتين
setInterval(() => {
    fetch('/operations/api/stats')
        .then(response => response.json())
        .then(data => {
            // تحديث الإحصائيات في الصفحة
            document.querySelectorAll('.stat-number').forEach((element, index) => {
                const statTypes = ['pending', 'under_review', 'approved', 'rejected'];
                if (data[statTypes[index]] !== undefined) {
                    element.textContent = data[statTypes[index]];
                }
            });
        })
        .catch(console.error);
}, 120000);

// إضافة أصوات الإشعارات
function playNotificationSound() {
    // يمكن إضافة صوت إشعار هنا
    console.log('New notification');
}

// التحقق من الإشعارات الجديدة
setInterval(() => {
    fetch('/operations/api/notifications-count')
        .then(response => response.json())
        .then(data => {
            const currentCount = parseInt(document.querySelector('.notification-dot')?.textContent || '0');
            if (data.unread > currentCount) {
                playNotificationSound();
                location.reload(); // إعادة تحميل الصفحة لعرض الإشعارات الجديدة
            }
        })
        .catch(console.error);
}, 30000);

// تفعيل pull-to-refresh
let startY = 0;
document.addEventListener('touchstart', function(e) {
    startY = e.touches[0].clientY;
});

document.addEventListener('touchend', function(e) {
    const endY = e.changedTouches[0].clientY;
    const diff = endY - startY;
    
    if (diff > 100 && window.scrollY === 0) {
        refreshData();
    }
});
</script>
{% endblock %}