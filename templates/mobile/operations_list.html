{% extends "mobile/layout.html" %}

{% block title %}قائمة العمليات{% endblock %}

{% block content %}
<style>
/* تنسيق قائمة العمليات المحمولة */
.operations-list-header {
    background: linear-gradient(135deg, #1e3a5c 0%, #2c5282 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}

.filter-section {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.filter-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 12px;
}

.filter-row:last-child {
    margin-bottom: 0;
}

.filter-input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
}

.operation-card {
    background: white;
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-left: 4px solid #007bff;
}

.operation-card.pending {
    border-left-color: #ffc107;
}

.operation-card.under_review {
    border-left-color: #17a2b8;
}

.operation-card.approved {
    border-left-color: #28a745;
}

.operation-card.rejected {
    border-left-color: #dc3545;
}

.operation-header {
    display: flex;
    justify-content: between;
    align-items: flex-start;
    margin-bottom: 12px;
}

.operation-title {
    font-weight: 600;
    font-size: 15px;
    color: #333;
    margin-bottom: 4px;
}

.operation-type {
    font-size: 12px;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: 500;
}

.operation-type.handover {
    background: #e3f2fd;
    color: #1976d2;
}

.operation-type.workshop {
    background: #fff3e0;
    color: #f57c00;
}

.operation-type.safety_inspection {
    background: #e8f5e8;
    color: #388e3c;
}

.operation-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #666;
    margin-top: 12px;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 500;
}

.status-badge.pending {
    background: #fff3cd;
    color: #856404;
}

.status-badge.under_review {
    background: #d1ecf1;
    color: #0c5460;
}

.status-badge.approved {
    background: #d4edda;
    color: #155724;
}

.status-badge.rejected {
    background: #f8d7da;
    color: #721c24;
}

.priority-badge {
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 10px;
    font-weight: 500;
}

.priority-badge.urgent {
    background: #dc3545;
    color: white;
}

.priority-badge.high {
    background: #ffc107;
    color: #212529;
}

.priority-badge.normal {
    background: #17a2b8;
    color: white;
}

.priority-badge.low {
    background: #6c757d;
    color: white;
}

.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #666;
}

.empty-state i {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}
</style>

<!-- Header -->
<div class="operations-list-header">
    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h5 class="mb-1">
                <i class="fas fa-list me-2"></i>
                قائمة العمليات
            </h5>
            <p class="mb-0 opacity-75">جميع العمليات والطلبات</p>
        </div>
        <a href="{{ url_for('mobile.operations') }}" class="btn btn-light btn-sm">
            <i class="fas fa-arrow-right me-1"></i>
            عودة
        </a>
    </div>
</div>

<!-- فلاتر البحث -->
<div class="filter-section">
    <form method="GET" action="{{ url_for('mobile.operations_list') }}">
        <div class="filter-row">
            <select name="status" class="filter-input">
                <option value="all" {{ 'selected' if status_filter == 'all' }}>جميع الحالات</option>
                <option value="pending" {{ 'selected' if status_filter == 'pending' }}>معلقة</option>
                <option value="under_review" {{ 'selected' if status_filter == 'under_review' }}>تحت المراجعة</option>
                <option value="approved" {{ 'selected' if status_filter == 'approved' }}>موافق عليها</option>
                <option value="rejected" {{ 'selected' if status_filter == 'rejected' }}>مرفوضة</option>
            </select>
            
            <select name="operation_type" class="filter-input">
                <option value="all" {{ 'selected' if operation_type_filter == 'all' }}>جميع الأنواع</option>
                <option value="handover" {{ 'selected' if operation_type_filter == 'handover' }}>تسليم/استلام</option>
                <option value="workshop" {{ 'selected' if operation_type_filter == 'workshop' }}>ورشة</option>
                <option value="safety_inspection" {{ 'selected' if operation_type_filter == 'safety_inspection' }}>فحص سلامة</option>
                <option value="external_authorization" {{ 'selected' if operation_type_filter == 'external_authorization' }}>تفويض خارجي</option>
            </select>
        </div>
        
        <div class="filter-row">
            <select name="priority" class="filter-input">
                <option value="all" {{ 'selected' if priority_filter == 'all' }}>جميع الأولويات</option>
                <option value="urgent" {{ 'selected' if priority_filter == 'urgent' }}>عاجل</option>
                <option value="high" {{ 'selected' if priority_filter == 'high' }}>عالي</option>
                <option value="normal" {{ 'selected' if priority_filter == 'normal' }}>عادي</option>
                <option value="low" {{ 'selected' if priority_filter == 'low' }}>منخفض</option>
            </select>
            
            <button type="submit" class="btn btn-primary btn-sm">
                <i class="fas fa-search me-1"></i>
                فلترة
            </button>
        </div>
        
        <input type="text" name="vehicle_search" value="{{ vehicle_search or '' }}" 
               placeholder="بحث في العنوان أو الوصف..." class="filter-input">
    </form>
</div>

<!-- قائمة العمليات -->
{% if operations %}
    {% for operation in operations %}
    <div class="operation-card {{ operation.status }}">
        <div class="operation-header">
            <div class="flex-grow-1">
                <div class="operation-title">{{ operation.title or 'عملية بدون عنوان' }}</div>
                <span class="operation-type {{ operation.operation_type }}">
                    {% if operation.operation_type == 'handover' %}تسليم/استلام
                    {% elif operation.operation_type == 'workshop' %}ورشة
                    {% elif operation.operation_type == 'safety_inspection' %}فحص سلامة
                    {% elif operation.operation_type == 'external_authorization' %}تفويض خارجي
                    {% else %}{{ operation.operation_type }}{% endif %}
                </span>
            </div>
            <div class="text-end">
                <span class="status-badge {{ operation.status }}">
                    {% if operation.status == 'pending' %}معلقة
                    {% elif operation.status == 'under_review' %}تحت المراجعة
                    {% elif operation.status == 'approved' %}موافق عليها
                    {% elif operation.status == 'rejected' %}مرفوضة
                    {% else %}{{ operation.status }}{% endif %}
                </span>
            </div>
        </div>
        
        {% if operation.description %}
        <p class="text-muted mb-2" style="font-size: 13px;">
            {{ operation.description[:100] }}{% if operation.description|length > 100 %}...{% endif %}
        </p>
        {% endif %}
        
        <div class="operation-meta">
            <div>
                <i class="fas fa-clock me-1"></i>
                {{ operation.requested_at.strftime('%Y/%m/%d %H:%M') if operation.requested_at }}
            </div>
            <div class="d-flex align-items-center gap-2">
                {% if operation.priority %}
                <span class="priority-badge {{ operation.priority }}">
                    {% if operation.priority == 'urgent' %}عاجل
                    {% elif operation.priority == 'high' %}عالي
                    {% elif operation.priority == 'normal' %}عادي
                    {% elif operation.priority == 'low' %}منخفض
                    {% else %}{{ operation.priority }}{% endif %}
                </span>
                {% endif %}
                
                {% if operation.vehicle %}
                <span class="badge bg-secondary">{{ operation.vehicle.plate_number }}</span>
                {% endif %}
                
                {% if operation.operation_type == 'handover' and operation.related_id %}
                <a href="{{ url_for('vehicles.handover_pdf_public', handover_id=operation.related_id) }}" 
                   class="btn btn-sm btn-outline-danger" target="_blank" title="عرض نموذج PDF">
                    <i class="fas fa-file-pdf"></i>
                </a>
                {% endif %}
                
                {% if current_user.role == 'admin' %}
                <a href="{{ url_for('mobile.operation_details', operation_id=operation.id) }}" 
                   class="btn btn-sm btn-outline-primary" title="عرض التفاصيل">
                    <i class="fas fa-eye"></i>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- تصدير Excel -->
    <div class="text-center mt-4">
        <a href="{{ url_for('operations.export_all_operations_excel') }}" class="btn btn-success">
            <i class="fas fa-file-excel me-2"></i>
            تصدير Excel
        </a>
    </div>
    
{% else %}
    <div class="empty-state">
        <i class="fas fa-clipboard-list"></i>
        <h6>لا توجد عمليات</h6>
        <p class="text-muted">لم يتم العثور على عمليات مطابقة للفلاتر المحددة</p>
    </div>
{% endif %}

{% endblock %}