{% extends 'mobile/layout.html' %}
{% block title %}نموذج تسليم/استلام محسن{% endblock %}
{% block header_title %}نموذج تسليم/استلام{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .signature-canvas {
        border: 2px dashed #007bff;
        border-radius: 8px;
        background: #f8f9fa;
        cursor: crosshair;
        width: 100%;
        height: 120px;
    }
    
    .damage-canvas {
        border: 2px solid #ddd;
        border-radius: 8px;
        background: white;
        width: 100%;
        max-width: 400px;
        height: 300px;
    }
    
    .canvas-controls {
        margin: 10px 0;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .status-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
    }
    
    .form-section {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .section-header {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <!-- تحذيرات الحالة -->
    <div id="vehicle-warnings" class="d-none">
        <div class="status-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>تحذير:</strong> <span id="warning-message"></span>
        </div>
    </div>

    <form method="post" id="main-handover-form" enctype="multipart/form-data">
        <!-- اختيار السيارة -->
        <div class="form-section">
            <div class="section-header">
                <i class="fas fa-car me-2"></i>اختيار المركبة
            </div>
            
            <div class="mb-3">
                <label for="vehicle_id" class="form-label">اختر المركبة:</label>
                <select class="form-select" id="vehicle_id" name="vehicle_id" required>
                    <option value="">-- اختر مركبة --</option>
                    {% for vehicle in vehicles %}
                    <option value="{{ vehicle.id }}" 
                            data-status="{{ vehicle.status }}"
                            data-plate="{{ vehicle.plate_number }}">
                        {{ vehicle.plate_number }} - {{ vehicle.make }} {{ vehicle.model }}
                        {% if vehicle.status != 'available' %} [{{ vehicle.status }}]{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- نوع العملية -->
        <div class="form-section" id="operation-section" style="display: none;">
            <div class="section-header">
                <i class="fas fa-exchange-alt me-2"></i>نوع العملية
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">نوع العملية:</label>
                    <select class="form-select" name="handover_type" id="handover_type" required>
                        <option value="">-- اختر النوع --</option>
                        <option value="delivery">تسليم</option>
                        <option value="return">استلام</option>
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">التاريخ:</label>
                    <input type="date" class="form-control" name="handover_date" id="handover_date" required>
                </div>
            </div>
        </div>

        <!-- معلومات الموظف -->
        <div class="form-section" id="employee-section" style="display: none;">
            <div class="section-header">
                <i class="fas fa-user me-2"></i>معلومات المستلم/المسلم
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">اسم الموظف:</label>
                    <input type="text" class="form-control" name="person_name" id="person_name" required>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label class="form-label">رقم الموظف (اختياري):</label>
                    <input type="text" class="form-control" name="employee_id" id="employee_id">
                </div>
            </div>
        </div>

        <!-- حالة السيارة والملاحظات -->
        <div class="form-section" id="condition-section" style="display: none;">
            <div class="section-header">
                <i class="fas fa-clipboard-check me-2"></i>حالة السيارة
            </div>
            
            <div class="mb-3">
                <label class="form-label">وصف حالة السيارة:</label>
                <textarea class="form-control" name="vehicle_condition" rows="3" required
                          placeholder="وصف تفصيلي لحالة السيارة..."></textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label">ملاحظات إضافية:</label>
                <textarea class="form-control" name="notes" rows="2"
                          placeholder="أي ملاحظات أخرى..."></textarea>
            </div>
        </div>

        <!-- خريطة الأضرار -->
        <div class="form-section" id="damage-section" style="display: none;">
            <div class="section-header">
                <i class="fas fa-car-crash me-2"></i>مخطط الأضرار
            </div>
            
            <div class="text-center mb-3">
                <canvas id="damage-canvas" class="damage-canvas"></canvas>
                <input type="hidden" name="damage_diagram_data" id="damage-diagram-data">
            </div>
            
            <div class="canvas-controls">
                <button type="button" class="btn btn-sm btn-primary" id="draw-mode-btn">
                    <i class="fas fa-pen"></i> رسم
                </button>
                <button type="button" class="btn btn-sm btn-secondary" id="select-mode-btn">
                    <i class="fas fa-mouse-pointer"></i> تحديد
                </button>
                <input type="color" id="draw-color" value="#ff0000" class="form-control" style="width: 50px;">
                <input type="range" id="draw-width" min="1" max="10" value="3" class="form-range" style="width: 100px;">
                <button type="button" class="btn btn-sm btn-warning" id="clear-canvas">
                    <i class="fas fa-trash"></i> مسح
                </button>
            </div>
        </div>

        <!-- التوقيعات -->
        <div class="form-section" id="signatures-section" style="display: none;">
            <div class="section-header">
                <i class="fas fa-signature me-2"></i>التوقيعات
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-4">
                    <label class="form-label">توقيع المشرف:</label>
                    <canvas id="supervisor-signature" class="signature-canvas"></canvas>
                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearSignature('supervisor-signature')">
                        مسح التوقيع
                    </button>
                    <input type="hidden" name="supervisor_signature_data" id="supervisor-signature-data">
                </div>
                
                <div class="col-md-6 mb-4">
                    <label class="form-label">توقيع السائق:</label>
                    <canvas id="driver-signature" class="signature-canvas"></canvas>
                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" onclick="clearSignature('driver-signature')">
                        مسح التوقيع
                    </button>
                    <input type="hidden" name="driver_signature_data" id="driver-signature-data">
                </div>
            </div>
        </div>

        <!-- أزرار الإرسال -->
        <div class="form-section" id="submit-section" style="display: none;">
            <div class="d-grid gap-2">
                <button type="button" class="btn btn-success btn-lg" onclick="submitForm()">
                    <i class="fas fa-save me-2"></i>حفظ النموذج
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                    <i class="fas fa-undo me-2"></i>إعادة تعيين
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let damageCanvas = null;
    let signatureCanvases = {};
    
    // تهيئة التاريخ
    document.getElementById('handover_date').value = new Date().toISOString().split('T')[0];
    
    // عند اختيار السيارة
    document.getElementById('vehicle_id').addEventListener('change', function() {
        const vehicleId = this.value;
        const selectedOption = this.options[this.selectedIndex];
        const status = selectedOption.dataset.status;
        
        if (!vehicleId) {
            hideAllSections();
            return;
        }
        
        // فحص حالة السيارة
        const warningDiv = document.getElementById('vehicle-warnings');
        const warningMessage = document.getElementById('warning-message');
        
        if (status === 'out_of_service') {
            warningMessage.textContent = 'السيارة خارج الخدمة ولا يمكن تنفيذ عمليات عليها.';
            warningDiv.classList.remove('d-none');
            hideAllSections();
            return;
        } else if (status !== 'available') {
            warningMessage.textContent = 'السيارة المختارة ليست متاحة حالياً. يجب استلامها أولاً من السائق الحالي.';
            warningDiv.classList.remove('d-none');
        } else {
            warningDiv.classList.add('d-none');
        }
        
        // إظهار الأقسام
        showAllSections();
        initializeCanvases();
    });
    
    function hideAllSections() {
        const sections = ['operation-section', 'employee-section', 'condition-section', 
                         'damage-section', 'signatures-section', 'submit-section'];
        sections.forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
    }
    
    function showAllSections() {
        const sections = ['operation-section', 'employee-section', 'condition-section', 
                         'damage-section', 'signatures-section', 'submit-section'];
        sections.forEach(id => {
            document.getElementById(id).style.display = 'block';
        });
    }
    
    function initializeCanvases() {
        // تهيئة خريطة الأضرار
        if (!damageCanvas) {
            damageCanvas = new fabric.Canvas('damage-canvas', {
                isDrawingMode: true,
                backgroundColor: '#f8f9fa'
            });
            
            // رسم مخطط بسيط للسيارة
            drawVehicleOutline();
            
            // أزرار التحكم
            document.getElementById('draw-mode-btn').onclick = () => {
                damageCanvas.isDrawingMode = true;
            };
            
            document.getElementById('select-mode-btn').onclick = () => {
                damageCanvas.isDrawingMode = false;
            };
            
            document.getElementById('draw-color').onchange = (e) => {
                damageCanvas.freeDrawingBrush.color = e.target.value;
            };
            
            document.getElementById('draw-width').oninput = (e) => {
                damageCanvas.freeDrawingBrush.width = parseInt(e.target.value);
            };
            
            document.getElementById('clear-canvas').onclick = () => {
                if (confirm('هل تريد مسح جميع الرسوم؟')) {
                    damageCanvas.clear();
                    drawVehicleOutline();
                }
            };
        }
        
        // تهيئة التوقيعات
        initializeSignatures();
    }
    
    function drawVehicleOutline() {
        // رسم مخطط بسيط للسيارة
        const rect = new fabric.Rect({
            left: 50,
            top: 50,
            width: 300,
            height: 150,
            fill: 'transparent',
            stroke: '#333',
            strokeWidth: 2,
            selectable: false,
            evented: false
        });
        
        const windshield = new fabric.Rect({
            left: 80,
            top: 30,
            width: 240,
            height: 30,
            fill: 'lightblue',
            stroke: '#333',
            strokeWidth: 1,
            selectable: false,
            evented: false
        });
        
        damageCanvas.add(rect, windshield);
        
        // إضافة نص إرشادي
        const text = new fabric.Text('انقر واسحب لتحديد مواقع الأضرار', {
            left: 200,
            top: 125,
            fontSize: 14,
            textAlign: 'center',
            selectable: false,
            evented: false
        });
        
        damageCanvas.add(text);
    }
    
    function initializeSignatures() {
        const signatureIds = ['supervisor-signature', 'driver-signature'];
        
        signatureIds.forEach(id => {
            if (!signatureCanvases[id]) {
                signatureCanvases[id] = new fabric.Canvas(id, {
                    isDrawingMode: true,
                    backgroundColor: 'transparent'
                });
                
                signatureCanvases[id].freeDrawingBrush.color = '#000';
                signatureCanvases[id].freeDrawingBrush.width = 2;
            }
        });
    }
    
    window.clearSignature = function(canvasId) {
        if (signatureCanvases[canvasId]) {
            signatureCanvases[canvasId].clear();
        }
    };
    
    window.submitForm = function() {
        // حفظ بيانات الرسم والتوقيعات
        if (damageCanvas) {
            document.getElementById('damage-diagram-data').value = damageCanvas.toDataURL();
        }
        
        if (signatureCanvases['supervisor-signature']) {
            document.getElementById('supervisor-signature-data').value = 
                signatureCanvases['supervisor-signature'].toDataURL();
        }
        
        if (signatureCanvases['driver-signature']) {
            document.getElementById('driver-signature-data').value = 
                signatureCanvases['driver-signature'].toDataURL();
        }
        
        // إرسال النموذج
        document.getElementById('main-handover-form').submit();
    };
    
    window.resetForm = function() {
        if (confirm('هل تريد إعادة تعيين النموذج؟')) {
            document.getElementById('main-handover-form').reset();
            hideAllSections();
            
            // مسح الرسوم والتوقيعات
            if (damageCanvas) {
                damageCanvas.clear();
                drawVehicleOutline();
            }
            
            Object.values(signatureCanvases).forEach(canvas => {
                canvas.clear();
            });
        }
    };
});
</script>
{% endblock %}