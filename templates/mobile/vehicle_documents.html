{% extends 'mobile/layout.html' %}

{% block title %}وثائق السيارات{% endblock %}
{% block header_title %}وثائق السيارات{% endblock %}

{% block content %}
<div class="mobile-section">
  <div class="mobile-section-header">
    <h2 class="mobile-section-title">
      <i class="fas fa-file-alt"></i>
      وثائق السيارات
    </h2>
    <a href="{{ url_for('mobile.vehicles') }}" class="mobile-btn mobile-btn-secondary">
      <i class="fas fa-arrow-right"></i>
      عودة
    </a>
  </div>

  <!-- إحصائيات سريعة -->
  <div class="mobile-summary-cards">
    <div class="mobile-summary-card primary">
      <div class="mobile-summary-icon">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="mobile-summary-value">{{ valid_docs }}</div>
      <div class="mobile-summary-label">سارية</div>
    </div>
    
    <div class="mobile-summary-card warning">
      <div class="mobile-summary-icon">
        <i class="fas fa-exclamation-triangle"></i>
      </div>
      <div class="mobile-summary-value">{{ warning_docs }}</div>
      <div class="mobile-summary-label">تنتهي قريباً</div>
    </div>
    
    <div class="mobile-summary-card danger">
      <div class="mobile-summary-icon">
        <i class="fas fa-times-circle"></i>
      </div>
      <div class="mobile-summary-value">{{ expired_docs }}</div>
      <div class="mobile-summary-label">منتهية</div>
    </div>
    
    <div class="mobile-summary-card info">
      <div class="mobile-summary-icon">
        <i class="fas fa-file-invoice"></i>
      </div>
      <div class="mobile-summary-value">{{ total_docs }}</div>
      <div class="mobile-summary-label">الإجمالي</div>
    </div>
  </div>

  <!-- قائمة الوثائق -->
  <div class="mobile-card">
    <div class="mobile-card-header">
      <div class="mobile-card-title">
        <i class="fas fa-list"></i>
        وثائق السيارات
      </div>
      <div class="mobile-card-actions">
        <button class="mobile-btn-icon" onclick="toggleFilters()">
          <i class="fas fa-filter"></i>
        </button>
      </div>
    </div>
    
    <!-- فلاتر البحث (مخفية افتراضياً) -->
    <div class="mobile-card-body" id="filtersSection" style="display: none;">
      <div class="mobile-form-group">
        <label class="mobile-form-label">السيارة</label>
        <select class="mobile-form-select">
          <option value="">جميع السيارات</option>
          {% for vehicle in vehicles %}
            <option value="{{ vehicle.id }}">{{ vehicle.make }} {{ vehicle.model }} - {{ vehicle.plate_number }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="mobile-form-group">
        <label class="mobile-form-label">نوع الوثيقة</label>
        <select class="mobile-form-select">
          <option value="">جميع الأنواع</option>
          <option value="registration">رخصة سير</option>
          <option value="authorization">تفويض</option>
          <option value="inspection">فحص دوري</option>
        </select>
      </div>
      
      <div class="mobile-form-group">
        <label class="mobile-form-label">حالة الوثيقة</label>
        <select class="mobile-form-select">
          <option value="">الكل</option>
          <option value="valid">سارية</option>
          <option value="warning">تنتهي قريباً</option>
          <option value="expired">منتهية</option>
        </select>
      </div>
      
      <div class="mobile-form-actions">
        <button class="mobile-btn mobile-btn-primary" onclick="applyFilters()">
          <i class="fas fa-search"></i>
          تطبيق الفلتر
        </button>
      </div>
    </div>
    
    <div class="mobile-documents-list">
      {% if documents %}
        {% for doc in documents %}
          <div class="mobile-document-item">
            <div class="mobile-document-status {{ doc.status }}"></div>
            <div class="mobile-document-icon">
              <i class="fas {{ doc.icon }}"></i>
            </div>
            <div class="mobile-document-details">
              <div class="mobile-document-title">{{ doc.type_name }}</div>
              <div class="mobile-document-subtitle">{{ doc.vehicle.make }} {{ doc.vehicle.model }} - {{ doc.vehicle.plate_number }}</div>
              <div class="mobile-document-expiry">
                {% if doc.days_remaining >= 0 %}
                  تنتهي في: {{ doc.expiry_date.strftime('%d %B %Y') }} ({{ doc.days_remaining }} يوم)
                {% else %}
                  انتهت في: {{ doc.expiry_date.strftime('%d %B %Y') }} (منذ {{ doc.days_remaining * -1 }} يوم)
                {% endif %}
              </div>
            </div>
            <button class="mobile-btn-icon mobile-document-action">
              <i class="fas fa-chevron-left"></i>
            </button>
          </div>
        {% endfor %}
      {% else %}
        <div class="mobile-empty-state">
          <div class="mobile-empty-icon">
            <i class="fas fa-file-invoice"></i>
          </div>
          <div class="mobile-empty-title">لا توجد وثائق</div>
          <div class="mobile-empty-text">لم يتم العثور على أي وثائق للمركبات</div>
        </div>
      {% endif %}
    </div>
  </div>
  
  <!-- زر إضافة وثيقة جديدة -->
  <button class="mobile-fab" onclick="location.href='{{ url_for('mobile.vehicles') }}'">
    <i class="fas fa-plus"></i>
  </button>
</div>
{% endblock %}

{% block styles %}
<style>
  .mobile-documents-list {
    padding: 0;
  }
  
  .mobile-document-item {
    display: flex;
    align-items: center;
    padding: 16px;
    border-bottom: 1px solid var(--border-light);
    position: relative;
  }
  
  .mobile-document-status {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 4px;
  }
  
  .mobile-document-status.valid {
    background-color: var(--success-color);
  }
  
  .mobile-document-status.warning {
    background-color: var(--warning-color);
  }
  
  .mobile-document-status.expired {
    background-color: var(--danger-color);
  }
  
  .mobile-document-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: rgba(var(--primary-rgb), 0.1);
    color: var(--primary-color);
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 12px;
    font-size: 1.2rem;
  }
  
  .mobile-document-details {
    flex: 1;
  }
  
  .mobile-document-title {
    font-weight: var(--font-weight-medium);
    margin-bottom: 4px;
  }
  
  .mobile-document-subtitle {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: 4px;
  }
  
  .mobile-document-expiry {
    font-size: var(--font-size-xs);
    color: var(--text-muted);
  }
  
  .mobile-document-action {
    color: var(--text-muted);
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  function toggleFilters() {
    const filtersSection = document.getElementById('filtersSection');
    if (filtersSection.style.display === 'none') {
      filtersSection.style.display = 'block';
    } else {
      filtersSection.style.display = 'none';
    }
  }
  
  function applyFilters() {
    const vehicleFilter = document.querySelector('.mobile-form-select:nth-child(1)');
    const typeFilter = document.querySelectorAll('.mobile-form-select')[1];
    const statusFilter = document.querySelectorAll('.mobile-form-select')[2];
    
    const documents = document.querySelectorAll('.mobile-document-item');
    
    documents.forEach(doc => {
      let show = true;
      
      // فلتر حسب حالة الوثيقة
      if (statusFilter && statusFilter.value) {
        const docStatus = doc.querySelector('.mobile-document-status');
        if (docStatus && !docStatus.classList.contains(statusFilter.value)) {
          show = false;
        }
      }
      
      // فلتر حسب نوع الوثيقة
      if (typeFilter && typeFilter.value) {
        const docTitle = doc.querySelector('.mobile-document-title');
        if (docTitle) {
          const titleText = docTitle.textContent.trim();
          let matchesType = false;
          
          if (typeFilter.value === 'registration' && titleText.includes('رخصة سير')) {
            matchesType = true;
          } else if (typeFilter.value === 'authorization' && titleText.includes('تفويض')) {
            matchesType = true;
          } else if (typeFilter.value === 'inspection' && titleText.includes('فحص دوري')) {
            matchesType = true;
          }
          
          if (!matchesType) {
            show = false;
          }
        }
      }
      
      doc.style.display = show ? 'flex' : 'none';
    });
    
    // إخفاء الفلاتر بعد التطبيق
    toggleFilters();
  }
</script>
{% endblock %}