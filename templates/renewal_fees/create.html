{% extends 'layout.html' %}

{% block title %}إضافة رسوم تجديد{% endblock %}

{% block styles %}
<style>
    /* تنسيق صفوف الرسوم */
    .fee-row {
        position: relative;
        transition: all 0.3s ease;
        border-radius: 8px;
        overflow: hidden;
        margin-bottom: 8px;
        padding: 10px 0;
    }
    /* تحسينات عامة لعناصر النموذج */
    .form-control, .form-select {
        background-color: #1a1a1a !important;
        color: white !important;
        border-color: #6c757d;
        padding: 0.6rem 1rem;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .form-label {
        color: #e9ecef;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    /* تحسينات للبطاقات */
    .card {
        border: none;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .card-header {
        border-bottom: 0;
        padding: 1rem 1.5rem;
    }
    
    .card-header h6 {
        margin: 0;
        font-weight: 700;
        font-size: 1.05rem;
    }
    
    .card-header.bg-light h6 {
        color: #212529;
    }
    
    .card-body {
        padding: 1.5rem;
    }
    
    /* تحسينات مؤشرات التبديل */
    .form-check-input {
        width: 2.5em;
        height: 1.25em;
    }
    
    .form-check-input:checked {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }
    
    .form-check-label {
        margin-right: 8px;
        color: var(--bs-gray-200);
    }
    
    /* تحسينات عرض القوائم المنسدلة Select2 */
    .select2-container--default .select2-selection--single {
        background-color: #1a1a1a !important;
        color: white !important;
        border-color: #6c757d;
        height: 48px;
        border-radius: 6px;
        padding: 8px 10px;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: white !important;
        line-height: 32px;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 46px;
    }
    
    /* معالجة لون خلفية القائمة المنسدلة وعناصرها */
    .select2-dropdown {
        background-color: #1a1a1a !important;
        border: 1px solid #6c757d !important;
        border-radius: 6px !important;
        z-index: 9999 !important;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2) !important;
    }
    
    .select2-container--default .select2-search--dropdown .select2-search__field {
        background-color: #1a1a1a !important;
        color: white !important;
        border: 1px solid #6c757d !important;
        padding: 8px 10px;
        border-radius: 4px;
    }
    
    .select2-results__option {
        color: white !important;
        background-color: #1a1a1a !important;
        padding: 10px 15px !important;
        transition: all 0.2s;
    }
    
    /* العناوين في القائمة المنسدلة */
    .select2-results__group {
        background-color: #e9ecef !important;
        color: #212529 !important;
        font-weight: bold !important;
        padding: 10px 15px !important;
    }
    
    /* العنصر المحدد */
    .select2-container--default .select2-results__option--selected {
        background-color: rgba(13, 110, 253, 0.15) !important;
        color: white !important;
    }
    
    /* العنصر عند المرور عليه */
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: var(--bs-primary) !important;
        color: white !important;
    }
    
    /* حل مشكلة تقويم التاريخ */
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
    }
    
    /* أقسام الرسوم */
    .fee-section {
        position: relative;
        padding-top: 1.5rem;
        border-top: 1px dashed rgba(255, 255, 255, 0.1);
        margin-top: 1.5rem;
    }
    
    .fee-section-active {
        background-color: rgba(13, 110, 253, 0.05);
        border-radius: 8px;
    }
    
    /* لون نص جداول الملخص */
    .table {
        color: #e9ecef;
    }
    
    /* تنسيق جدول الملخص */
    .summary-table {
        border-radius: 8px;
        overflow: hidden;
    }
    
    .summary-table thead th {
        background-color: rgba(13, 110, 253, 0.15);
        color: white;
        font-weight: 600;
        padding: 12px 15px;
        border: none;
    }
    
    .summary-table tbody td {
        padding: 12px 15px;
        border-color: rgba(255, 255, 255, 0.05);
    }
    
    .summary-table tfoot td {
        background-color: rgba(13, 110, 253, 0.1);
        font-weight: 700;
        color: white;
        padding: 12px 15px;
        border-top: 2px solid rgba(255, 255, 255, 0.1);
    }
    
    /* رسوم الأنواع المختلفة بألوان مختلفة */
    .fee-card {
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .fee-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background-color: transparent;
        transition: all 0.3s;
    }
    
    .fee-card.labor-office::before {
        background-color: #17a2b8;
    }
    
    .fee-card.passport::before {
        background-color: #0d6efd;
    }
    
    .fee-card.social-insurance::before {
        background-color: #198754;
    }
    
    .fee-card.transfer-sponsorship::before {
        background-color: #dc3545;
    }
    
    .fee-card.other::before {
        background-color: #6c757d;
    }
    
    .fee-card .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .fee-type-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        color: white;
    }
    
    .fee-type-icon.labor-office {
        background-color: #17a2b8;
    }
    
    .fee-type-icon.passport {
        background-color: #0d6efd;
    }
    
    .fee-type-icon.social-insurance {
        background-color: #198754;
    }
    
    .fee-type-icon.transfer-sponsorship {
        background-color: #dc3545;
    }
    
    .fee-type-icon.other {
        background-color: #6c757d;
    }
    
    /* أزرار أكثر جمالا */
    .btn {
        border-radius: 6px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .btn-lg {
        padding: 0.75rem 1.75rem;
        font-size: 1.1rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        border: none;
    }
    
    .btn-success {
        background: linear-gradient(135deg, #198754 0%, #146c43 100%);
        border: none;
    }
    
    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #5c636a 100%);
        border: none;
    }
    
    .btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }
    
    .btn:hover::after {
        animation: ripple 1s ease-out;
    }
    
    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(20, 20);
            opacity: 0;
        }
    }
    
    /* تنبيهات محسنة */
    .alert {
        border: none;
        border-radius: 8px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        padding: 1.25rem;
    }

    .fee-amount-input {
        position: relative;
    }
    
    .fee-amount-input .form-control {
        padding-left: 60px;
    }
    
    .fee-currency {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: rgba(255, 255, 255, 0.7);
        font-weight: 600;
    }
    
    /* تأثيرات تفاعلية للنماذج */
    .form-floating-group {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .form-floating-group .form-control {
        height: 50px;
        padding-top: 25px;
    }
    
    .form-floating-group .form-label {
        position: absolute;
        top: 8px;
        left: 15px;
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
        pointer-events: none;
    }
    
    /* تحسين أيقونات الأقسام */
    .section-icon-container {
        display: flex;
        align-items: center;
    }
    
    .section-icon {
        font-size: 1.25rem;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- عنوان الصفحة مع أيقونة وزر الرجوع -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <div class="bg-gradient-primary rounded-circle p-3 me-3 shadow-sm">
                <i class="fas fa-money-bill-wave fa-2x text-white"></i>
            </div>
            <div>
                <h2 class="mb-0 fw-bold">إضافة رسوم تجديد جديدة</h2>
                <p class="text-muted mb-0">إدخال رسوم تجديد الأوراق للموظفين</p>
            </div>
        </div>
        <a href="{{ url_for('renewal_fees.index') }}" class="btn btn-outline-secondary rounded-pill">
            <i class="fas fa-arrow-right me-2"></i>
            العودة للقائمة
        </a>
    </div>

    <!-- رسالة إرشادية للمستخدم -->
    <div class="alert alert-info alert-dismissible fade show mb-4">
        <div class="d-flex">
            <div class="me-3">
                <i class="fas fa-info-circle fa-2x"></i>
            </div>
            <div>
                <h5 class="alert-heading fw-bold">كيفية إضافة رسوم تجديد</h5>
                <p class="mb-0">
                    1. اختر وثيقة الموظف التي ترتبط بها الرسوم.<br>
                    2. حدد تاريخ الاستحقاق وحالة الدفع.<br>
                    3. فعّل أنواع الرسوم المطلوبة وأدخل قيمها.<br>
                    4. اضغط على زر "حفظ الرسوم" عند الانتهاء.
                </p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- نموذج إدخال البيانات -->
            <form method="POST" action="{{ url_for('renewal_fees.create') }}" id="feesForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- معلومات الوثيقة والتاريخ -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-gradient-primary text-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-file-alt me-2"></i>
                            <h5 class="mb-0">المعلومات الأساسية</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="document_id" class="form-label">
                                    <i class="fas fa-id-card me-1"></i>
                                    الوثيقة *
                                </label>
                                <select class="form-select select2" id="document_id" name="document_id" required>
                                    <option value="">اختر وثيقة الموظف</option>
                                    <optgroup label="وثائق الموظفين">
                                        {% for document in documents %}
                                        <option value="{{ document.id }}">{{ document.employee.name }} - {{ document.document_type }} ({{ document.document_number }})</option>
                                        {% endfor %}
                                    </optgroup>
                                </select>
                                <small class="form-text text-muted mt-1">اختر وثيقة الموظف التي تريد إضافة رسوم تجديد لها</small>
                            </div>
                            <div class="col-md-6">
                                <label for="fee_date" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    تاريخ الاستحقاق *
                                </label>
                                <input type="date" class="form-control" id="fee_date" name="fee_date" required>
                                <small class="form-text text-muted mt-1">تاريخ استحقاق الرسوم أو تاريخ الإصدار</small>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-3">
                            <div class="col-md-6">
                                <label for="payment_status" class="form-label">
                                    <i class="fas fa-money-check-alt me-1"></i>
                                    حالة الدفع *
                                </label>
                                <select class="form-select" id="payment_status" name="payment_status" required>
                                    {% for status_key, status_name in payment_statuses.items() %}
                                    <option value="{{ status_key }}" {% if status_key == 'pending' %}selected{% endif %}>
                                        {{ status_name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-3 payment-details" style="display: none;">
                            <div class="col-md-6">
                                <label for="payment_date" class="form-label">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    تاريخ الدفع
                                </label>
                                <input type="date" class="form-control" id="payment_date" name="payment_date">
                            </div>
                            <div class="col-md-6">
                                <label for="receipt_number" class="form-label">
                                    <i class="fas fa-receipt me-1"></i>
                                    رقم الإيصال
                                </label>
                                <input type="text" class="form-control" id="receipt_number" name="receipt_number" placeholder="أدخل رقم إيصال الدفع">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- أنواع الرسوم -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-gradient-primary text-white">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-list-alt me-2"></i>
                            <h5 class="mb-0">أنواع الرسوم</h5>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning mb-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span>قم بتفعيل نوع الرسم المطلوب وأدخل قيمته. يمكنك تفعيل أكثر من نوع للإطلاع على قيمة الرسوم الإجمالية.</span>
                        </div>
                        
                        <!-- جدول الرسوم بالتصميم الجديد -->
                        <div class="fees-container bg-dark p-3 rounded-3 mb-4">
                            <!-- عنوان الجدول -->
                            <div class="row mb-3 pb-2 text-white fw-bold border-bottom border-secondary">
                                <div class="col-4 text-end pe-4">نوع الرسم</div>
                                <div class="col-3 text-center">المبلغ</div>
                                <div class="col-4">ملاحظات</div>
                                <div class="col-1 text-center">تفعيل</div>
                            </div>
                            
                            <!-- رسوم مكتب العمل -->
                            <div id="labor_office_row" class="row mb-3 py-2 align-items-center fee-row rounded">
                                <div class="col-4 text-end">
                                    <div class="d-inline-block">
                                        <i class="fas fa-building me-2"></i>
                                        <span class="fw-bold">رسوم مكتب العمل</span>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="input-group">
                                        <input type="number" id="labor_office_amount" class="form-control bg-dark text-white border-secondary text-start fee-amount" 
                                               min="0" step="0.01" placeholder="0">
                                        <span class="input-group-text bg-dark text-white border-secondary">ريال</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <input type="text" id="labor_office_notes" class="form-control bg-dark text-white border-secondary" placeholder="ملاحظات">
                                </div>
                                <div class="col-1 text-center">
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input fee-toggle" type="checkbox" id="labor_office_toggle" data-target="labor_office">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسوم الجوازات -->
                            <div id="passport_row" class="row mb-3 py-2 align-items-center fee-row rounded">
                                <div class="col-4 text-end">
                                    <div class="d-inline-block">
                                        <i class="fas fa-passport me-2"></i>
                                        <span class="fw-bold">رسوم الجوازات</span>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="input-group">
                                        <input type="number" id="passport_amount" class="form-control bg-dark text-white border-secondary text-start fee-amount" 
                                               min="0" step="0.01" placeholder="0">
                                        <span class="input-group-text bg-dark text-white border-secondary">ريال</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <input type="text" id="passport_notes" class="form-control bg-dark text-white border-secondary" placeholder="ملاحظات">
                                </div>
                                <div class="col-1 text-center">
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input fee-toggle" type="checkbox" id="passport_toggle" data-target="passport">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسوم التأمينات الاجتماعية -->
                            <div id="social_insurance_row" class="row mb-3 py-2 align-items-center fee-row rounded">
                                <div class="col-4 text-end">
                                    <div class="d-inline-block">
                                        <i class="fas fa-users me-2"></i>
                                        <span class="fw-bold">رسوم التأمينات الاجتماعية</span>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="input-group">
                                        <input type="number" id="social_insurance_amount" class="form-control bg-dark text-white border-secondary text-start fee-amount" 
                                               min="0" step="0.01" placeholder="0">
                                        <span class="input-group-text bg-dark text-white border-secondary">ريال</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <input type="text" id="social_insurance_notes" class="form-control bg-dark text-white border-secondary" placeholder="ملاحظات">
                                </div>
                                <div class="col-1 text-center">
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input fee-toggle" type="checkbox" id="social_insurance_toggle" data-target="social_insurance">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسوم نقل الكفالة -->
                            <div id="transfer_sponsorship_row" class="row mb-3 py-2 align-items-center fee-row rounded">
                                <div class="col-4 text-end">
                                    <div class="d-inline-block">
                                        <i class="fas fa-exchange-alt me-2"></i>
                                        <span class="fw-bold">رسوم نقل الكفالة</span>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="input-group">
                                        <input type="number" id="transfer_sponsorship_amount" class="form-control bg-dark text-white border-secondary text-start fee-amount" 
                                               min="0" step="0.01" placeholder="0">
                                        <span class="input-group-text bg-dark text-white border-secondary">ريال</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="d-flex">
                                        <input type="text" id="transfer_sponsorship_notes" class="form-control bg-dark text-white border-secondary" 
                                               style="width: 60%;" placeholder="ملاحظات">
                                        <input type="text" id="transfer_number" class="form-control bg-dark text-white border-secondary ms-2" 
                                               style="width: 40%;" placeholder="رقم النقل">
                                    </div>
                                </div>
                                <div class="col-1 text-center">
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input fee-toggle" type="checkbox" id="transfer_sponsorship_toggle" data-target="transfer_sponsorship">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسوم أخرى -->
                            <div id="other_row" class="row py-2 align-items-center fee-row rounded">
                                <div class="col-4 text-end">
                                    <div class="d-inline-block">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>
                                        <span class="fw-bold">رسوم أخرى</span>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="input-group">
                                        <input type="number" id="other_amount" class="form-control bg-dark text-white border-secondary text-start fee-amount" 
                                               min="0" step="0.01" placeholder="0">
                                        <span class="input-group-text bg-dark text-white border-secondary">ريال</span>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <input type="text" id="other_description" class="form-control bg-dark text-white border-secondary" placeholder="وصف النوع">
                                </div>
                                <div class="col-1 text-center">
                                    <div class="form-check form-switch d-flex justify-content-center">
                                        <input class="form-check-input fee-toggle" type="checkbox" id="other_toggle" data-target="other">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- حقول مخفية -->
                        <input type="hidden" name="fee_types[]" id="labor_office_type" value="labor_office">
                        <input type="hidden" name="fee_types[]" id="passport_type" value="passport">
                        <input type="hidden" name="fee_types[]" id="social_insurance_type" value="social_insurance">
                        <input type="hidden" name="fee_types[]" id="transfer_sponsorship_type" value="transfer_sponsorship">
                        <input type="hidden" name="fee_types[]" id="other_type" value="other">
                    </div>
                </div>
                
                <!-- حقول رسوم التجديد للإرسال -->
                <input type="hidden" id="fee_type" name="fee_type">
                <input type="hidden" id="amount" name="amount">
                <input type="hidden" id="notes" name="notes">
                <input type="hidden" id="transfer_number_hidden" name="transfer_number">
            </form>
        </div>
        
        <div class="col-lg-4">
            <!-- ملخص الرسوم وأزرار الإجراءات -->
            <div class="card shadow-sm sticky-top mb-4" style="top: 20px; z-index: 100;">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calculator me-2"></i>
                        ملخص الرسوم
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <table class="table table-hover summary-table">
                            <thead>
                                <tr>
                                    <th>نوع الرسم</th>
                                    <th>المبلغ</th>
                                </tr>
                            </thead>
                            <tbody id="fees_summary">
                                <tr>
                                    <td colspan="2" class="text-center py-4">
                                        <div class="text-muted">
                                            <i class="fas fa-info-circle me-2"></i>
                                            لم يتم إضافة أي رسوم بعد
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td>الإجمالي</td>
                                    <td id="total_fees">0.00 ريال</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    
                    <div class="alert alert-warning mb-4">
                        <h6 class="alert-heading fw-bold">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ملاحظة هامة
                        </h6>
                        <p class="mb-0 small">
                            سيتم حفظ نوع واحد فقط من الرسوم، وهو أول نوع مفعّل في القائمة. باقي الأنواع المفعلة هي للعرض فقط وحساب الإجمالي التقديري.
                        </p>
                    </div>
                    
                    <div class="d-grid gap-3">
                        <button type="button" id="submitFeeButton" class="btn btn-success btn-lg fw-bold">
                            <i class="fas fa-check-circle me-2"></i>
                            حفظ الرسوم
                        </button>
                        <button type="button" id="resetFormButton" class="btn btn-outline-secondary">
                            <i class="fas fa-undo me-2"></i>
                            إعادة ضبط النموذج
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- كارت المساعدة والتعليمات -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        تعليمات الاستخدام
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="fw-bold">
                            <i class="fas fa-clipboard-list me-2 text-primary"></i>
                            خطوات إضافة الرسوم
                        </h6>
                        <ol class="ps-3 mt-2">
                            <li class="mb-2">حدد وثيقة الموظف المطلوبة.</li>
                            <li class="mb-2">أدخل تاريخ الاستحقاق وحالة الدفع.</li>
                            <li class="mb-2">فعّل نوع الرسم وأدخل قيمته.</li>
                            <li>اضغط على زر "حفظ الرسوم".</li>
                        </ol>
                    </div>
                    
                    <div>
                        <h6 class="fw-bold">
                            <i class="fas fa-lightbulb me-2 text-warning"></i>
                            نصائح مفيدة
                        </h6>
                        <ul class="ps-3 mt-2">
                            <li class="mb-2">يمكنك إضافة عدة أنواع من الرسوم لرؤية إجمالي المبلغ.</li>
                            <li class="mb-2">تأكد من اختيار حالة الدفع الصحيحة.</li>
                            <li>في حالة الدفع المسبق، لا تنسَ إدخال رقم الإيصال.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تهيئة القوائم المنسدلة
        $('.select2').select2({
            dir: 'rtl',
            placeholder: 'اختر الوثيقة',
            language: {
                noResults: function() {
                    return "لا توجد نتائج";
                }
            },
            templateResult: formatDocument,
            templateSelection: formatDocumentSelection
        });
        
        // تنسيق عرض الوثائق في القائمة المنسدلة
        function formatDocument(document) {
            if (!document.id) {
                return document.text;
            }
            
            return $(`<div class="d-flex align-items-center py-1">
                <div class="me-2" style="width: 24px; text-align: center;">
                    <i class="fas fa-id-card text-primary"></i>
                </div>
                <div>
                    <div>${document.text.split(' - ')[0]}</div>
                    <small class="text-muted">${document.text.split(' - ')[1] || ''}</small>
                </div>
            </div>`);
        }
        
        // تنسيق العنصر المحدد
        function formatDocumentSelection(document) {
            if (!document.id) {
                return document.text;
            }
            
            const name = document.text.split(' - ')[0];
            const docInfo = document.text.split(' - ')[1] || '';
            
            return $(`<div class="d-flex align-items-center">
                <i class="fas fa-id-card text-primary me-2"></i>
                <span>${name} - <small>${docInfo}</small></span>
            </div>`);
        }
        
        // إخفاء أو إظهار حقول تاريخ الدفع ورقم الإيصال حسب حالة الدفع
        const paymentStatusSelect = document.getElementById('payment_status');
        const paymentDetailsRow = document.querySelector('.payment-details');
        
        paymentStatusSelect.addEventListener('change', function() {
            if (this.value === 'paid') {
                paymentDetailsRow.style.display = 'flex';
                document.getElementById('payment_date').setAttribute('required', 'required');
            } else {
                paymentDetailsRow.style.display = 'none';
                document.getElementById('payment_date').removeAttribute('required');
            }
        });
        
        // التحقق من حالة الدفع عند التحميل
        if (paymentStatusSelect.value === 'paid') {
            paymentDetailsRow.style.display = 'flex';
            document.getElementById('payment_date').setAttribute('required', 'required');
        } else {
            paymentDetailsRow.style.display = 'none';
            document.getElementById('payment_date').removeAttribute('required');
        }
        
        // مؤشرات التبديل وأقسام الرسوم
        const toggles = [
            { id: 'labor_office_toggle', row: 'labor_office_row', amount: 'labor_office_amount', notes: 'labor_office_notes', type: 'labor_office_type', icon: '<i class="fas fa-building"></i>', colorClass: 'bg-info' },
            { id: 'passport_toggle', row: 'passport_row', amount: 'passport_amount', notes: 'passport_notes', type: 'passport_type', icon: '<i class="fas fa-passport"></i>', colorClass: 'bg-primary' },
            { id: 'social_insurance_toggle', row: 'social_insurance_row', amount: 'social_insurance_amount', notes: 'social_insurance_notes', type: 'social_insurance_type', icon: '<i class="fas fa-users"></i>', colorClass: 'bg-success' },
            { id: 'transfer_sponsorship_toggle', row: 'transfer_sponsorship_row', amount: 'transfer_sponsorship_amount', notes: 'transfer_sponsorship_notes', transferNumber: 'transfer_number', type: 'transfer_sponsorship_type', icon: '<i class="fas fa-exchange-alt"></i>', colorClass: 'bg-danger' },
            { id: 'other_toggle', row: 'other_row', amount: 'other_amount', notes: 'other_description', type: 'other_type', icon: '<i class="fas fa-file-invoice-dollar"></i>', colorClass: 'bg-secondary' }
        ];
        
        // تفعيل/تعطيل حقول الرسوم وتحديث الملخص
        toggles.forEach(toggle => {
            const toggleElement = document.getElementById(toggle.id);
            const rowElement = document.getElementById(toggle.row);
            const amountInput = document.getElementById(toggle.amount);
            const notesInput = document.getElementById(toggle.notes);
            const typeInput = document.getElementById(toggle.type);
            
            // إضافة تأثير عند تمرير الماوس على الصف
            rowElement.addEventListener('mouseover', function() {
                if (!toggleElement.checked) {
                    this.classList.add('bg-dark', 'bg-opacity-25');
                }
            });
            
            rowElement.addEventListener('mouseout', function() {
                if (!toggleElement.checked) {
                    this.classList.remove('bg-dark', 'bg-opacity-25');
                }
            });
            
            toggleElement.addEventListener('change', function() {
                try {
                    if (this.checked) {
                        // تغيير خلفية الصف المفعل
                        rowElement.classList.add('bg-primary', 'bg-opacity-10');
                        rowElement.style.boxShadow = '0 0 5px rgba(13, 110, 253, 0.5)';
                        
                        // تغيير نمط الحدود لجميع الحقول في الصف
                        const inputFields = rowElement.querySelectorAll('input:not(.fee-toggle)');
                        inputFields.forEach(input => {
                            input.classList.add('border-primary');
                        });
                        
                        // التركيز على حقل المبلغ
                        setTimeout(() => {
                            amountInput.focus();
                        }, 100);
                    } else {
                        // إزالة الخلفية والتأثيرات البصرية
                        rowElement.classList.remove('bg-primary', 'bg-opacity-10');
                        rowElement.style.boxShadow = '';
                        
                        // مسح قيم الحقول عند إلغاء التفعيل
                        amountInput.value = '';
                        notesInput.value = '';
                        
                        // إزالة التأثير المرئي من الحقول
                        const inputFields = rowElement.querySelectorAll('input:not(.fee-toggle)');
                        inputFields.forEach(input => {
                            input.classList.remove('border-primary');
                        });
                        
                        if (toggle.transferNumber) {
                            document.getElementById(toggle.transferNumber).value = '';
                        }
                    }
                } catch (e) {
                    console.error('خطأ في تفعيل/تعطيل الحقول:', e);
                }
                updateSummary();
            });
        });
        
        // تحديث الملخص عند تغيير قيمة أي رسم
        document.querySelectorAll('.fee-amount').forEach(input => {
            input.addEventListener('input', function() {
                console.log('تغيير قيمة المبلغ:', this.value);
                updateSummary();
            });
        });
        
        // تحديث عند تغيير حالة التفعيل
        document.querySelectorAll('.fee-toggle').forEach(toggle => {
            toggle.addEventListener('change', function() {
                console.log('تغيير حالة التفعيل:', this.checked);
                updateSummary();
            });
        });
        
        // تحديث ملخص الرسوم
        function updateSummary() {
            try {
                console.log('بدء تحديث الملخص');
                const summaryTable = document.getElementById('fees_summary');
                if (!summaryTable) {
                    console.error('لم يتم العثور على جدول الملخص');
                    return;
                }
                
                const feesData = [];
                let totalFees = 0;
                
                // فحص كل نوع رسوم
                for (const toggle of toggles) {
                    const toggleElement = document.getElementById(toggle.id);
                    if (!toggleElement) continue;
                    
                    const rowElement = document.getElementById(toggle.row);
                    if (!rowElement) continue;
                    
                    console.log('فحص:', toggle.id, 'مفعل:', toggleElement.checked);
                    
                    // إذا كان النوع مفعلاً
                    if (toggleElement.checked) {
                        const amountInput = document.getElementById(toggle.amount);
                        if (!amountInput) continue;
                        
                        const amount = parseFloat(amountInput.value) || 0;
                        console.log('المبلغ:', amount);
                        
                        if (amount > 0) {
                            // نستخرج اسم نوع الرسم من العنصر
                            const typeElement = rowElement.querySelector('.fw-bold');
                            const typeName = typeElement ? typeElement.textContent.trim() : 'نوع الرسم';
                            
                            feesData.push({
                                type: typeName,
                                amount: amount,
                                icon: toggle.icon,
                                colorClass: toggle.colorClass
                            });
                            
                            totalFees += amount;
                            console.log('إضافة للإجمالي. الإجمالي الحالي:', totalFees);
                        }
                    }
                }
                
                // تحديث الجدول
                if (feesData.length > 0) {
                    let tableHTML = '';
                    feesData.forEach(fee => {
                        tableHTML += `
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <span class="badge ${fee.colorClass} me-2">${fee.icon}</span>
                                        ${fee.type}
                                    </div>
                                </td>
                                <td class="text-end fw-bold">${fee.amount.toFixed(2)} ريال</td>
                            </tr>
                        `;
                    });
                    summaryTable.innerHTML = tableHTML;
                } else {
                    summaryTable.innerHTML = `
                        <tr>
                            <td colspan="2" class="text-center py-4">
                                <div class="text-muted">
                                    <i class="fas fa-info-circle me-2"></i>
                                    لم يتم إضافة أي رسوم بعد
                                </div>
                            </td>
                        </tr>
                    `;
                }
                
                // تحديث الإجمالي
                const totalFeesElement = document.getElementById('total_fees');
                if (totalFeesElement) {
                    totalFeesElement.textContent = totalFees.toFixed(2) + ' ريال';
                }
                
                // إظهار أو إخفاء زر الحفظ بناءً على وجود رسوم مدخلة
                const submitButton = document.getElementById('submitFeeButton');
                if (submitButton) {
                    submitButton.disabled = feesData.length === 0;
                    
                    if (feesData.length > 0) {
                        submitButton.classList.remove('btn-secondary');
                        submitButton.classList.add('btn-success');
                        submitButton.innerHTML = '<i class="fas fa-check-circle me-2"></i> حفظ الرسوم';
                    } else {
                        submitButton.classList.remove('btn-success');
                        submitButton.classList.add('btn-secondary');
                        submitButton.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> أدخل البيانات أولاً';
                    }
                }
            } catch (error) {
                console.error('خطأ في تحديث الملخص:', error);
            }
        }
        
        // تنفيذ تحديث الملخص عند تحميل الصفحة
        updateSummary();
        
        // زر حفظ الرسوم
        document.getElementById('submitFeeButton').addEventListener('click', function() {
            try {
                console.log('زر الحفظ: بدء عملية الحفظ');
                
                // التحقق من حقول النموذج الأساسية
                const form = document.getElementById('feesForm');
                if (!form) {
                    showAlert('warning', 'حدث خطأ في النموذج، يرجى تحديث الصفحة');
                    return;
                }
                
                const documentSelect = document.getElementById('document_id');
                if (!documentSelect || !documentSelect.value) {
                    showAlert('warning', 'يرجى اختيار الوثيقة');
                    if (documentSelect) documentSelect.focus();
                    return;
                }
                
                const feeDateInput = document.getElementById('fee_date');
                if (!feeDateInput || !feeDateInput.value) {
                    showAlert('warning', 'يرجى تحديد تاريخ الاستحقاق');
                    if (feeDateInput) feeDateInput.focus();
                    return;
                }
                
                // التحقق من حقول الدفع إذا كانت الحالة مدفوعة
                const paymentStatusSelect = document.getElementById('payment_status');
                if (paymentStatusSelect && paymentStatusSelect.value === 'paid') {
                    const paymentDateInput = document.getElementById('payment_date');
                    if (!paymentDateInput || !paymentDateInput.value) {
                        showAlert('warning', 'يرجى تحديد تاريخ الدفع');
                        if (paymentDateInput) paymentDateInput.focus();
                        return;
                    }
                }
                
                // العثور على أول نوع مفعّل
                let selectedToggle = null;
                for (const toggle of toggles) {
                    const toggleElement = document.getElementById(toggle.id);
                    if (toggleElement && toggleElement.checked) {
                        const amountInput = document.getElementById(toggle.amount);
                        const amount = parseFloat(amountInput.value) || 0;
                        
                        if (amount > 0) {
                            selectedToggle = toggle;
                            break;
                        }
                    }
                }
                
                // التحقق من وجود رسوم مدخلة
                if (!selectedToggle) {
                    showAlert('warning', 'يرجى تفعيل وإدخال قيمة لرسم واحد على الأقل');
                    return;
                }
                
                console.log('تم تحديد الرسم:', selectedToggle.id);
                
                // تعيين نوع الرسم
                const feeType = selectedToggle.id.replace('_toggle', '');
                document.getElementById('fee_type').value = feeType;
                console.log('تعيين نوع الرسم:', feeType);
                
                // تعيين المبلغ
                const amount = document.getElementById(selectedToggle.amount).value;
                document.getElementById('amount').value = amount;
                console.log('تعيين المبلغ:', amount);
                
                // تعيين الملاحظات
                const notes = document.getElementById(selectedToggle.notes)?.value || '';
                document.getElementById('notes').value = notes;
                console.log('تعيين الملاحظات:', notes);
                
                // معالجة رقم نقل الكفالة إذا كان مطلوبًا
                if (feeType === 'transfer_sponsorship') {
                    const transferValue = document.getElementById('transfer_number')?.value || '';
                    document.getElementById('transfer_number_hidden').value = transferValue;
                    console.log('تعيين رقم النقل:', transferValue);
                    
                    if (!transferValue) {
                        showAlert('warning', 'يرجى إدخال رقم النقل لتجديد نقل الكفالة');
                        document.getElementById('transfer_number').focus();
                        return;
                    }
                }
                
                // عرض رسالة قبل الإرسال
                showAlert('info', 'جاري حفظ الرسوم...');
                
                // تأخير قصير ثم إرسال النموذج
                setTimeout(() => {
                    console.log('إرسال النموذج');
                    form.submit();
                }, 500);
            } catch (error) {
                console.error('خطأ في معالجة النموذج:', error);
                showAlert('warning', 'حدث خطأ أثناء معالجة النموذج، يرجى تحديث الصفحة');
            }
        });
        
        // عرض رسالة تنبيه
        function showAlert(type, message) {
            // إزالة أي تنبيهات سابقة
            const existingAlerts = document.querySelectorAll('.alert-floating');
            existingAlerts.forEach(alert => alert.remove());
            
            // إنشاء تنبيه جديد
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show alert-floating`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.left = '50%';
            alertDiv.style.transform = 'translateX(-50%)';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.style.boxShadow = '0 5px 15px rgba(0,0,0,0.2)';
            
            alertDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} fa-lg me-2"></i>
                    <div>${message}</div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // إزالة التنبيه تلقائياً بعد 5 ثوان
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, 5000);
        }
        
        // زر إعادة ضبط النموذج
        document.getElementById('resetFormButton').addEventListener('click', function() {
            const confirmReset = confirm('هل أنت متأكد من رغبتك في إعادة ضبط جميع الحقول؟');
            if (confirmReset) {
                try {
                    // إعادة تعيين أقسام الرسوم
                    toggles.forEach(toggle => {
                        const toggleElement = document.getElementById(toggle.id);
                        if (toggleElement) {
                            toggleElement.checked = false;
                        }
                        
                        const rowElement = document.getElementById(toggle.row);
                        if (rowElement) {
                            rowElement.classList.remove('bg-primary', 'bg-opacity-10');
                            rowElement.style.boxShadow = '';
                        }
                        
                        const amountInput = document.getElementById(toggle.amount);
                        if (amountInput) {
                            amountInput.value = '';
                            amountInput.classList.remove('border-primary');
                        }
                        
                        const notesInput = document.getElementById(toggle.notes);
                        if (notesInput) {
                            notesInput.value = '';
                            notesInput.classList.remove('border-primary');
                        }
                        
                        if (toggle.transferNumber) {
                            const transferNumberInput = document.getElementById(toggle.transferNumber);
                            if (transferNumberInput) {
                                transferNumberInput.value = '';
                            }
                        }
                        
                        // إزالة التأثيرات المرئية من جميع الحقول في الصف
                        const inputFields = rowElement.querySelectorAll('input:not(.fee-toggle)');
                        inputFields.forEach(input => {
                            input.classList.remove('border-primary');
                        });
                    });
                    
                    // إعادة تعيين الحقول الأساسية
                    const documentSelect = document.getElementById('document_id');
                    if (documentSelect) {
                        documentSelect.value = '';
                        $('.select2').trigger('change');
                    }
                    
                    const feeDateInput = document.getElementById('fee_date');
                    if (feeDateInput) {
                        feeDateInput.value = '';
                    }
                    
                    const paymentStatusSelect = document.getElementById('payment_status');
                    if (paymentStatusSelect) {
                        paymentStatusSelect.value = 'pending';
                    }
                    
                    const paymentDateInput = document.getElementById('payment_date');
                    if (paymentDateInput) {
                        paymentDateInput.value = '';
                    }
                    
                    const receiptNumberInput = document.getElementById('receipt_number');
                    if (receiptNumberInput) {
                        receiptNumberInput.value = '';
                    }
                    
                    // إخفاء تفاصيل الدفع
                    if (paymentDetailsRow) {
                        paymentDetailsRow.style.display = 'none';
                    }
                    
                    // تحديث الملخص
                    updateSummary();
                    
                    // عرض رسالة نجاح إعادة الضبط
                    showAlert('info', 'تم إعادة ضبط النموذج بنجاح');
                } catch (error) {
                    console.error('خطأ في إعادة ضبط النموذج:', error);
                    showAlert('warning', 'حدث خطأ أثناء إعادة ضبط النموذج');
                }
            }
        });
        
        // تأثيرات عند تركيز الحقول
        document.querySelectorAll('.fee-amount, #document_id, #fee_date, #payment_status, #payment_date, #receipt_number').forEach(input => {
            input.addEventListener('focus', function() {
                this.style.boxShadow = '0 0 0 0.25rem rgba(13, 110, 253, 0.25)';
            });
            
            input.addEventListener('blur', function() {
                this.style.boxShadow = '';
            });
        });
    });
</script>
{% endblock %}