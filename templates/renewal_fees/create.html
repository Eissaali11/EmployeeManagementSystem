{% extends 'layout.html' %}

{% block title %}إضافة رسوم تجديد{% endblock %}

{% block styles %}
<style>
    .page-header {
        background-color: #0c326f;
        color: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 0;
    }
    
    .main-section {
        background-color: white;
        border-radius: 0;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
    }
    
    .section-header {
        background-color: #0c326f;
        color: white;
        padding: 12px 15px;
        margin-bottom: 0;
        font-size: 18px;
        font-weight: 600;
    }
    
    .section-body {
        padding: 20px;
    }
    
    .custom-control-input:checked {
        background-color: #0c326f;
        border-color: #0c326f;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
    }
    
    .custom-table th {
        background-color: #f8f9fa;
        padding: 10px;
        font-weight: 600;
    }
    
    .fee-row td {
        padding: 12px;
        vertical-align: middle;
    }
    
    .fee-row {
        background-color: #f8f9fa;
        transition: all 0.2s;
    }
    
    .fee-row:hover {
        background-color: #e9ecef;
    }
    
    .fee-row.active {
        background-color: #e8f4ff;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .save-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 18px;
        font-weight: 600;
        border-radius: 0;
        width: 100%;
        margin-top: 20px;
    }
    
    .save-btn:hover {
        background-color: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .instructions-list {
        list-style-type: none;
        padding: 0;
        margin: 0;
    }
    
    .instructions-list li {
        padding: 8px 0;
        border-bottom: 1px dashed #dee2e6;
    }
    
    .instructions-list li:last-child {
        border-bottom: none;
    }
    
    .instructions-list i {
        color: #28a745;
        margin-left: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- عنوان الصفحة -->
    <div class="page-header d-flex justify-content-between align-items-center">
        <h2 class="mb-0">إضافة رسوم تجديد</h2>
        <a href="{{ url_for('renewal_fees.index') }}" class="btn btn-outline-light">
            العودة للقائمة
        </a>
    </div>
    
    <!-- نموذج البيانات -->
    <form id="feeForm" method="POST" action="{{ url_for('renewal_fees.create') }}">
        {{ form.hidden_tag() }}
        
        <div class="row">
            <!-- المعلومات الأساسية -->
            <div class="col-lg-4">
                <div class="main-section">
                    <h3 class="section-header">
                        <i class="fas fa-info-circle me-2"></i>
                        المعلومات الأساسية
                    </h3>
                    <div class="section-body">
                        <div class="form-group">
                            <label for="document_id" class="form-label">
                                الوثيقة <span class="text-danger">*</span>
                            </label>
                            <select name="document_id" id="document_id" class="form-select select2" required>
                                <option value="">-- اختر الوثيقة --</option>
                                {% for document in documents %}
                                <option value="{{ document.id }}">{{ document.employee.name }} - {{ document.document_type }} ({{ document.document_number }})</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fee_date" class="form-label">
                                تاريخ الاستحقاق <span class="text-danger">*</span>
                            </label>
                            <input type="date" name="fee_date" id="fee_date" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="payment_status" class="form-label">
                                حالة الدفع <span class="text-danger">*</span>
                            </label>
                            <select name="payment_status" id="payment_status" class="form-select" required>
                                {% for status_key, status_name in payment_statuses.items() %}
                                <option value="{{ status_key }}" {% if status_key == 'pending' %}selected{% endif %}>{{ status_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div id="payment_details" style="display: none;">
                            <div class="form-group">
                                <label for="payment_date" class="form-label">
                                    تاريخ الدفع
                                </label>
                                <input type="date" name="payment_date" id="payment_date" class="form-control">
                            </div>
                            
                            <div class="form-group">
                                <label for="receipt_number" class="form-label">
                                    رقم الإيصال
                                </label>
                                <input type="text" name="receipt_number" id="receipt_number" class="form-control" placeholder="أدخل رقم الإيصال">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="main-section">
                    <h3 class="section-header">
                        <i class="fas fa-question-circle me-2"></i>
                        تعليمات الاستخدام
                    </h3>
                    <div class="section-body">
                        <ul class="instructions-list">
                            <li><i class="fas fa-check"></i> اختر وثيقة الموظف</li>
                            <li><i class="fas fa-check"></i> حدد تاريخ استحقاق الرسوم</li>
                            <li><i class="fas fa-check"></i> اختر نوع واحد فقط من الرسوم</li>
                            <li><i class="fas fa-check"></i> أدخل قيمة الرسوم بالريال</li>
                            <li><i class="fas fa-check"></i> في حالة رسوم نقل الكفالة، أدخل رقم النقل</li>
                        </ul>
                    </div>
                </div>

                <button type="submit" class="save-btn">
                    <i class="fas fa-check-circle me-2"></i>
                    حفظ رسوم التجديد
                </button>
            </div>
            
            <!-- جدول الرسوم -->
            <div class="col-lg-8">
                <div class="main-section">
                    <h3 class="section-header">
                        <i class="fas fa-money-bill-wave me-2"></i>
                        أنواع الرسوم
                    </h3>
                    <div class="section-body">
                        <table class="custom-table">
                            <thead>
                                <tr>
                                    <th>نوع الرسم</th>
                                    <th>المبلغ</th>
                                    <th>المعلومات</th>
                                    <th>اختيار</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- رسوم مكتب العمل -->
                                <tr class="fee-row" id="labor_office_row">
                                    <td width="30%">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-building me-2 text-primary"></i>
                                            <span class="fw-bold">رسوم مكتب العمل</span>
                                        </div>
                                    </td>
                                    <td width="20%">
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="labor_office_amount" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td width="30%">
                                        <input type="text" class="form-control" id="labor_office_notes" placeholder="ملاحظات">
                                    </td>
                                    <td width="20%" class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="labor_office" id="labor_office_toggle">
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- رسوم الجوازات -->
                                <tr class="fee-row" id="passport_row">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-passport me-2 text-info"></i>
                                            <span class="fw-bold">رسوم الجوازات</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="passport_amount" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" id="passport_notes" placeholder="ملاحظات">
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="passport" id="passport_toggle">
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- رسوم التأمينات الاجتماعية -->
                                <tr class="fee-row" id="social_insurance_row">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-users me-2 text-success"></i>
                                            <span class="fw-bold">رسوم التأمينات الاجتماعية</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="social_insurance_amount" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" id="social_insurance_notes" placeholder="ملاحظات">
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="social_insurance" id="social_insurance_toggle">
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- رسوم نقل الكفالة -->
                                <tr class="fee-row" id="transfer_sponsorship_row">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-exchange-alt me-2 text-danger"></i>
                                            <span class="fw-bold">رسوم نقل الكفالة</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="transfer_sponsorship_amount" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex">
                                            <input type="text" class="form-control" id="transfer_number" name="transfer_number" placeholder="رقم النقل" style="width: 50%;">
                                            <input type="text" class="form-control ms-2" id="transfer_sponsorship_notes" placeholder="ملاحظات" style="width: 50%;">
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="transfer_sponsorship" id="transfer_sponsorship_toggle">
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- رسوم أخرى -->
                                <tr class="fee-row" id="other_row">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-file-invoice-dollar me-2 text-secondary"></i>
                                            <span class="fw-bold">رسوم أخرى</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="other_amount" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" id="other_notes" placeholder="تفاصيل الرسوم">
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="other" id="other_toggle">
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- ملخص الرسوم -->
                <div class="main-section">
                    <h3 class="section-header">
                        <i class="fas fa-receipt me-2"></i>
                        ملخص الرسوم المختارة
                    </h3>
                    <div class="section-body">
                        <div id="fee_summary_empty" class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            لم يتم اختيار أي نوع من الرسوم بعد. يرجى اختيار نوع الرسم وإدخال المبلغ.
                        </div>
                        
                        <div id="fee_summary" style="display: none;">
                            <table class="table table-bordered">
                                <tr>
                                    <th width="30%">نوع الرسم:</th>
                                    <td id="summary_fee_type">-</td>
                                </tr>
                                <tr>
                                    <th>المبلغ:</th>
                                    <td id="summary_fee_amount" class="text-success fw-bold">0.00 ريال</td>
                                </tr>
                                <tr id="summary_transfer_row" style="display: none;">
                                    <th>رقم النقل:</th>
                                    <td id="summary_transfer_number">-</td>
                                </tr>
                                <tr>
                                    <th>الملاحظات:</th>
                                    <td id="summary_notes">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- حقول مخفية لنقل البيانات للخادم -->
        <input type="hidden" name="amount" id="hidden_amount">
        <input type="hidden" name="notes" id="hidden_notes">
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تهيئة السيلكت2
        $('.select2').select2({
            dir: 'rtl',
            width: '100%'
        });
        
        // مراجع العناصر
        const paymentStatus = document.getElementById('payment_status');
        const paymentDetails = document.getElementById('payment_details');
        const feeForm = document.getElementById('feeForm');
        const feeToggles = document.querySelectorAll('.fee-toggle');
        const feeRows = document.querySelectorAll('.fee-row');
        const feeSummaryEmpty = document.getElementById('fee_summary_empty');
        const feeSummary = document.getElementById('fee_summary');
        const summaryFeeType = document.getElementById('summary_fee_type');
        const summaryFeeAmount = document.getElementById('summary_fee_amount');
        const summaryTransferRow = document.getElementById('summary_transfer_row');
        const summaryTransferNumber = document.getElementById('summary_transfer_number');
        const summaryNotes = document.getElementById('summary_notes');
        const hiddenAmountField = document.getElementById('hidden_amount');
        const hiddenNotesField = document.getElementById('hidden_notes');
        
        // إظهار/إخفاء تفاصيل الدفع
        paymentStatus.addEventListener('change', function() {
            if (this.value === 'paid') {
                paymentDetails.style.display = 'block';
                document.getElementById('payment_date').setAttribute('required', 'required');
            } else {
                paymentDetails.style.display = 'none';
                document.getElementById('payment_date').removeAttribute('required');
            }
        });
        
        // التحقق من الحالة الأولية
        if (paymentStatus.value === 'paid') {
            paymentDetails.style.display = 'block';
            document.getElementById('payment_date').setAttribute('required', 'required');
        }
        
        // معالجة تبديل نوع الرسم
        feeToggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                // إزالة الصف النشط من جميع الصفوف
                feeRows.forEach(row => row.classList.remove('active'));
                
                // تنشيط الصف المحدد
                if (this.checked) {
                    const row = document.getElementById(this.value + '_row');
                    if (row) {
                        row.classList.add('active');
                        
                        // تحديث الملخص
                        updateSummary(this.value);
                    }
                }
            });
        });
        
        // تحديث الملخص عند تغيير المبلغ
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function() {
                const feeType = this.id.replace('_amount', '');
                const toggle = document.getElementById(feeType + '_toggle');
                
                if (toggle && toggle.checked) {
                    updateSummary(feeType);
                }
            });
        });
        
        // تحديث عرض رقم النقل
        const transferNumber = document.getElementById('transfer_number');
        if (transferNumber) {
            transferNumber.addEventListener('input', function() {
                const toggle = document.getElementById('transfer_sponsorship_toggle');
                
                if (toggle && toggle.checked) {
                    summaryTransferNumber.textContent = this.value || '-';
                }
            });
        }
        
        // تحديث الملاحظات
        document.querySelectorAll('input[id$="_notes"]').forEach(input => {
            input.addEventListener('input', function() {
                const feeType = this.id.replace('_notes', '');
                const toggle = document.getElementById(feeType + '_toggle');
                
                if (toggle && toggle.checked) {
                    summaryNotes.textContent = this.value || '-';
                }
            });
        });
        
        // معالجة إرسال النموذج
        feeForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // التحقق من اختيار نوع الرسم
            const selectedToggle = document.querySelector('.fee-toggle:checked');
            if (!selectedToggle) {
                alert('يرجى اختيار نوع الرسم');
                return;
            }
            
            const feeType = selectedToggle.value;
            const amountField = document.getElementById(feeType + '_amount');
            
            // التحقق من إدخال مبلغ صحيح
            if (!amountField || !amountField.value || parseFloat(amountField.value) <= 0) {
                alert('يرجى إدخال مبلغ صحيح');
                if (amountField) amountField.focus();
                return;
            }
            
            // التحقق من إدخال رقم النقل إذا كان نوع الرسم هو نقل الكفالة
            if (feeType === 'transfer_sponsorship') {
                if (!transferNumber.value.trim()) {
                    alert('يرجى إدخال رقم النقل لرسوم نقل الكفالة');
                    transferNumber.focus();
                    return;
                }
            }
            
            // تعيين قيم الحقول المخفية
            hiddenAmountField.value = amountField.value;
            
            const notesField = document.getElementById(feeType + '_notes');
            if (notesField) {
                hiddenNotesField.value = notesField.value || '';
            }
            
            // عرض مؤشر التحميل
            showLoading();
            
            // إرسال النموذج
            this.submit();
        });
        
        // تحديث ملخص الرسوم
        function updateSummary(feeType) {
            const amountField = document.getElementById(feeType + '_amount');
            const notesField = document.getElementById(feeType + '_notes');
            
            const amount = amountField ? parseFloat(amountField.value) || 0 : 0;
            const notes = notesField ? notesField.value : '';
            
            if (amount > 0) {
                // إظهار الملخص
                feeSummaryEmpty.style.display = 'none';
                feeSummary.style.display = 'block';
                
                // تعيين قيم الملخص
                summaryFeeType.textContent = getFeeTypeName(feeType);
                summaryFeeAmount.textContent = amount.toFixed(2) + ' ريال';
                summaryNotes.textContent = notes || '-';
                
                // عرض/إخفاء صف رقم النقل
                if (feeType === 'transfer_sponsorship') {
                    summaryTransferRow.style.display = 'table-row';
                    summaryTransferNumber.textContent = transferNumber.value || '-';
                } else {
                    summaryTransferRow.style.display = 'none';
                }
            } else {
                // إخفاء الملخص
                feeSummaryEmpty.style.display = 'block';
                feeSummary.style.display = 'none';
            }
        }
        
        // الحصول على اسم نوع الرسم بالعربية
        function getFeeTypeName(feeType) {
            const feeTypes = {
                'labor_office': 'رسوم مكتب العمل',
                'passport': 'رسوم الجوازات',
                'social_insurance': 'رسوم التأمينات الاجتماعية',
                'transfer_sponsorship': 'رسوم نقل الكفالة',
                'other': 'رسوم أخرى'
            };
            
            return feeTypes[feeType] || 'غير معروف';
        }
        
        // عرض مؤشر التحميل
        function showLoading() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center';
            loadingDiv.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            loadingDiv.style.zIndex = '9999';
            
            loadingDiv.innerHTML = `
                <div class="card p-4 shadow">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-3" role="status"></div>
                        <h5 class="mb-0">جاري حفظ البيانات...</h5>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loadingDiv);
        }
    });
</script>
{% endblock %}