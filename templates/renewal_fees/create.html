{% extends 'layout.html' %}

{% block title %}إضافة رسوم تجديد{% endblock %}

{% block styles %}
<style>
    /* تصميم عام */
    .card {
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
    }
    
    .card-header {
        padding: 15px;
    }
    
    .card-body {
        padding: 20px;
    }
    
    /* تصميم صفوف نوع الرسم */
    .fee-row {
        transition: all 0.3s ease;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
    }
    
    .fee-row:hover {
        background-color: rgba(13, 110, 253, 0.1);
    }
    
    .fee-row.active {
        background-color: rgba(13, 110, 253, 0.2);
        box-shadow: 0 0 5px rgba(13, 110, 253, 0.5);
    }
    
    /* تصميم حقول الإدخال */
    .fee-amount {
        font-weight: bold;
        text-align: left;
    }
    
    /* تصميم مفاتيح التبديل */
    .form-check-input {
        cursor: pointer;
        width: 2.5em;
        height: 1.3em;
    }
    
    /* تصميم جدول الملخص */
    .fee-summary {
        background-color: #1e2f45;
        border-radius: 10px;
        overflow: hidden;
    }
    
    /* تصميم الملاحظات */
    .alert-hint {
        background-color: rgba(255, 193, 7, 0.2);
        border-left: 4px solid #ffc107;
    }
    
    /* تأثيرات للأزرار */
    .btn-success {
        transition: all 0.3s;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- عنوان الصفحة -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <div class="bg-gradient-primary rounded-circle p-3 me-3 shadow-sm">
                <i class="fas fa-money-bill-wave fa-2x text-white"></i>
            </div>
            <div>
                <h2 class="mb-0 fw-bold">إضافة رسوم تجديد جديدة</h2>
                <p class="text-muted mb-0">إدخال رسوم تجديد الأوراق للموظفين</p>
            </div>
        </div>
        <a href="{{ url_for('renewal_fees.index') }}" class="btn btn-outline-primary">
            <i class="fas fa-arrow-right me-1"></i>
            العودة للقائمة
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- نموذج إضافة رسوم التجديد -->
            <form method="POST" action="{{ url_for('renewal_fees.create') }}" id="feesForm">
                {{ form.hidden_tag() }}
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-file-alt me-2"></i>
                            المعلومات الأساسية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="document_id" class="form-label">الوثيقة <span class="text-danger">*</span></label>
                                <select name="document_id" id="document_id" class="form-select select2" required>
                                    <option value="">-- اختر وثيقة --</option>
                                    {% for document in documents %}
                                    <option value="{{ document.id }}">{{ document.employee.name }} - {{ document.document_type }} ({{ document.document_number }})</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="fee_date" class="form-label">تاريخ الاستحقاق <span class="text-danger">*</span></label>
                                <input type="date" name="fee_date" id="fee_date" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="payment_status" class="form-label">حالة الدفع <span class="text-danger">*</span></label>
                                <select name="payment_status" id="payment_status" class="form-select" required>
                                    {% for status_key, status_name in payment_statuses.items() %}
                                    <option value="{{ status_key }}" {% if status_key == 'pending' %}selected{% endif %}>{{ status_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div id="payment_details" class="row mb-3" style="display: none;">
                            <div class="col-md-6">
                                <label for="payment_date" class="form-label">تاريخ الدفع</label>
                                <input type="date" name="payment_date" id="payment_date" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label for="receipt_number" class="form-label">رقم الإيصال</label>
                                <input type="text" name="receipt_number" id="receipt_number" class="form-control" placeholder="أدخل رقم الإيصال">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list-alt me-2"></i>
                            اختر نوع الرسم والمبلغ
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-hint mb-4">
                            <i class="fas fa-lightbulb me-2"></i>
                            <span>اختر نوع واحد فقط من الرسوم من القائمة أدناه، وأدخل المبلغ المطلوب.</span>
                        </div>
                        
                        <div class="fee-types">
                            <!-- رسوم مكتب العمل -->
                            <div class="form-check mb-3 p-0">
                                <div class="fee-row d-flex align-items-center p-3" id="labor_office_row">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="labor_office" id="labor_office_toggle">
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <label class="form-check-label fw-bold" for="labor_office_toggle">
                                            <i class="fas fa-building me-2 text-primary"></i>
                                            رسوم مكتب العمل
                                        </label>
                                        <div class="d-flex align-items-center" style="width: 50%;">
                                            <div class="input-group" style="width: 60%;">
                                                <input type="number" class="form-control fee-amount" id="labor_office_amount" min="0" step="0.01" placeholder="المبلغ">
                                                <span class="input-group-text">ريال</span>
                                            </div>
                                            <input type="text" class="form-control ms-2" id="labor_office_notes" placeholder="ملاحظات" style="width: 40%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسوم الجوازات -->
                            <div class="form-check mb-3 p-0">
                                <div class="fee-row d-flex align-items-center p-3" id="passport_row">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="passport" id="passport_toggle">
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <label class="form-check-label fw-bold" for="passport_toggle">
                                            <i class="fas fa-passport me-2 text-info"></i>
                                            رسوم الجوازات
                                        </label>
                                        <div class="d-flex align-items-center" style="width: 50%;">
                                            <div class="input-group" style="width: 60%;">
                                                <input type="number" class="form-control fee-amount" id="passport_amount" min="0" step="0.01" placeholder="المبلغ">
                                                <span class="input-group-text">ريال</span>
                                            </div>
                                            <input type="text" class="form-control ms-2" id="passport_notes" placeholder="ملاحظات" style="width: 40%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسوم التأمينات الاجتماعية -->
                            <div class="form-check mb-3 p-0">
                                <div class="fee-row d-flex align-items-center p-3" id="social_insurance_row">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="social_insurance" id="social_insurance_toggle">
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <label class="form-check-label fw-bold" for="social_insurance_toggle">
                                            <i class="fas fa-users me-2 text-success"></i>
                                            رسوم التأمينات الاجتماعية
                                        </label>
                                        <div class="d-flex align-items-center" style="width: 50%;">
                                            <div class="input-group" style="width: 60%;">
                                                <input type="number" class="form-control fee-amount" id="social_insurance_amount" min="0" step="0.01" placeholder="المبلغ">
                                                <span class="input-group-text">ريال</span>
                                            </div>
                                            <input type="text" class="form-control ms-2" id="social_insurance_notes" placeholder="ملاحظات" style="width: 40%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسوم نقل الكفالة -->
                            <div class="form-check mb-3 p-0">
                                <div class="fee-row d-flex align-items-center p-3" id="transfer_sponsorship_row">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="transfer_sponsorship" id="transfer_sponsorship_toggle">
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <label class="form-check-label fw-bold" for="transfer_sponsorship_toggle">
                                            <i class="fas fa-exchange-alt me-2 text-danger"></i>
                                            رسوم نقل الكفالة
                                        </label>
                                        <div class="d-flex" style="width: 50%;">
                                            <div class="input-group" style="width: 40%;">
                                                <input type="number" class="form-control fee-amount" id="transfer_sponsorship_amount" min="0" step="0.01" placeholder="المبلغ">
                                                <span class="input-group-text">ريال</span>
                                            </div>
                                            <input type="text" class="form-control mx-2" id="transfer_number" name="transfer_number" placeholder="رقم النقل" style="width: 30%;">
                                            <input type="text" class="form-control" id="transfer_sponsorship_notes" placeholder="ملاحظات" style="width: 30%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- رسوم أخرى -->
                            <div class="form-check mb-3 p-0">
                                <div class="fee-row d-flex align-items-center p-3" id="other_row">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="other" id="other_toggle">
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center w-100">
                                        <label class="form-check-label fw-bold" for="other_toggle">
                                            <i class="fas fa-file-invoice-dollar me-2 text-secondary"></i>
                                            رسوم أخرى
                                        </label>
                                        <div class="d-flex align-items-center" style="width: 50%;">
                                            <div class="input-group" style="width: 60%;">
                                                <input type="number" class="form-control fee-amount" id="other_amount" min="0" step="0.01" placeholder="المبلغ">
                                                <span class="input-group-text">ريال</span>
                                            </div>
                                            <input type="text" class="form-control ms-2" id="other_notes" placeholder="تفاصيل" style="width: 40%;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- حقل المبلغ المخفي الذي سيتم إرساله -->
                        <input type="hidden" name="amount" id="amount">
                        <input type="hidden" name="notes" id="notes">
                        
                        <div class="mt-4 d-flex justify-content-between">
                            <button type="reset" class="btn btn-outline-secondary">
                                <i class="fas fa-undo me-1"></i>
                                إعادة ضبط
                            </button>
                            <button type="submit" class="btn btn-success px-4">
                                <i class="fas fa-check-circle me-1"></i>
                                حفظ الرسوم
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        
        <div class="col-lg-4">
            <!-- ملخص الرسوم -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-receipt me-2"></i>
                        ملخص الرسوم
                    </h5>
                </div>
                <div class="card-body">
                    <div class="fee-summary p-3 mb-3">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-light rounded-circle p-2 me-2">
                                <i class="fas fa-file-invoice-dollar text-primary"></i>
                            </div>
                            <h6 class="mb-0 text-white" id="fee_type_label">نوع الرسم:</h6>
                            <span class="badge bg-primary ms-2" id="selected_fee_type">لم يتم الاختيار</span>
                        </div>
                        
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-light rounded-circle p-2 me-2">
                                <i class="fas fa-money-bill-wave text-success"></i>
                            </div>
                            <h6 class="mb-0 text-white">المبلغ:</h6>
                            <h5 class="mb-0 ms-auto text-success" id="fee_amount_display">0.00 ريال</h5>
                        </div>
                        
                        <div class="d-flex align-items-center" id="transfer_number_display_container" style="display: none;">
                            <div class="bg-light rounded-circle p-2 me-2">
                                <i class="fas fa-exchange-alt text-warning"></i>
                            </div>
                            <h6 class="mb-0 text-white">رقم النقل:</h6>
                            <span class="badge bg-warning ms-2" id="transfer_number_display">-</span>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <span>اختر نوع الرسم وأدخل المبلغ لتسجيل رسوم التجديد</span>
                    </div>
                </div>
            </div>
            
            <!-- كارت المساعدة -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-question-circle me-2"></i>
                        تعليمات الاستخدام
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="ps-3">
                        <li class="mb-2">اختر الوثيقة المطلوبة من القائمة المنسدلة</li>
                        <li class="mb-2">حدد تاريخ استحقاق الرسوم</li>
                        <li class="mb-2">اختر نوع واحد فقط من الرسوم</li>
                        <li class="mb-2">أدخل المبلغ المستحق بالريال</li>
                        <li class="mb-2">في حالة رسوم نقل الكفالة، تأكد من إدخال رقم النقل</li>
                        <li>اضغط على زر "حفظ الرسوم" لإتمام العملية</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تهيئة السيلكت2
        $('.select2').select2({
            dir: 'rtl',
            width: '100%'
        });
        
        // إظهار/إخفاء تفاصيل الدفع بناءً على حالة الدفع
        const paymentStatus = document.getElementById('payment_status');
        const paymentDetails = document.getElementById('payment_details');
        
        paymentStatus.addEventListener('change', function() {
            if (this.value === 'paid') {
                paymentDetails.style.display = 'flex';
                document.getElementById('payment_date').setAttribute('required', 'required');
            } else {
                paymentDetails.style.display = 'none';
                document.getElementById('payment_date').removeAttribute('required');
            }
        });
        
        // تفعيل التالتات الاولية
        if (paymentStatus.value === 'paid') {
            paymentDetails.style.display = 'flex';
            document.getElementById('payment_date').setAttribute('required', 'required');
        }
        
        // مقابض للعناصر المختلفة
        const feeRows = document.querySelectorAll('.fee-row');
        const feeToggles = document.querySelectorAll('.fee-toggle');
        const transferNumberContainer = document.getElementById('transfer_number_display_container');
        const transferNumberDisplay = document.getElementById('transfer_number_display');
        const selectedFeeTypeDisplay = document.getElementById('selected_fee_type');
        const feeAmountDisplay = document.getElementById('fee_amount_display');
        const hiddenAmountField = document.getElementById('amount');
        const hiddenNotesField = document.getElementById('notes');
        
        // تفعيل صف نوع الرسم عند اختياره
        feeToggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                // إلغاء تفعيل جميع الصفوف
                feeRows.forEach(row => {
                    row.classList.remove('active');
                });
                
                // تفعيل الصف المحدد
                if (this.checked) {
                    const row = this.closest('.fee-row');
                    row.classList.add('active');
                    
                    // تحديث العرض في الملخص
                    const feeType = this.value;
                    selectedFeeTypeDisplay.textContent = getFeeTypeName(feeType);
                    
                    // إظهار حقل رقم النقل إذا كان نوع الرسم هو نقل كفالة
                    if (feeType === 'transfer_sponsorship') {
                        transferNumberContainer.style.display = 'flex';
                        updateTransferNumber();
                    } else {
                        transferNumberContainer.style.display = 'none';
                    }
                    
                    // تحديث المبلغ في الملخص
                    updateFeeAmount(feeType);
                    
                    // تعيين التركيز على حقل المبلغ
                    const amountField = row.querySelector('.fee-amount');
                    if (amountField) {
                        amountField.focus();
                    }
                }
            });
        });
        
        // تحديث المبلغ عند التغيير
        document.querySelectorAll('.fee-amount').forEach(input => {
            input.addEventListener('input', function() {
                const row = this.closest('.fee-row');
                const toggle = row.querySelector('.fee-toggle');
                
                if (toggle && toggle.checked) {
                    updateFeeAmount(toggle.value);
                }
            });
        });
        
        // تحديث رقم النقل عند التغيير
        document.getElementById('transfer_number').addEventListener('input', updateTransferNumber);
        
        // تحديث حقول الإدخال المخفية قبل إرسال النموذج
        document.getElementById('feesForm').addEventListener('submit', function(event) {
            // تحقق من اختيار نوع رسم
            const selectedFeeType = document.querySelector('.fee-toggle:checked');
            if (!selectedFeeType) {
                event.preventDefault();
                alert('يرجى اختيار نوع الرسم');
                return;
            }
            
            const feeType = selectedFeeType.value;
            const amountField = document.getElementById(`${feeType}_amount`);
            
            // تحقق من إدخال المبلغ
            if (!amountField || !amountField.value || parseFloat(amountField.value) <= 0) {
                event.preventDefault();
                alert('يرجى إدخال مبلغ صحيح');
                if (amountField) amountField.focus();
                return;
            }
            
            // تعيين قيمة المبلغ في الحقل المخفي
            hiddenAmountField.value = amountField.value;
            
            // تعيين قيمة الملاحظات في الحقل المخفي
            const notesField = document.getElementById(`${feeType}_notes`);
            if (notesField) {
                hiddenNotesField.value = notesField.value;
            }
            
            // تحقق من إدخال رقم النقل لرسوم نقل الكفالة
            if (feeType === 'transfer_sponsorship') {
                const transferNumber = document.getElementById('transfer_number');
                if (!transferNumber || !transferNumber.value.trim()) {
                    event.preventDefault();
                    alert('يرجى إدخال رقم النقل لرسوم نقل الكفالة');
                    if (transferNumber) transferNumber.focus();
                    return;
                }
            }
            
            // إظهار رسالة التحميل
            showLoadingMessage();
        });
        
        // دالة لتحديث المبلغ في الملخص
        function updateFeeAmount(feeType) {
            const amountField = document.getElementById(`${feeType}_amount`);
            const amount = amountField ? parseFloat(amountField.value) || 0 : 0;
            feeAmountDisplay.textContent = amount.toFixed(2) + ' ريال';
            
            // تعطيل/تمكين زر الحفظ بناءً على وجود مبلغ
            document.querySelector('button[type="submit"]').disabled = amount <= 0;
        }
        
        // دالة لتحديث رقم النقل في الملخص
        function updateTransferNumber() {
            const transferNumber = document.getElementById('transfer_number');
            transferNumberDisplay.textContent = transferNumber && transferNumber.value ? transferNumber.value : '-';
        }
        
        // دالة للحصول على اسم نوع الرسم بالعربية
        function getFeeTypeName(feeType) {
            const feeTypes = {
                'labor_office': 'رسوم مكتب العمل',
                'passport': 'رسوم الجوازات',
                'social_insurance': 'رسوم التأمينات الاجتماعية',
                'transfer_sponsorship': 'رسوم نقل الكفالة',
                'other': 'رسوم أخرى'
            };
            
            return feeTypes[feeType] || 'نوع غير معروف';
        }
        
        // دالة لإظهار رسالة التحميل
        function showLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-50';
            loadingDiv.style.zIndex = '9999';
            
            loadingDiv.innerHTML = `
                <div class="card p-4 shadow">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-primary me-3" role="status"></div>
                        <h5 class="mb-0">جاري حفظ البيانات...</h5>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loadingDiv);
        }
    });
</script>
{% endblock %}