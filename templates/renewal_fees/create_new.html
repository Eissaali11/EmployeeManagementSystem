{% extends 'layout.html' %}

{% block title %}إضافة رسوم تجديد{% endblock %}

{% block styles %}
<style>
    /* تصميم عام */
    body {
        background-color: #e9f0f7;
    }
    
    .main-container {
        background-color: #f5f8fa;
        border-radius: 0;
        padding: 0;
        box-shadow: none;
    }
    
    .card {
        border: none;
        border-radius: 0;
        background-color: #192f4d;
        color: white;
        margin-bottom: 15px;
    }
    
    .card-header {
        background-color: #192f4d;
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .card-body {
        padding: 15px;
    }
    
    /* تصميم العناوين */
    .section-title {
        color: white;
        font-size: 1rem;
        margin: 0;
        font-weight: 600;
    }
    
    /* تصميم حقول الإدخال */
    .form-control, .form-select {
        background-color: #192f4d;
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 0;
        color: white;
        padding: 10px;
    }
    
    .form-control:focus, .form-select:focus {
        background-color: #1b3254;
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
        box-shadow: none;
    }
    
    .form-control::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }
    
    /* تصميم جدول الرسوم */
    .fees-table {
        width: 100%;
        color: white;
    }
    
    .fees-table th {
        padding: 10px;
        font-weight: 600;
        text-align: right;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .fees-table td {
        padding: 5px 10px;
        vertical-align: middle;
    }
    
    .fees-table .form-check {
        margin: 0;
    }
    
    /* تصميم الأزرار */
    .btn-success {
        background-color: #28a745;
        border: none;
        color: white;
        border-radius: 0;
        padding: 10px 20px;
        width: 100%;
    }
    
    .btn-outline-secondary {
        background-color: transparent;
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        border-radius: 0;
        padding: 10px 20px;
        width: 100%;
    }
    
    /* تصميم الخط */
    .hr-light {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        margin: 15px 0;
    }
    
    /* تصميم ملخص الرسوم */
    .fee-summary {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 10px;
        border-radius: 0;
    }
    
    /* تصميم رسالة المعلومات */
    .info-message {
        background-color: rgba(255, 255, 255, 0.05);
        padding: 15px;
        border-radius: 0;
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
    }
    
    /* مربع الاختيار */
    .form-check-input {
        width: 18px;
        height: 18px;
        background-color: #192f4d;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .form-check-input:checked {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3 main-container">
    <!-- عنوان الصفحة -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">رسوم تجديد الأوراق</h4>
        <a href="{{ url_for('renewal_fees.index') }}" class="btn btn-sm btn-outline-primary rounded-0">
            العودة للقائمة
        </a>
    </div>

    <!-- نموذج إضافة رسوم التجديد -->
    <form method="POST" action="{{ url_for('renewal_fees.create') }}" id="feesForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="amount" id="amount" value="">
        <input type="hidden" name="notes" id="notes" value="">
        
        <div class="row">
            <!-- القسم الأيمن (بيانات الوثيقة) -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="section-title">المعلومات الأساسية</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="document_id" class="form-label">الوثيقة</label>
                            <select name="document_id" id="document_id" class="form-select select2" required>
                                <option value="">-- اختر وثيقة --</option>
                                {% for document in documents %}
                                <option value="{{ document.id }}">{{ document.employee.name }} - {{ document.document_type }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="fee_date" class="form-label">تاريخ الاستحقاق</label>
                            <input type="date" name="fee_date" id="fee_date" class="form-control" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="payment_status" class="form-label">حالة الدفع</label>
                            <select name="payment_status" id="payment_status" class="form-select" required>
                                {% for status_key, status_name in payment_statuses.items() %}
                                <option value="{{ status_key }}" {% if status_key == 'pending' %}selected{% endif %}>{{ status_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div id="payment_details" style="display: none;">
                            <div class="mb-3">
                                <label for="payment_date" class="form-label">تاريخ الدفع</label>
                                <input type="date" name="payment_date" id="payment_date" class="form-control">
                            </div>
                            
                            <div class="mb-3">
                                <label for="receipt_number" class="form-label">رقم الإيصال</label>
                                <input type="text" name="receipt_number" id="receipt_number" class="form-control" placeholder="أدخل رقم الإيصال">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="section-title">ملخص الرسوم</h5>
                    </div>
                    <div class="card-body">
                        <div class="fee-summary p-3">
                            <div class="row mb-2">
                                <div class="col-6 text-muted">نوع الرسم:</div>
                                <div class="col-6 text-end fw-bold" id="fee_type_display">-</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 text-muted">المبلغ:</div>
                                <div class="col-6 text-end fw-bold" id="fee_amount_display">0.00 ريال</div>
                            </div>
                            <div id="transfer_row" class="row" style="display: none;">
                                <div class="col-6 text-muted">رقم النقل:</div>
                                <div class="col-6 text-end fw-bold" id="transfer_number_display">-</div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success mt-3" id="submitButton" disabled>
                            <i class="fas fa-check-circle me-1"></i>
                            حفظ الرسوم
                        </button>
                        
                        <button type="reset" class="btn btn-outline-secondary mt-2" id="resetButton">
                            <i class="fas fa-undo me-1"></i>
                            إعادة ضبط
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="section-title">تعليمات الاستخدام</h5>
                    </div>
                    <div class="card-body">
                        <div class="info-message">
                            <p class="mb-2"><i class="fas fa-check-circle me-1 text-primary"></i> اختر وثيقة الموظف أولاً</p>
                            <p class="mb-2"><i class="fas fa-check-circle me-1 text-primary"></i> حدد تاريخ استحقاق الرسوم</p>
                            <p class="mb-2"><i class="fas fa-check-circle me-1 text-primary"></i> اختر نوع رسوم واحد فقط من الجدول</p>
                            <p class="mb-2"><i class="fas fa-check-circle me-1 text-primary"></i> أدخل قيمة الرسوم بالريال</p>
                            <p class="mb-0"><i class="fas fa-check-circle me-1 text-primary"></i> في حالة نقل الكفالة قم بإدخال رقم النقل</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- القسم الأيسر (جدول الرسوم) -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="section-title">أنواع الرسوم</h5>
                    </div>
                    <div class="card-body">
                        <table class="fees-table">
                            <thead>
                                <tr>
                                    <th width="40%">نوع الرسم</th>
                                    <th width="25%">المبلغ</th>
                                    <th width="30%">ملاحظات</th>
                                    <th width="5%">تفعيل</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- رسوم مكتب العمل -->
                                <tr>
                                    <td>رسوم مكتب العمل</td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control fee-amount" id="labor_office_amount" min="0" step="0.01" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" id="labor_office_notes" placeholder="ملاحظات">
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="labor_office" id="labor_office_toggle">
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- رسوم الجوازات -->
                                <tr>
                                    <td>رسوم الجوازات</td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control fee-amount" id="passport_amount" min="0" step="0.01" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" id="passport_notes" placeholder="ملاحظات">
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="passport" id="passport_toggle">
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- رسوم التأمينات الاجتماعية -->
                                <tr>
                                    <td>رسوم التأمينات الاجتماعية</td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control fee-amount" id="social_insurance_amount" min="0" step="0.01" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" id="social_insurance_notes" placeholder="ملاحظات">
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="social_insurance" id="social_insurance_toggle">
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- رسوم نقل الكفالة -->
                                <tr>
                                    <td>رسوم نقل الكفالة</td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control fee-amount" id="transfer_sponsorship_amount" min="0" step="0.01" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex">
                                            <input type="text" class="form-control form-control-sm me-1" id="transfer_sponsorship_notes" placeholder="ملاحظات" style="width: 50%;">
                                            <input type="text" class="form-control form-control-sm" id="transfer_number" name="transfer_number" placeholder="رقم النقل" style="width: 50%;">
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="transfer_sponsorship" id="transfer_sponsorship_toggle">
                                        </div>
                                    </td>
                                </tr>
                                
                                <!-- رسوم أخرى -->
                                <tr>
                                    <td>رسوم أخرى</td>
                                    <td>
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control fee-amount" id="other_amount" min="0" step="0.01" placeholder="0.00">
                                            <span class="input-group-text">ريال</span>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control form-control-sm" id="other_notes" placeholder="وصف الرسوم">
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check d-flex justify-content-center">
                                            <input class="form-check-input fee-toggle" type="radio" name="fee_type" value="other" id="other_toggle">
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تهيئة السيلكت2
        $('.select2').select2({
            dir: 'rtl',
            width: '100%',
            dropdownParent: $('#document_id').parent(),
            theme: "bootstrap-5"
        });
        
        // إظهار/إخفاء تفاصيل الدفع بناءً على حالة الدفع
        const paymentStatus = document.getElementById('payment_status');
        const paymentDetails = document.getElementById('payment_details');
        
        paymentStatus.addEventListener('change', function() {
            if (this.value === 'paid') {
                paymentDetails.style.display = 'block';
                document.getElementById('payment_date').setAttribute('required', 'required');
            } else {
                paymentDetails.style.display = 'none';
                document.getElementById('payment_date').removeAttribute('required');
            }
        });
        
        // مقابض للعناصر المختلفة
        const feeToggles = document.querySelectorAll('.fee-toggle');
        const feeAmounts = document.querySelectorAll('.fee-amount');
        const transferNumberField = document.getElementById('transfer_number');
        const transferRow = document.getElementById('transfer_row');
        const transferNumberDisplay = document.getElementById('transfer_number_display');
        const feeTypeDisplay = document.getElementById('fee_type_display');
        const feeAmountDisplay = document.getElementById('fee_amount_display');
        const hiddenAmountField = document.getElementById('amount');
        const hiddenNotesField = document.getElementById('notes');
        const submitButton = document.getElementById('submitButton');
        
        // تفعيل الحالة الأولية
        if (paymentStatus.value === 'paid') {
            paymentDetails.style.display = 'block';
            document.getElementById('payment_date').setAttribute('required', 'required');
        }
        
        // تفعيل صف نوع الرسم عند اختياره
        feeToggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                // تحديث العرض في الملخص
                const feeType = this.value;
                feeTypeDisplay.textContent = getFeeTypeName(feeType);
                
                // إظهار حقل رقم النقل إذا كان نوع الرسم هو نقل كفالة
                if (feeType === 'transfer_sponsorship') {
                    transferRow.style.display = 'flex';
                    updateTransferNumber();
                } else {
                    transferRow.style.display = 'none';
                }
                
                // تحديث المبلغ في الملخص
                updateFeeAmount(feeType);
                
                // تعيين التركيز على حقل المبلغ
                const amountField = document.getElementById(`${feeType}_amount`);
                if (amountField) {
                    amountField.focus();
                }
            });
        });
        
        // تحديث المبلغ عند التغيير
        feeAmounts.forEach(input => {
            input.addEventListener('input', function() {
                const row = this.closest('tr');
                const toggle = row.querySelector('.fee-toggle');
                
                if (toggle && toggle.checked) {
                    updateFeeAmount(toggle.value);
                }
            });
        });
        
        // تحديث رقم النقل عند التغيير
        if (transferNumberField) {
            transferNumberField.addEventListener('input', updateTransferNumber);
        }
        
        // تحديث حقول الإدخال المخفية قبل إرسال النموذج
        document.getElementById('feesForm').addEventListener('submit', function(event) {
            // تحقق من اختيار نوع رسم
            const selectedFeeType = document.querySelector('.fee-toggle:checked');
            if (!selectedFeeType) {
                event.preventDefault();
                alert('يرجى اختيار نوع الرسم');
                return;
            }
            
            const feeType = selectedFeeType.value;
            const amountField = document.getElementById(`${feeType}_amount`);
            
            // تحقق من إدخال المبلغ
            if (!amountField || !amountField.value || parseFloat(amountField.value) <= 0) {
                event.preventDefault();
                alert('يرجى إدخال مبلغ صحيح');
                if (amountField) amountField.focus();
                return;
            }
            
            // تعيين قيمة المبلغ في الحقل المخفي
            hiddenAmountField.value = amountField.value;
            
            // تعيين قيمة الملاحظات في الحقل المخفي
            const notesField = document.getElementById(`${feeType}_notes`);
            if (notesField) {
                hiddenNotesField.value = notesField.value;
            }
            
            // تحقق من إدخال رقم النقل لرسوم نقل الكفالة
            if (feeType === 'transfer_sponsorship') {
                const transferNumber = document.getElementById('transfer_number');
                if (!transferNumber || !transferNumber.value.trim()) {
                    event.preventDefault();
                    alert('يرجى إدخال رقم النقل لرسوم نقل الكفالة');
                    if (transferNumber) transferNumber.focus();
                    return;
                }
            }
            
            // إظهار رسالة التحميل
            showLoadingMessage();
        });
        
        // إعادة ضبط النموذج
        document.getElementById('resetButton').addEventListener('click', function() {
            // إعادة تعيين عناصر الملخص
            feeTypeDisplay.textContent = '-';
            feeAmountDisplay.textContent = '0.00 ريال';
            transferNumberDisplay.textContent = '-';
            transferRow.style.display = 'none';
            
            // تعطيل زر الحفظ
            submitButton.disabled = true;
            
            // إخفاء تفاصيل الدفع إذا كانت حالة الدفع "قيد الانتظار"
            if (paymentStatus.value !== 'paid') {
                paymentDetails.style.display = 'none';
            }
        });
        
        // دالة لتحديث المبلغ في الملخص
        function updateFeeAmount(feeType) {
            const amountField = document.getElementById(`${feeType}_amount`);
            const amount = amountField ? parseFloat(amountField.value) || 0 : 0;
            feeAmountDisplay.textContent = amount.toFixed(2) + ' ريال';
            
            // تعطيل/تمكين زر الحفظ بناءً على وجود مبلغ
            submitButton.disabled = amount <= 0;
        }
        
        // دالة لتحديث رقم النقل في الملخص
        function updateTransferNumber() {
            transferNumberDisplay.textContent = transferNumberField && transferNumberField.value ? transferNumberField.value : '-';
        }
        
        // دالة للحصول على اسم نوع الرسم بالعربية
        function getFeeTypeName(feeType) {
            const feeTypes = {
                'labor_office': 'رسوم مكتب العمل',
                'passport': 'رسوم الجوازات',
                'social_insurance': 'رسوم التأمينات الاجتماعية',
                'transfer_sponsorship': 'رسوم نقل الكفالة',
                'other': 'رسوم أخرى'
            };
            
            return feeTypes[feeType] || 'نوع غير معروف';
        }
        
        // دالة لإظهار رسالة التحميل
        function showLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-dark bg-opacity-75';
            loadingDiv.style.zIndex = '9999';
            
            loadingDiv.innerHTML = `
                <div class="card p-3 shadow" style="background-color: #192f4d; border: none; border-radius: 0;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border text-light me-3" role="status"></div>
                        <h5 class="mb-0 text-white">جاري حفظ البيانات...</h5>
                    </div>
                </div>
            `;
            
            document.body.appendChild(loadingDiv);
        }
    });
</script>
{% endblock %}