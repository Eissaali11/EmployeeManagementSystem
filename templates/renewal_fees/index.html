{% extends 'layout.html' %}

{% block title %}رسوم تجديد الأوراق{% endblock %}

{% block styles %}
<style>
    /* تحسينات عامة للقسم */
    .stats-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        margin-right: 15px;
    }
    
    .stats-card {
        transition: transform 0.3s;
    }
    
    .stats-card:hover {
        transform: translateY(-5px);
    }
    
    .filter-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        font-size: 0.7rem;
        padding: 5px 10px;
    }
    
    .card {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .card-header {
        border-bottom: 0;
        background: linear-gradient(135deg, var(--bs-primary) 0%, #2c3e50 100%);
        color: white;
        padding: 1rem 1.5rem;
    }
    
    .table th {
        background-color: rgba(0, 0, 0, 0.1);
        border-top: none;
    }
    
    .table-row-hover:hover {
        background-color: rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transform: scale(1.01);
        transition: transform 0.2s;
    }
    
    /* بادج مخصصة للأنواع المختلفة */
    .badge-fee-type {
        padding: 0.5rem 0.75rem;
        border-radius: 4px;
        font-weight: normal;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .filter-section {
        position: relative;
        margin-top: 1.5rem;
        padding: 1.5rem;
        border-radius: 8px;
        background-color: rgba(0, 0, 0, 0.05);
        border-left: 4px solid var(--bs-primary);
    }
    
    .filter-section .form-label {
        font-weight: 600;
        color: var(--bs-gray-700);
    }

    /* تنسيق التواريخ والأرقام */
    .date-data {
        background-color: rgba(0, 0, 0, 0.05);
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-family: monospace;
        letter-spacing: 1px;
    }
    
    .amount-value {
        font-weight: 700;
        color: var(--bs-success);
    }
    
    /* تحسينات للجدول الرئيسي */
    .table-responsive {
        border-radius: 8px;
        overflow: hidden;
    }
    
    .action-buttons .btn {
        margin-right: 5px;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
    }
    
    .action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* مخطط بياني مع تظليل جميل */
    .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
    }
    
    .chart-gradient {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        background: linear-gradient(180deg, rgba(13,110,253,0.1) 0%, rgba(13,110,253,0) 100%);
        pointer-events: none;
    }
    
    /* أزرار الفلتر المحسنة */
    .filter-btn {
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
    }
    
    .filter-btn::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }
    
    .filter-btn:hover::after {
        animation: ripple 1s ease-out;
    }
    
    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 0.5;
        }
        100% {
            transform: scale(20, 20);
            opacity: 0;
        }
    }
    
    /* حاويات البطاقات مع إطارات خفيفة */
    .fee-stats-card {
        border-right: 5px solid;
        transition: all 0.3s;
    }
    
    .fee-stats-card:hover {
        transform: scale(1.02);
    }
    
    .fee-stats-card.total-card {
        border-right-color: var(--bs-primary);
    }
    
    .fee-stats-card.pending-card {
        border-right-color: var(--bs-warning);
    }
    
    .fee-stats-card.paid-card {
        border-right-color: var(--bs-success);
    }
    
    /* إضافة تأثير عند التمرير على الرسم البياني */
    .chart-card {
        transition: all 0.3s ease;
        overflow: hidden;
    }
    
    .chart-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- عنوان الصفحة مع أيقونة وزر الإضافة -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div class="d-flex align-items-center">
            <div class="stats-icon bg-gradient-primary">
                <i class="fas fa-money-bill-wave fa-2x text-white"></i>
            </div>
            <div class="ms-3">
                <h2 class="mb-0 fw-bold">رسوم تجديد الأوراق</h2>
                <p class="text-muted mb-0">إدارة ومتابعة رسوم تجديد المستندات</p>
            </div>
        </div>
        <a href="{{ url_for('renewal_fees.create') }}" class="btn btn-primary btn-lg rounded-pill">
            <i class="fas fa-plus-circle me-2"></i>
            إضافة رسوم جديدة
        </a>
    </div>

    <!-- إحصائيات سريعة -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card fee-stats-card total-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-primary">
                            <i class="fas fa-file-invoice-dollar fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-1 small fw-bold">إجمالي الرسوم</p>
                            <h3 class="mb-0 fw-bold">{{ '{:,.2f}'.format(total_fees) }} <small>ريال</small></h3>
                            <p class="card-text mt-2 small text-muted">إجمالي جميع رسوم التجديد المسجلة في النظام</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card fee-stats-card pending-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-warning">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-1 small fw-bold">الرسوم قيد الانتظار</p>
                            <h3 class="mb-0 fw-bold">{{ '{:,.2f}'.format(pending_fees) }} <small>ريال</small></h3>
                            <p class="card-text mt-2 small text-muted">رسوم لم يتم تسويتها بعد وتحتاج إلى المتابعة</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card fee-stats-card paid-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stats-icon bg-success">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                        <div>
                            <p class="text-muted mb-1 small fw-bold">الرسوم المدفوعة</p>
                            <h3 class="mb-0 fw-bold">{{ '{:,.2f}'.format(paid_fees) }} <small>ريال</small></h3>
                            <p class="card-text mt-2 small text-muted">رسوم تم سدادها بالكامل ولا تحتاج متابعة</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- قسم الفلترة بتصميم محسن -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>
                تصفية وفرز النتائج
            </h5>
            <button class="btn btn-sm btn-light rounded-pill" data-bs-toggle="collapse" data-bs-target="#filterSection">
                <i class="fas fa-sliders-h me-1"></i>
                إظهار/إخفاء
            </button>
        </div>
        <div class="card-body collapse show" id="filterSection">
            <form method="GET" action="{{ url_for('renewal_fees.index') }}" class="row align-items-end g-3">
                <div class="col-md-4 col-lg-2">
                    <label for="fee_type" class="form-label">نوع الرسم</label>
                    <select class="form-select shadow-sm rounded-pill" id="fee_type" name="fee_type">
                        <option value="">جميع الأنواع</option>
                        {% for type_key, type_name in fee_types.items() %}
                        <option value="{{ type_key }}" {% if fee_type == type_key %}selected{% endif %}>{{ type_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 col-lg-2">
                    <label for="payment_status" class="form-label">حالة الدفع</label>
                    <select class="form-select shadow-sm rounded-pill" id="payment_status" name="payment_status">
                        <option value="">جميع الحالات</option>
                        {% for status_key, status_name in payment_statuses.items() %}
                        <option value="{{ status_key }}" {% if payment_status == status_key %}selected{% endif %}>{{ status_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 col-lg-2">
                    <label for="department_id" class="form-label">القسم</label>
                    <select class="form-select shadow-sm rounded-pill" id="department_id" name="department_id">
                        <option value="">جميع الأقسام</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}" {% if department_id|string == department.id|string %}selected{% endif %}>{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 col-lg-2">
                    <label for="month" class="form-label">الشهر</label>
                    <select class="form-select shadow-sm rounded-pill" id="month" name="month">
                        <option value="">جميع الشهور</option>
                        {% for m in range(1, 13) %}
                        <option value="{{ m }}" {% if month|string == m|string %}selected{% endif %}>
                            {{ ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"][m-1] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 col-lg-2">
                    <label for="year" class="form-label">السنة</label>
                    <select class="form-select shadow-sm rounded-pill" id="year" name="year">
                        <option value="">جميع السنوات</option>
                        {% for y in range(2020, 2031) %}
                        <option value="{{ y }}" {% if year|string == y|string %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 col-lg-2">
                    <button type="submit" class="btn btn-primary w-100 rounded-pill filter-btn">
                        <i class="fas fa-search me-2"></i>
                        تصفية
                    </button>
                </div>

                <!-- عرض الفلاتر النشطة -->
                {% if fee_type or payment_status or department_id or month or year %}
                <div class="col-12 mt-3">
                    <div class="py-2 px-3 bg-light rounded-3">
                        <div class="d-flex flex-wrap align-items-center">
                            <span class="me-2 text-muted">الفلاتر النشطة:</span>
                            {% if fee_type %}
                            <span class="badge bg-primary rounded-pill m-1 p-2">
                                نوع الرسم: {{ fee_types[fee_type] }}
                                <a href="{{ url_for('renewal_fees.index', 
                                    payment_status=payment_status, 
                                    department_id=department_id, 
                                    month=month, 
                                    year=year) }}" class="ms-2 text-white"><i class="fas fa-times-circle"></i></a>
                            </span>
                            {% endif %}
                            
                            {% if payment_status %}
                            <span class="badge bg-info rounded-pill m-1 p-2">
                                حالة الدفع: {{ payment_statuses[payment_status] }}
                                <a href="{{ url_for('renewal_fees.index', 
                                    fee_type=fee_type, 
                                    department_id=department_id, 
                                    month=month, 
                                    year=year) }}" class="ms-2 text-white"><i class="fas fa-times-circle"></i></a>
                            </span>
                            {% endif %}
                            
                            {% if department_id %}
                            <span class="badge bg-secondary rounded-pill m-1 p-2">
                                القسم: {{ departments|selectattr('id', 'eq', department_id|int)|map(attribute='name')|first }}
                                <a href="{{ url_for('renewal_fees.index', 
                                    fee_type=fee_type, 
                                    payment_status=payment_status, 
                                    month=month, 
                                    year=year) }}" class="ms-2 text-white"><i class="fas fa-times-circle"></i></a>
                            </span>
                            {% endif %}
                            
                            {% if month %}
                            <span class="badge bg-dark rounded-pill m-1 p-2">
                                الشهر: {{ ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"][month|int - 1] }}
                                <a href="{{ url_for('renewal_fees.index', 
                                    fee_type=fee_type, 
                                    payment_status=payment_status, 
                                    department_id=department_id,
                                    year=year) }}" class="ms-2 text-white"><i class="fas fa-times-circle"></i></a>
                            </span>
                            {% endif %}
                            
                            {% if year %}
                            <span class="badge bg-dark rounded-pill m-1 p-2">
                                السنة: {{ year }}
                                <a href="{{ url_for('renewal_fees.index', 
                                    fee_type=fee_type, 
                                    payment_status=payment_status, 
                                    department_id=department_id, 
                                    month=month) }}" class="ms-2 text-white"><i class="fas fa-times-circle"></i></a>
                            </span>
                            {% endif %}
                            
                            <a href="{{ url_for('renewal_fees.index') }}" class="btn btn-sm btn-outline-danger ms-auto rounded-pill">
                                <i class="fas fa-trash-alt me-1"></i>
                                مسح الكل
                            </a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- الرسم البياني المحسن -->
    <div class="card chart-card shadow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2"></i>
                توزيع الرسوم حسب النوع
            </h5>
            <div class="btn-group">
                <button type="button" class="btn btn-sm btn-light active" id="barChartBtn">
                    <i class="fas fa-chart-bar"></i>
                </button>
                <button type="button" class="btn btn-sm btn-light" id="pieChartBtn">
                    <i class="fas fa-chart-pie"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="feeTypeChart"></canvas>
                <div class="chart-gradient"></div>
            </div>
            <!-- معلومات إضافية تحت الرسم البياني -->
            <div class="row mt-3">
                {% for fee_type, amount in fee_type_data.items() %}
                {% if amount > 0 %}
                <div class="col-md-3 col-sm-6 mb-3">
                    <div class="d-flex align-items-center p-2 rounded bg-light">
                        <div class="me-2" style="width: 15px; height: 15px; border-radius: 50%; 
                            background-color: {% if fee_type == 'passport' %}rgba(54, 162, 235, 0.8)
                            {% elif fee_type == 'labor_office' %}rgba(75, 192, 192, 0.8)
                            {% elif fee_type == 'insurance' %}rgba(255, 206, 86, 0.8)
                            {% elif fee_type == 'social_insurance' %}rgba(46, 204, 113, 0.8)
                            {% elif fee_type == 'transfer_sponsorship' %}rgba(153, 102, 255, 0.8)
                            {% else %}rgba(201, 203, 207, 0.8){% endif %};">
                        </div>
                        <div>
                            <small class="d-block text-muted">{{ fee_types.get(fee_type, fee_type) }}</small>
                            <strong>{{ '{:,.2f}'.format(amount) }} ريال</strong>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- جدول الرسوم المحسن -->
    <div class="card shadow mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list-alt me-2"></i>
                قائمة رسوم تجديد الأوراق
            </h5>
            <div>
                <a href="{{ url_for('renewal_fees.stats') }}" class="btn btn-sm btn-outline-light rounded-pill">
                    <i class="fas fa-chart-pie me-1"></i>
                    إحصائيات متقدمة
                </a>
                <button class="btn btn-sm btn-outline-light ms-2 rounded-pill" id="exportTableBtn">
                    <i class="fas fa-file-excel me-1"></i>
                    تصدير
                </button>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="renewalFeesTable">
                    <thead class="table-light">
                        <tr>
                            <th class="text-center">#</th>
                            <th>الموظف</th>
                            <th>نوع الوثيقة</th>
                            <th>نوع الرسم</th>
                            <th>المبلغ</th>
                            <th>تاريخ الاستحقاق</th>
                            <th>حالة الدفع</th>
                            <th>تاريخ الدفع</th>
                            <th>رقم الإيصال/النقل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for fee in fees %}
                        <tr class="table-row-hover">
                            <td class="text-center">{{ loop.index }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <span class="avatar-circle me-2" style="background-color: #{{ '%06x' % (fee.document.employee.id * 12345 % 0xffffff) }}">
                                        {{ fee.document.employee.name[0] }}
                                    </span>
                                    <div>
                                        <a href="{{ url_for('employees.view', id=fee.document.employee.id) }}" class="text-primary fw-bold mb-0 d-block">
                                            {{ fee.document.employee.name }}
                                        </a>
                                        <small class="text-muted">{{ fee.document.employee.job_title }}</small>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <a href="{{ url_for('renewal_fees.document_fees', document_id=fee.document.id) }}" class="text-decoration-none">
                                    <span class="badge rounded-pill bg-secondary">
                                        {{ fee.document.document_type }}
                                    </span>
                                    <div class="small text-muted mt-1">{{ fee.document.document_number }}</div>
                                </a>
                            </td>
                            <td>
                                <span class="badge-fee-type 
                                    {% if fee.fee_type == 'passport' %}bg-primary
                                    {% elif fee.fee_type == 'labor_office' %}bg-info
                                    {% elif fee.fee_type == 'insurance' %}bg-warning
                                    {% elif fee.fee_type == 'social_insurance' %}bg-success
                                    {% elif fee.fee_type == 'transfer_sponsorship' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    <i class="
                                        {% if fee.fee_type == 'passport' %}fas fa-passport
                                        {% elif fee.fee_type == 'labor_office' %}fas fa-building
                                        {% elif fee.fee_type == 'insurance' %}fas fa-shield-alt
                                        {% elif fee.fee_type == 'social_insurance' %}fas fa-users
                                        {% elif fee.fee_type == 'transfer_sponsorship' %}fas fa-exchange-alt
                                        {% else %}fas fa-file-invoice{% endif %} me-1"></i>
                                    {{ fee_types[fee.fee_type] }}
                                </span>
                            </td>
                            <td>
                                <span class="amount-value">{{ '{:,.2f}'.format(fee.amount) }}</span>
                                <small class="d-block text-muted">ريال</small>
                            </td>
                            <td>
                                <span class="date-data">{{ fee.fee_date.strftime('%Y-%m-%d') }}</span>
                            </td>
                            <td>
                                <span class="badge rounded-pill 
                                      {% if fee.payment_status == 'pending' %}bg-warning
                                      {% elif fee.payment_status == 'paid' %}bg-success
                                      {% elif fee.payment_status == 'overdue' %}bg-danger
                                      {% endif %} p-2">
                                    <i class="
                                        {% if fee.payment_status == 'pending' %}fas fa-clock
                                        {% elif fee.payment_status == 'paid' %}fas fa-check-circle
                                        {% elif fee.payment_status == 'overdue' %}fas fa-exclamation-circle
                                        {% endif %} me-1"></i>
                                    {{ payment_statuses[fee.payment_status] }}
                                </span>
                            </td>
                            <td>
                                {% if fee.payment_date %}
                                <span class="date-data">{{ fee.payment_date.strftime('%Y-%m-%d') }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if fee.fee_type == 'transfer_sponsorship' and fee.transfer_number %}
                                <div class="d-flex flex-column">
                                    <span class="badge bg-info">رقم النقل: {{ fee.transfer_number }}</span>
                                    {% if fee.receipt_number %}
                                    <small class="mt-1">إيصال: {{ fee.receipt_number }}</small>
                                    {% endif %}
                                </div>
                                {% elif fee.receipt_number %}
                                <span class="badge bg-secondary">{{ fee.receipt_number }}</span>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{{ url_for('renewal_fees.edit', id=fee.id) }}" class="btn btn-primary" data-bs-toggle="tooltip" title="تعديل">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ fee.id }}" data-bs-toggle="tooltip" title="حذف">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                                
                                <!-- Modal for Delete -->
                                <div class="modal fade" id="deleteModal{{ fee.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ fee.id }}" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header bg-danger text-white">
                                                <h5 class="modal-title" id="deleteModalLabel{{ fee.id }}">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    تأكيد الحذف
                                                </h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body p-4">
                                                <div class="text-center mb-4">
                                                    <i class="fas fa-trash-alt fa-4x text-danger mb-3"></i>
                                                    <h5>هل أنت متأكد من حذف هذا الرسم؟</h5>
                                                    <p class="text-muted">هذا الإجراء لا يمكن التراجع عنه.</p>
                                                </div>

                                                <div class="alert alert-secondary">
                                                    <p class="mb-1"><strong>نوع الرسم:</strong> {{ fee_types[fee.fee_type] }}</p>
                                                    <p class="mb-1"><strong>المبلغ:</strong> {{ '{:,.2f}'.format(fee.amount) }} ريال</p>
                                                    <p class="mb-0"><strong>الموظف:</strong> {{ fee.document.employee.name }}</p>
                                                </div>
                                            </div>
                                            <div class="modal-footer justify-content-center">
                                                <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">
                                                    <i class="fas fa-times me-2"></i>
                                                    إلغاء
                                                </button>
                                                <form action="{{ url_for('renewal_fees.delete', id=fee.id) }}" method="POST" class="d-inline">
                                                    <button type="submit" class="btn btn-danger rounded-pill px-4">
                                                        <i class="fas fa-trash-alt me-2"></i>
                                                        تأكيد الحذف
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="10" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice-dollar fa-4x text-muted mb-3"></i>
                                    <h4>لا توجد رسوم تجديد مسجلة</h4>
                                    <p class="text-muted">لم يتم العثور على أي رسوم تجديد. يمكنك إضافة رسوم جديدة عن طريق النقر على زر "إضافة رسوم جديدة"</p>
                                    <a href="{{ url_for('renewal_fees.create') }}" class="btn btn-primary rounded-pill mt-3">
                                        <i class="fas fa-plus-circle me-2"></i>
                                        إضافة رسوم جديدة
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // تفعيل tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // إضافة أسلوب CSS للأحرف الأولى في الأسماء
        var style = document.createElement('style');
        style.innerHTML = `
            .avatar-circle {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                background-color: #3498db;
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
            }
        `;
        document.head.appendChild(style);

        // تهيئة جدول البيانات
        var dataTable = $('#renewalFeesTable').DataTable({
            language: {
                url: 'https://cdn.datatables.net/plug-ins/1.10.25/i18n/ar.json'
            },
            order: [[5, 'desc']], // ترتيب حسب تاريخ الاستحقاق (تنازلي)
            pageLength: 10,
            dom: "<'row'<'col-sm-6'l><'col-sm-6'f>>" +
                 "<'row'<'col-sm-12'tr>>" +
                 "<'row'<'col-sm-5'i><'col-sm-7'p>>",
            responsive: true
        });
        
        // الرسم البياني
        let chartType = 'bar';
        let feeTypeChart;
        
        function createChart(type) {
            const ctx = document.getElementById('feeTypeChart').getContext('2d');
            
            // تنظيف أي رسم بياني موجود
            if (feeTypeChart) {
                feeTypeChart.destroy();
            }
            
            // تكوين البيانات
            const chartLabels = [
                'الجوازات',
                'مكتب العمل',
                'التأمين',
                'التأمينات الاجتماعية',
                'نقل كفالة',
                'أخرى'
            ];
            
            const chartData = [
                {{ fee_type_data.get('passport', 0) }},
                {{ fee_type_data.get('labor_office', 0) }},
                {{ fee_type_data.get('insurance', 0) }},
                {{ fee_type_data.get('social_insurance', 0) }},
                {{ fee_type_data.get('transfer_sponsorship', 0) }},
                {{ fee_type_data.get('other', 0) }}
            ];
            
            const backgroundColors = [
                'rgba(54, 162, 235, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(46, 204, 113, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(201, 203, 207, 0.8)'
            ];
            
            const borderColors = backgroundColors.map(color => color.replace('0.8', '1'));
            
            // إعداد الرسم البياني
            feeTypeChart = new Chart(ctx, {
                type: type,
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'المبلغ (ريال)',
                        data: chartData,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1,
                        borderRadius: type === 'bar' ? 5 : 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: {
                            display: type === 'pie' || type === 'doughnut',
                            position: 'right',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const formattedValue = new Intl.NumberFormat('ar-SA', {
                                        style: 'currency',
                                        currency: 'SAR',
                                        minimumFractionDigits: 2
                                    }).format(value);
                                    
                                    return formattedValue;
                                }
                            },
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 14
                            },
                            padding: 12,
                            cornerRadius: 8,
                            backgroundColor: 'rgba(0, 0, 0, 0.7)'
                        }
                    },
                    scales: type === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(200, 200, 200, 0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('ar-SA') + ' ريال';
                                },
                                font: {
                                    size: 12
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    } : undefined
                }
            });
        }
        
        // إنشاء الرسم البياني الافتراضي
        createChart(chartType);
        
        // التبديل بين أنواع الرسوم البيانية
        document.getElementById('barChartBtn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('pieChartBtn').classList.remove('active');
            createChart('bar');
        });
        
        document.getElementById('pieChartBtn').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('barChartBtn').classList.remove('active');
            createChart('doughnut');
        });
        
        // زر تصدير البيانات
        document.getElementById('exportTableBtn').addEventListener('click', function() {
            // يمكن هنا إضافة وظيفة التصدير إلى Excel
            alert('سيتم إضافة ميزة تصدير البيانات قريبًا!');
        });
    });
</script>
{% endblock %}