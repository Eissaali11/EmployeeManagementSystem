{% extends "layout.html" %}

{% block title %}إدارة صلاحيات المستخدم{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h3 mb-0">
                    <i class="fas fa-key me-2"></i>
                    إدارة صلاحيات المستخدم: {{ user.name or user.email }}
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('attendance.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('users.index') }}">إدارة المستخدمين</a></li>
                        <li class="breadcrumb-item active" aria-current="page">صلاحيات المستخدم</li>
                    </ol>
                </nav>
            </div>

            <!-- معلومات المستخدم -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-user me-2"></i>
                        معلومات المستخدم
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center mb-2">
                                <div class="avatar-lg rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3">
                                    {{ user.name[0] if user.name else user.email[0] }}
                                </div>
                                <div>
                                    <h6 class="mb-1">{{ user.name or 'غير محدد' }}</h6>
                                    <p class="text-muted mb-0">{{ user.email }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-2">
                                <strong>الدور:</strong> 
                                <span class="badge bg-primary">{{ user.role.value }}</span>
                            </div>
                            <div class="mb-2">
                                <strong>القسم المخصص:</strong> 
                                {% if user.assigned_department %}
                                    <span class="badge bg-info">{{ user.assigned_department.name }}</span>
                                {% else %}
                                    <span class="text-muted">غير محدد</span>
                                {% endif %}
                            </div>
                            <div class="mb-2">
                                <strong>الحالة:</strong> 
                                {% if user.is_active %}
                                    <span class="badge bg-success">نشط</span>
                                {% else %}
                                    <span class="badge bg-secondary">غير نشط</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- أزرار التحكم -->
            <div class="d-flex gap-2 mb-4">
                <a href="{{ url_for('users.index') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right me-2"></i>
                    العودة لقائمة المستخدمين
                </a>
            </div>

            <!-- الصلاحيات التفصيلية -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        الصلاحيات التفصيلية حسب الوحدات
                    </h5>
                </div>
                <div class="card-body">
                    {% if user.role.value == 'admin' %}
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-crown me-2"></i>
                            <strong>مدير النظام:</strong> هذا المستخدم لديه صلاحيات كاملة على جميع وحدات النظام.
                        </div>
                    {% else %}
                        <form id="permissionsForm" method="POST" action="{{ url_for('users.update_permissions', user_id=user.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            
                            <div class="row">
                                <!-- صلاحيات الوحدات -->
                                <div class="col-lg-8">
                                    <h6 class="fw-bold mb-3">صلاحيات الوحدات</h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-bordered">
                                            <thead class="table-primary">
                                                <tr>
                                                    <th style="width: 30%">الوحدة</th>
                                                    <th style="width: 14%" class="text-center">عرض</th>
                                                    <th style="width: 14%" class="text-center">إنشاء</th>
                                                    <th style="width: 14%" class="text-center">تعديل</th>
                                                    <th style="width: 14%" class="text-center">حذف</th>
                                                    <th style="width: 14%" class="text-center">إدارة</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% set module_names = {
                                                    'DASHBOARD': 'لوحة التحكم',
                                                    'EMPLOYEES': 'إدارة الموظفين',
                                                    'ATTENDANCE': 'نظام الحضور',
                                                    'DEPARTMENTS': 'إدارة الأقسام',
                                                    'SALARIES': 'إدارة الرواتب',
                                                    'DOCUMENTS': 'إدارة الوثائق',
                                                    'VEHICLES': 'إدارة المركبات',
                                                    'USERS': 'إدارة المستخدمين'
                                                } %}
                                                {% for module in modules %}
                                                {% set current_permissions = user.permissions|selectattr('module', 'equalto', module)|first %}
                                                <tr>
                                                    <td class="fw-medium">{{ module_names.get(module.name, module.value) }}</td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_1"
                                                               {% if current_permissions %}
                                                                   {% set perm_bits = current_permissions.permissions %}
                                                                   {% if (perm_bits // 1) % 2 == 1 %}checked{% endif %}
                                                               {% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_2"
                                                               {% if current_permissions %}
                                                                   {% set perm_bits = current_permissions.permissions %}
                                                                   {% if (perm_bits // 2) % 2 == 1 %}checked{% endif %}
                                                               {% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_4"
                                                               {% if current_permissions %}
                                                                   {% set perm_bits = current_permissions.permissions %}
                                                                   {% if (perm_bits // 4) % 2 == 1 %}checked{% endif %}
                                                               {% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_8"
                                                               {% if current_permissions %}
                                                                   {% set perm_bits = current_permissions.permissions %}
                                                                   {% if (perm_bits // 8) % 2 == 1 %}checked{% endif %}
                                                               {% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_16"
                                                               {% if current_permissions %}
                                                                   {% set perm_bits = current_permissions.permissions %}
                                                                   {% if (perm_bits // 16) % 2 == 1 %}checked{% endif %}
                                                               {% endif %}>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- الأقسام والصلاحيات الحالية -->
                                <div class="col-lg-4">
                                    <!-- إدارة الأقسام -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-building me-2"></i>
                                                الوصول للأقسام
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="department_access" 
                                                       id="all_departments" value="all"
                                                       {% if not user.assigned_department_id %}checked{% endif %}>
                                                <label class="form-check-label" for="all_departments">
                                                    <i class="fas fa-globe me-2 text-success"></i>
                                                    جميع الأقسام
                                                </label>
                                            </div>
                                            
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="department_access" 
                                                       id="specific_departments" value="specific"
                                                       {% if user.assigned_department_id %}checked{% endif %}>
                                                <label class="form-check-label" for="specific_departments">
                                                    <i class="fas fa-building me-2 text-warning"></i>
                                                    أقسام محددة
                                                </label>
                                            </div>
                                            
                                            <div id="departments_selection" class="mt-3" 
                                                 style="{% if not user.assigned_department_id %}display: none;{% endif %}">
                                                <div class="mb-2">
                                                    <small class="text-muted">اختر الأقسام المتاحة للمستخدم:</small>
                                                </div>
                                                
                                                <div class="department-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                                                    {% for dept in departments %}
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="accessible_departments" 
                                                               value="{{ dept.id }}" 
                                                               id="dept_{{ dept.id }}"
                                                               {% if user.assigned_department_id == dept.id or 
                                                                     user.department_accesses|selectattr('department_id', 'equalto', dept.id)|list|length > 0 %}checked{% endif %}>
                                                        <label class="form-check-label" for="dept_{{ dept.id }}">
                                                            <i class="fas fa-building me-2 text-primary"></i>
                                                            {{ dept.name }}
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllDepartments()">
                                                        <i class="fas fa-check-all me-1"></i>
                                                        تحديد الكل
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllDepartments()">
                                                        <i class="fas fa-times me-1"></i>
                                                        إلغاء الكل
                                                    </button>
                                                </div>
                                                
                                                <small class="text-muted mt-2 d-block">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    المستخدم سيتمكن من الوصول لبيانات الأقسام المحددة فقط
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- الصلاحيات الحالية -->
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-list-check me-2"></i>
                                                الصلاحيات الحالية
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if user.permissions %}
                                                {% for perm in user.permissions %}
                                                <div class="mb-3 p-2 border rounded d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <div class="fw-bold mb-2">{{ module_names.get(perm.module.name, perm.module.value) }}</div>
                                                        <div>
                                                            {% set perm_bits = perm.permissions %}
                                                            {% if (perm_bits // 1) % 2 == 1 %}
                                                                <span class="badge bg-success me-1">عرض</span>
                                                            {% endif %}
                                                            {% if (perm_bits // 2) % 2 == 1 %}
                                                                <span class="badge bg-primary me-1">إنشاء</span>
                                                            {% endif %}
                                                            {% if (perm_bits // 4) % 2 == 1 %}
                                                                <span class="badge bg-warning me-1">تعديل</span>
                                                            {% endif %}
                                                            {% if (perm_bits // 8) % 2 == 1 %}
                                                                <span class="badge bg-danger me-1">حذف</span>
                                                            {% endif %}
                                                            {% if (perm_bits // 16) % 2 == 1 %}
                                                                <span class="badge bg-info me-1">إدارة</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <form method="POST" action="{{ url_for('users.delete_permission', user_id=user.id, permission_id=perm.id) }}" 
                                                              style="display: inline;" 
                                                              onsubmit="return confirm('هل أنت متأكد من حذف صلاحية {{ module_names.get(perm.module.name, perm.module.value) }}؟')">
                                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                                            <button type="submit" 
                                                                    class="btn btn-outline-danger btn-sm" 
                                                                    title="حذف صلاحية {{ module_names.get(perm.module.name, perm.module.value) }}">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                                    <p class="mb-0">لا توجد صلاحيات محددة</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <a href="{{ url_for('users.index') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    العودة
                                </a>
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" id="selectAll">
                                        <i class="fas fa-check-double me-1"></i>
                                        تحديد الكل
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary me-2" id="clearAll">
                                        <i class="fas fa-times me-1"></i>
                                        إلغاء الكل
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>
                                        حفظ الصلاحيات
                                    </button>
                                </div>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>

            <!-- معلومات إضافية -->
            <div class="alert alert-info mt-4" role="alert">
                <h6 class="alert-heading">
                    <i class="fas fa-lightbulb me-2"></i>
                    فهم نظام الصلاحيات
                </h6>
                <hr>
                <ul class="mb-0">
                    <li><strong>المديرون:</strong> لديهم وصول كامل لجميع الوحدات والأقسام</li>
                    <li><strong>الأقسام المحددة:</strong> تحدد أي موظفين يمكن للمستخدم إدارة بياناتهم</li>
                    <li><strong>الأدوار:</strong> تحدد الصلاحيات العامة للمستخدم في النظام</li>
                    <li><strong>الصلاحيات التفصيلية:</strong> تتيح تحكم دقيق في كل وحدة</li>
                    <li><strong>اختيار متعدد للأقسام:</strong> يمكن منح الوصول لأكثر من قسم واحد</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle select all permissions button
    document.getElementById('selectAll').addEventListener('click', function() {
        document.querySelectorAll('.permission-checkbox').forEach(function(checkbox) {
            checkbox.checked = true;
        });
    });

    // Handle clear all permissions button
    document.getElementById('clearAll').addEventListener('click', function() {
        document.querySelectorAll('.permission-checkbox').forEach(function(checkbox) {
            checkbox.checked = false;
        });
    });

    // Handle department access radio buttons
    document.querySelectorAll('input[name="department_access"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const departmentsSelection = document.getElementById('departments_selection');
            if (this.value === 'specific') {
                departmentsSelection.style.display = 'block';
            } else {
                departmentsSelection.style.display = 'none';
            }
        });
    });
});

// Functions for department selection
function selectAllDepartments() {
    document.querySelectorAll('input[name="accessible_departments"]').forEach(function(checkbox) {
        checkbox.checked = true;
    });
}

function clearAllDepartments() {
    document.querySelectorAll('input[name="accessible_departments"]').forEach(function(checkbox) {
        checkbox.checked = false;
    });
}
</script>
{% endblock %}

            <!-- معلومات إضافية -->
            <div class="alert alert-info mt-4" role="alert">
                <h6 class="alert-heading">
                    <i class="fas fa-lightbulb me-2"></i>
                    فهم نظام الصلاحيات
                </h6>
                <hr>
                <ul class="mb-0">
                    <li><strong>المديرون:</strong> لديهم وصول كامل لجميع الوحدات والأقسام</li>
                    <li><strong>القسم المخصص:</strong> يحدد أي موظفين يمكن للمستخدم إدارة حضورهم</li>
                    <li><strong>الأدوار:</strong> تحدد الصلاحيات العامة للمستخدم في النظام</li>
                    <li><strong>الصلاحيات التفصيلية:</strong> تتيح تحكم دقيق في كل وحدة</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-lg {
    width: 48px;
    height: 48px;
    font-size: 18px;
}

.table th {
    border-top: none;
    font-weight: 600;
    font-size: 0.875rem;
}

.form-check-input:disabled {
    opacity: 0.5;
}

.alert-heading {
    margin-bottom: 0.5rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllBtn = document.getElementById('selectAll');
    const clearAllBtn = document.getElementById('clearAll');
    const checkboxes = document.querySelectorAll('.permission-checkbox');
    
    if (selectAllBtn) {
        selectAllBtn.addEventListener('click', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
        });
    }
    
    if (clearAllBtn) {
        clearAllBtn.addEventListener('click', function() {
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        });
    }
    
    // تأكيد الحفظ
    const form = document.getElementById('permissionsForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const checkedBoxes = document.querySelectorAll('.permission-checkbox:checked');
            if (checkedBoxes.length === 0) {
                e.preventDefault();
                alert('يرجى تحديد صلاحية واحدة على الأقل');
                return false;
            }
            
            if (!confirm('هل أنت متأكد من حفظ هذه الصلاحيات؟')) {
                e.preventDefault();
                return false;
            }
        });
    }
});
</script>
{% endblock %}