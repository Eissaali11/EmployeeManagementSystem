{% extends "layout.html" %}

{% block title %}إدارة صلاحيات المستخدم{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="h3 mb-0">
                    <i class="fas fa-user-shield me-2 text-primary"></i>
                    إدارة صلاحيات: {{ user.name or user.email }}
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('attendance.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('users.index') }}">المستخدمين</a></li>
                        <li class="breadcrumb-item active">الصلاحيات</li>
                    </ol>
                </nav>
            </div>

            <!-- User Info -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <div class="avatar-lg rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 60px; height: 60px;">
                                    <i class="fas fa-user fa-2x"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1">{{ user.name or 'غير محدد' }}</h5>
                                    <p class="text-muted mb-0">{{ user.email }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <strong>الدور:</strong> 
                            <span class="badge bg-primary fs-6">{{ user.role.value }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>القسم:</strong> 
                            <span class="badge bg-info fs-6">{{ user.assigned_department.name if user.assigned_department else 'متعدد' }}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>الحالة:</strong> 
                            <span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                {% if user.is_active %}نشط{% else %}معطل{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Permissions Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        الصلاحيات التفصيلية حسب الوحدات
                    </h5>
                </div>
                <div class="card-body">
                    {% if user.role.value == 'admin' %}
                        <div class="alert alert-info" role="alert">
                            <i class="fas fa-crown me-2"></i>
                            <strong>مدير النظام:</strong> هذا المستخدم لديه صلاحيات كاملة على جميع وحدات النظام.
                        </div>
                    {% else %}
                        <form id="permissionsForm" method="POST" action="{{ url_for('users.update_permissions', user_id=user.id) }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            
                            <div class="row">
                                <!-- Module Permissions -->
                                <div class="col-lg-8">
                                    <h6 class="fw-bold mb-3">صلاحيات الوحدات</h6>
                                    <div class="table-responsive">
                                        <table class="table table-hover table-bordered">
                                            <thead class="table-primary">
                                                <tr>
                                                    <th style="width: 30%">الوحدة</th>
                                                    <th style="width: 14%" class="text-center">عرض</th>
                                                    <th style="width: 14%" class="text-center">إنشاء</th>
                                                    <th style="width: 14%" class="text-center">تعديل</th>
                                                    <th style="width: 14%" class="text-center">حذف</th>
                                                    <th style="width: 14%" class="text-center">إدارة</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% set module_names = {
                                                    'DASHBOARD': 'لوحة التحكم',
                                                    'EMPLOYEES': 'إدارة الموظفين',
                                                    'ATTENDANCE': 'نظام الحضور',
                                                    'DEPARTMENTS': 'إدارة الأقسام',
                                                    'SALARIES': 'إدارة الرواتب',
                                                    'DOCUMENTS': 'إدارة الوثائق',
                                                    'VEHICLES': 'إدارة المركبات',
                                                    'USERS': 'إدارة المستخدمين'
                                                } %}
                                                {% for module in modules %}
                                                {% set current_permissions = user.permissions|selectattr('module', 'equalto', module)|first %}
                                                <tr>
                                                    <td class="fw-medium">{{ module_names.get(module.name, module.value) }}</td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_1"
                                                               {% if current_permissions and ((current_permissions.permissions // 1) % 2 == 1) %}checked{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_2"
                                                               {% if current_permissions and ((current_permissions.permissions // 2) % 2 == 1) %}checked{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_4"
                                                               {% if current_permissions and ((current_permissions.permissions // 4) % 2 == 1) %}checked{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_8"
                                                               {% if current_permissions and ((current_permissions.permissions // 8) % 2 == 1) %}checked{% endif %}>
                                                    </td>
                                                    <td class="text-center">
                                                        <input type="checkbox" class="form-check-input permission-checkbox" 
                                                               name="permissions" value="{{ module.name }}_16"
                                                               {% if current_permissions and ((current_permissions.permissions // 16) % 2 == 1) %}checked{% endif %}>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Department Access and Current Permissions -->
                                <div class="col-lg-4">
                                    <!-- Department Access -->
                                    <div class="card mb-4">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-building me-2"></i>
                                                الوصول للأقسام
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="department_access" 
                                                       id="all_departments" value="all"
                                                       {% if not user.assigned_department_id %}checked{% endif %}>
                                                <label class="form-check-label" for="all_departments">
                                                    <i class="fas fa-globe me-2 text-success"></i>
                                                    جميع الأقسام
                                                </label>
                                            </div>
                                            
                                            <div class="form-check mb-3">
                                                <input class="form-check-input" type="radio" name="department_access" 
                                                       id="specific_departments" value="specific"
                                                       {% if user.assigned_department_id %}checked{% endif %}>
                                                <label class="form-check-label" for="specific_departments">
                                                    <i class="fas fa-building me-2 text-warning"></i>
                                                    أقسام محددة
                                                </label>
                                            </div>
                                            
                                            <div id="departments_selection" class="mt-3" 
                                                 style="{% if not user.assigned_department_id %}display: none;{% endif %}">
                                                <div class="mb-2">
                                                    <small class="text-muted">اختر الأقسام المتاحة للمستخدم:</small>
                                                </div>
                                                
                                                <div class="department-checkboxes" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px;">
                                                    {% for dept in departments %}
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" 
                                                               name="accessible_departments" 
                                                               value="{{ dept.id }}" 
                                                               id="dept_{{ dept.id }}"
                                                               {% if user.assigned_department_id == dept.id %}checked{% endif %}>
                                                        <label class="form-check-label" for="dept_{{ dept.id }}">
                                                            <i class="fas fa-building me-2 text-primary"></i>
                                                            {{ dept.name }}
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                
                                                <div class="mt-2">
                                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="selectAllDepartments()">
                                                        تحديد الكل
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearAllDepartments()">
                                                        إلغاء الكل
                                                    </button>
                                                </div>
                                                
                                                <small class="text-muted mt-2 d-block">
                                                    المستخدم سيتمكن من الوصول لبيانات الأقسام المحددة فقط
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Current Permissions Summary -->
                                    <div class="card">
                                        <div class="card-header bg-info text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-list-check me-2"></i>
                                                الصلاحيات الحالية
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% if user.permissions %}
                                                {% for perm in user.permissions %}
                                                <div class="mb-3 p-2 border rounded">
                                                    <div class="fw-bold mb-2">{{ module_names.get(perm.module.name, perm.module.value) }}</div>
                                                    <div>
                                                        {% if (perm.permissions // 1) % 2 == 1 %}
                                                            <span class="badge bg-success me-1">عرض</span>
                                                        {% endif %}
                                                        {% if (perm.permissions // 2) % 2 == 1 %}
                                                            <span class="badge bg-primary me-1">إنشاء</span>
                                                        {% endif %}
                                                        {% if (perm.permissions // 4) % 2 == 1 %}
                                                            <span class="badge bg-warning me-1">تعديل</span>
                                                        {% endif %}
                                                        {% if (perm.permissions // 8) % 2 == 1 %}
                                                            <span class="badge bg-danger me-1">حذف</span>
                                                        {% endif %}
                                                        {% if (perm.permissions // 16) % 2 == 1 %}
                                                            <span class="badge bg-info me-1">إدارة</span>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            {% else %}
                                                <div class="text-center text-muted">
                                                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                                    <p class="mb-0">لا توجد صلاحيات محددة</p>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <a href="{{ url_for('users.index') }}" class="btn btn-secondary">
                                    <i class="fas fa-arrow-right me-2"></i>
                                    العودة
                                </a>
                                <div>
                                    <button type="button" class="btn btn-outline-primary me-2" id="selectAll">
                                        تحديد الكل
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary me-2" id="clearAll">
                                        إلغاء الكل
                                    </button>
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-save me-2"></i>
                                        حفظ الصلاحيات
                                    </button>
                                </div>
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>

            <!-- Help Section -->
            <div class="alert alert-info mt-4" role="alert">
                <h6 class="alert-heading">
                    <i class="fas fa-lightbulb me-2"></i>
                    دليل نظام الصلاحيات
                </h6>
                <hr>
                <ul class="mb-0">
                    <li><strong>المديرون:</strong> لديهم وصول كامل لجميع الوحدات والأقسام</li>
                    <li><strong>الأقسام المتعددة:</strong> يمكن منح الوصول لأكثر من قسم واحد</li>
                    <li><strong>الصلاحيات التفصيلية:</strong> تحكم دقيق في كل وحدة (عرض، إنشاء، تعديل، حذف، إدارة)</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle select all permissions
    document.getElementById('selectAll').addEventListener('click', function() {
        document.querySelectorAll('.permission-checkbox').forEach(function(checkbox) {
            checkbox.checked = true;
        });
    });

    // Handle clear all permissions
    document.getElementById('clearAll').addEventListener('click', function() {
        document.querySelectorAll('.permission-checkbox').forEach(function(checkbox) {
            checkbox.checked = false;
        });
    });

    // Handle department access radio buttons
    document.querySelectorAll('input[name="department_access"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const departmentsSelection = document.getElementById('departments_selection');
            if (this.value === 'specific') {
                departmentsSelection.style.display = 'block';
            } else {
                departmentsSelection.style.display = 'none';
            }
        });
    });
});

// Department selection functions
function selectAllDepartments() {
    document.querySelectorAll('input[name="accessible_departments"]').forEach(function(checkbox) {
        checkbox.checked = true;
    });
}

function clearAllDepartments() {
    document.querySelectorAll('input[name="accessible_departments"]').forEach(function(checkbox) {
        checkbox.checked = false;
    });
}
</script>
{% endblock %}