{% extends "layout.html" %}
{% set active_page = 'vehicles' %}

{% block title %}الوثائق السارية للمركبات{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <!-- العنوان الرئيسي -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-primary mb-2">
                        <i class="fas fa-check-circle me-2"></i>
                        الوثائق السارية للمركبات
                    </h2>
                    <p class="text-muted mb-0">عرض وإدارة الوثائق السارية المفعول لجميع المركبات</p>
                </div>
                <div>
                    <a href="{{ url_for('vehicles.expired_documents') }}" class="btn btn-outline-danger me-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        الوثائق المنتهية
                    </a>
                    <button onclick="exportWithFilters()" class="btn btn-success">
                        <i class="fas fa-file-excel me-2"></i>
                        تصدير Excel
                    </button>
                </div>
            </div>

            <!-- فلاتر البحث -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        فلاتر البحث والتصفية
                    </h6>
                </div>
                <div class="card-body">
                    <form id="filterForm" method="GET">
                        <input type="hidden" name="document_status" value="valid">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="document_type" class="form-label">نوع الوثيقة</label>
                                <select class="form-select" id="document_type" name="document_type">
                                    <option value="all" {{ 'selected' if document_type == 'all' else '' }}>جميع الوثائق</option>
                                    <option value="registration" {{ 'selected' if document_type == 'registration' else '' }}>استمارة السيارة</option>
                                    <option value="inspection" {{ 'selected' if document_type == 'inspection' else '' }}>الفحص الدوري</option>
                                    <option value="authorization" {{ 'selected' if document_type == 'authorization' else '' }}>التفويض</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="plate_number" class="form-label">رقم اللوحة</label>
                                <input type="text" class="form-control" id="plate_number" name="plate_number" 
                                       placeholder="ابحث برقم اللوحة..." value="{{ request.args.get('plate_number', '') }}">
                            </div>
                            <div class="col-md-3">
                                <label for="vehicle_make" class="form-label">نوع المركبة</label>
                                <input type="text" class="form-control" id="vehicle_make" name="vehicle_make" 
                                       placeholder="ابحث بنوع المركبة..." value="{{ request.args.get('vehicle_make', '') }}">
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" onclick="applyFilters()" class="btn btn-success">
                                        <i class="fas fa-search me-1"></i>
                                        بحث
                                    </button>
                                    <button type="button" onclick="clearFilters()" class="btn btn-outline-secondary">
                                        <i class="fas fa-times me-1"></i>
                                        مسح
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ملخص الوثائق السارية -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body bg-success bg-opacity-10 border-success">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <span class="fa-stack fa-lg text-success">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fas fa-clipboard-check fa-stack-1x fa-inverse"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="mb-1">الفحص الدوري</h5>
                                    <h3 class="mb-0 fw-bold">{{ expired_inspection|length }}</h3>
                                    <span class="text-success">مركبة سارية الفحص الدوري</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body bg-success bg-opacity-10 border-success">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <span class="fa-stack fa-lg text-success">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fas fa-id-card fa-stack-1x fa-inverse"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="mb-1">التفويض</h5>
                                    <h3 class="mb-0 fw-bold">{{ expired_authorization|length }}</h3>
                                    <span class="text-success">مركبة سارية التفويض</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card shadow-sm">
                        <div class="card-body bg-success bg-opacity-10 border-success">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <span class="fa-stack fa-lg text-success">
                                        <i class="fas fa-circle fa-stack-2x"></i>
                                        <i class="fas fa-file-alt fa-stack-1x fa-inverse"></i>
                                    </span>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h5 class="mb-1">الاستمارة</h5>
                                    <h3 class="mb-0 fw-bold">{{ expired_registration|length }}</h3>
                                    <span class="text-success">مركبة سارية الاستمارة</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- التبويبات للوثائق السارية -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        قائمة المركبات ذات الوثائق السارية
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="inspection-tab" data-bs-toggle="tab" data-bs-target="#inspection-tab-pane" type="button" role="tab" aria-controls="inspection-tab-pane" aria-selected="true">
                                الفحص الدوري
                                <span class="badge bg-success ms-1">{{ expired_inspection|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="authorization-tab" data-bs-toggle="tab" data-bs-target="#authorization-tab-pane" type="button" role="tab" aria-controls="authorization-tab-pane" aria-selected="false">
                                التفويض
                                <span class="badge bg-success ms-1">{{ expired_authorization|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="registration-tab" data-bs-toggle="tab" data-bs-target="#registration-tab-pane" type="button" role="tab" aria-controls="registration-tab-pane" aria-selected="false">
                                الاستمارة
                                <span class="badge bg-success ms-1">{{ expired_registration|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-tab-pane" type="button" role="tab" aria-controls="all-tab-pane" aria-selected="false">
                                كافة الوثائق السارية
                                <span class="badge bg-success ms-1">{{ expired_all|length }}</span>
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="myTabContent">
                        <!-- تبويب الفحص الدوري -->
                        <div class="tab-pane fade show active" id="inspection-tab-pane" role="tabpanel" aria-labelledby="inspection-tab" tabindex="0">
                            {% if expired_inspection %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>رقم اللوحة</th>
                                            <th>نوع المركبة</th>
                                            <th>الموديل</th>
                                            <th>السنة</th>
                                            <th>تاريخ انتهاء الفحص الدوري</th>
                                            <th>الأيام المتبقية</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for vehicle in expired_inspection %}
                                        <tr>
                                            <td>
                                                <span class="fw-bold text-primary">{{ vehicle.plate_number or 'غير محدد' }}</span>
                                            </td>
                                            <td>{{ vehicle.make or 'غير محدد' }}</td>
                                            <td>{{ vehicle.model or 'غير محدد' }}</td>
                                            <td>{{ vehicle.year or 'غير محدد' }}</td>
                                            <td>
                                                {% if vehicle.inspection_expiry_date %}
                                                    <span class="text-success">{{ vehicle.inspection_expiry_date.strftime('%Y-%m-%d') }}</span>
                                                {% else %}
                                                    <span class="text-muted">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if vehicle.inspection_expiry_date %}
                                                    {% set days_remaining = (vehicle.inspection_expiry_date - today).days %}
                                                    {% if days_remaining > 30 %}
                                                        <span class="badge bg-success">{{ days_remaining }} يوم</span>
                                                    {% elif days_remaining > 7 %}
                                                        <span class="badge bg-warning">{{ days_remaining }} يوم</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">{{ days_remaining }} يوم</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>
                                                    عرض
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5 class="text-muted">لا توجد مركبات ذات فحص دوري ساري</h5>
                                <p class="text-muted">جميع الفحوصات الدورية منتهية أو غير محددة</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- تبويب التفويض -->
                        <div class="tab-pane fade" id="authorization-tab-pane" role="tabpanel" aria-labelledby="authorization-tab" tabindex="0">
                            {% if expired_authorization %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>رقم اللوحة</th>
                                            <th>نوع المركبة</th>
                                            <th>الموديل</th>
                                            <th>السنة</th>
                                            <th>تاريخ انتهاء التفويض</th>
                                            <th>الأيام المتبقية</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for vehicle in expired_authorization %}
                                        <tr>
                                            <td>
                                                <span class="fw-bold text-primary">{{ vehicle.plate_number or 'غير محدد' }}</span>
                                            </td>
                                            <td>{{ vehicle.make or 'غير محدد' }}</td>
                                            <td>{{ vehicle.model or 'غير محدد' }}</td>
                                            <td>{{ vehicle.year or 'غير محدد' }}</td>
                                            <td>
                                                {% if vehicle.authorization_expiry_date %}
                                                    <span class="text-success">{{ vehicle.authorization_expiry_date.strftime('%Y-%m-%d') }}</span>
                                                {% else %}
                                                    <span class="text-muted">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if vehicle.authorization_expiry_date %}
                                                    {% set days_remaining = (vehicle.authorization_expiry_date - today).days %}
                                                    {% if days_remaining > 30 %}
                                                        <span class="badge bg-success">{{ days_remaining }} يوم</span>
                                                    {% elif days_remaining > 7 %}
                                                        <span class="badge bg-warning">{{ days_remaining }} يوم</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">{{ days_remaining }} يوم</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>
                                                    عرض
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5 class="text-muted">لا توجد مركبات ذات تفويض ساري</h5>
                                <p class="text-muted">جميع التفاويض منتهية أو غير محددة</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- تبويب الاستمارة -->
                        <div class="tab-pane fade" id="registration-tab-pane" role="tabpanel" aria-labelledby="registration-tab" tabindex="0">
                            {% if expired_registration %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>رقم اللوحة</th>
                                            <th>نوع المركبة</th>
                                            <th>الموديل</th>
                                            <th>السنة</th>
                                            <th>تاريخ انتهاء الاستمارة</th>
                                            <th>الأيام المتبقية</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for vehicle in expired_registration %}
                                        <tr>
                                            <td>
                                                <span class="fw-bold text-primary">{{ vehicle.plate_number or 'غير محدد' }}</span>
                                            </td>
                                            <td>{{ vehicle.make or 'غير محدد' }}</td>
                                            <td>{{ vehicle.model or 'غير محدد' }}</td>
                                            <td>{{ vehicle.year or 'غير محدد' }}</td>
                                            <td>
                                                {% if vehicle.registration_expiry_date %}
                                                    <span class="text-success">{{ vehicle.registration_expiry_date.strftime('%Y-%m-%d') }}</span>
                                                {% else %}
                                                    <span class="text-muted">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if vehicle.registration_expiry_date %}
                                                    {% set days_remaining = (vehicle.registration_expiry_date - today).days %}
                                                    {% if days_remaining > 30 %}
                                                        <span class="badge bg-success">{{ days_remaining }} يوم</span>
                                                    {% elif days_remaining > 7 %}
                                                        <span class="badge bg-warning">{{ days_remaining }} يوم</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">{{ days_remaining }} يوم</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>
                                                    عرض
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5 class="text-muted">لا توجد مركبات ذات استمارة سارية</h5>
                                <p class="text-muted">جميع الاستمارات منتهية أو غير محددة</p>
                            </div>
                            {% endif %}
                        </div>

                        <!-- تبويب جميع الوثائق -->
                        <div class="tab-pane fade" id="all-tab-pane" role="tabpanel" aria-labelledby="all-tab" tabindex="0">
                            {% if expired_all %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-success">
                                        <tr>
                                            <th>رقم اللوحة</th>
                                            <th>نوع المركبة</th>
                                            <th>الموديل</th>
                                            <th>السنة</th>
                                            <th>الاستمارة</th>
                                            <th>الفحص الدوري</th>
                                            <th>التفويض</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for vehicle in expired_all %}
                                        <tr>
                                            <td>
                                                <span class="fw-bold text-primary">{{ vehicle.plate_number or 'غير محدد' }}</span>
                                            </td>
                                            <td>{{ vehicle.make or 'غير محدد' }}</td>
                                            <td>{{ vehicle.model or 'غير محدد' }}</td>
                                            <td>{{ vehicle.year or 'غير محدد' }}</td>
                                            <td>
                                                {% if vehicle.registration_expiry_date and vehicle.registration_expiry_date >= today %}
                                                    <span class="badge bg-success">ساري</span>
                                                {% elif vehicle.registration_expiry_date %}
                                                    <span class="badge bg-danger">منتهي</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if vehicle.inspection_expiry_date and vehicle.inspection_expiry_date >= today %}
                                                    <span class="badge bg-success">ساري</span>
                                                {% elif vehicle.inspection_expiry_date %}
                                                    <span class="badge bg-danger">منتهي</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if vehicle.authorization_expiry_date and vehicle.authorization_expiry_date >= today %}
                                                    <span class="badge bg-success">ساري</span>
                                                {% elif vehicle.authorization_expiry_date %}
                                                    <span class="badge bg-danger">منتهي</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">غير محدد</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('vehicles.view', id=vehicle.id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>
                                                    عرض
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5 class="text-muted">لا توجد مركبات ذات وثائق سارية</h5>
                                <p class="text-muted">جميع الوثائق منتهية أو غير محددة</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // دالة تطبيق الفلاتر
    function applyFilters() {
        const form = document.getElementById('filterForm');
        if (!form) return;
        
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        // إضافة جميع قيم الفورم للمعاملات
        for (let [key, value] of formData.entries()) {
            if (value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // تحديث الرابط
        window.location.href = '{{ url_for("vehicles.valid_documents") }}?' + params.toString();
    }

    // دالة مسح الفلاتر
    function clearFilters() {
        const form = document.getElementById('filterForm');
        if (form) {
            form.reset();
        }
        window.location.href = '{{ url_for("vehicles.valid_documents") }}';
    }

    // دالة تصدير البيانات مع الفلاتر
    function exportWithFilters() {
        const form = document.getElementById('filterForm');
        if (!form) return;
        
        const formData = new FormData(form);
        const params = new URLSearchParams();
        
        // إضافة جميع قيم الفورم للمعاملات
        for (let [key, value] of formData.entries()) {
            if (value.trim() !== '') {
                params.append(key, value);
            }
        }
        
        // فتح رابط التصدير مع المعاملات
        window.open('{{ url_for("vehicles.export_valid_documents_excel") }}?' + params.toString(), '_blank');
    }

    // تعيين القيم الحالية للفلاتر عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        
        // تعيين قيم الفلاتر من URL
        if (urlParams.has('document_type')) {
            const typeSelect = document.getElementById('document_type');
            if (typeSelect) {
                typeSelect.value = urlParams.get('document_type');
            }
        }
        
        if (urlParams.has('plate_number')) {
            const plateInput = document.getElementById('plate_number');
            if (plateInput) {
                plateInput.value = urlParams.get('plate_number');
            }
        }
        
        if (urlParams.has('vehicle_make')) {
            const makeInput = document.getElementById('vehicle_make');
            if (makeInput) {
                makeInput.value = urlParams.get('vehicle_make');
            }
        }
    });
</script>
{% endblock %}