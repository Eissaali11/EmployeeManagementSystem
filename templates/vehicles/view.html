{% extends 'layout.html' %}

{% block title %}تفاصيل السيارة: {{ vehicle.plate_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- شريط التنقل العلوي -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-car ms-2"></i>
            تفاصيل السيارة: {{ vehicle.plate_number }}
        </h2>
        <div>
            <a href="{{ url_for('vehicles.edit', id=vehicle.id) }}" class="btn btn-warning">
                <i class="fas fa-edit ms-1"></i>
                تعديل السيارة
            </a>
            <a href="{{ url_for('vehicles.view_documents', id=vehicle.id) }}" class="btn btn-primary me-2">
                <i class="fas fa-id-card ms-1"></i>
                وثائق المركبة
            </a>
            <a href="{{ url_for('vehicles.confirm_delete', id=vehicle.id) }}" class="btn btn-danger me-2">
                <i class="fas fa-trash ms-1"></i>
                حذف السيارة
            </a>
            <a href="{{ url_for('vehicles.generate_vehicle_report', id=vehicle.id) }}" class="btn btn-info me-2"
                target="_blank">
                <i class="fas fa-file-excel ms-1"></i>
                إنشاء تقرير شامل (Excel)
            </a>
            <a href="{{ url_for('vehicles.index') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-right ms-1"></i>
                العودة للقائمة
            </a>
        </div>
    </div>

    {% if inspection_warnings %}
    <div class="alert alert-warning mb-4">
        <i class="fas fa-exclamation-triangle ms-2"></i>
        {% for warning in inspection_warnings %}
        <span>{{ warning }}</span>{% if not loop.last %} | {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- بطاقة المعلومات الرئيسية -->
    <div class="row mb-4">
        <!-- تفاصيل السيارة الأساسية -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header ">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle ms-2"></i>
                        معلومات السيارة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">رقم اللوحة:</div>
                        <div class="col-sm-8">{{ vehicle.plate_number }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">النوع:</div>
                        <div class="col-sm-8">{{ vehicle.make }} {{ vehicle.model }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">سنة الصنع:</div>
                        <div class="col-sm-8">{{ vehicle.year }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">اللون:</div>
                        <div class="col-sm-8">
                            <span class="badge rounded-pill"
                                style="background-color: {{ vehicle.color }}; color: {{ '#000' if vehicle.color in ['white', 'yellow', 'silver'] else '#fff' }};">
                                {{ vehicle.color }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">الحالة:</div>
                        <div class="col-sm-8">
                            {% if vehicle.status == 'available' %}
                            <span class="badge bg-success">متاحة</span>
                            {% elif vehicle.status == 'rented' %}
                            <span class="badge bg-primary">مؤجرة</span>
                            {% elif vehicle.status == 'in_project' %}
                            <span class="badge bg-info">في المشروع</span>
                            {% elif vehicle.status == 'in_workshop' %}
                            <span class="badge bg-warning text-dark">في الورشة</span>
                            {% elif vehicle.status == 'accident' %}
                            <span class="badge bg-danger">حادث</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ vehicle.status }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">تاريخ الإضافة:</div>
                        <div class="col-sm-8">{{ vehicle.created_at.strftime('%Y-%m-%d') if vehicle.created_at else 'غير محدد' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">آخر تحديث:</div>
                        <div class="col-sm-8">{{ vehicle.updated_at.strftime('%Y-%m-%d') if vehicle.updated_at else 'غير محدد' }}</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-sm-4 fw-bold">السائق الحالي:</div>
                        <div class="col-sm-8">
                            {% if current_driver %}
                            <span class="text-success fw-bold">{{ current_driver.name }}</span>
                            <small class="text-muted d-block">منذ {{ current_driver.formatted_date }}</small>
                            <div class="mt-2">
                                <a href="{{ url_for('vehicles.view_handover', id=current_driver.handover_id) }}"
                                    class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-eye ms-1"></i>
                                    مشاهدة سجل التسليم
                                </a>
                                {% if current_driver.mobile %}
                                <a href="https://wa.me/{{ current_driver.mobile.replace('+', '').replace(' ', '').replace('-', '') }}?text=مرحباً {{ current_driver.name }}%0A%0Aبخصوص المركبة رقم: {{ vehicle.plate_number }}%0Aتاريخ {{ current_driver.handover_type_ar }}: {{ current_driver.formatted_date }}%0A%0Aرابط ملف PDF لبيانات التسليم/الاستلام:%0A{{ url_for('vehicles.handover_pdf_public', id=current_driver.handover_id, _external=True) }}%0A%0Aشكراً لك"
                                    class="btn btn-sm btn-success ms-1" target="_blank" title="إرسال رسالة واتساب">
                                    <i class="fab fa-whatsapp ms-1"></i>
                                    واتساب
                                </a>
                                {% endif %}
                            </div>
                            {% else %}
                            <span class="text-muted">غير محدد</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if vehicle.notes %}
                    <div class="row mb-2">
                        <div class="col-12 fw-bold">ملاحظات:</div>
                        <div class="col-12 mt-2">
                            <div class="alert alert-secondary">{{ vehicle.notes }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- معلومات الإيجار -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-money-bill-wave ms-2"></i>
                        معلومات الإيجار
                    </h5>
                    <a href="{{ url_for('vehicles.create_rental', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                        {% if rental %}تعديل الإيجار{% else %}إضافة إيجار{% endif %}
                    </a>
                </div>
                <div class="card-body">
                    {% if rental %}
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">تاريخ البداية:</div>
                        <div class="col-sm-8">{{ rental.formatted_start_date }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">تاريخ النهاية:</div>
                        <div class="col-sm-8">
                            {% if rental.end_date %}
                            {{ rental.formatted_end_date }}
                            {% else %}
                            <span class="badge bg-info">مستمر</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">قيمة الإيجار الشهري:</div>
                        <div class="col-sm-8">{{ "{:,.2f}".format(rental.monthly_cost) }} ريال</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">حالة الإيجار:</div>
                        <div class="col-sm-8">
                            {% if rental.is_active %}
                            <span class="badge bg-success">نشط</span>
                            {% else %}
                            <span class="badge bg-danger">منتهي</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">المؤجر:</div>
                        <div class="col-sm-8">{{ rental.lessor_name or 'غير محدد' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">معلومات الاتصال:</div>
                        <div class="col-sm-8">{{ rental.lessor_contact or 'غير محدد' }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">رقم العقد:</div>
                        <div class="col-sm-8">{{ rental.contract_number or 'غير محدد' }}</div>
                    </div>
                    {% if rental.notes %}
                    <div class="row mb-2">
                        <div class="col-12 fw-bold">ملاحظات الإيجار:</div>
                        <div class="col-12 mt-2">
                            <div class="alert alert-secondary">{{ rental.notes }}</div>
                        </div>
                    </div>
                    {% endif %}
                    <div class="mt-3">
                        <a href="{{ url_for('vehicles.edit_rental', id=rental.id) }}" class="btn btn-sm btn-warning">
                            <i class="fas fa-edit ms-1"></i>
                            تعديل معلومات الإيجار
                        </a>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-file-contract fa-4x text-muted"></i>
                        </div>
                        <h5>لا يوجد إيجار نشط حالياً</h5>
                        <p class="text-muted">يمكنك إضافة معلومات الإيجار للسيارة من خلال النقر على زر "إضافة إيجار"</p>
                        <a href="{{ url_for('vehicles.create_rental', id=vehicle.id) }}" class="btn btn-primary mt-2">
                            <i class="fas fa-plus ms-1"></i>
                            إضافة إيجار
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- فحوصات السيارة -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check ms-2"></i>
                        الفحص الدوري
                        {% if periodic_inspections %}
                        <span class="badge bg-secondary">{{ periodic_inspections|length }}</span>
                        {% endif %}
                    </h5>
                    <div>
                        <a href="{{ url_for('vehicles.vehicle_inspections', id=vehicle.id) }}"
                            class="btn btn-sm btn-primary">
                            <i class="fas fa-eye ms-1"></i>
                            عرض الكل
                        </a>
                        <a href="{{ url_for('vehicles.create_inspection', id=vehicle.id) }}"
                            class="btn btn-sm btn-success me-1">
                            <i class="fas fa-plus ms-1"></i>
                            إضافة فحص
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if periodic_inspections %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>رقم الفحص</th>
                                    <th>تاريخ الفحص</th>
                                    <th>تاريخ الانتهاء</th>
                                    <th>النوع</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inspection in periodic_inspections[:3] %}
                                <tr
                                    class="{% if inspection.is_expired %}table-danger{% elif inspection.is_expiring_soon %}table-warning{% endif %}">
                                    <td>{{ inspection.inspection_number }}</td>
                                    <td>{{ inspection.formatted_inspection_date }}</td>
                                    <td>{{ inspection.formatted_expiry_date }}</td>
                                    <td>
                                        {% if inspection.inspection_type == 'technical' %}
                                        <span class="badge bg-info">فحص فني</span>
                                        {% elif inspection.inspection_type == 'periodic' %}
                                        <span class="badge bg-primary">فحص دوري</span>
                                        {% elif inspection.inspection_type == 'safety' %}
                                        <span class="badge bg-warning text-dark">فحص أمان</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ inspection.inspection_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if inspection.inspection_status == 'valid' %}
                                        <span class="badge bg-success">ساري</span>
                                        {% elif inspection.inspection_status == 'expired' %}
                                        <span class="badge bg-danger">منتهي</span>
                                        {% elif inspection.inspection_status == 'expiring_soon' %}
                                        <span class="badge bg-warning text-dark">ينتهي قريبًا</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ inspection.inspection_status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if periodic_inspections|length > 3 %}
                    <div class="text-center mt-2">
                        <a href="{{ url_for('vehicles.vehicle_inspections', id=vehicle.id) }}"
                            class="btn btn-sm btn-outline-primary">
                            عرض كل السجلات ({{ periodic_inspections|length }})
                        </a>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-clipboard fa-4x text-muted"></i>
                        </div>
                        <h5>لا توجد سجلات فحص دوري</h5>
                        <p class="text-muted">يمكنك إضافة سجل فحص دوري جديد من خلال النقر على زر "إضافة فحص"</p>
                        <a href="{{ url_for('vehicles.create_inspection', id=vehicle.id) }}"
                            class="btn btn-success mt-2">
                            <i class="fas fa-plus ms-1"></i>
                            إضافة فحص دوري
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header  d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt ms-2"></i>
                        فحوصات السلامة
                        {% if safety_checks %}
                        <span class="badge bg-secondary">{{ safety_checks|length }}</span>
                        {% endif %}
                    </h5>
                    <div>
                        <a href="{{ url_for('vehicles.vehicle_safety_checks', id=vehicle.id) }}"
                            class="btn btn-sm btn-primary">
                            <i class="fas fa-eye ms-1"></i>
                            عرض الكل
                        </a>
                        <a href="{{ url_for('vehicles.create_safety_check', id=vehicle.id) }}"
                            class="btn btn-sm btn-success me-1">
                            <i class="fas fa-plus ms-1"></i>
                            إضافة فحص
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if safety_checks %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>السائق</th>
                                    <th>المشرف</th>
                                    <th>الحالة</th>
                                    <th>مشاكل</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for check in safety_checks[:3] %}
                                <tr>
                                    <td>{{ check.formatted_check_date }}</td>
                                    <td>
                                        {% if check.check_type == 'daily' %}
                                        <span class="badge bg-info">يومي</span>
                                        {% elif check.check_type == 'weekly' %}
                                        <span class="badge bg-warning text-dark">أسبوعي</span>
                                        {% elif check.check_type == 'monthly' %}
                                        <span class="badge bg-danger">شهري</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ check.check_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ check.driver_name }}</td>
                                    <td>{{ check.supervisor_name }}</td>
                                    <td>
                                        {% if check.status == 'completed' %}
                                        <span class="badge bg-success">مكتمل</span>
                                        {% elif check.status == 'in_progress' %}
                                        <span class="badge bg-warning text-dark">قيد التنفيذ</span>
                                        {% elif check.status == 'needs_review' %}
                                        <span class="badge bg-danger">بحاجة للمراجعة</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ check.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if check.issues_found %}
                                        <span class="badge bg-danger">نعم</span>
                                        {% else %}
                                        <span class="badge bg-success">لا</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('vehicles.vehicle_safety_checks', id=vehicle.id) }}"
                                                class="btn btn-sm btn-outline-primary" title="عرض التفاصيل">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('vehicles.edit_safety_check', id=check.id) }}"
                                                class="btn btn-sm btn-outline-warning" title="تعديل">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <form method="POST"
                                                action="{{ url_for('vehicles.delete_safety_check', id=check.id) }}"
                                                style="display: inline-block;"
                                                onsubmit="return confirm('هل أنت متأكد من حذف هذا السجل؟')">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="حذف">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if safety_checks|length > 3 %}
                    <div class="text-center mt-2">
                        <a href="{{ url_for('vehicles.vehicle_safety_checks', id=vehicle.id) }}"
                            class="btn btn-sm btn-outline-primary">
                            عرض كل السجلات ({{ safety_checks|length }})
                        </a>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-shield-alt fa-4x text-muted"></i>
                        </div>
                        <h5>لا توجد سجلات فحص سلامة</h5>
                        <p class="text-muted">يمكنك إضافة سجل فحص سلامة جديد من خلال النقر على زر "إضافة فحص"</p>
                        <a href="{{ url_for('vehicles.create_safety_check', id=vehicle.id) }}"
                            class="btn btn-success mt-2">
                            <i class="fas fa-plus ms-1"></i>
                            إضافة فحص سلامة
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- وثائق المركبة -->
    <div class="row mb-4">
        <!-- بطاقة معلومات وثائق المركبة -->
        <div class="col-md-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-id-card ms-2"></i>
                        وثائق المركبة
                    </h5>
                    <a href="{{ url_for('vehicles.edit_documents', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-edit ms-1"></i>
                        تعديل تواريخ الوثائق
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- تفويض المركبة -->
                        <div class="col-md-4 mb-3">
                            <div class="card h-100 {% if vehicle.authorization_expiry_date %}
                                {% if (vehicle.authorization_expiry_date - today).days < 0 %}
                                    border-danger
                                {% elif (vehicle.authorization_expiry_date - today).days <= 30 %}
                                    border-warning
                                {% else %}
                                    border-success
                                {% endif %}
                            {% else %}
                                border-light
                            {% endif %}">
                                <div class="card-body text-center">
                                    <h5 class="card-title mb-3">
                                        <i class="fas fa-file-contract me-1"></i>
                                        تفويض المركبة
                                    </h5>
                                    {% if vehicle.authorization_expiry_date %}
                                    <p class="mb-1">تاريخ الانتهاء:</p>
                                    <h4 class="mb-2">{{ vehicle.authorization_expiry_date.strftime('%Y-%m-%d') }}</h4>

                                    {% set days_remaining = (vehicle.authorization_expiry_date - today).days %}

                                    {% if days_remaining < 0 %} <div class="badge bg-danger p-2 mb-2 w-100">منتهي منذ {{
                                        days_remaining|abs }} يوم
                                </div>
                                {% elif days_remaining <= 30 %} <div class="badge bg-warning text-dark p-2 mb-2 w-100">
                                    يتبقى {{ days_remaining }} يوم
                            </div>
                            {% else %}
                            <div class="badge bg-success p-2 mb-2 w-100">يتبقى {{ days_remaining }} يوم</div>
                            {% endif %}

                            <a href="{{ url_for('vehicles.view_documents', id=vehicle.id) }}"
                                class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-eye ms-1"></i>
                                التفاصيل
                            </a>
                            {% else %}
                            <div class="text-muted mb-3">
                                <i class="fas fa-exclamation-circle fa-2x"></i>
                                <p class="mt-2">لم يتم تحديد تاريخ انتهاء</p>
                            </div>
                            <a href="{{ url_for('vehicles.edit_documents', id=vehicle.id) }}"
                                class="btn btn-sm btn-primary w-100">
                                <i class="fas fa-plus ms-1"></i>
                                إضافة التاريخ
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- استمارة السيارة -->
                <div class="col-md-4 mb-3">
                    <div class="card h-100 {% if vehicle.registration_expiry_date %}
                                {% if (vehicle.registration_expiry_date - today).days < 0 %}
                                    border-danger
                                {% elif (vehicle.registration_expiry_date - today).days <= 30 %}
                                    border-warning
                                {% else %}
                                    border-success
                                {% endif %}
                            {% else %}
                                border-light
                            {% endif %}">
                        <div class="card-body text-center">
                            <h5 class="card-title mb-3">
                                <i class="fas fa-clipboard-list me-1"></i>
                                استمارة السيارة
                            </h5>
                            {% if vehicle.registration_expiry_date %}
                            <p class="mb-1">تاريخ الانتهاء:</p>
                            <h4 class="mb-2">{{ vehicle.registration_expiry_date.strftime('%Y-%m-%d') }}</h4>

                            {% set days_remaining = (vehicle.registration_expiry_date - today).days %}

                            {% if days_remaining < 0 %} <div class="badge bg-danger p-2 mb-2 w-100">منتهي منذ {{
                                days_remaining|abs }} يوم
                        </div>
                        {% elif days_remaining <= 30 %} <div class="badge bg-warning text-dark p-2 mb-2 w-100">يتبقى {{
                            days_remaining }} يوم
                    </div>
                    {% else %}
                    <div class="badge bg-success p-2 mb-2 w-100">يتبقى {{ days_remaining }} يوم</div>
                    {% endif %}

                    <a href="{{ url_for('vehicles.view_documents', id=vehicle.id) }}"
                        class="btn btn-sm btn-outline-primary w-100">
                        <i class="fas fa-eye ms-1"></i>
                        التفاصيل
                    </a>
                    {% else %}
                    <div class="text-muted mb-3">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                        <p class="mt-2">لم يتم تحديد تاريخ انتهاء</p>
                    </div>
                    <a href="{{ url_for('vehicles.edit_documents', id=vehicle.id) }}"
                        class="btn btn-sm btn-primary w-100">
                        <i class="fas fa-plus ms-1"></i>
                        إضافة التاريخ
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- الفحص الدوري -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 {% if vehicle.inspection_expiry_date %}
                                {% if (vehicle.inspection_expiry_date - today).days < 0 %}
                                    border-danger
                                {% elif (vehicle.inspection_expiry_date - today).days <= 30 %}
                                    border-warning
                                {% else %}
                                    border-success
                                {% endif %}
                            {% else %}
                                border-light
                            {% endif %}">
                <div class="card-body text-center">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-clipboard-check me-1"></i>
                        الفحص الدوري
                    </h5>
                    {% if vehicle.inspection_expiry_date %}
                    <p class="mb-1">تاريخ الانتهاء:</p>
                    <h4 class="mb-2">{{ vehicle.inspection_expiry_date.strftime('%Y-%m-%d') }}</h4>

                    {% set days_remaining = (vehicle.inspection_expiry_date - today).days %}

                    {% if days_remaining < 0 %} <div class="badge bg-danger p-2 mb-2 w-100">منتهي منذ {{
                        days_remaining|abs }} يوم
                </div>
                {% elif days_remaining <= 30 %} <div class="badge bg-warning text-dark p-2 mb-2 w-100">يتبقى {{
                    days_remaining }} يوم
            </div>
            {% else %}
            <div class="badge bg-success p-2 mb-2 w-100">يتبقى {{ days_remaining }} يوم</div>
            {% endif %}

            <a href="{{ url_for('vehicles.view_documents', id=vehicle.id) }}"
                class="btn btn-sm btn-outline-primary w-100">
                <i class="fas fa-eye ms-1"></i>
                التفاصيل
            </a>
            {% else %}
            <div class="text-muted mb-3">
                <i class="fas fa-exclamation-circle fa-2x"></i>
                <p class="mt-2">لم يتم تحديد تاريخ انتهاء</p>
            </div>
            <a href="{{ url_for('vehicles.edit_documents', id=vehicle.id) }}" class="btn btn-sm btn-primary w-100">
                <i class="fas fa-plus ms-1"></i>
                إضافة التاريخ
            </a>
            {% endif %}
        </div>
    </div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- القسم الثاني: سجلات الورشة والمشاريع -->
<div class="row mb-4">
    <!-- سجلات الورشة -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-tools ms-2"></i>
                    سجلات الورشة
                    <span class="badge bg-secondary">{{ workshop_records|length }}</span>
                </h5>
                <div>
                    <div class="dropdown d-inline-block me-2">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-file-export ms-1"></i>
                            تصدير / مشاركة
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="exportDropdown">
                            <li><a class="dropdown-item fw-bold"
                                    href="{{ url_for('vehicles.export_workshop_to_pdf', id=vehicle.id) }}">
                                    <i class="fas fa-file-pdf text-success ms-1"></i>
                                    تصدير PDF <span class="badge bg-success ms-1">محسن</span>
                                </a></li>
                            <li><a class="dropdown-item"
                                    href="{{ url_for('vehicles.export_workshop_to_excel', id=vehicle.id) }}">
                                    <i class="fas fa-file-excel text-success ms-1"></i>
                                    تصدير Excel
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item"
                                    href="{{ url_for('vehicles.print_workshop_records', id=vehicle.id) }}"
                                    target="_blank">
                                    <i class="fas fa-print text-primary ms-1"></i>
                                    طباعة
                                </a></li>
                            <li><a class="dropdown-item"
                                    href="{{ url_for('vehicles.share_workshop_options', id=vehicle.id) }}">
                                    <i class="fas fa-share-alt text-info ms-1"></i>
                                    مشاركة
                                </a></li>
                        </ul>
                    </div>
                    <a href="{{ url_for('vehicles.create_workshop', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus ms-1"></i>
                        إضافة سجل جديد
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if workshop_records %}
                <div class="list-group">
                    {% for record in workshop_records %}
                    <div
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3">
                        <div class="w-75">
                            <div class="fw-bold d-flex align-items-center mb-1">
                                {% if record.reason == 'maintenance' %}
                                <span class="badge bg-info me-2">صيانة دورية</span>
                                {% elif record.reason == 'breakdown' %}
                                <span class="badge bg-warning text-dark me-2">عطل</span>
                                {% elif record.reason == 'accident' %}
                                <span class="badge bg-danger me-2">حادث</span>
                                {% else %}
                                <span class="badge bg-secondary me-2">{{ record.reason }}</span>
                                {% endif %}

                                <!-- حالة الإصلاح -->
                                {% if record.repair_status == 'in_progress' %}
                                <span class="badge rounded-pill bg-warning text-dark me-2">قيد التنفيذ</span>
                                {% elif record.repair_status == 'completed' %}
                                <span class="badge rounded-pill bg-success me-2">تم الإصلاح</span>
                                {% elif record.repair_status == 'pending_approval' %}
                                <span class="badge rounded-pill bg-info me-2">بانتظار الموافقة</span>
                                {% endif %}

                                <!-- اسم الورشة -->
                                {% if record.workshop_name %}
                                <span class="small ms-2">{{ record.workshop_name }}</span>
                                {% endif %}
                            </div>
                            <div class="small mb-1 d-flex align-items-center">
                                <i class="fas fa-calendar-alt text-muted me-1"></i>
                                <span class="text-muted me-1">الدخول:</span>
                                <span class="fw-bold me-3">{{ record.formatted_entry_date }}</span>

                                {% if record.exit_date %}
                                <i class="fas fa-calendar-check text-success me-1"></i>
                                <span class="text-muted me-1">الخروج:</span>
                                <span class="fw-bold">{{ record.formatted_exit_date }}</span>
                                {% else %}
                                <i class="fas fa-tools text-warning me-1"></i>
                                <span class="text-warning fw-bold">ما زالت في الورشة</span>
                                {% endif %}
                            </div>

                            <div class="small d-flex align-items-center">
                                <i class="fas fa-coins text-muted me-1"></i>
                                <span class="text-muted me-1">التكلفة:</span>
                                <span class="fw-bold">{{ "{:,.2f}".format(record.cost) }} ريال</span>

                                {% if record.technician_name %}
                                <span class="mx-2">|</span>
                                <i class="fas fa-user-cog text-muted me-1"></i>
                                <span class="text-muted me-1">الفني:</span>
                                <span>{{ record.technician_name }}</span>
                                {% endif %}
                            </div>

                            <!-- الروابط إن وجدت -->
                            {% if record.delivery_link or record.reception_link %}
                            <div class="mt-2">
                                {% if record.delivery_link %}
                                <a href="{{ record.delivery_link }}" target="_blank"
                                    class="btn btn-sm btn-outline-primary me-2">
                                    <i class="fas fa-file-export me-1"></i>
                                    نموذج التسليم
                                </a>
                                {% endif %}

                                {% if record.reception_link %}
                                <a href="{{ record.reception_link }}" target="_blank"
                                    class="btn btn-sm btn-outline-success">
                                    <i class="fas fa-file-import me-1"></i>
                                    نموذج الاستلام
                                </a>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>

                        <div class="d-flex flex-column align-items-center">
                            <!-- زر عرض التفاصيل -->
                            <a href="{{ url_for('vehicles.workshop_details', workshop_id=record.id) }}"
                                class="btn btn-sm btn-info mb-2 w-100" title="عرض التفاصيل">
                                <i class="fas fa-eye ms-1"></i>
                                عرض
                            </a>

                            <!-- زر التعديل -->
                            <a href="{{ url_for('vehicles.edit_workshop', id=record.id) }}"
                                class="btn btn-sm btn-warning w-100" title="تعديل">
                                <i class="fas fa-edit ms-1"></i>
                                تعديل
                            </a>
                        </div>

                        <!-- نافذة عرض التفاصيل - نموذج جديد بتصميم أبسط -->
                        <div class="modal fade" id="workshopDetails{{ record.id }}" tabindex="-1"
                            aria-labelledby="workshopDetailsLabel{{ record.id }}" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="workshopDetailsLabel{{ record.id }}">
                                            <i class="fas fa-tools ms-2"></i>
                                            تفاصيل سجل الورشة
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="إغلاق"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="table-responsive mb-4">
                                            <table class="table table-bordered table-striped">
                                                <tbody>
                                                    <tr>
                                                        <th scope="row" class="table-light" width="30%">سبب الدخول</th>
                                                        <td>
                                                            {% if record.reason == 'maintenance' %}
                                                            <span class="badge bg-info">صيانة دورية</span>
                                                            {% elif record.reason == 'breakdown' %}
                                                            <span class="badge bg-warning text-dark">عطل</span>
                                                            {% elif record.reason == 'accident' %}
                                                            <span class="badge bg-danger">حادث</span>
                                                            {% else %}
                                                            <span class="badge bg-secondary">{{ record.reason }}</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row" class="table-light">حالة الإصلاح</th>
                                                        <td>
                                                            {% if record.repair_status == 'in_progress' %}
                                                            <span class="badge bg-warning text-dark">قيد التنفيذ</span>
                                                            {% elif record.repair_status == 'completed' %}
                                                            <span class="badge bg-success">تم الإصلاح</span>
                                                            {% elif record.repair_status == 'pending_approval' %}
                                                            <span class="badge bg-info">بانتظار الموافقة</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row" class="table-light">تاريخ الدخول</th>
                                                        <td>{{ record.formatted_entry_date }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row" class="table-light">تاريخ الخروج</th>
                                                        <td>
                                                            {% if record.exit_date %}
                                                            {{ record.formatted_exit_date }}
                                                            {% else %}
                                                            <span class="text-warning">ما زالت في الورشة</span>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row" class="table-light">اسم الورشة</th>
                                                        <td>{{ record.workshop_name or 'غير محدد' }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row" class="table-light">اسم الفني</th>
                                                        <td>{{ record.technician_name or 'غير محدد' }}</td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row" class="table-light">التكلفة</th>
                                                        <td>{{ "{:,.2f}".format(record.cost) }} ريال</td>
                                                    </tr>
                                                    {% if record.delivery_link or record.reception_link %}
                                                    <tr>
                                                        <th scope="row" class="table-light">الروابط</th>
                                                        <td>
                                                            {% if record.delivery_link %}
                                                            <a href="{{ record.delivery_link }}" target="_blank"
                                                                class="btn btn-sm btn-outline-primary me-2 mb-2">
                                                                <i class="fas fa-external-link-alt ms-1"></i>
                                                                نموذج التسليم
                                                            </a>
                                                            {% endif %}

                                                            {% if record.reception_link %}
                                                            <a href="{{ record.reception_link }}" target="_blank"
                                                                class="btn btn-sm btn-outline-success mb-2">
                                                                <i class="fas fa-external-link-alt ms-1"></i>
                                                                نموذج الاستلام
                                                            </a>
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endif %}
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="mb-4">
                                            <h6 class="fw-bold mb-2">وصف العطل أو الصيانة</h6>
                                            <div class="card">
                                                <div class="card-body bg-light">
                                                    {{ record.description|nl2br|safe or 'لا يوجد وصف' }}
                                                </div>
                                            </div>
                                        </div>

                                        {% if record.notes %}
                                        <div class="mb-4">
                                            <h6 class="fw-bold mb-2">ملاحظات إضافية</h6>
                                            <div class="card">
                                                <div class="card-body bg-light">
                                                    {{ record.notes|nl2br|safe }}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        {% if record.images %}
                                        <div>
                                            <h6 class="fw-bold mb-2">الصور</h6>
                                            <div class="row">
                                                {% for image in record.images %}
                                                {% if image.image_type == 'before' %}
                                                <div class="col-md-3 mb-3">
                                                    <div class="card">
                                                        <div class="card-header bg-warning text-dark py-1 small">قبل
                                                            الإصلاح</div>
                                                        <img src="{{ url_for('static', filename=image.image_path) }}"
                                                            class="img-fluid" alt="صورة قبل الإصلاح">
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% endfor %}

                                                {% for image in record.images %}
                                                {% if image.image_type == 'after' %}
                                                <div class="col-md-3 mb-3">
                                                    <div class="card">
                                                        <div class="card-header bg-success text-white py-1 small">بعد
                                                            الإصلاح</div>
                                                        <img src="{{ url_for('static', filename=image.image_path) }}"
                                                            class="img-fluid" alt="صورة بعد الإصلاح">
                                                    </div>
                                                </div>
                                                {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="modal-footer">
                                        <a href="{{ url_for('vehicles.edit_workshop', id=record.id) }}"
                                            class="btn btn-warning">
                                            <i class="fas fa-edit ms-1"></i>
                                            تعديل السجل
                                        </a>
                                        <button type="button" class="btn btn-secondary"
                                            data-bs-dismiss="modal">إغلاق</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="d-flex justify-content-between mt-3">
                    <div>
                        <span class="fw-bold">إجمالي تكاليف الصيانة:</span>
                        <span class="badge bg-primary">{{ "{:,.2f}".format(total_maintenance_cost) }} ريال</span>
                    </div>
                    <div>
                        <span class="fw-bold">إجمالي الأيام في الورشة:</span>
                        <span class="badge bg-danger">{{ days_in_workshop }} يوم</span>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-wrench fa-4x text-muted"></i>
                    </div>
                    <h5>لا توجد سجلات ورشة لهذه السيارة</h5>
                    <p class="text-muted">يمكنك إضافة سجل جديد من خلال النقر على زر "إضافة سجل جديد"</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- تخصيصات المشاريع -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-project-diagram ms-2"></i>
                    تخصيصات المشاريع
                    <span class="badge bg-secondary">{{ project_assignments|length }}</span>
                </h5>
                <a href="{{ url_for('vehicles.create_project', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus ms-1"></i>
                    تخصيص لمشروع
                </a>
            </div>
            <div class="card-body">
                {% if project_assignments %}
                <div class="list-group">
                    {% for assignment in project_assignments %}
                    <div
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">
                                {{ assignment.project_name }}
                                {% if assignment.is_active %}
                                <span class="badge bg-success">نشط</span>
                                {% else %}
                                <span class="badge bg-danger">منتهي</span>
                                {% endif %}
                            </div>
                            <div class="small">
                                البداية: {{ assignment.formatted_start_date }}
                                {% if assignment.end_date %}
                                | النهاية: {{ assignment.formatted_end_date }}
                                {% else %}
                                | <span class="text-success">مستمر</span>
                                {% endif %}
                            </div>
                            <div class="small">
                                المسؤول: {{ assignment.manager_name }} |
                                الموقع: {{ assignment.location }}
                            </div>
                        </div>
                        <a href="{{ url_for('vehicles.edit_project', id=assignment.id) }}"
                            class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-building fa-4x text-muted"></i>
                    </div>
                    <h5>لا توجد تخصيصات لمشاريع</h5>
                    <p class="text-muted">يمكنك تخصيص السيارة لمشروع من خلال النقر على زر "تخصيص لمشروع"</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- القسم الثالث: السائق الحالي والسائقين السابقين -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header  d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-user-tie ms-2"></i>
                    السائق الحالي
                </h5>
                <a href="{{ url_for('vehicles.create_handover', id=vehicle.id) }}?type=delivery"
                    class="btn btn-sm btn-success">
                    <i class="fas fa-exchange-alt ms-1"></i>
                    تسليم لسائق جديد
                </a>
            </div>
            <div class="card-body">
                {% if current_driver %}
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h5 mb-1">{{ current_driver.name }}</div>
                        <div class="small text-muted">
                            منذ {{ current_driver.formatted_date }}
                        </div>
                    </div>
                    <div>
                        <a href="{{ url_for('vehicles.view_handover', id=current_driver.handover_id) }}"
                            class="btn btn-sm btn-outline-primary ms-1" title="مشاهدة التفاصيل">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{{ url_for('vehicles.handover_pdf_public', id=current_driver.handover_id) }}"
                            class="btn btn-sm btn-outline-danger ms-1" target="_blank" title="تحميل PDF">
                            <i class="fas fa-file-pdf"></i>
                        </a>
                        {% if current_driver.mobile %}
                        <a href="https://wa.me/{{ current_driver.mobile.replace('+', '').replace(' ', '').replace('-', '') }}?text=مرحباً {{ current_driver.name }}%0A%0Aبخصوص المركبة رقم: {{ vehicle.plate_number }}%0Aتاريخ {{ current_driver.handover_type_ar }}: {{ current_driver.formatted_date }}%0A%0Aرابط ملف PDF لبيانات التسليم/الاستلام:%0A{{ url_for('vehicles.handover_pdf_public', id=current_driver.handover_id, _external=True) }}%0A%0Aشكراً لك"
                            class="btn btn-sm btn-success ms-1" target="_blank" title="إرسال رسالة واتساب">
                            <i class="fab fa-whatsapp"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div class="text-muted">
                    <i class="fas fa-info-circle ms-1"></i>
                    لا يوجد معلومات عن السائق الحالي
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm h-100">
            <div class="card-header  d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history ms-2"></i>
                    السائقين السابقين
                    <span class="badge bg-secondary">{{ previous_drivers|length }}</span>
                </h5>
                <a href="{{ url_for('vehicles.create_handover', id=vehicle.id) }}?type=receive"
                    class="btn btn-sm btn-info">
                    <i class="fas fa-exchange-alt ms-1"></i>
                    استلام من سائق
                </a>
            </div>
            <div class="card-body">
                {% if previous_drivers %}
                <div class="list-group">
                    {% for driver in previous_drivers %}
                    <div
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fw-bold">{{ driver.name }}</div>
                            <div class="small text-muted">{{ driver.formatted_date }}</div>
                        </div>
                        <div>
                            <a href="{{ url_for('vehicles.view_handover', id=driver.handover_id) }}"
                                class="btn btn-sm btn-outline-primary ms-1" title="مشاهدة التفاصيل">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('vehicles.handover_pdf_public', id=driver.handover_id) }}"
                                class="btn btn-sm btn-outline-danger ms-1" target="_blank" title="تحميل PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                            {% if driver.mobile %}
                            <a href="https://wa.me/{{ driver.mobile.replace('+', '').replace(' ', '').replace('-', '') }}?text=مرحباً {{ driver.name }}%0A%0Aبخصوص المركبة رقم: {{ vehicle.plate_number }}%0Aتاريخ {{ driver.handover_type_ar }}: {{ driver.formatted_date }}%0A%0Aرابط ملف PDF لبيانات التسليم/الاستلام:%0A{{ url_for('vehicles.handover_pdf_public', id=driver.handover_id, _external=True) }}%0A%0Aشكراً لك"
                                class="btn btn-sm btn-success ms-1" target="_blank" title="إرسال رسالة واتساب">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-muted">
                    <i class="fas fa-info-circle ms-1"></i>
                    لا يوجد سائقين سابقين
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- القسم الرابع: سجلات التسليم والاستلام -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header  d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-exchange-alt ms-2"></i>
                    سجلات التسليم والاستلام
                    <span class="badge bg-secondary">{{ handover_records|length }}</span>
                </h5>
                <a href="{{ url_for('vehicles.create_handover', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus ms-1"></i>
                    إضافة سجل تسليم/استلام
                </a>
            </div>
            <div class="card-body">
                {% if handover_records %}
                <form action="{{ url_for('vehicles.confirm_delete_handovers', vehicle_id=vehicle.id) }}" method="post"
                    id="handover-delete-form">
                    <div class="mb-3 d-flex justify-content-end">
                        <button type="submit" class="btn btn-sm btn-danger" id="delete-selected-btn" disabled>
                            <i class="fas fa-trash-alt ms-1"></i>
                            حذف المحدد
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="40">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="select-all">
                                        </div>
                                    </th>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>الشخص</th>
                                    <th>العداد</th>
                                    <th>مستوى الوقود</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for record in handover_records %}
                                <tr>
                                    <td>
                                        <div class="form-check">
                                            <input class="form-check-input handover-checkbox" type="checkbox"
                                                name="handover_ids[]" value="{{ record.id }}">
                                        </div>
                                    </td>
                                    <td>{{ record.formatted_handover_date }}</td>
                                    <td>
                                        {% if record.handover_type_ar == 'تسليم' %}
                                        <span class="badge bg-success">تسليم</span>
                                        {% else %}
                                        <span class="badge bg-info">استلام</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ record.person_name }}</td>
                                    <td>{{ record.mileage }} كم</td>
                                    <td>{{ record.fuel_level }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('vehicles.view_handover', id=record.id) }}"
                                                class="btn btn-outline-primary">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ url_for('vehicles.edit_handover', id=record.id) }}"
                                                class="btn btn-outline-success">
                                                <i class="fas fa-edit"></i>
                                                تعديل
                                            </a>
                                            {% if record.mobile %}
                                            <a href="https://wa.me/{{ record.mobile.replace('+', '').replace(' ', '').replace('-', '') }}?text=مرحباً {{ record.person_name }}%0A%0Aبخصوص المركبة رقم: {{ vehicle.plate_number }}%0Aتاريخ {{ record.handover_type_ar }}: {{ record.formatted_handover_date }}%0A%0Aرابط ملف PDF لبيانات التسليم/الاستلام:%0A{{ url_for('vehicles.handover_pdf_public', id=record.id, _external=True) }}%0A%0Aشكراً لك"
                                                class="btn btn-outline-success" target="_blank"
                                                title="إرسال رسالة واتساب">
                                                <i class="fab fa-whatsapp"></i>
                                            </a>
                                            {% endif %}
                                            <a href="{{ url_for('vehicles.handover_pdf_public', id=record.id) }}"
                                                class="btn btn-outline-danger" target="_blank">
                                                <i class="fas fa-file-pdf"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </form>
                {% else %}
                <div class="text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-file-signature fa-4x text-muted"></i>
                    </div>
                    <h5>لا توجد سجلات تسليم واستلام</h5>
                    <p class="text-muted">يمكنك إضافة سجل تسليم أو استلام من خلال النقر على زر "إضافة سجل تسليم/استلام"
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- قسم التفويضات الخارجية -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-file-signature ms-2"></i>
                    التفويضات الخارجية للموظفين
                    <span class="badge bg-secondary">0</span>
                </h5>
                <a href="{{ url_for('external_authorizations.create_authorization', vehicle_id=vehicle.id) }}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus ms-1"></i>
                    إضافة تفويض خارجي
                </a>
            </div>
            <div class="card-body">
                <div class="text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-clipboard-list fa-4x text-muted"></i>
                    </div>
                    <h5>لا توجد تفويضات خارجية</h5>
                    <p class="text-muted">يمكنك إضافة تفويض خارجي جديد للموظفين المرتبطين بهذه السيارة</p>
                    <a href="{{ url_for('external_authorizations.create_authorization', vehicle_id=vehicle.id) }}" class="btn btn-primary mt-2">
                        <i class="fas fa-plus ms-1"></i>
                        إضافة أول تفويض
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- قسم بيانات الحوادث المرورية -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header  d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-car-crash ms-2"></i>
                    الحوادث المرورية
                    {% if accidents %}
                    <span class="badge bg-secondary">{{ accidents|length }}</span>
                    {% endif %}
                </h5>
                <div>
                    <a href="{{ url_for('vehicles.create_accident', id=vehicle.id) }}" class="btn btn-sm btn-success">
                        <i class="fas fa-plus ms-1"></i>
                        إضافة حادث جديد
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if accidents %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>تاريخ الحادث</th>
                                <th>اسم السائق</th>
                                <th>حالة الحادث</th>
                                <th>حالة السيارة</th>
                                <th>نسبة التحمل</th>
                                <th>مبلغ الخصم</th>
                                <th>حالة الخصم</th>
                                <th>المستندات</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for accident in accidents %}
                            <tr>
                                <td>{{ accident.accident_date|display_date }}</td>
                                <td>{{ accident.driver_name }}</td>
                                <td>
                                    {% if accident.accident_status == 'قيد المعالجة' %}
                                    <span class="badge bg-warning text-dark">قيد المعالجة</span>
                                    {% elif accident.accident_status == 'مغلق' %}
                                    <span class="badge bg-success">مغلق</span>
                                    {% elif accident.accident_status == 'معلق' %}
                                    <span class="badge bg-secondary">معلق</span>
                                    {% elif accident.accident_status == 'في التأمين' %}
                                    <span class="badge bg-info">في التأمين</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ accident.accident_status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ accident.vehicle_condition or 'غير محدد' }}</td>
                                <td>
                                    {% if accident.liability_percentage > 0 %}
                                    {% if accident.liability_percentage == 25 %}
                                    <span class="badge bg-info">تحمل جزئي (25%)</span>
                                    {% elif accident.liability_percentage == 50 %}
                                    <span class="badge bg-warning text-dark">تحمل متوسط (50%)</span>
                                    {% elif accident.liability_percentage == 75 %}
                                    <span class="badge bg-danger">تحمل كبير (75%)</span>
                                    {% elif accident.liability_percentage == 100 %}
                                    <span class="badge bg-dark">تحمل كامل (100%)</span>
                                    {% else %}
                                    <span class="badge bg-secondary">{{ accident.liability_percentage }}%</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="badge bg-light text-dark">لا يوجد تحمل (0%)</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if accident.deduction_amount > 0 %}
                                    {{ "{:,.2f}".format(accident.deduction_amount) }} ريال
                                    {% else %}
                                    <span class="text-muted">لا يوجد</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if accident.deduction_amount > 0 %}
                                    {% if accident.deduction_status %}
                                    <span class="badge bg-success">تم الخصم</span>
                                    {% else %}
                                    <span class="badge bg-danger">لم يتم الخصم</span>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if accident.accident_file_link %}
                                    <a href="{{ accident.accident_file_link }}" target="_blank"
                                        class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-file-alt"></i>
                                    </a>
                                    {% else %}
                                    <span class="text-muted">لا يوجد</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{{ url_for('vehicles.edit_accident', id=accident.id) }}"
                                            class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ url_for('vehicles.confirm_delete_accident', id=accident.id) }}"
                                            class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <div class="mb-3">
                        <i class="fas fa-car-crash fa-4x text-muted"></i>
                    </div>
                    <h5>لا توجد سجلات حوادث مسجلة</h5>
                    <p class="text-muted">يمكنك إضافة سجل حادث جديد من خلال النقر على زر "إضافة حادث جديد"</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- تضمين النافذة المنبثقة للتفويضات الخارجية -->
{% include 'vehicles/external_auth_modal.html' %}
<div class="modal fade" id="externalAuthModal" tabindex="-1" aria-labelledby="externalAuthModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="externalAuthModalLabel">
                    <i class="fas fa-file-signature ms-2"></i>
                    إضافة تفويض خارجي للموظف - {{ vehicle.plate_number }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="externalAuthForm" enctype="multipart/form-data">
                <div class="modal-body">
                    <!-- معلومات السيارة -->
                    <div class="card mb-3 bg-light">
                        <div class="card-body p-3">
                            <div class="row align-items-center">
                                <div class="col-auto">
                                    <i class="fas fa-car fa-2x text-primary"></i>
                                </div>
                                <div class="col">
                                    <h6 class="mb-1">{{ vehicle.make }} {{ vehicle.model }}</h6>
                                    <small class="text-muted">رقم اللوحة: {{ vehicle.plate_number }} | سنة الصنع: {{ vehicle.year }}</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- فلترة القسم والمشروع -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="departmentFilter" class="form-label fw-bold">
                                <i class="fas fa-building me-1"></i>فلترة حسب القسم
                            </label>
                            <select class="form-select" id="departmentFilter">
                                <option value="">جميع الأقسام</option>
                                <option value="1">الإدارة العامة</option>
                                <option value="2">الموارد البشرية</option>
                                <option value="3">التقنية</option>
                                <option value="4">المالية</option>
                                <option value="5">العمليات</option>
                                <option value="6">المبيعات</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="projectSelect" class="form-label fw-bold">
                                <i class="fas fa-project-diagram me-1"></i>المشروع *
                            </label>
                            <select class="form-select" id="projectSelect" name="project_id" required>
                                <option value="">اختر المشروع</option>
                                <option value="1">مشروع الرياض</option>
                                <option value="2">مشروع جدة</option>
                                <option value="3">مشروع الشرقية</option>
                                <option value="4">مشروع نيوم</option>
                                <option value="5">مشروع القصيم</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="authorizationType" class="form-label fw-bold">
                                <i class="fas fa-exchange-alt me-1"></i>نوع الإحالة *
                            </label>
                            <select class="form-select" name="authorization_type" id="authorizationType" required>
                                <option value="تسليم">تسليم</option>
                                <option value="استلام">استلام</option>
                            </select>
                        </div>
                    </div>

                    <!-- اختيار الموظف -->
                    <div class="mb-3">
                        <label for="employeeSelect" class="form-label fw-bold">
                            <i class="fas fa-user me-1"></i>اختيار الموظف *
                        </label>
                        <select class="form-select" id="employeeSelect" name="employee_id" required>
                            <option value="">اختر الموظف</option>
                            <option value="178">أحمد محمد - الإدارة العامة</option>
                            <option value="179">سارة أحمد - الموارد البشرية</option>
                            <option value="180">محمد علي - التقنية</option>
                            <option value="181">فاطمة خالد - المالية</option>
                            <option value="182">عبدالله سعد - العمليات</option>
                            <option value="183">نورا عبدالرحمن - المبيعات</option>
                        </select>
                        <input type="hidden" name="vehicle_id" value="{{ vehicle.id }}">
                    </div>

                    <!-- وصف التفويض -->
                    <div class="mb-3">
                        <label for="description" class="form-label fw-bold">
                            <i class="fas fa-align-left me-1"></i>وصف التفويض
                        </label>
                        <textarea class="form-control" name="description" id="description" 
                                  rows="3" placeholder="وصف مختصر للتفويض..."></textarea>
                    </div>

                    <!-- رفع الملف -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-paperclip me-1"></i>رفع ملف (PDF أو صورة)
                        </label>
                        <div class="file-upload-area border-2 border-dashed rounded p-4 text-center bg-light" 
                             style="cursor: pointer; transition: all 0.3s ease; border-color: #dee2e6;" id="fileUploadArea">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                            <h6 class="text-primary">اسحب الملف هنا أو انقر للاختيار</h6>
                            <p class="text-muted mb-0 small">PDF, JPG, PNG, GIF (حد أقصى 10MB)</p>
                            <input type="file" name="authorization_file" id="authorizationFile" 
                                   accept=".pdf,.jpg,.jpeg,.png,.gif" style="display: none;">
                        </div>
                        <div class="file-info d-none mt-2" id="fileInfo">
                            <div class="alert alert-success d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-file me-2"></i>
                                    <span id="fileName"></span>
                                    <small class="text-muted d-block" id="fileSize"></small>
                                </div>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="clearFile()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- الرابط الخارجي -->
                    <div class="mb-3">
                        <label for="externalLink" class="form-label fw-bold">
                            <i class="fas fa-link me-1"></i>رابط خارجي (اختياري)
                        </label>
                        <input type="url" class="form-control" name="external_link" id="externalLink" 
                               placeholder="https://example.com">
                        <small class="text-muted">مثل رابط Google Form أو مستند على Drive</small>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times ms-1"></i>إلغاء
                    </button>
                    <button type="submit" class="btn btn-primary" onclick="submitExternalAuth()">
                        <i class="fas fa-save ms-1"></i>
                        حفظ التفويض
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
</div>

{% endblock %}

<style>
.employee-dropdown {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
    max-height: 300px;
    overflow-y: auto;
    z-index: 1050;
}

.employee-item {
    padding: 15px 20px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: all 0.2s ease;
    position: relative;
}

.employee-item:hover {
    background-color: #e3f2fd;
    border-left: 4px solid #2196f3;
    padding-left: 16px;
}

.employee-item:last-child {
    border-bottom: none;
}

.employee-name {
    font-weight: bold;
    color: #333;
}

.employee-details {
    font-size: 0.85rem;
    color: #666;
    margin-top: 3px;
}

.file-upload-area:hover {
    border-color: #0d6efd !important;
    background-color: #e7f1ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.15);
}

.loading-spinner {
    width: 16px;
    height: 16px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #667eea;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #999;
    font-style: italic;
}
</style>

{% block scripts %}
{{ super() }}
<script>
// دالة مؤقتة لحل مشكلة animateCounters
function animateCounters() {
    console.log('animateCounters called but not implemented');
}

// دالة إرسال التفويض الخارجي
function submitExternalAuth() {
    event.preventDefault();
    
    const form = document.getElementById('externalAuthForm');
    const formData = new FormData(form);
    
    // التحقق من الحقول المطلوبة
    if (!formData.get('employee_id')) {
        alert('يرجى اختيار الموظف');
        return;
    }
    
    if (!formData.get('project_id')) {
        alert('يرجى اختيار المشروع');
        return;
    }
    
    // إرسال البيانات
    fetch('/external-authorizations/create', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // إغلاق النافذة
            const modal = bootstrap.Modal.getInstance(document.getElementById('externalAuthModal'));
            modal.hide();
            
            // إعادة تعيين النموذج
            form.reset();
            
            // عرض رسالة نجاح
            alert('تم حفظ التفويض بنجاح');
            
            // إعادة تحميل الصفحة
            location.reload();
        } else {
            alert('حدث خطأ أثناء الحفظ');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ أثناء الحفظ');
    });
}

// دالة فلترة الموظفين حسب القسم
function filterEmployeesByDepartment() {
    const departmentFilter = document.getElementById('departmentFilter');
    const employeeSelect = document.getElementById('employeeSelect');
    const selectedDept = departmentFilter.value;
    
    // خيارات الموظفين مع أقسامهم
    const allEmployees = [
        { value: "178", text: "أحمد محمد - الإدارة العامة", dept: "1" },
        { value: "179", text: "سارة أحمد - الموارد البشرية", dept: "2" },
        { value: "180", text: "محمد علي - التقنية", dept: "3" },
        { value: "181", text: "فاطمة خالد - المالية", dept: "4" },
        { value: "182", text: "عبدالله سعد - العمليات", dept: "5" },
        { value: "183", text: "نورا عبدالرحمن - المبيعات", dept: "6" }
    ];
    
    // مسح الخيارات الحالية
    employeeSelect.innerHTML = '<option value="">اختر الموظف</option>';
    
    // إضافة الموظفين المفلترين
    allEmployees.forEach(emp => {
        if (!selectedDept || emp.dept === selectedDept) {
            const option = document.createElement('option');
            option.value = emp.value;
            option.textContent = emp.text;
            employeeSelect.appendChild(option);
        }
    });
}

// إعداد أحداث الفلترة
document.addEventListener('DOMContentLoaded', function() {
    const departmentFilter = document.getElementById('departmentFilter');
    if (departmentFilter) {
        departmentFilter.addEventListener('change', filterEmployeesByDepartment);
    }
});

// النظام المبسط بدون تحميل خارجي

// حذف النظام القديم

// إعداد بحث الموظفين
function setupEmployeeSearch() {
    const employeeSearch = document.getElementById('employeeSearch');
    const departmentFilter = document.getElementById('departmentFilter');
    
    employeeSearch.addEventListener('input', function(e) {
        const query = e.target.value.trim();
        const departmentId = departmentFilter.value;
        
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            hideEmployeeDropdown();
            return;
        }
        
        showSpinner();
        
        searchTimeout = setTimeout(() => {
            searchEmployees(query, departmentId);
        }, 300);
    });
    
    departmentFilter.addEventListener('change', function() {
        const query = employeeSearch.value.trim();
        const departmentId = this.value;
        
        if (query.length >= 2) {
            showSpinner();
            searchEmployees(query, departmentId);
        }
    });
}

// بحث الموظفين
async function searchEmployees(query, departmentId = '') {
    try {
        const params = new URLSearchParams({ search: query });
        if (departmentId) {
            params.append('department_id', departmentId);
        }
        
        const response = await fetch(`/external-authorizations/api/employees?${params}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const employees = await response.json();
        displayEmployees(employees);
    } catch (error) {
        console.error('Error searching employees:', error);
        displayEmployees([]);
    } finally {
        hideSpinner();
    }
}

// عرض الموظفين
function displayEmployees(employees) {
    const dropdown = document.getElementById('employeeDropdown');
    dropdown.innerHTML = '';
    
    if (employees.length === 0) {
        dropdown.innerHTML = `
            <div class="no-results p-3 text-center text-muted">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p class="mb-0">لا توجد نتائج</p>
                <small>جرب البحث بطريقة أخرى</small>
            </div>
        `;
    } else {
        employees.forEach(employee => {
            const item = document.createElement('div');
            item.className = 'employee-item p-3 border-bottom';
            item.style.cursor = 'pointer';
            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 40px; height: 40px;">
                            <i class="fas fa-user text-white"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="mb-1 fw-bold employee-name">${employee.name}</h6>
                        <div class="employee-details">
                            <small class="text-muted">
                                <i class="fas fa-id-card me-1"></i>
                                ${employee.employee_id}
                            </small>
                            <br>
                            <small class="text-primary">
                                <i class="fas fa-building me-1"></i>
                                ${employee.departments_str || 'غير محدد'}
                            </small>
                        </div>
                    </div>
                    <div class="ms-2">
                        <i class="fas fa-chevron-left text-muted"></i>
                    </div>
                </div>
            `;
            
            // إضافة تأثير hover
            item.addEventListener('mouseenter', () => {
                item.style.backgroundColor = '#f8f9fa';
            });
            item.addEventListener('mouseleave', () => {
                item.style.backgroundColor = 'white';
            });
            
            item.addEventListener('click', () => selectEmployee(employee));
            dropdown.appendChild(item);
        });
    }
    
    showEmployeeDropdown(employees);
}

// إظهار قائمة الموظفين
function showEmployeeDropdown(employees) {
    const dropdown = document.getElementById('employeeDropdown');
    if (dropdown) {
        dropdown.style.display = 'block';
    }
}

// اختيار موظف
function selectEmployee(employee) {
    selectedEmployeeId = employee.id;
    
    document.getElementById('employeeId').value = employee.id;
    document.getElementById('employeeSearch').value = employee.name;
    
    document.getElementById('selectedEmployeeName').textContent = employee.name;
    document.getElementById('selectedEmployeeDetails').textContent = 
        `رقم الموظف: ${employee.employee_id} | الأقسام: ${employee.departments_str || 'غير محدد'}`;
    
    document.getElementById('selectedEmployee').classList.remove('d-none');
    hideEmployeeDropdown();
}

// مسح اختيار الموظف
function clearSelectedEmployee() {
    selectedEmployeeId = null;
    document.getElementById('employeeId').value = '';
    document.getElementById('employeeSearch').value = '';
    document.getElementById('selectedEmployee').classList.add('d-none');
}

// إظهار/إخفاء القائمة المنسدلة
function showEmployeeDropdown() {
    document.getElementById('employeeDropdown').style.display = 'block';
}

function hideEmployeeDropdown() {
    document.getElementById('employeeDropdown').style.display = 'none';
}

// إظهار/إخفاء رمز التحميل
function showSpinner() {
    document.getElementById('searchSpinner').classList.remove('d-none');
    document.getElementById('searchIcon').classList.add('d-none');
}

function hideSpinner() {
    document.getElementById('searchSpinner').classList.add('d-none');
    document.getElementById('searchIcon').classList.remove('d-none');
}

// إعداد رفع الملفات
function setupFileUpload() {
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('authorizationFile');
    
    fileUploadArea.addEventListener('click', () => fileInput.click());
    
    fileUploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '#667eea';
        fileUploadArea.style.backgroundColor = '#e3f2fd';
    });
    
    fileUploadArea.addEventListener('dragleave', () => {
        fileUploadArea.style.borderColor = '#ddd';
        fileUploadArea.style.backgroundColor = '';
    });
    
    fileUploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUploadArea.style.borderColor = '#ddd';
        fileUploadArea.style.backgroundColor = '';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFile(e.target.files[0]);
        }
    });
}

// معالجة الملف
function handleFile(file) {
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
    if (!allowedTypes.includes(file.type)) {
        alert('نوع الملف غير مدعوم. يرجى اختيار PDF أو صورة.');
        return;
    }
    
    if (file.size > 10 * 1024 * 1024) {
        alert('حجم الملف كبير جداً. الحد الأقصى 10MB.');
        return;
    }
    
    document.getElementById('fileName').textContent = file.name;
    document.getElementById('fileSize').textContent = formatFileSize(file.size);
    document.getElementById('fileInfo').classList.remove('d-none');
}

// مسح الملف
function clearFile() {
    document.getElementById('authorizationFile').value = '';
    document.getElementById('fileInfo').classList.add('d-none');
}

// تنسيق حجم الملف
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// إعداد إرسال النموذج
function setupFormSubmission() {
    const form = document.getElementById('externalAuthForm');
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (!selectedEmployeeId) {
            alert('يرجى اختيار موظف');
            return;
        }
        
        const projectId = document.getElementById('projectSelect').value;
        if (!projectId) {
            alert('يرجى اختيار المشروع');
            return;
        }
        
        const formData = new FormData(form);
        
        try {
            const response = await fetch('/external-authorizations/create', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const responseData = await response.json();
                
                // إغلاق النافذة وإعادة تحميل القسم
                const modal = bootstrap.Modal.getInstance(document.getElementById('externalAuthModal'));
                modal.hide();
                
                // إعادة تعيين النموذج
                form.reset();
                clearSelectedEmployee();
                clearFile();
                
                // عرض رسالة نجاح بتصميم Bootstrap
                showSuccessAlert(responseData.message || 'تم إنشاء التفويض بنجاح');
                
                // إعادة تحميل قائمة التفويضات
                loadExistingAuthorizations();
            } else {
                const errorData = await response.json();
                showErrorAlert(errorData.error || 'حدث خطأ أثناء إنشاء التفويض');
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            alert('حدث خطأ أثناء إرسال البيانات');
        }
    });
}

// إخفاء القائمة عند النقر خارجها
document.addEventListener('click', (e) => {
    if (!e.target.closest('.employee-search-container')) {
        hideEmployeeDropdown();
    }
});

// عرض رسالة نجاح
function showSuccessAlert(message) {
    const alertHTML = `
        <div class="alert alert-success alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHTML);
    
    // إزالة الرسالة تلقائياً بعد 3 ثوان
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 3000);
}

// عرض رسالة خطأ
function showErrorAlert(message) {
    const alertHTML = `
        <div class="alert alert-danger alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHTML);
    
    // إزالة الرسالة تلقائياً بعد 5 ثوان
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// عرض تفاصيل التفويض
function viewAuthorization(authId) {
    // سيتم إضافة نافذة عرض التفاصيل لاحقاً
    console.log('View authorization:', authId);
}

// فتح نافذة التفويض الخارجي
function openExternalAuthModal() {
    console.log('Opening external auth modal...');
    
    // التحقق من وجود النافذة
    const modal = document.getElementById('externalAuthModal');
    if (modal) {
        console.log('Modal found, showing...');
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
    } else {
        console.error('Modal not found!');
    }
}

// JavaScript الخاص بصفحة السيارة الأساسية
    document.addEventListener('DOMContentLoaded', function () {
        // تحديد العناصر
        const selectAllCheckbox = document.getElementById('select-all');
        const handoverCheckboxes = document.querySelectorAll('.handover-checkbox');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');

        if (selectAllCheckbox && handoverCheckboxes.length > 0 && deleteSelectedBtn) {
            // تحديث زر الحذف بناءً على الخانات المحددة
            function updateDeleteButton() {
                const checkedCount = document.querySelectorAll('.handover-checkbox:checked').length;
                deleteSelectedBtn.disabled = checkedCount === 0;

                // تحديث نص الزر ليعكس عدد العناصر المحددة
                if (checkedCount > 0) {
                    deleteSelectedBtn.innerHTML = `<i class="fas fa-trash-alt ms-1"></i> حذف المحدد (${checkedCount})`;
                } else {
                    deleteSelectedBtn.innerHTML = `<i class="fas fa-trash-alt ms-1"></i> حذف المحدد`;
                }
            }

            // تحديد/إلغاء تحديد الكل
            selectAllCheckbox.addEventListener('change', function () {
                handoverCheckboxes.forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                updateDeleteButton();
            });

            // تحديث زر الحذف عند تغيير حالة أي خانة
            handoverCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function () {
                    // تحديث حالة خانة تحديد الكل
                    const allChecked = document.querySelectorAll('.handover-checkbox:checked').length === handoverCheckboxes.length;
                    selectAllCheckbox.checked = allChecked;

                    // تحديث زر الحذف
                    updateDeleteButton();
                });
            });

            // تحديث حالة زر الحذف عند تحميل الصفحة
            updateDeleteButton();
        }
    });
</script>
{% endblock %}