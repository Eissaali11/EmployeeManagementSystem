{% extends 'layout.html' %}

{% block title %}تفاصيل السيارة: {{ vehicle.plate_number }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- شريط التنقل العلوي -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-car ms-2"></i>
            تفاصيل السيارة: {{ vehicle.plate_number }}
        </h2>
        <div>
            <a href="{{ url_for('vehicles.edit', id=vehicle.id) }}" class="btn btn-warning">
                <i class="fas fa-edit ms-1"></i>
                تعديل السيارة
            </a>
            <a href="{{ url_for('vehicles.index') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-right ms-1"></i>
                العودة للقائمة
            </a>
        </div>
    </div>

    <!-- بطاقة المعلومات الرئيسية -->
    <div class="row mb-4">
        <!-- تفاصيل السيارة الأساسية -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle ms-2"></i>
                        معلومات السيارة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">رقم اللوحة:</div>
                        <div class="col-sm-8">{{ vehicle.plate_number }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">النوع:</div>
                        <div class="col-sm-8">{{ vehicle.make }} {{ vehicle.model }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">سنة الصنع:</div>
                        <div class="col-sm-8">{{ vehicle.year }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">اللون:</div>
                        <div class="col-sm-8">
                            <span class="badge rounded-pill" style="background-color: {{ vehicle.color }}; color: {{ '#000' if vehicle.color in ['white', 'yellow', 'silver'] else '#fff' }};">
                                {{ vehicle.color }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">الحالة:</div>
                        <div class="col-sm-8">
                            {% if vehicle.status == 'available' %}
                                <span class="badge bg-success">متاحة</span>
                            {% elif vehicle.status == 'rented' %}
                                <span class="badge bg-primary">مؤجرة</span>
                            {% elif vehicle.status == 'in_project' %}
                                <span class="badge bg-info">في المشروع</span>
                            {% elif vehicle.status == 'in_workshop' %}
                                <span class="badge bg-warning text-dark">في الورشة</span>
                            {% elif vehicle.status == 'accident' %}
                                <span class="badge bg-danger">حادث</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ vehicle.status }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-sm-4 fw-bold">تاريخ الإضافة:</div>
                        <div class="col-sm-8">{{ vehicle.created_at.strftime('%Y-%m-%d') }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-4 fw-bold">آخر تحديث:</div>
                        <div class="col-sm-8">{{ vehicle.updated_at.strftime('%Y-%m-%d') }}</div>
                    </div>
                    {% if vehicle.notes %}
                    <div class="row mb-2">
                        <div class="col-12 fw-bold">ملاحظات:</div>
                        <div class="col-12 mt-2">
                            <div class="alert alert-secondary">{{ vehicle.notes }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- معلومات الإيجار -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-money-bill-wave ms-2"></i>
                        معلومات الإيجار
                    </h5>
                    <a href="{{ url_for('vehicles.create_rental', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                        {% if rental %}تعديل الإيجار{% else %}إضافة إيجار{% endif %}
                    </a>
                </div>
                <div class="card-body">
                    {% if rental %}
                        <div class="row mb-2">
                            <div class="col-sm-4 fw-bold">تاريخ البداية:</div>
                            <div class="col-sm-8">{{ rental.formatted_start_date }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 fw-bold">تاريخ النهاية:</div>
                            <div class="col-sm-8">
                                {% if rental.end_date %}
                                    {{ rental.formatted_end_date }}
                                {% else %}
                                    <span class="badge bg-info">مستمر</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 fw-bold">قيمة الإيجار الشهري:</div>
                            <div class="col-sm-8">{{ "{:,.2f}".format(rental.monthly_cost) }} ريال</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 fw-bold">حالة الإيجار:</div>
                            <div class="col-sm-8">
                                {% if rental.is_active %}
                                    <span class="badge bg-success">نشط</span>
                                {% else %}
                                    <span class="badge bg-danger">منتهي</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 fw-bold">المؤجر:</div>
                            <div class="col-sm-8">{{ rental.lessor_name or 'غير محدد' }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 fw-bold">معلومات الاتصال:</div>
                            <div class="col-sm-8">{{ rental.lessor_contact or 'غير محدد' }}</div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-sm-4 fw-bold">رقم العقد:</div>
                            <div class="col-sm-8">{{ rental.contract_number or 'غير محدد' }}</div>
                        </div>
                        {% if rental.notes %}
                        <div class="row mb-2">
                            <div class="col-12 fw-bold">ملاحظات الإيجار:</div>
                            <div class="col-12 mt-2">
                                <div class="alert alert-secondary">{{ rental.notes }}</div>
                            </div>
                        </div>
                        {% endif %}
                        <div class="mt-3">
                            <a href="{{ url_for('vehicles.edit_rental', id=rental.id) }}" class="btn btn-sm btn-warning">
                                <i class="fas fa-edit ms-1"></i>
                                تعديل معلومات الإيجار
                            </a>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-file-contract fa-4x text-muted"></i>
                            </div>
                            <h5>لا يوجد إيجار نشط حالياً</h5>
                            <p class="text-muted">يمكنك إضافة معلومات الإيجار للسيارة من خلال النقر على زر "إضافة إيجار"</p>
                            <a href="{{ url_for('vehicles.create_rental', id=vehicle.id) }}" class="btn btn-primary mt-2">
                                <i class="fas fa-plus ms-1"></i>
                                إضافة إيجار
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- القسم الثاني: سجلات الورشة والمشاريع -->
    <div class="row mb-4">
        <!-- سجلات الورشة -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-tools ms-2"></i>
                        سجلات الورشة
                        <span class="badge bg-secondary">{{ workshop_records|length }}</span>
                    </h5>
                    <a href="{{ url_for('vehicles.create_workshop', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus ms-1"></i>
                        إضافة سجل جديد
                    </a>
                </div>
                <div class="card-body">
                    {% if workshop_records %}
                        <div class="list-group">
                            {% for record in workshop_records %}
                            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">
                                        {% if record.reason == 'maintenance' %}
                                            <span class="badge bg-info">صيانة دورية</span>
                                        {% elif record.reason == 'breakdown' %}
                                            <span class="badge bg-warning text-dark">عطل</span>
                                        {% elif record.reason == 'accident' %}
                                            <span class="badge bg-danger">حادث</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ record.reason }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="small">
                                        الدخول: {{ record.formatted_entry_date }}
                                        {% if record.exit_date %}
                                            | الخروج: {{ record.formatted_exit_date }}
                                        {% else %}
                                            | <span class="text-warning">ما زالت في الورشة</span>
                                        {% endif %}
                                    </div>
                                    <div class="small">التكلفة: {{ "{:,.2f}".format(record.cost) }} ريال</div>
                                </div>
                                <a href="{{ url_for('vehicles.edit_workshop', id=record.id) }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="d-flex justify-content-between mt-3">
                            <div>
                                <span class="fw-bold">إجمالي تكاليف الصيانة:</span>
                                <span class="badge bg-primary">{{ "{:,.2f}".format(total_maintenance_cost) }} ريال</span>
                            </div>
                            <div>
                                <span class="fw-bold">إجمالي الأيام في الورشة:</span>
                                <span class="badge bg-danger">{{ days_in_workshop }} يوم</span>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-wrench fa-4x text-muted"></i>
                            </div>
                            <h5>لا توجد سجلات ورشة لهذه السيارة</h5>
                            <p class="text-muted">يمكنك إضافة سجل جديد من خلال النقر على زر "إضافة سجل جديد"</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- تخصيصات المشاريع -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-project-diagram ms-2"></i>
                        تخصيصات المشاريع
                        <span class="badge bg-secondary">{{ project_assignments|length }}</span>
                    </h5>
                    <a href="{{ url_for('vehicles.create_project', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus ms-1"></i>
                        تخصيص لمشروع
                    </a>
                </div>
                <div class="card-body">
                    {% if project_assignments %}
                        <div class="list-group">
                            {% for assignment in project_assignments %}
                            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">
                                        {{ assignment.project_name }}
                                        {% if assignment.is_active %}
                                            <span class="badge bg-success">نشط</span>
                                        {% else %}
                                            <span class="badge bg-danger">منتهي</span>
                                        {% endif %}
                                    </div>
                                    <div class="small">
                                        البداية: {{ assignment.formatted_start_date }}
                                        {% if assignment.end_date %}
                                            | النهاية: {{ assignment.formatted_end_date }}
                                        {% else %}
                                            | <span class="text-success">مستمر</span>
                                        {% endif %}
                                    </div>
                                    <div class="small">
                                        المسؤول: {{ assignment.manager_name }} | 
                                        الموقع: {{ assignment.location }}
                                    </div>
                                </div>
                                <a href="{{ url_for('vehicles.edit_project', id=assignment.id) }}" class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-building fa-4x text-muted"></i>
                            </div>
                            <h5>لا توجد تخصيصات لمشاريع</h5>
                            <p class="text-muted">يمكنك تخصيص السيارة لمشروع من خلال النقر على زر "تخصيص لمشروع"</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- القسم الثالث: سجلات التسليم والاستلام -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-exchange-alt ms-2"></i>
                        سجلات التسليم والاستلام
                        <span class="badge bg-secondary">{{ handover_records|length }}</span>
                    </h5>
                    <a href="{{ url_for('vehicles.create_handover', id=vehicle.id) }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus ms-1"></i>
                        إضافة سجل تسليم/استلام
                    </a>
                </div>
                <div class="card-body">
                    {% if handover_records %}
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>التاريخ</th>
                                        <th>النوع</th>
                                        <th>الشخص</th>
                                        <th>العداد</th>
                                        <th>مستوى الوقود</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in handover_records %}
                                    <tr>
                                        <td>{{ record.formatted_handover_date }}</td>
                                        <td>
                                            {% if record.handover_type == 'delivery' %}
                                                <span class="badge bg-success">تسليم</span>
                                            {% else %}
                                                <span class="badge bg-info">استلام</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ record.person_name }}</td>
                                        <td>{{ record.mileage }} كم</td>
                                        <td>{{ record.fuel_level }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ url_for('vehicles.view_handover', id=record.id) }}" class="btn btn-outline-primary">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="{{ url_for('vehicles.handover_pdf', id=record.id) }}" class="btn btn-outline-danger" target="_blank">
                                                    <i class="fas fa-file-pdf"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <div class="mb-3">
                                <i class="fas fa-file-signature fa-4x text-muted"></i>
                            </div>
                            <h5>لا توجد سجلات تسليم واستلام</h5>
                            <p class="text-muted">يمكنك إضافة سجل تسليم أو استلام من خلال النقر على زر "إضافة سجل تسليم/استلام"</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}